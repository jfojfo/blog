<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>绕过Copy-On-Write机制安装全局Hook | jfo planet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="绕过Copy-On-Write机制安装全局Hook创建时间：2005-10-22文章属性：原创文章提交：Addylee (Addylee2004_at_163.com)Jeffrey Richter在他的&amp;lt;&amp;lt;widows核心编程&amp;gt;&amp;gt;一书中对Ring 3级的API Hook方法做了详细的介绍，但是一般的Ring 3无论是修改IAT，还是插入JMP XXX都将导致Copy-O">
<meta property="og:type" content="article">
<meta property="og:title" content="绕过Copy-On-Write机制安装全局Hook">
<meta property="og:url" content="http://blog.pickbox.me/2007/05/15/绕过Copy-On-Write机制安装全局Hook/index.html">
<meta property="og:site_name" content="jfo planet">
<meta property="og:description" content="绕过Copy-On-Write机制安装全局Hook创建时间：2005-10-22文章属性：原创文章提交：Addylee (Addylee2004_at_163.com)Jeffrey Richter在他的&amp;lt;&amp;lt;widows核心编程&amp;gt;&amp;gt;一书中对Ring 3级的API Hook方法做了详细的介绍，但是一般的Ring 3无论是修改IAT，还是插入JMP XXX都将导致Copy-O">
<meta property="og:updated_time" content="2016-10-15T05:24:27.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="绕过Copy-On-Write机制安装全局Hook">
<meta name="twitter:description" content="绕过Copy-On-Write机制安装全局Hook创建时间：2005-10-22文章属性：原创文章提交：Addylee (Addylee2004_at_163.com)Jeffrey Richter在他的&amp;lt;&amp;lt;widows核心编程&amp;gt;&amp;gt;一书中对Ring 3级的API Hook方法做了详细的介绍，但是一般的Ring 3无论是修改IAT，还是插入JMP XXX都将导致Copy-O">
  
    <link rel="alternative" href="/atom.xml" title="jfo planet" type="application/atom+xml">
  
  
    <link rel="icon" href="//favicon.ico">
  
  <script src="/style.js"></script>
  

</head>

<body>
  <div id="container">
    <div class="left-col">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="http://img.pickbox.me/wp-content/uploads/penguin.gif" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">jfo</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Hope is the best gift that tomorrow gives.</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a class="js-smart-menu" data-idx="0" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="1" href="javascript:void(0)">分类</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="2" href="javascript:void(0)">友链</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="3" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/jfojfo" title="github">github</a>
		        
					<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/jfojfo" title="zhihu">zhihu</a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-list"></i></div>
  		<h1 class="header-author js-mobile-header hide">jfo</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="http://img.pickbox.me/wp-content/uploads/penguin.gif" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">jfo</h1>
			</hgroup>
			
			<p class="header-subtitle">Hope is the best gift that tomorrow gives.</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/jfojfo" title="github">github</a>
			        
						<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/jfojfo" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
        <article id="post-绕过Copy-On-Write机制安装全局Hook" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      绕过Copy-On-Write机制安装全局Hook
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p> 绕过Copy-On-Write机制安装全局Hook<br>创建时间：2005-10-22<br>文章属性：原创<br>文章提交：<a href="https://www.xfocus.net/bbs/index.php?lang=cn&amp;act=Profile&amp;do=03&amp;MID=64388" target="_blank" rel="external">Addylee</a> (Addylee2004_at_163.com)<br><br>Jeffrey Richter在他的&lt;&lt;widows核心编程&gt;&gt;一书中对Ring 3级的API Hook方法做了详细的介绍，但是一般的Ring 3无论是修改IAT，还是插入JMP XXX都将导致Copy-On-Write的发生，如果，要在系统范围内安装一个全局的Hook的话，就不得不枚举系统中所有进程，对所有进程中的相应模 块做同样的修改，这样以来，对系统性能，是有一定的负面影响的。另一方面，如果要做系统范围内的全局Hook的话，可以直接在Ring 0级通过Hook系统调，修改目标API的指令等方法实现。但是，代码在Ring 0的地址空间中，Ring 3环境下的程序无法直接调用。<br>&nbsp;&nbsp; 由于Windows利用了PTE中的第9位用于Copy-On-Write机制。而Ring 3的代码无法访问PTE的，因此要绕过Copy-On-Write的话，该程序还是无法避免的要工作在Ring 0环境下。本文将以修改Kernel32.dll内存映象中的CreateProcessW为例，介绍绕过Copy-On-Write实现全局Hook的 一种方法。我的实验环境是Windows 2000 SP4 内部版本2195。因为EProcess的未公开原因，本例在其它版本的Windows不能保证正确运行。<br>&nbsp;&nbsp; 一般情况下，每个进程都加载了Kernel32.dll这个模块，并且绝大多数情况下Kernel32在每个进程中所加载的基址都一样，在物理内存 中，也只有一份Kernel32的映象，所以可以让用户程序LoadLibrary后，把Kernel32的基地址发到Ring 0的驱动程序中，让驱动程序来修改相应PTE，禁了Copy-On-Write后再修改相应的API指令就行了，但是，为了防止某种可能，比如：之前有一 个进程也对它进行了写操作，让系统中有了两份或多份Kernel32的映象，而在用户级LoadLibrary，最多只可能修改到某一个映象，所以，我从 内核中枚举了所有的EPROCESS结构，再根据PEB_LDR_DATA结构中找到它的所加载的模信息，对其修改。 直接操作各个进程地址空间的数据，很不方便，可以用Windows 未公开API，KeAttachProcess， 函数来切换到指定进程的内存上下文环境。把CreateProcessW的入口处改成了JMP XXX，但是，跳到哪去呢？程序工作在<br>Ring 0下，CreateProcessW不可能直接那里边的一个函数中的，但是，PE文件中每个节都会存在一些&ldquo;空洞&rdquo;，kernel32也不例外，就把代码 Copy到Kernel32的某个节区的&ldquo;空洞&rdquo;中去吧。如果&ldquo;空洞&rdquo;太小，怎么办呢？可以把我们的代码写成一个DLL，在那个&ldquo;空洞&rdquo;中放上一小段代码 来Load这个DLL，当然，也有可能在某种极端的情况下，这点&ldquo;空洞&rdquo;还是不够 就:(<br>struct&nbsp;&nbsp;  _hardware_pte_x86 (sizeof=4)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  +0 bits0-0 valid<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  +0 bits1-1 write<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  +0 bits2-2 owner<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  +0 bits3-3 writethrough<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  +0 bits4-4 cachedisable<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  +0 bits5-5 accessed<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  +0 bits6-6 dirty<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  +0 bits7-7 largepage<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  +0 bits8-8 global<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  +0 bits9-9 copyonwrite<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  +0 bits10-10 prototype<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  +0 bits11-11 reserved<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  +0 bits12-31 pageframenumber<br>从上面可以看出，bits 9 被用于Copy-On-Write机制，以下这段内容摘自&lt;&lt;Undocumented Windows NT&gt;&gt;<br>&nbsp;&nbsp; The VirtualProtect() function does not mark the page as read-write&ndash;it keeps the page as<br>read-only. Nevertheless, to distinguish this page from normal read-only pages, it is marked for copy-on-write. Windows NT uses one of the available PTE bits for doing this. When this page is written onto, because it is a read-only page, the processor raises a page fault exception. The page fault handler makes a copy of the page and modifies the page table of the faulting process accordingly. The new copy is marked as read-write so that the process can write to it. <br>所以只要把Read-Only属性去掉，再对这个DLL进行写入，就可以绕过Copy-On-Write机制了。:)<br><br>#include &lt;ntddk.h&gt;<br>#include &quot;proc.h&quot;&nbsp;&nbsp;  // 进程块的结构信息<br>#include &quot;PE.h&quot;&nbsp;&nbsp;&nbsp;&nbsp;  // PE文件的一些结构信息<br>#include &quot;Page.h&quot;&nbsp;&nbsp;  // 页表，页目录操作<br><br>#define PEBOFFSET 0x1B0&nbsp;&nbsp;  // PEB指针位于EPPROCESS中偏移0x1B0处<br>#define FLINKOFFSET 0xA0&nbsp;&nbsp; // 进程的链表指针。这些信息可以通过kd得到。<br><br>// 为了突出重点，节省篇幅，硬编码了两个未公开API的地址，其实也可以通过操作PE<br>// 的导出表来得到这些信息。<br>typedef NTSTATUS (NTAPI <em>KEATTACHPROCESS)(PPEB);<br>typedef NTSTATUS (NTAPI </em>KEDETACHPROCESS)();<br>KEATTACHPROCESS KeAttachProcess = 0x8042bd32;<br>KEDETACHPROCESS KeDetachProcess = 0x8042beca;<br><br>NTSTATUS DriverEntry(IN PDRIVER_OBJECT pDriverObject, IN PUNICODE_STRING pRegistryPath)<br>{<br>&nbsp;&nbsp; UNICODE_STRING Kernel32;<br>&nbsp;&nbsp; RtlInitUnicodeString(&amp;Kernel32, L&quot;C:\WINNT\SYSTEM32\KERNEL32.dll&quot;);<br>&nbsp;&nbsp; <strong>try<br>{&nbsp;&nbsp;  <br>&nbsp;&nbsp;&nbsp;&nbsp; Hook(&amp;Kernel32, &quot;CreateProcessW&quot;, NewCreateProcessW); <br>}<br></strong>except(EXCEPTION_EXECUTE_HANDLER)<br>{<br>&nbsp;&nbsp;  DbgPrint(&quot;Error&quot;);<br>}<br>RtlFreeUnicodeString(&amp;Kernel32);<br>return STATUS_SUCCESS;<br>}<br><br>VOID Hook(PUNICODE_STRING pModuleName, PCHAR pFunctionName, PVOID pfnNewFunction)<br>{<br>&nbsp;&nbsp; PLIST_ENTRY pCurrentList = NULL, pTempList = NULL, pLoadOrderModuleList, list;<br>&nbsp;&nbsp; PPEB pPeb = NULL;<br>&nbsp;&nbsp; PHYSICAL_ADDRESS paOld,&nbsp;&nbsp; paCurrent;<br>&nbsp;&nbsp; ULONG hModule, temp, pEProcess;<br>&nbsp;&nbsp; paOld.QuadPart = 0;<br>&nbsp;&nbsp; paCurrent.QuadPart = 0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp; pEProcess = (ULONG)IoGetCurrentProcess();<br>&nbsp;&nbsp; pCurrentList = (PLIST_ENTRY)(pEProcess + FLINKOFFSET);<br>&nbsp;&nbsp; pTempList = pCurrentList;<br>&nbsp;&nbsp; // 对所有进程进行枚举。<br>&nbsp;&nbsp; do<br>&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp; pEProcess = (ULONG)pTempList - FLINKOFFSET;<br>&nbsp;&nbsp;&nbsp;&nbsp; pPeb = (PPEB)(<em>(PULONG)(pEProcess + PEBOFFSET));<br>&nbsp;&nbsp;&nbsp;&nbsp; if (pPeb != NULL)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KeAttachProcess(pEProcess);&nbsp;&nbsp; // 切换内存上下文到指定的进程<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pLoadOrderModuleList = pPeb-&gt;LoaderData-&gt;InLoadOrderModuleList.Flink;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; list = pLoadOrderModuleList;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do&nbsp;&nbsp;  // 遍历进程所加载模块中，直到找到kernel32<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(0==RtlCompareUnicodeString(&amp;(((PLDR_MODULE)list)-&gt;FullDllName), pModuleName, TRUE)))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hModule = ((PLDR_MODULE)list)-&gt;BaseAddress;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Kernel32可能被调出,对它进行一次读操作，由于KeAttachProcess切换到了该进程的地址空间<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //所以让Windows自动处理缺页，把它调入吧，以免它&ldquo;漏网&rdquo;:)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; temp = </em>(PULONG)hModule; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; paCurrent = MmGetPhysicalAddress(hModule);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 如果上次处理过的，和现在的在同一物理地址上，就不处理了，当然如果，在内存中，有两个<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 以上的映像的话，这种处理方法不是很有效(还是造成了重复的工作)不过，在我实验中，<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 似乎总是只有一份Kernel32的内存映象，做个循环，只不过是为了以防万一。:)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (paOld.QuadPart != paCurrent.QuadPart)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; paOld.QuadPart = paCurrent.QuadPart;<br>&nbsp;&nbsp;&nbsp;&nbsp;  Patch(hModule, pFunctionName, pfnNewFunction);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  } <br>&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; list = list-&gt;Flink;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  } while(list != pLoadOrderModuleList);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  KeDetachProcess();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pTempList = pTempList-&gt;Flink;<br>&nbsp;&nbsp; } while(pTempList != pCurrentList);<br>}<br><br>VOID Patch(PVOID hModule, PCHAR pFunctionName, PVOID pfnNewFunction)<br>{<br>&nbsp;&nbsp; ULONG len, n;<br>&nbsp;&nbsp; PVOID pfnOrig, SectionGapStart;<br>&nbsp;&nbsp; pfnOrig = GetFunctionAddress(hModule, pFunctionName);<br>&nbsp;&nbsp; len = GetMyFunctionLen(pfnNewFunction);<br>&nbsp;&nbsp; SectionGapStart = GetSectionGap(hModule, len);<br>&nbsp;&nbsp; if (SectionGapStart == NULL)<br>&nbsp;&nbsp;&nbsp;&nbsp; return NULL;<br><br>&nbsp;&nbsp; PTE_ENTRY((ULONG)SectionGapStart) |= 2; // Read-Only 位。<br>&nbsp;&nbsp; for (n = 0; n &lt; len; n++)<br>&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp; <em>(PUCHAR)((PUCHAR)SectionGapStart + n) = </em>(PUCHAR)((PUCHAR)pfnNewFunction + n);<br>&nbsp;&nbsp; }<br>&nbsp;&nbsp; /<em> 我的机器上的CreateProcessW的代码，是这样了。<br>&nbsp;&nbsp;&nbsp;&nbsp; KERNEL32!CreateProcessW<br>&nbsp;&nbsp;&nbsp;&nbsp; 001B:77E6B252&nbsp;&nbsp;&nbsp;&nbsp; 55&nbsp;&nbsp;&nbsp;&nbsp; PUSH &nbsp;&nbsp;&nbsp;&nbsp; EBP<br>&nbsp;&nbsp;&nbsp;&nbsp; 001B:77E6B253&nbsp;&nbsp;&nbsp;&nbsp; 8BEC&nbsp;&nbsp;&nbsp;&nbsp; MOV&nbsp;&nbsp;&nbsp;&nbsp; EBP, ESP<br>&nbsp;&nbsp;&nbsp;&nbsp; 001B:77E6B255&nbsp;&nbsp;&nbsp;&nbsp; FF752C&nbsp;&nbsp;&nbsp;&nbsp; PUSH&nbsp;&nbsp;&nbsp;&nbsp; DWORD PTR [EBP+2C]<br>&nbsp;&nbsp;&nbsp;&nbsp; 第二条和第三条指令正好是5Byte的长度，所以，我选择把第二条和第三条改成跳转指令。<br>&nbsp;&nbsp;&nbsp;&nbsp; 跳转指令码为0xE9，位移计算：目的地址 - 起始地址 - 跳转指令本身的长度。<br>&nbsp;&nbsp; </em>/<br>&nbsp;&nbsp; for (len = 1; len &lt;= 5; len++, n++)<br>&nbsp;&nbsp;&nbsp;&nbsp; <em>(PUCHAR)((PUCHAR)SectionGapStart + n) = </em>(PUCHAR)((PUCHAR)pfnOrig + len);<br>&nbsp;&nbsp; <em>(PUCHAR)((PUCHAR)SectionGapStart + n) = 0xE9;<br>&nbsp;&nbsp; </em>(PULONG)((PUCHAR)SectionGapStart+n+1) = (ULONG)(((PUCHAR)pfnOrig + 6) <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - (ULONG)((PUCHAR)SectionGapStart + n) - 5);<br>&nbsp;&nbsp; PTE_ENTRY((ULONG)SectionGapStart) &amp;= 0xFFD;<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp; PTE_ENTRY((ULONG)pfnOrig) |= 2;&nbsp;&nbsp;<br>&nbsp;&nbsp; n += 6;<br>&nbsp;&nbsp; <strong>asm CLI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp; <em>(PUCHAR)((PUCHAR)pfnOrig + 1) = 0xE9;<br>&nbsp;&nbsp; </em>(PULONG)((PCHAR)pfnOrig + 2) = ((ULONG)SectionGapStart - (ULONG)((PUCHAR)pfnOrig+1) - 5);<br>&nbsp;&nbsp; </strong>asm STI<br>&nbsp;&nbsp; PTE_ENTRY((ULONG)pfnOrig) &amp;= 0xFFD;<br>}<br>// 根据指定的模块获取代码节的&ldquo;空洞&rdquo;偏移地址。<br>PVOID GetSectionGap(PVOID hModule, USHORT GapSize)<br>{<br>&nbsp;&nbsp; PIMAGE_DOS_HEADER pDosHeader = hModule;<br>&nbsp;&nbsp; PIMAGE_NT_HEADERS pNtHeader;<br>&nbsp;&nbsp; PIMAGE_SECTION_HEADER pSectionHeader;<br>&nbsp;&nbsp; ULONG n = 0;<br><br>&nbsp;&nbsp; if (pDosHeader-&gt;e_magic != ‘ZM’)<br>&nbsp;&nbsp;&nbsp;&nbsp; return NULL;<br>&nbsp;&nbsp; pNtHeader = (PIMAGE_NT_HEADERS)((PCHAR)hModule + pDosHeader-&gt;e_lfanew);<br>&nbsp;&nbsp; if (pNtHeader-&gt;Signature != ‘EP’)<br>&nbsp;&nbsp;&nbsp;&nbsp; return NULL;<br>&nbsp;&nbsp; pSectionHeader = (PCHAR)pNtHeader + sizeof(IMAGE_NT_HEADERS);<br>&nbsp;&nbsp; for (n = 0; n &lt; pNtHeader-&gt;FileHeader.NumberOfSections; n++)<br>&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp; pSectionHeader += n;<br>&nbsp;&nbsp;&nbsp;&nbsp; // 找到代码节，该法不总是有效，Borland编译器好像代码节为.CODE<br>&nbsp;&nbsp;&nbsp;&nbsp; if (IsStringEqual(pSectionHeader-&gt;Name, &quot;.text&quot;)) <br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ((PAGE_SIZE - (pSectionHeader-&gt;Misc.VirtualSize &amp; PAGE_SIZE)) &gt; GapSize)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return (ULONG)((PCHAR)hModule + pSectionHeader-&gt;VirtualAddress <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; + pSectionHeader-&gt;Misc.VirtualSize);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp; return NULL;<br>}<br>// 从指定模块根据导出表获取导出函数地址。<br>PVOID GetFunctionAddress(PVOID hModule, PCHAR pFunctionName)<br>{<br>&nbsp;&nbsp; PIMAGE_DOS_HEADER pDosHeader = hModule;<br>&nbsp;&nbsp; PIMAGE_NT_HEADERS pNtHeader;<br>&nbsp;&nbsp; PIMAGE_EXPORT_DIRECTORY pExportDirectory;<br>&nbsp;&nbsp; ULONG n;<br>&nbsp;&nbsp; PULONG pExportFunction;<br>&nbsp;&nbsp; PULONG pFunctionAddress;<br>&nbsp;&nbsp; PUSHORT pAddressOridinals;<br><br>&nbsp;&nbsp; if (pDosHeader-&gt;e_magic != ‘ZM’)<br>&nbsp;&nbsp;&nbsp;&nbsp; return NULL;<br>&nbsp;&nbsp; pNtHeader = (PIMAGE_NT_HEADERS)((PCHAR)hModule + pDosHeader-&gt;e_lfanew);<br>&nbsp;&nbsp; if (pNtHeader-&gt;Signature != ‘EP’)<br>&nbsp;&nbsp;&nbsp;&nbsp; return NULL;<br>&nbsp;&nbsp; pExportDirectory = (PCHAR)hModule + <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pNtHeader-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress;<br>&nbsp;&nbsp; pExportFunction = (PCHAR)hModule + pExportDirectory-&gt;AddressOfNames;<br>&nbsp;&nbsp; pFunctionAddress = (PCHAR)hModule + pExportDirectory-&gt;AddressOfFunctions;<br>&nbsp;&nbsp; pAddressOridinals = (PCHAR)hModule + pExportDirectory-&gt;AddressOfNameOrdinals;<br><br>&nbsp;&nbsp; for (n = 0; n &lt; pExportDirectory-&gt;NumberOfNames; n++)<br>&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp; if (IsStringEqual(((PCHAR)hModule + <em>(pExportFunction + n)), pFunctionName) == TRUE)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return&nbsp;&nbsp; (PVOID)((PCHAR)hModule + </em>(pFunctionAddress + <em>(pAddressOridinals + n)));<br>&nbsp;&nbsp; }<br>}<br>这个函数是最晦涩的了。这段代码将被Copy到Kernel32的一个&ldquo;空洞&rdquo;中执行，既要处理重定位， 又要在那里，手工获取LoadLibrary和GetProcAddress的地址，而且VC中inline asm也没有masm32那么直接，更可恨的是 naked 函数中申明局部变量，好像会破坏了堆栈平衡，本来，想申明一两个register变量，加强程序的可读性，但是，又不能保证编译器，总是成功分配 register变量，然后，又想，在一个<strong>forceinline函数中，写所有的代码，在这个</strong>forceinline函数，使用局部变量，加强 可读性，而这个naked函数只要调用<strong>forceinline函数就好了，但是，似乎也没办法让编译器总是inline成功。就只有全部自己写了 :(<br>这个函数从PEB中取kernel32的基地址，再根据导出表获取LoadLibrary和GetProcAddress的地址，然后加载User32.dll，关获取MessageBoxW的地址，再调用它。最后，再Free User32.dll。<br></strong>declspec(naked) NewCreateProcessW()<br>{<br>&nbsp;&nbsp; __asm<br>&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp; PUSHAD<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV EAX, DWORD PTR FS:[0x30]<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV EAX, DWORD PTR [EAX+0xC]<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV ESI,&nbsp;&nbsp; DWORD PTR [EAX+0x1C]<br>&nbsp;&nbsp;&nbsp;&nbsp; LODSD<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV EBX,&nbsp;&nbsp; DWORD PTR [EAX+0x8]&nbsp;&nbsp; // EBX: KERNEL32.DLL的基址<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV EAX,&nbsp;&nbsp; EBX <br>&nbsp;&nbsp;&nbsp;&nbsp; ADD EAX,&nbsp;&nbsp; 0x3C<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV EAX,&nbsp;&nbsp; [EAX]<br>&nbsp;&nbsp;&nbsp;&nbsp; ADD EAX,&nbsp;&nbsp; EBX &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; // EAX 定位到 IMAGE_DIRECTORY_ENTRY_EXPORT<br>&nbsp;&nbsp;&nbsp;&nbsp; ADD EAX, ((TYPE IMAGE_NT_HEADERS) - ((TYPE IMAGE_DATA_DIRECTORY)</em>16))<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV EAX, [EAX]<br>&nbsp;&nbsp;&nbsp;&nbsp; ADD EAX, EBX&nbsp;&nbsp;&nbsp;&nbsp; // EAX -&gt; 导出表&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV ESI, [EAX + 0x20]<br>&nbsp;&nbsp;&nbsp;&nbsp; ADD ESI, EBX&nbsp;&nbsp;&nbsp;&nbsp; // ESI -&gt; 导出函数名字的 RVA 数组<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; PUSH ESI<br>&nbsp;&nbsp;&nbsp;&nbsp; // int 3<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV ECX, 0xB<br>&nbsp;&nbsp;&nbsp;&nbsp; CALL a0<br>a0:<br>&nbsp;&nbsp;&nbsp;&nbsp; POP EBP<br>&nbsp;&nbsp;&nbsp;&nbsp; LEA EDI, a0<br>&nbsp;&nbsp;&nbsp;&nbsp; SUB EBP, EDI<br>&nbsp;&nbsp;&nbsp;&nbsp; LEA EDI, pFreeLibrary<br>&nbsp;&nbsp;&nbsp;&nbsp; ADD EDI, EBP<br>&nbsp;&nbsp;&nbsp;&nbsp; CALL GetProcAddr&nbsp;&nbsp; // GetProcAddr 在 EDX 中返回 FreeLibrary 的地址<br>&nbsp;&nbsp;&nbsp;&nbsp; POP ESI<br>&nbsp;&nbsp;&nbsp;&nbsp; PUSH EDX&nbsp;&nbsp;  // EDX = FreeLibrary 的地址, 保存起来<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; PUSH ESI<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV ECX, 0xE <br>&nbsp;&nbsp;&nbsp;&nbsp; CALL a1<br>a1:<br>&nbsp;&nbsp;&nbsp;&nbsp; POP EBP<br>&nbsp;&nbsp;&nbsp;&nbsp; LEA EDI, a1<br>&nbsp;&nbsp;&nbsp;&nbsp; SUB EBP, EDI<br>&nbsp;&nbsp;&nbsp;&nbsp; LEA&nbsp;&nbsp; EDI, pGetProcAddress<br>&nbsp;&nbsp;&nbsp;&nbsp; ADD&nbsp;&nbsp; EDI, EBP&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; CALL GetProcAddr&nbsp;&nbsp; // GetProcAddr 在 EDX 中返回 GetProcAddress 的地址<br>&nbsp;&nbsp;&nbsp;&nbsp; POP ESI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <br>&nbsp;&nbsp;&nbsp;&nbsp; PUSH EDX&nbsp;&nbsp; // 保存 EDX = GetProcAddress 的地址, 保存起来<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV ECX, 0xC<br>&nbsp;&nbsp;&nbsp;&nbsp; CALL a2<br>a2:<br>&nbsp;&nbsp;&nbsp;&nbsp; POP&nbsp;&nbsp; EBP<br>&nbsp;&nbsp;&nbsp;&nbsp; LEA&nbsp;&nbsp; EDI, a2<br>&nbsp;&nbsp;&nbsp;&nbsp; SUB&nbsp;&nbsp; EBP, EDI<br>&nbsp;&nbsp;&nbsp;&nbsp; LEA&nbsp;&nbsp; EDI, pLoadLibraryA<br>&nbsp;&nbsp;&nbsp;&nbsp; ADD&nbsp;&nbsp; EDI, EBP&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; CALL GetProcAddr&nbsp;&nbsp; // GetProcAddr 在 EDX 中返回 LoadLibraryA 的地址<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; CALL a3<br>a3:<br>&nbsp;&nbsp;&nbsp;&nbsp; POP EBP<br>&nbsp;&nbsp;&nbsp;&nbsp; LEA EDI, a3<br>&nbsp;&nbsp;&nbsp;&nbsp; SUB EBP, EDI<br>&nbsp;&nbsp;&nbsp;&nbsp; LEA EDI, pUser32dll<br>&nbsp;&nbsp;&nbsp;&nbsp; ADD EBP, EDI<br>&nbsp;&nbsp;&nbsp;&nbsp; PUSH EBP<br>&nbsp;&nbsp;&nbsp;&nbsp; CALL EDX&nbsp;&nbsp; // 调用 LoadLibraryA<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; POP EDX&nbsp;&nbsp;  // EDX = GetProcAddress 的地址<br>&nbsp;&nbsp;&nbsp;&nbsp; CALL a4<br>a4: <br>&nbsp;&nbsp;&nbsp;&nbsp; POP EBP<br>&nbsp;&nbsp;&nbsp;&nbsp; LEA EDI, a4<br>&nbsp;&nbsp;&nbsp;&nbsp; SUB EBP, EDI<br>&nbsp;&nbsp;&nbsp;&nbsp; LEA EDI, pMessageBoxW<br>&nbsp;&nbsp;&nbsp;&nbsp; ADD EBP, EDI<br>&nbsp;&nbsp;&nbsp;&nbsp; PUSH EAX<br>&nbsp;&nbsp;&nbsp;&nbsp; PUSH EBP<br>&nbsp;&nbsp;&nbsp;&nbsp; PUSH EAX&nbsp;&nbsp; // EAX = user32.dll的模块句柄<br>&nbsp;&nbsp;&nbsp;&nbsp; CALL EDX&nbsp;&nbsp; // 调用 GetProcAddress<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; PUSH 0<br>&nbsp;&nbsp;&nbsp;&nbsp; PUSH [esp + 0x38]<br>&nbsp;&nbsp;&nbsp;&nbsp; PUSH [esp + 0x3C]<br>&nbsp;&nbsp;&nbsp;&nbsp; PUSH 0<br>&nbsp;&nbsp;&nbsp;&nbsp; CALL EAX&nbsp;&nbsp; // 调用MessageBoxW<br>&nbsp;&nbsp;&nbsp;&nbsp; POP EAX<br>&nbsp;&nbsp;&nbsp;&nbsp; POP EDX&nbsp;&nbsp; // FreeLibrary 的地址<br>&nbsp;&nbsp;&nbsp;&nbsp; PUSH EAX<br>&nbsp;&nbsp;&nbsp;&nbsp; CALL EDX<br>&nbsp;&nbsp;&nbsp;&nbsp; JMP over<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>GetProcAddr:&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV EDX, [EAX+0x18] //以名字导出的函数个数<br>&nbsp;&nbsp;&nbsp;&nbsp; FindNext:<br>&nbsp;&nbsp;&nbsp;&nbsp; PUSH EDI<br>&nbsp;&nbsp;&nbsp;&nbsp; PUSH ECX<br>&nbsp;&nbsp;&nbsp;&nbsp; PUSH EDX<br>&nbsp;&nbsp;&nbsp;&nbsp; PUSH ESI<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV ESI, [ESI]<br>&nbsp;&nbsp;&nbsp;&nbsp; ADD ESI, EBX<br>&nbsp;&nbsp;&nbsp;&nbsp; CLD<br>&nbsp;&nbsp;&nbsp;&nbsp; REPE CMPSB<br>&nbsp;&nbsp;&nbsp;&nbsp; POP ESI<br>&nbsp;&nbsp;&nbsp;&nbsp; POP EDX<br>&nbsp;&nbsp;&nbsp;&nbsp; POP ECX<br>&nbsp;&nbsp;&nbsp;&nbsp; POP EDI<br>&nbsp;&nbsp;&nbsp;&nbsp; JZ Found<br>&nbsp;&nbsp;&nbsp;&nbsp; ADD ESI, 4<br>&nbsp;&nbsp;&nbsp;&nbsp; DEC EDX<br>&nbsp;&nbsp;&nbsp;&nbsp; JNZ FindNext<br><br>Found:&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV ECX, [EAX+0x18]<br>&nbsp;&nbsp;&nbsp;&nbsp; SUB ECX, EDX<br>&nbsp;&nbsp;&nbsp;&nbsp; SAL ECX, 1<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV EDX, [EAX+0x24] // 导出函数序号表 的 RVA<br>&nbsp;&nbsp;&nbsp;&nbsp; ADD EDX, EBX<br>&nbsp;&nbsp;&nbsp;&nbsp; ADD EDX, ECX<br>&nbsp;&nbsp;&nbsp;&nbsp; XOR ECX, ECX<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV CX, WORD PTR [EDX]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // ECX &lt;= 编号<br>&nbsp;&nbsp;&nbsp;&nbsp; SAL ECX, 1<br>&nbsp;&nbsp;&nbsp;&nbsp; SAL ECX, 1<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV EDX, [EAX+0x1C]<br>&nbsp;&nbsp;&nbsp;&nbsp; ADD EDX, EBX<br>&nbsp;&nbsp;&nbsp;&nbsp; ADD EDX, ECX<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV EDX, [EDX]<br>&nbsp;&nbsp;&nbsp;&nbsp; ADD EDX, EBX<br>&nbsp;&nbsp;&nbsp;&nbsp; RET&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>pLoadLibraryA:<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘L’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘o’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘a’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘d’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘L’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘i’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘b’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘r’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘a’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘r’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘y’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘A’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit 0<br>pGetProcAddress:<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘G’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘e’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘t’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘P’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘r’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘o’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘c’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘A’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘d’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘d’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘r’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘e’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘s’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘s’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit 0<br>pMessageBoxW:<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘M’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘e’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘s’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘s’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘a’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘g’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘e’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘B’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘o’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘x’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘W’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit 0<br>pUser32dll:<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘U’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘s’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘e’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘r’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘3’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘2’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘.’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘d’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘l’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘l’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit 0<br>pFreeLibrary:<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘F’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘r’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘e’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘e’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘L’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘i’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘b’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘r’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘a’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘r’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit ‘y’<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit 0<br>over:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; POPAD<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit 0x90<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit 0x90<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit 0x90<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit 0x90<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit 0x90<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit 0x90<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit 0x90<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit 0x90<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit 0x90<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit 0x90<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit 0x90<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit 0x90<br>&nbsp;&nbsp;&nbsp;&nbsp; _emit 0x90<br>&nbsp;&nbsp; }<br>}<br>要把代码Copy到指别的地方，就要知道要Copy的字节数，本来，在masm32中很简单的一件事，定义两个标号就OK了，在这VC里确变得麻烦起来。<br>ULONG GetMyFunctionLen(PULONG pfn)<br>{<br>&nbsp;&nbsp; ULONG res = 0;<br>&nbsp;&nbsp; <strong>asm<br>&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV EAX, 0x90909090&nbsp;&nbsp;&nbsp;&nbsp;  // 新的函数以0x90909090作为结束的标志<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV ECX, 0xFFFFFFFF<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV EDI, pfn<br>&nbsp;&nbsp;&nbsp;&nbsp; CLD<br>&nbsp;&nbsp;&nbsp;&nbsp; REPNZ SCASD<br>&nbsp;&nbsp;&nbsp;&nbsp; NOT ECX<br>&nbsp;&nbsp;&nbsp;&nbsp; DEC ECX<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV res, ECX<br>&nbsp;&nbsp; }<br>&nbsp;&nbsp; return res * 4;<br>}<br>自己写了一段代码比较两个字符串。<br>BOOLEAN IsStringEqual(PCHAR psrc, PCHAR pdest)<br>{<br>&nbsp;&nbsp; BOOLEAN res = FALSE;<br>&nbsp;&nbsp; </strong>asm<br>&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp; XOR EAX, EAX<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV ECX, EAX<br>&nbsp;&nbsp;&nbsp;&nbsp; DEC ECX<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV EDI, psrc<br>&nbsp;&nbsp;&nbsp;&nbsp; CLD<br>&nbsp;&nbsp;&nbsp;&nbsp; REPNZ SCASB<br>&nbsp;&nbsp;&nbsp;&nbsp; NOT ECX<br>&nbsp;&nbsp;&nbsp;&nbsp; DEC ECX<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV EDX, ECX<br><br>&nbsp;&nbsp;&nbsp;&nbsp; MOV ECX, EAX<br>&nbsp;&nbsp;&nbsp;&nbsp; DEC ECX<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV EDI, pdest<br>&nbsp;&nbsp;&nbsp;&nbsp; REPNZ SCASB<br>&nbsp;&nbsp;&nbsp;&nbsp; NOT ECX<br>&nbsp;&nbsp;&nbsp;&nbsp; DEC ECX<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; CMP ECX, EDX<br>&nbsp;&nbsp;&nbsp;&nbsp; JNE over<br><br>&nbsp;&nbsp;&nbsp;&nbsp; MOV ESI, psrc<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV EDI, pdest&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; REPE CMPSB<br>&nbsp;&nbsp;&nbsp;&nbsp; JNZ over<br>&nbsp;&nbsp;&nbsp;&nbsp; MOV res, TRUE<br>over:<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp; return res;<br>}<br><br>水平有限，纰漏之处难免，希望诸位大虾斧正。<br>以上几个头文件都是一些结构和宏的定义，就没有帖出来了。<br>若有不正确的地方，欢迎交流，QQ: 22517257<br><br>参考资料：<br>Windows 环境下32位汇编语言程序设计 罗云彬 著<br>Rootkits: Subverting the Windows Kernel By Greg Hoglund, James Butler <br>Undocumented Windows NT<br>Undocumented Windows 2000 Secrets </p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2007/05/15/绕过Copy-On-Write机制安装全局Hook/" class="archive-article-date">
  	<time datetime="2007-05-15T14:49:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2007-05-15</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Windows/">Windows</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>

  
<nav id="article-nav">
  
    <a href="/2007/05/16/The-Linux-Kernel-Module-Programming-Guide/" id="article-nav-newer" class="article-nav-link-wrap">
      <i class="icon-circle-left"></i>
      <div class="article-nav-title">
        
          The Linux Kernel Module Programming Guide
        
      </div>
    </a>
  
  
    <a href="/2007/05/15/hotkey-collections/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">hotkey collections</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>




<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">Share to: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
	    <a class="jiathis_button_twitter"></a>
	    <a class="jiathis_button_plus"></a> 
	    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="//v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>









      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 jfo
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true
	}
</script>

<script src="/./main.js"></script>


    
<div class="tools-col">
  <ul class="btn-wrap">
    
      <li class="chose" data-hook="tools-section-all"><span class="text">全部</span><i class="icon-book"></i></li>
    
    
      <li data-hook="tools-section-tag"><span class="text">标签</span><i class="icon-price-tags"></i></li>
    
    
      <li data-hook="tools-section-friends"><span class="text">友链</span><i class="icon-link"></i></li>
    
    
      <li data-hook="tools-section-me"><span class="text">我</span><i class="icon-smile"></i></li>
    
  </ul>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all chose">
    	</section>
    

    
    	<section class="tools-section tools-section-tag">
    			<div class="widget tagcloud" id="js-tagcloud">
    				<ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">87</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Arduino-OpenWrt/">Arduino/OpenWrt</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/DefaultCategory/">DefaultCategory</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Distributed-Computing/">Distributed Computing</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/English/">English</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Google/">Google</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">25</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Life/">Life</a><span class="category-list-count">67</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">52</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux-App/">Linux App</a><span class="category-list-count">61</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux-Debug/">Linux Debug</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux-Virtualization/">Linux Virtualization</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mac-OS-X/">Mac OS X</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mobile/">Mobile</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Network/">Network</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Saying/">Saying</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/WebDev/">WebDev</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Windows/">Windows</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/c-c-template-gp-boost/">c++/c++ template/gp/boost</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/c-c-algorithm/">c/c++/algorithm</a><span class="category-list-count">36</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/cocos2d-x-模拟器/">cocos2d-x/模拟器</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/com组件/">com组件</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/framework/">framework</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/gcc-binutils-make-共享库/">gcc/binutils/make/共享库</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/js-html-python/">js/html/python</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/l4ka-pistachio-iguana/">l4ka::pistachio/iguana</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux-图形/">linux 图形</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python-js-php-html-mysql-http/">python/js/php/html/mysql/http</a><span class="category-list-count">46</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/reading/">reading</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/self-collect/">self_collect</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/unifiedkernel-wine-reactos/">unifiedkernel/wine/reactos</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/wordpress/">wordpress</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/产品/">产品</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/教育/">教育</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数学-物理/">数学/物理</a><span class="category-list-count">3</span></li></ul>
    			</div>
    	</section>
    

    
    	<section class="tools-section tools-section-friends">
  		
  			<div class="friends-wrap" id="js-friends">
  			
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://iguangba.pickbox.me/">爱逛吧</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.pickbox.me/">收藏夹</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://note.pickbox.me/">网络剪贴板</a>
  	        
  	        </div>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">jfojfo#gmail.com</div>
  	  	
    	</section>
    
  </div>
  
</div>

    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>