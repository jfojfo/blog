<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>组件程序 | jfo planet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="DictComp.cpp                                                                            //// DictComp.cpp : Defines the entry point for the DLL application.//#include &amp;quot;stdafx.h&amp;quot;#include &amp;lt">
<meta property="og:type" content="article">
<meta property="og:title" content="组件程序">
<meta property="og:url" content="http://blog.pickbox.me/2007/07/14/组件程序/index.html">
<meta property="og:site_name" content="jfo planet">
<meta property="og:description" content="DictComp.cpp                                                                            //// DictComp.cpp : Defines the entry point for the DLL application.//#include &amp;quot;stdafx.h&amp;quot;#include &amp;lt">
<meta property="og:updated_time" content="2016-10-15T04:38:07.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="组件程序">
<meta name="twitter:description" content="DictComp.cpp                                                                            //// DictComp.cpp : Defines the entry point for the DLL application.//#include &amp;quot;stdafx.h&amp;quot;#include &amp;lt">
  
    <link rel="alternative" href="/atom.xml" title="jfo planet" type="application/atom+xml">
  
  
    <link rel="icon" href="//favicon.ico">
  
  <script src="/style.js"></script>
  

</head>

<body>
  <div id="container">
    <div class="left-col">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="http://img.pickbox.me/wp-content/uploads/penguin.gif" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">jfo</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Hope is the best gift that tomorrow gives.</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a class="js-smart-menu" data-idx="0" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="1" href="javascript:void(0)">分类</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="2" href="javascript:void(0)">友链</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="3" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/jfojfo" title="github">github</a>
		        
					<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/jfojfo" title="zhihu">zhihu</a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-list"></i></div>
  		<h1 class="header-author js-mobile-header hide">jfo</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="http://img.pickbox.me/wp-content/uploads/penguin.gif" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">jfo</h1>
			</hgroup>
			
			<p class="header-subtitle">Hope is the best gift that tomorrow gives.</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/jfojfo" title="github">github</a>
			        
						<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/jfojfo" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
        <article id="post-组件程序" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      组件程序
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p> DictComp.cpp                                                                            //<br>// DictComp.cpp : Defines the entry point for the DLL application.<br>//<br><br>#include &quot;stdafx.h&quot;<br>#include &lt;comutil.h&gt;<br>#include &lt;stdio.h&gt;<br>#include &quot;objbase.h&quot;<br>#include &quot;olectl.h&quot;<br><br>#include &quot;DictComp.h&quot;<br>#include &quot;factory.h&quot;<br>#include &quot;registry.h&quot;<br><br>ULONG    g_LockNumber = 0;<br>ULONG    g_DictionaryNumber = 0;<br>HANDLE  g_hModule;<br><br>// {54BF6567-1007-11D1-B0AA-444553540000}<br>extern &quot;C&quot; const GUID CLSID_Dictionary = <br>  { 0x54bf6567, 0x1007, 0x11d1,<br>  { 0xb0, 0xaa, 0x44, 0x45, 0x53, 0x54, 0x00, 0x00} } ;<br><br>extern &quot;C&quot; const GUID IID_Dictionary = <br>  { 0x54bf6568, 0x1007, 0x11d1,<br>  { 0xb0, 0xaa, 0x44, 0x45, 0x53, 0x54, 0x00, 0x00} } ;<br><br>extern &quot;C&quot; const GUID IID_SpellCheck = <br>  { 0x54bf6569, 0x1007, 0x11d1,<br>  { 0xb0, 0xaa, 0x44, 0x45, 0x53, 0x54, 0x00, 0x00} } ;<br><br><br><br>BOOL APIENTRY DllMain( HANDLE hModule, <br>                       DWORD  ul_reason_for_call, <br>                       LPVOID lpReserved<br>      )<br>{<br>    g_hModule = hModule;<br> return TRUE;<br>}<br><br><br>extern &quot;C&quot; HRESULT <strong>stdcall DllGetClassObject(const CLSID&amp; clsid, const IID&amp; iid, void <em>*ppv)<br>{<br> if (clsid == CLSID_Dictionary ) {<br> <br>  CDictionaryFactory </em>pFactory = new CDictionaryFactory;<br> <br>  if (pFactory == NULL) {<br>   return E_OUTOFMEMORY ;<br>  }<br> <br>  HRESULT result = pFactory-&gt;QueryInterface(iid, ppv);<br><br>  return result;<br> } else {<br>  return CLASS_E_CLASSNOTAVAILABLE;<br> }<br>}<br><br>extern &quot;C&quot; HRESULT </strong>stdcall DllCanUnloadNow(void)<br>{<br> if ((g_DictionaryNumber == 0) &amp;&amp; (g_LockNumber == 0))<br>  return S_OK;<br> else<br>  return S_FALSE;<br>}<br><br>//<br>// Server registration<br>//<br>extern &quot;C&quot; HRESULT <strong>stdcall DllRegisterServer()<br>{<br> char szModule[1024];<br> DWORD dwResult = ::GetModuleFileName((HMODULE)g_hModule, szModule, 1024);<br> if (dwResult == 0)<br>  return SELFREG_E_CLASS;<br> return RegisterServer(CLSID_Dictionary,<br>                       szModule, <br>        &quot;Dictionary.Object&quot;,<br>        &quot;Dictionary Component&quot;,<br>        NULL);<br>}<br><br><br>//<br>// Server unregistration<br>//<br>extern &quot;C&quot; HRESULT </strong>stdcall DllUnregisterServer()<br>{<br> return UnregisterServer(CLSID_Dictionary,<br>                         &quot;Dictionary.Object&quot;,NULL);<br>}<br><br>// class CDictionary implementation<br><br>CDictionary::CDictionary()<br>{<br> m_Ref = 0;<br> m_nWordNumber = 0;<br> m_nStructNumber = 0;<br> m_pData = NULL;<br> g_DictionaryNumber ++ ;<br>}<br><br>CDictionary::~CDictionary()<br>{<br> if (m_pData != NULL) <br> {<br>  delete [] m_pData;<br> }<br>}<br><br>HRESULT  CDictionary::QueryInterface(const IID&amp; iid, void <strong>ppv)<br>{<br> if ( iid == IID_IUnknown )<br> {<br>  <em>ppv = (IDictionary </em>) this ;<br>    ((IDictionary <em>)(</em>ppv))-&gt;AddRef() ;<br> } else if ( iid == IID_Dictionary ) <br> {<br>  <em>ppv = (IDictionary </em>) this ;<br>    ((IDictionary <em>)(</em>ppv))-&gt;AddRef() ;<br> } else if ( iid == IID_SpellCheck ) <br> {<br>  <em>ppv = (ISpellCheck </em>) this ;<br>    ((ISpellCheck <em>)(</em>ppv))-&gt;AddRef() ;<br> }<br> else<br> {<br>  <em>ppv = NULL;<br>  return E_NOINTERFACE ;<br> }<br> return S_OK;<br>}<br><br>ULONG   CDictionary::AddRef()<br>{<br> m_Ref ++;<br> return  (ULONG) m_Ref;<br>}<br><br>ULONG   CDictionary::Release()<br>{<br> m_Ref –;<br> if (m_Ref == 0 ) {<br>  g_DictionaryNumber – ;<br>  delete this;<br>  return 0;<br> }<br> return  (ULONG) m_Ref;<br>}<br><br>BOOL CDictionary::Initialize()<br>{<br> m_nWordNumber = 0;<br> m_nStructNumber = 0;<br> if (m_pData != NULL) <br> {<br>  delete [] m_pData;<br> }<br> m_pData = NULL;<br> return TRUE;<br>}<br><br>BOOL CDictionary::LoadLibrary(String filename)<br>{<br> char </em>pFileName = _com_util::ConvertBSTRToString(filename);<br> FILE <em>fp;<br> if( (fp = fopen( pFileName, &quot;rt&quot; )) == NULL ) {<br>  printf(&quot;Open dictionary file : %s failed.n&quot;, pFileName);<br>  delete pFileName;<br>  return FALSE;<br> }<br> char LineBuffer[128];<br> if (feof(fp)) {<br>  printf(&quot;It is a null file!n&quot;);<br>  fclose(fp);<br>  delete pFileName;<br>  return FALSE; <br> }<br> if (fgets(LineBuffer, 128, fp) == NULL) {<br>  printf(&quot;Read TotalNumber failed!n&quot;);<br>  fclose(fp);<br>  delete pFileName;<br>  return FALSE; <br> }<br> <br> int nTotalNumber = 0;<br> sscanf(LineBuffer, &quot;%d&quot;, &amp;nTotalNumber);<br> if ( (nTotalNumber &lt; 1) &amp;&amp; (nTotalNumber &gt; 5000) ) {<br>  printf(&quot;The Number of words is invalid!n&quot;);<br>  fclose(fp);<br>  delete pFileName;<br>  return FALSE; <br> }<br><br> Initialize();<br> m_nStructNumber = nTotalNumber+100;<br> m_pData = new DictWord[m_nStructNumber];<br> m_nWordNumber = 0;<br> <br> while(!feof(fp)) {<br>  if (fgets(LineBuffer, MaxWordLength, fp) == NULL) {<br>   printf(&quot;Read the first string failed!n&quot;);<br>   break;<br>  }<br>  sscanf(LineBuffer, &quot;%s&quot;, m_pData[m_nWordNumber].wordForLang1);<br>  if (fgets(LineBuffer, MaxWordLength, fp) == NULL) {<br>   printf(&quot;Read the second string failed!n&quot;);<br>   break;<br>  }<br>  sscanf(LineBuffer, &quot;%s&quot;, m_pData[m_nWordNumber].wordForLang2);<br>  m_nWordNumber ++;<br>  if (m_nWordNumber == nTotalNumber)<br>   break;<br>  if (m_nWordNumber &gt; m_nStructNumber)<br>   break;<br> } <br> <br> fclose(fp);<br> delete pFileName;<br> return TRUE;<br>}<br><br>BOOL CDictionary::InsertWord(String word1, String word2)<br>{<br> char </em>pWord1, <em>pWord2;<br> if (m_nWordNumber &lt; m_nStructNumber) {<br>  pWord1 = _com_util::ConvertBSTRToString(word1);<br>  pWord2 = _com_util::ConvertBSTRToString(word2);<br><br>  if (strlen(pWord1) &gt; MaxWordLength)<br>   </em>(pWord1+MaxWordLength-1) = ‘ ’;<br>  if (strlen(pWord2) &gt; MaxWordLength)<br>   <em>(pWord2+MaxWordLength-1) = ‘ ’;<br>  strcpy(m_pData[m_nWordNumber].wordForLang1, pWord1);<br>  strcpy(m_pData[m_nWordNumber].wordForLang2, pWord2);<br>  m_nWordNumber ++ ;<br>  delete pWord1;<br>  delete pWord2;<br>  return TRUE;<br> }<br> return FALSE;<br>}<br><br>void CDictionary::DeleteWord(String word)<br>{<br> char </em>pWord = _com_util::ConvertBSTRToString(word);<br> char <em>pUpperWord = strupr(pWord);<br> for (int i = 0; i &lt; m_nWordNumber; i++)<br> {<br>  char </em>tmpWord = strupr(m_pData[i].wordForLang1);<br>  if (strcmp(tmpWord, pWord) == 0) {<br>   for(int j = i + 1; j &lt; m_nWordNumber; j++) {<br>    strcpy( m_pData[j].wordForLang1, m_pData[j + 1].wordForLang1);<br>    strcpy( m_pData[j].wordForLang2, m_pData[j + 1].wordForLang2);<br>   }<br>   m_nWordNumber ++ ;<br>   break;<br>  }<br> }<br> delete pWord;<br>}<br><br>BOOL CDictionary::LookupWord(String word, String <em>resultWord)<br>{<br> char </em>pWord = _com_util::ConvertBSTRToString(word);<br> char <em>pUpperWord = strupr(pWord);<br> for (int i = 0; i &lt; m_nWordNumber; i++)<br> {<br>  char </em>tmpWord = strupr(m_pData[i].wordForLang1);<br>  if (strcmp(tmpWord, pWord) == 0) {<br>   <em>resultWord = _com_util::ConvertStringToBSTR(m_pData[i].wordForLang2);<br>   delete pWord;<br>   return TRUE;<br>  }<br> }<br> </em>resultWord = NULL;<br> delete pWord;<br> return FALSE;<br>}<br><br>BOOL CDictionary::RestoreLibrary(String filename)<br>{<br> char <em>pFileName = _com_util::ConvertBSTRToString(filename);<br> FILE </em>fp;<br> if( (fp = fopen( pFileName, &quot;wt&quot; )) == NULL ) {<br>  printf(&quot;Open dictionary file : %s failed.n&quot;, pFileName);<br>  delete pFileName;<br>  return FALSE;<br> }<br> char LineBuffer[128];<br> sprintf(LineBuffer, &quot;%dn&quot;, m_nWordNumber);<br> if (fputs(LineBuffer, fp) == EOF) {<br>  printf(&quot;Write TotalNumber failed!n&quot;);<br>  fclose(fp);<br>  delete pFileName;<br>  return FALSE; <br> }<br> <br> for(int i = 0; i &lt; m_nWordNumber; i ++ ) {<br>  if (fputs(m_pData[i].wordForLang1, fp) == EOF) {<br>   printf(&quot;Write the first string failed!n&quot;);<br>   fclose(fp);<br>   delete pFileName;<br>   return FALSE; <br>  }<br>  fputs(&quot;n&quot;, fp);<br>  if (fputs(m_pData[i].wordForLang2, fp) == EOF) {<br>   printf(&quot;Write the first string failed!n&quot;);<br>   fclose(fp);<br>   delete pFileName;<br>   return FALSE; <br>  }<br>  fputs(&quot;n&quot;, fp);<br> }<br> <br> fclose(fp);<br> delete pFileName;<br> return TRUE;<br>}<br><br>void CDictionary::FreeLibrary()<br>{<br> Initialize();<br>}<br><br> <br>BOOL CDictionary::CheckWord (String word, String <em>resultWord)<br>{<br> char </em>pWord = _com_util::ConvertBSTRToString(word);<br> char <em>pUpperWord = strupr(pWord);<br> char </em>pMinMaxWord, <em>pMaxMinWord;<br> int  nMinIndex = -1, nMaxIndex = -1;<br> pMinMaxWord = pMaxMinWord = NULL;<br> for (int i = 0; i &lt; m_nWordNumber; i++)<br> {<br>  char </em>tmpWord = strupr(m_pData[i].wordForLang1);<br>  if (strcmp(tmpWord, pWord) == 0) {<br>   delete pWord;<br>   return TRUE;<br>  } else if (strcmp(tmpWord, pWord) &lt; 0) {<br>   if ((pMinMaxWord == NULL) || (strcmp(tmpWord, pMinMaxWord) &gt; 0)) <br>   {<br>    pMinMaxWord = tmpWord;<br>    nMinIndex = i;<br>   }<br>  } else {<br>   if ((pMaxMinWord == NULL) || (strcmp(tmpWord, pMaxMinWord) &lt; 0)) <br>   {<br>    pMaxMinWord = tmpWord;<br>    nMaxIndex = i;<br>   }<br>  }<br> }<br> <br> <em>resultWord = NULL;<br> if (nMinIndex != -1)<br>  </em>resultWord = _com_util::ConvertStringToBSTR(m_pData[nMinIndex].wordForLang1);<br> else if (nMaxIndex != -1)<br>  <em>resultWord = _com_util::ConvertStringToBSTR(m_pData[nMaxIndex].wordForLang1);<br> delete pWord;<br> return FALSE;<br>}<br> <br><br>组件程序自注册 Registry：<br>Registry.cpp<br>(regsvr32 DictComp.dll)<br>(regsvr32 /u DictComp.dll)                                                                           //<br>// Registry.cpp<br>//<br><br>#include &lt;objbase.h&gt;<br>#include &lt;assert.h&gt;<br><br>#include &quot;Registry.h&quot;<br><br>////////////////////////////////////////////////////////<br>//<br>// Internal helper functions prototypes<br>//<br>//   - These helper functions were borrowed and modifed from<br>//     Dale Rogerson’s book Inside COM.<br><br>// Set the given key and its value.<br>BOOL SetKeyAndValue(const char</em> pszPath,<br>                    const char<em> szSubkey,<br>                    const char</em> szValue) ;<br><br>// Convert a CLSID into a char string.<br>void CLSIDtoString(const CLSID&amp; clsid, <br>                 char<em> szCLSID,<br>                 int length) ;<br><br>// Delete szKeyChild and all of its descendents.<br>LONG DeleteKey(HKEY hKeyParent, const char</em> szKeyString) ;<br><br>////////////////////////////////////////////////////////<br>//<br>// Constants<br>//<br><br>// Size of a CLSID as a string<br>const int CLSID_STRING_SIZE = 39 ;<br><br>/////////////////////////////////////////////////////////<br>//<br>// Public function implementation<br>//<br><br>//<br>// Register the component in the registry.<br>//<br>HRESULT RegisterServer(const CLSID&amp; clsid,         // Class ID<br>                       const char <em>szFileName,     // DLL module handle<br>                       const char</em> szProgID,       //   IDs<br>                       const char<em> szDescription,  // Description String<br>        const char</em> szVerIndProgID) // optional<br><br>{<br> // Convert the CLSID into a char.<br> char szCLSID[CLSID_STRING_SIZE] ;<br> CLSIDtoString(clsid, szCLSID, sizeof(szCLSID)) ;<br><br> // Build the key CLSID{…}<br> char szKey[64] ;<br> strcpy(szKey, &quot;CLSID\&quot;) ;<br> strcat(szKey, szCLSID) ;<br> <br> // Add the CLSID to the registry.<br> SetKeyAndValue(szKey, NULL, szDescription) ;<br><br> // Add the server filename subkey under the CLSID key.<br> SetKeyAndValue(szKey, &quot;InprocServer32&quot;, szFileName) ;<br><br> // Add the ProgID subkey under the CLSID key.<br> if (szProgID != NULL) {<br>  SetKeyAndValue(szKey, &quot;ProgID&quot;, szProgID) ;<br>  SetKeyAndValue(szProgID, &quot;CLSID&quot;, szCLSID) ;<br> }<br><br> if (szVerIndProgID) {<br>  // Add the version-independent ProgID subkey under CLSID key.<br>  SetKeyAndValue(szKey, &quot;VersionIndependentProgID&quot;,<br>        szVerIndProgID) ;<br><br>  // Add the version-independent ProgID subkey under HKEY_CLASSES_ROOT.<br>  SetKeyAndValue(szVerIndProgID, NULL, szDescription) ; <br>  SetKeyAndValue(szVerIndProgID, &quot;CLSID&quot;, szCLSID) ;<br>  SetKeyAndValue(szVerIndProgID, &quot;CurVer&quot;, szProgID) ;<br><br>  // Add the versioned ProgID subkey under HKEY_CLASSES_ROOT.<br>  SetKeyAndValue(szProgID, NULL, szDescription) ; <br>  SetKeyAndValue(szProgID, &quot;CLSID&quot;, szCLSID) ;<br> }<br><br> return S_OK ;<br>}<br><br>//<br>// Remove the component from the registry.<br>//<br>HRESULT UnregisterServer(const CLSID&amp; clsid,      // Class ID<br>                      const char<em> szProgID,       //   IDs<br>                      const char</em> szVerIndProgID) // Programmatic<br>{<br> // Convert the CLSID into a char.<br> char szCLSID[CLSID_STRING_SIZE] ;<br> CLSIDtoString(clsid, szCLSID, sizeof(szCLSID)) ;<br><br> // Build the key CLSID{…}<br> char szKey[64] ;<br> strcpy(szKey, &quot;CLSID\&quot;) ;<br> strcat(szKey, szCLSID) ;<br><br> // Delete the CLSID Key - CLSID{…}<br> LONG lResult = DeleteKey(HKEY_CLASSES_ROOT, szKey) ;<br><br> // Delete the version-independent ProgID Key.<br> if (szVerIndProgID != NULL)<br>  lResult = DeleteKey(HKEY_CLASSES_ROOT, szVerIndProgID) ;<br><br> // Delete the ProgID key.<br> if (szProgID != NULL)<br>  lResult = DeleteKey(HKEY_CLASSES_ROOT, szProgID) ;<br><br> return S_OK ;<br>}<br><br>///////////////////////////////////////////////////////////<br>//<br>// Internal helper functions<br>//<br><br>// Convert a CLSID to a char string.<br>void CLSIDtoString(const CLSID&amp; clsid,<br>                 char<em> szCLSID,<br>                 int length)<br>{<br> assert(length &gt;= CLSID_STRING_SIZE) ;<br> // Get CLSID<br> LPOLESTR wszCLSID = NULL ;<br> HRESULT hr = StringFromCLSID(clsid, &amp;wszCLSID) ;<br> assert(SUCCEEDED(hr)) ;<br><br> // Covert from wide characters to non-wide.<br> wcstombs(szCLSID, wszCLSID, length) ;<br><br> // Free memory.<br> CoTaskMemFree(wszCLSID) ;<br>}<br><br>//<br>// Delete a key and all of its descendents.<br>//<br>LONG DeleteKey(HKEY hKeyParent,           // Parent of key to delete<br>               const char</em> lpszKeyChild)  // Key to delete<br>{<br> // Open the child.<br> HKEY hKeyChild ;<br> LONG lRes = RegOpenKeyEx(hKeyParent, lpszKeyChild, 0,<br>                          KEY_ALL_ACCESS, &amp;hKeyChild) ;<br> if (lRes != ERROR_SUCCESS)<br> {<br>  return lRes ;<br> }<br><br> // Enumerate all of the decendents of this child.<br> FILETIME time ;<br> char szBuffer[256] ;<br> DWORD dwSize = 256 ;<br> while (RegEnumKeyEx(hKeyChild, 0, szBuffer, &amp;dwSize, NULL,<br>                     NULL, NULL, &amp;time) == S_OK)<br> {<br>  // Delete the decendents of this child.<br>  lRes = DeleteKey(hKeyChild, szBuffer) ;<br>  if (lRes != ERROR_SUCCESS)<br>  {<br>   // Cleanup before exiting.<br>   RegCloseKey(hKeyChild) ;<br>   return lRes;<br>  }<br>  dwSize = 256 ;<br> }<br><br> // Close the child.<br> RegCloseKey(hKeyChild) ;<br><br> // Delete this child.<br> return RegDeleteKey(hKeyParent, lpszKeyChild) ;<br>}<br><br>//<br>// Create a key and set its value.<br>//<br>BOOL SetKeyAndValue(const char<em> szKey,<br>                    const char</em> szSubkey,<br>                    const char<em> szValue)<br>{<br> HKEY hKey;<br> char szKeyBuf[1024] ;<br><br> // Copy keyname into buffer.<br> strcpy(szKeyBuf, szKey) ;<br><br> // Add subkey name to buffer.<br> if (szSubkey != NULL)<br> {<br>  strcat(szKeyBuf, &quot;\&quot;) ;<br>  strcat(szKeyBuf, szSubkey ) ;<br> }<br><br> // Create and open key and subkey.<br> long lResult = RegCreateKeyEx(HKEY_CLASSES_ROOT ,<br>                               szKeyBuf, <br>                               0, NULL, REG_OPTION_NON_VOLATILE,<br>                               KEY_ALL_ACCESS, NULL, <br>                               &amp;hKey, NULL) ;<br> if (lResult != ERROR_SUCCESS)<br> {<br>  return FALSE ;<br> }<br><br> // Set the Value.<br> if (szValue != NULL)<br> {<br>  RegSetValueEx(hKey, NULL, 0, REG_SZ, <br>                (BYTE </em>)szValue, <br>                strlen(szValue)+1) ;<br> }<br><br> RegCloseKey(hKey) ;<br> return TRUE ;<br>}<br> <br><br>Factory.cpp                                                                           #include &quot;stdafx.h&quot;<br>#include &quot;factory.h&quot;<br>#include &quot;dictcomp.h&quot;<br><br>extern ULONG    g_LockNumber;<br>extern ULONG    g_DictionaryNumber;<br><br>CDictionaryFactory::CDictionaryFactory()<br>{<br> m_Ref = 0;<br>}<br><br>CDictionaryFactory::~CDictionaryFactory()<br>{<br>}<br><br>HRESULT  CDictionaryFactory::QueryInterface(const IID&amp; iid, void </strong>ppv)<br>{<br> if ( iid == IID_IUnknown )<br> {<br>  <em>ppv = (IUnknown </em>) this ;<br>    ((IUnknown <em>)(</em>ppv))-&gt;AddRef() ;<br> } else if ( iid == IID_IClassFactory) <br> {<br>  <em>ppv = (IClassFactory </em>) this ;<br>    ((IClassFactory <em>)(</em>ppv))-&gt;AddRef() ;<br> } <br> else<br> {<br>  <em>ppv = NULL;<br>  return E_NOINTERFACE ;<br> }<br> return S_OK;<br>}<br><br>ULONG   CDictionaryFactory::AddRef()<br>{<br> m_Ref ++;<br> return  (ULONG) m_Ref;<br>}<br><br>ULONG   CDictionaryFactory::Release()<br>{<br> m_Ref –;<br> if (m_Ref == 0 ) {<br>  delete this;<br>  return 0;<br> }<br> return  (ULONG) m_Ref;<br>}<br><br>HRESULT CDictionaryFactory::CreateInstance(IUnknown </em>pUnknownOuter, <br>             const IID&amp; iid, void <strong>ppv)<br>{<br>   CDictionary <em> pObj;   <br>   HRESULT hr;<br> <br>   </em>ppv=NULL;<br>   hr=E_OUTOFMEMORY;<br>   if (NULL != pUnknownOuter)<br>    return CLASS_E_NOAGGREGATION;<br> <br>   //Create the object passing function to notify on destruction.<br>   pObj=new CDictionary();<br>   if (NULL==pObj)<br>      return hr;   <br> <br>   //Obtain the first interface pointer (which does an AddRef)<br>   hr=pObj-&gt;QueryInterface(iid, ppv);<br><br>   if (hr != S_OK) {<br>    //Kill the object if initial creation or FInit failed.<br>      g_DictionaryNumber –; // Reference count g_cDictionary be added in constructor<br>   delete pObj;<br>   }<br> <br>   return hr;   <br>}<br><br>HRESULT CDictionaryFactory::LockServer(BOOL bLock)<br>{<br>   if (bLock)<br>      g_LockNumber ++;<br>   else<br>      g_LockNumber –;<br><br>   return NOERROR;<br>}<br> <br><strong><br></strong>Factory.h                                    #ifndef <strong>DICTIONARY_FACTORY</strong><br>#define <strong>DICTIONARY_FACTORY</strong><br><br>#include &quot;Unknwn.h&quot;<br><br>class CDictionaryFactory : public IClassFactory<br>{<br>   protected:<br>      ULONG           m_Ref;<br><br>   public:<br>      CDictionaryFactory ();<br>      ~CDictionaryFactory ();<br><br>      //IUnknown members<br>      HRESULT __stdcall QueryInterface(const IID&amp; iid, void </strong>ppv);<br>      ULONG <strong>stdcall AddRef();<br>      ULONG </strong>stdcall Release();<br><br>      //IClassFactory members<br>      HRESULT <strong>stdcall CreateInstance(IUnknown <em>, const IID&amp; iid, void *</em>ppv);<br>      HRESULT </strong>stdcall LockServer(BOOL);<br>};<br><br>#endif // <strong>DICTIONARY_FACTORY</strong><br> <br><strong><br></strong><br><br><br> </p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2007/07/14/组件程序/" class="archive-article-date">
  	<time datetime="2007-07-14T13:44:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2007-07-14</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/com组件/">com组件</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>

  
<nav id="article-nav">
  
    <a href="/2007/07/14/客户端/" id="article-nav-newer" class="article-nav-link-wrap">
      <i class="icon-circle-left"></i>
      <div class="article-nav-title">
        
          客户端
        
      </div>
    </a>
  
  
    <a href="/2007/07/08/归去来辞/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">归去来辞</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>




<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">Share to: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
	    <a class="jiathis_button_twitter"></a>
	    <a class="jiathis_button_plus"></a> 
	    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="//v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>









      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 jfo
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true
	}
</script>

<script src="/./main.js"></script>


    
<div class="tools-col">
  <ul class="btn-wrap">
    
      <li class="chose" data-hook="tools-section-all"><span class="text">全部</span><i class="icon-book"></i></li>
    
    
      <li data-hook="tools-section-tag"><span class="text">标签</span><i class="icon-price-tags"></i></li>
    
    
      <li data-hook="tools-section-friends"><span class="text">友链</span><i class="icon-link"></i></li>
    
    
      <li data-hook="tools-section-me"><span class="text">我</span><i class="icon-smile"></i></li>
    
  </ul>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all chose">
    	</section>
    

    
    	<section class="tools-section tools-section-tag">
    			<div class="widget tagcloud" id="js-tagcloud">
    				<ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">87</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Arduino-OpenWrt/">Arduino/OpenWrt</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/DefaultCategory/">DefaultCategory</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Distributed-Computing/">Distributed Computing</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/English/">English</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Google/">Google</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">25</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Life/">Life</a><span class="category-list-count">67</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">52</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux-App/">Linux App</a><span class="category-list-count">61</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux-Debug/">Linux Debug</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux-Virtualization/">Linux Virtualization</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mac-OS-X/">Mac OS X</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mobile/">Mobile</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Network/">Network</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Saying/">Saying</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/WebDev/">WebDev</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Windows/">Windows</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/c-c-template-gp-boost/">c++/c++ template/gp/boost</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/c-c-algorithm/">c/c++/algorithm</a><span class="category-list-count">36</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/cocos2d-x-模拟器/">cocos2d-x/模拟器</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/com组件/">com组件</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/framework/">framework</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/gcc-binutils-make-共享库/">gcc/binutils/make/共享库</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/js-html-python/">js/html/python</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/l4ka-pistachio-iguana/">l4ka::pistachio/iguana</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux-图形/">linux 图形</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python-js-php-html-mysql-http/">python/js/php/html/mysql/http</a><span class="category-list-count">46</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/reading/">reading</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/self-collect/">self_collect</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/unifiedkernel-wine-reactos/">unifiedkernel/wine/reactos</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/wordpress/">wordpress</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/产品/">产品</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/教育/">教育</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数学-物理/">数学/物理</a><span class="category-list-count">3</span></li></ul>
    			</div>
    	</section>
    

    
    	<section class="tools-section tools-section-friends">
  		
  			<div class="friends-wrap" id="js-friends">
  			
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://iguangba.pickbox.me/">爱逛吧</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.pickbox.me/">收藏夹</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://note.pickbox.me/">网络剪贴板</a>
  	        
  	        </div>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">jfojfo#gmail.com</div>
  	  	
    	</section>
    
  </div>
  
</div>

    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>