<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="jfo, blog" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="DictComp.cpp                                                                            //// DictComp.cpp : Defines the entry point for the DLL application.//#include &amp;quot;stdafx.h&amp;quot;#include &amp;lt">
<meta property="og:type" content="article">
<meta property="og:title" content="组件程序">
<meta property="og:url" content="http://blog.pickbox.me/2007/07/14/组件程序/index.html">
<meta property="og:site_name" content="jfo planet">
<meta property="og:description" content="DictComp.cpp                                                                            //// DictComp.cpp : Defines the entry point for the DLL application.//#include &amp;quot;stdafx.h&amp;quot;#include &amp;lt">
<meta property="og:updated_time" content="2016-10-15T05:24:27.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="组件程序">
<meta name="twitter:description" content="DictComp.cpp                                                                            //// DictComp.cpp : Defines the entry point for the DLL application.//#include &amp;quot;stdafx.h&amp;quot;#include &amp;lt">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://blog.pickbox.me/2007/07/14/组件程序/"/>


  <title> 组件程序 | jfo planet </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">jfo planet</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Hope is the best gift that tomorrow gives.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                组件程序
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2007-07-14T21:44:00+08:00" content="2007-07-14">
              2007-07-14
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/com组件/" itemprop="url" rel="index">
                    <span itemprop="name">com组件</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p> DictComp.cpp                                                                            //<br>// DictComp.cpp : Defines the entry point for the DLL application.<br>//<br><br>#include &quot;stdafx.h&quot;<br>#include &lt;comutil.h&gt;<br>#include &lt;stdio.h&gt;<br>#include &quot;objbase.h&quot;<br>#include &quot;olectl.h&quot;<br><br>#include &quot;DictComp.h&quot;<br>#include &quot;factory.h&quot;<br>#include &quot;registry.h&quot;<br><br>ULONG    g_LockNumber = 0;<br>ULONG    g_DictionaryNumber = 0;<br>HANDLE  g_hModule;<br><br>// {54BF6567-1007-11D1-B0AA-444553540000}<br>extern &quot;C&quot; const GUID CLSID_Dictionary = <br>  { 0x54bf6567, 0x1007, 0x11d1,<br>  { 0xb0, 0xaa, 0x44, 0x45, 0x53, 0x54, 0x00, 0x00} } ;<br><br>extern &quot;C&quot; const GUID IID_Dictionary = <br>  { 0x54bf6568, 0x1007, 0x11d1,<br>  { 0xb0, 0xaa, 0x44, 0x45, 0x53, 0x54, 0x00, 0x00} } ;<br><br>extern &quot;C&quot; const GUID IID_SpellCheck = <br>  { 0x54bf6569, 0x1007, 0x11d1,<br>  { 0xb0, 0xaa, 0x44, 0x45, 0x53, 0x54, 0x00, 0x00} } ;<br><br><br><br>BOOL APIENTRY DllMain( HANDLE hModule, <br>                       DWORD  ul_reason_for_call, <br>                       LPVOID lpReserved<br>      )<br>{<br>    g_hModule = hModule;<br> return TRUE;<br>}<br><br><br>extern &quot;C&quot; HRESULT <strong>stdcall DllGetClassObject(const CLSID&amp; clsid, const IID&amp; iid, void <em>*ppv)<br>{<br> if (clsid == CLSID_Dictionary ) {<br> <br>  CDictionaryFactory </em>pFactory = new CDictionaryFactory;<br> <br>  if (pFactory == NULL) {<br>   return E_OUTOFMEMORY ;<br>  }<br> <br>  HRESULT result = pFactory-&gt;QueryInterface(iid, ppv);<br><br>  return result;<br> } else {<br>  return CLASS_E_CLASSNOTAVAILABLE;<br> }<br>}<br><br>extern &quot;C&quot; HRESULT </strong>stdcall DllCanUnloadNow(void)<br>{<br> if ((g_DictionaryNumber == 0) &amp;&amp; (g_LockNumber == 0))<br>  return S_OK;<br> else<br>  return S_FALSE;<br>}<br><br>//<br>// Server registration<br>//<br>extern &quot;C&quot; HRESULT <strong>stdcall DllRegisterServer()<br>{<br> char szModule[1024];<br> DWORD dwResult = ::GetModuleFileName((HMODULE)g_hModule, szModule, 1024);<br> if (dwResult == 0)<br>  return SELFREG_E_CLASS;<br> return RegisterServer(CLSID_Dictionary,<br>                       szModule, <br>        &quot;Dictionary.Object&quot;,<br>        &quot;Dictionary Component&quot;,<br>        NULL);<br>}<br><br><br>//<br>// Server unregistration<br>//<br>extern &quot;C&quot; HRESULT </strong>stdcall DllUnregisterServer()<br>{<br> return UnregisterServer(CLSID_Dictionary,<br>                         &quot;Dictionary.Object&quot;,NULL);<br>}<br><br>// class CDictionary implementation<br><br>CDictionary::CDictionary()<br>{<br> m_Ref = 0;<br> m_nWordNumber = 0;<br> m_nStructNumber = 0;<br> m_pData = NULL;<br> g_DictionaryNumber ++ ;<br>}<br><br>CDictionary::~CDictionary()<br>{<br> if (m_pData != NULL) <br> {<br>  delete [] m_pData;<br> }<br>}<br><br>HRESULT  CDictionary::QueryInterface(const IID&amp; iid, void <strong>ppv)<br>{<br> if ( iid == IID_IUnknown )<br> {<br>  <em>ppv = (IDictionary </em>) this ;<br>    ((IDictionary <em>)(</em>ppv))-&gt;AddRef() ;<br> } else if ( iid == IID_Dictionary ) <br> {<br>  <em>ppv = (IDictionary </em>) this ;<br>    ((IDictionary <em>)(</em>ppv))-&gt;AddRef() ;<br> } else if ( iid == IID_SpellCheck ) <br> {<br>  <em>ppv = (ISpellCheck </em>) this ;<br>    ((ISpellCheck <em>)(</em>ppv))-&gt;AddRef() ;<br> }<br> else<br> {<br>  <em>ppv = NULL;<br>  return E_NOINTERFACE ;<br> }<br> return S_OK;<br>}<br><br>ULONG   CDictionary::AddRef()<br>{<br> m_Ref ++;<br> return  (ULONG) m_Ref;<br>}<br><br>ULONG   CDictionary::Release()<br>{<br> m_Ref –;<br> if (m_Ref == 0 ) {<br>  g_DictionaryNumber – ;<br>  delete this;<br>  return 0;<br> }<br> return  (ULONG) m_Ref;<br>}<br><br>BOOL CDictionary::Initialize()<br>{<br> m_nWordNumber = 0;<br> m_nStructNumber = 0;<br> if (m_pData != NULL) <br> {<br>  delete [] m_pData;<br> }<br> m_pData = NULL;<br> return TRUE;<br>}<br><br>BOOL CDictionary::LoadLibrary(String filename)<br>{<br> char </em>pFileName = _com_util::ConvertBSTRToString(filename);<br> FILE <em>fp;<br> if( (fp = fopen( pFileName, &quot;rt&quot; )) == NULL ) {<br>  printf(&quot;Open dictionary file : %s failed.n&quot;, pFileName);<br>  delete pFileName;<br>  return FALSE;<br> }<br> char LineBuffer[128];<br> if (feof(fp)) {<br>  printf(&quot;It is a null file!n&quot;);<br>  fclose(fp);<br>  delete pFileName;<br>  return FALSE; <br> }<br> if (fgets(LineBuffer, 128, fp) == NULL) {<br>  printf(&quot;Read TotalNumber failed!n&quot;);<br>  fclose(fp);<br>  delete pFileName;<br>  return FALSE; <br> }<br> <br> int nTotalNumber = 0;<br> sscanf(LineBuffer, &quot;%d&quot;, &amp;nTotalNumber);<br> if ( (nTotalNumber &lt; 1) &amp;&amp; (nTotalNumber &gt; 5000) ) {<br>  printf(&quot;The Number of words is invalid!n&quot;);<br>  fclose(fp);<br>  delete pFileName;<br>  return FALSE; <br> }<br><br> Initialize();<br> m_nStructNumber = nTotalNumber+100;<br> m_pData = new DictWord[m_nStructNumber];<br> m_nWordNumber = 0;<br> <br> while(!feof(fp)) {<br>  if (fgets(LineBuffer, MaxWordLength, fp) == NULL) {<br>   printf(&quot;Read the first string failed!n&quot;);<br>   break;<br>  }<br>  sscanf(LineBuffer, &quot;%s&quot;, m_pData[m_nWordNumber].wordForLang1);<br>  if (fgets(LineBuffer, MaxWordLength, fp) == NULL) {<br>   printf(&quot;Read the second string failed!n&quot;);<br>   break;<br>  }<br>  sscanf(LineBuffer, &quot;%s&quot;, m_pData[m_nWordNumber].wordForLang2);<br>  m_nWordNumber ++;<br>  if (m_nWordNumber == nTotalNumber)<br>   break;<br>  if (m_nWordNumber &gt; m_nStructNumber)<br>   break;<br> } <br> <br> fclose(fp);<br> delete pFileName;<br> return TRUE;<br>}<br><br>BOOL CDictionary::InsertWord(String word1, String word2)<br>{<br> char </em>pWord1, <em>pWord2;<br> if (m_nWordNumber &lt; m_nStructNumber) {<br>  pWord1 = _com_util::ConvertBSTRToString(word1);<br>  pWord2 = _com_util::ConvertBSTRToString(word2);<br><br>  if (strlen(pWord1) &gt; MaxWordLength)<br>   </em>(pWord1+MaxWordLength-1) = ‘ ’;<br>  if (strlen(pWord2) &gt; MaxWordLength)<br>   <em>(pWord2+MaxWordLength-1) = ‘ ’;<br>  strcpy(m_pData[m_nWordNumber].wordForLang1, pWord1);<br>  strcpy(m_pData[m_nWordNumber].wordForLang2, pWord2);<br>  m_nWordNumber ++ ;<br>  delete pWord1;<br>  delete pWord2;<br>  return TRUE;<br> }<br> return FALSE;<br>}<br><br>void CDictionary::DeleteWord(String word)<br>{<br> char </em>pWord = _com_util::ConvertBSTRToString(word);<br> char <em>pUpperWord = strupr(pWord);<br> for (int i = 0; i &lt; m_nWordNumber; i++)<br> {<br>  char </em>tmpWord = strupr(m_pData[i].wordForLang1);<br>  if (strcmp(tmpWord, pWord) == 0) {<br>   for(int j = i + 1; j &lt; m_nWordNumber; j++) {<br>    strcpy( m_pData[j].wordForLang1, m_pData[j + 1].wordForLang1);<br>    strcpy( m_pData[j].wordForLang2, m_pData[j + 1].wordForLang2);<br>   }<br>   m_nWordNumber ++ ;<br>   break;<br>  }<br> }<br> delete pWord;<br>}<br><br>BOOL CDictionary::LookupWord(String word, String <em>resultWord)<br>{<br> char </em>pWord = _com_util::ConvertBSTRToString(word);<br> char <em>pUpperWord = strupr(pWord);<br> for (int i = 0; i &lt; m_nWordNumber; i++)<br> {<br>  char </em>tmpWord = strupr(m_pData[i].wordForLang1);<br>  if (strcmp(tmpWord, pWord) == 0) {<br>   <em>resultWord = _com_util::ConvertStringToBSTR(m_pData[i].wordForLang2);<br>   delete pWord;<br>   return TRUE;<br>  }<br> }<br> </em>resultWord = NULL;<br> delete pWord;<br> return FALSE;<br>}<br><br>BOOL CDictionary::RestoreLibrary(String filename)<br>{<br> char <em>pFileName = _com_util::ConvertBSTRToString(filename);<br> FILE </em>fp;<br> if( (fp = fopen( pFileName, &quot;wt&quot; )) == NULL ) {<br>  printf(&quot;Open dictionary file : %s failed.n&quot;, pFileName);<br>  delete pFileName;<br>  return FALSE;<br> }<br> char LineBuffer[128];<br> sprintf(LineBuffer, &quot;%dn&quot;, m_nWordNumber);<br> if (fputs(LineBuffer, fp) == EOF) {<br>  printf(&quot;Write TotalNumber failed!n&quot;);<br>  fclose(fp);<br>  delete pFileName;<br>  return FALSE; <br> }<br> <br> for(int i = 0; i &lt; m_nWordNumber; i ++ ) {<br>  if (fputs(m_pData[i].wordForLang1, fp) == EOF) {<br>   printf(&quot;Write the first string failed!n&quot;);<br>   fclose(fp);<br>   delete pFileName;<br>   return FALSE; <br>  }<br>  fputs(&quot;n&quot;, fp);<br>  if (fputs(m_pData[i].wordForLang2, fp) == EOF) {<br>   printf(&quot;Write the first string failed!n&quot;);<br>   fclose(fp);<br>   delete pFileName;<br>   return FALSE; <br>  }<br>  fputs(&quot;n&quot;, fp);<br> }<br> <br> fclose(fp);<br> delete pFileName;<br> return TRUE;<br>}<br><br>void CDictionary::FreeLibrary()<br>{<br> Initialize();<br>}<br><br> <br>BOOL CDictionary::CheckWord (String word, String <em>resultWord)<br>{<br> char </em>pWord = _com_util::ConvertBSTRToString(word);<br> char <em>pUpperWord = strupr(pWord);<br> char </em>pMinMaxWord, <em>pMaxMinWord;<br> int  nMinIndex = -1, nMaxIndex = -1;<br> pMinMaxWord = pMaxMinWord = NULL;<br> for (int i = 0; i &lt; m_nWordNumber; i++)<br> {<br>  char </em>tmpWord = strupr(m_pData[i].wordForLang1);<br>  if (strcmp(tmpWord, pWord) == 0) {<br>   delete pWord;<br>   return TRUE;<br>  } else if (strcmp(tmpWord, pWord) &lt; 0) {<br>   if ((pMinMaxWord == NULL) || (strcmp(tmpWord, pMinMaxWord) &gt; 0)) <br>   {<br>    pMinMaxWord = tmpWord;<br>    nMinIndex = i;<br>   }<br>  } else {<br>   if ((pMaxMinWord == NULL) || (strcmp(tmpWord, pMaxMinWord) &lt; 0)) <br>   {<br>    pMaxMinWord = tmpWord;<br>    nMaxIndex = i;<br>   }<br>  }<br> }<br> <br> <em>resultWord = NULL;<br> if (nMinIndex != -1)<br>  </em>resultWord = _com_util::ConvertStringToBSTR(m_pData[nMinIndex].wordForLang1);<br> else if (nMaxIndex != -1)<br>  <em>resultWord = _com_util::ConvertStringToBSTR(m_pData[nMaxIndex].wordForLang1);<br> delete pWord;<br> return FALSE;<br>}<br> <br><br>组件程序自注册 Registry：<br>Registry.cpp<br>(regsvr32 DictComp.dll)<br>(regsvr32 /u DictComp.dll)                                                                           //<br>// Registry.cpp<br>//<br><br>#include &lt;objbase.h&gt;<br>#include &lt;assert.h&gt;<br><br>#include &quot;Registry.h&quot;<br><br>////////////////////////////////////////////////////////<br>//<br>// Internal helper functions prototypes<br>//<br>//   - These helper functions were borrowed and modifed from<br>//     Dale Rogerson’s book Inside COM.<br><br>// Set the given key and its value.<br>BOOL SetKeyAndValue(const char</em> pszPath,<br>                    const char<em> szSubkey,<br>                    const char</em> szValue) ;<br><br>// Convert a CLSID into a char string.<br>void CLSIDtoString(const CLSID&amp; clsid, <br>                 char<em> szCLSID,<br>                 int length) ;<br><br>// Delete szKeyChild and all of its descendents.<br>LONG DeleteKey(HKEY hKeyParent, const char</em> szKeyString) ;<br><br>////////////////////////////////////////////////////////<br>//<br>// Constants<br>//<br><br>// Size of a CLSID as a string<br>const int CLSID_STRING_SIZE = 39 ;<br><br>/////////////////////////////////////////////////////////<br>//<br>// Public function implementation<br>//<br><br>//<br>// Register the component in the registry.<br>//<br>HRESULT RegisterServer(const CLSID&amp; clsid,         // Class ID<br>                       const char <em>szFileName,     // DLL module handle<br>                       const char</em> szProgID,       //   IDs<br>                       const char<em> szDescription,  // Description String<br>        const char</em> szVerIndProgID) // optional<br><br>{<br> // Convert the CLSID into a char.<br> char szCLSID[CLSID_STRING_SIZE] ;<br> CLSIDtoString(clsid, szCLSID, sizeof(szCLSID)) ;<br><br> // Build the key CLSID{…}<br> char szKey[64] ;<br> strcpy(szKey, &quot;CLSID\&quot;) ;<br> strcat(szKey, szCLSID) ;<br> <br> // Add the CLSID to the registry.<br> SetKeyAndValue(szKey, NULL, szDescription) ;<br><br> // Add the server filename subkey under the CLSID key.<br> SetKeyAndValue(szKey, &quot;InprocServer32&quot;, szFileName) ;<br><br> // Add the ProgID subkey under the CLSID key.<br> if (szProgID != NULL) {<br>  SetKeyAndValue(szKey, &quot;ProgID&quot;, szProgID) ;<br>  SetKeyAndValue(szProgID, &quot;CLSID&quot;, szCLSID) ;<br> }<br><br> if (szVerIndProgID) {<br>  // Add the version-independent ProgID subkey under CLSID key.<br>  SetKeyAndValue(szKey, &quot;VersionIndependentProgID&quot;,<br>        szVerIndProgID) ;<br><br>  // Add the version-independent ProgID subkey under HKEY_CLASSES_ROOT.<br>  SetKeyAndValue(szVerIndProgID, NULL, szDescription) ; <br>  SetKeyAndValue(szVerIndProgID, &quot;CLSID&quot;, szCLSID) ;<br>  SetKeyAndValue(szVerIndProgID, &quot;CurVer&quot;, szProgID) ;<br><br>  // Add the versioned ProgID subkey under HKEY_CLASSES_ROOT.<br>  SetKeyAndValue(szProgID, NULL, szDescription) ; <br>  SetKeyAndValue(szProgID, &quot;CLSID&quot;, szCLSID) ;<br> }<br><br> return S_OK ;<br>}<br><br>//<br>// Remove the component from the registry.<br>//<br>HRESULT UnregisterServer(const CLSID&amp; clsid,      // Class ID<br>                      const char<em> szProgID,       //   IDs<br>                      const char</em> szVerIndProgID) // Programmatic<br>{<br> // Convert the CLSID into a char.<br> char szCLSID[CLSID_STRING_SIZE] ;<br> CLSIDtoString(clsid, szCLSID, sizeof(szCLSID)) ;<br><br> // Build the key CLSID{…}<br> char szKey[64] ;<br> strcpy(szKey, &quot;CLSID\&quot;) ;<br> strcat(szKey, szCLSID) ;<br><br> // Delete the CLSID Key - CLSID{…}<br> LONG lResult = DeleteKey(HKEY_CLASSES_ROOT, szKey) ;<br><br> // Delete the version-independent ProgID Key.<br> if (szVerIndProgID != NULL)<br>  lResult = DeleteKey(HKEY_CLASSES_ROOT, szVerIndProgID) ;<br><br> // Delete the ProgID key.<br> if (szProgID != NULL)<br>  lResult = DeleteKey(HKEY_CLASSES_ROOT, szProgID) ;<br><br> return S_OK ;<br>}<br><br>///////////////////////////////////////////////////////////<br>//<br>// Internal helper functions<br>//<br><br>// Convert a CLSID to a char string.<br>void CLSIDtoString(const CLSID&amp; clsid,<br>                 char<em> szCLSID,<br>                 int length)<br>{<br> assert(length &gt;= CLSID_STRING_SIZE) ;<br> // Get CLSID<br> LPOLESTR wszCLSID = NULL ;<br> HRESULT hr = StringFromCLSID(clsid, &amp;wszCLSID) ;<br> assert(SUCCEEDED(hr)) ;<br><br> // Covert from wide characters to non-wide.<br> wcstombs(szCLSID, wszCLSID, length) ;<br><br> // Free memory.<br> CoTaskMemFree(wszCLSID) ;<br>}<br><br>//<br>// Delete a key and all of its descendents.<br>//<br>LONG DeleteKey(HKEY hKeyParent,           // Parent of key to delete<br>               const char</em> lpszKeyChild)  // Key to delete<br>{<br> // Open the child.<br> HKEY hKeyChild ;<br> LONG lRes = RegOpenKeyEx(hKeyParent, lpszKeyChild, 0,<br>                          KEY_ALL_ACCESS, &amp;hKeyChild) ;<br> if (lRes != ERROR_SUCCESS)<br> {<br>  return lRes ;<br> }<br><br> // Enumerate all of the decendents of this child.<br> FILETIME time ;<br> char szBuffer[256] ;<br> DWORD dwSize = 256 ;<br> while (RegEnumKeyEx(hKeyChild, 0, szBuffer, &amp;dwSize, NULL,<br>                     NULL, NULL, &amp;time) == S_OK)<br> {<br>  // Delete the decendents of this child.<br>  lRes = DeleteKey(hKeyChild, szBuffer) ;<br>  if (lRes != ERROR_SUCCESS)<br>  {<br>   // Cleanup before exiting.<br>   RegCloseKey(hKeyChild) ;<br>   return lRes;<br>  }<br>  dwSize = 256 ;<br> }<br><br> // Close the child.<br> RegCloseKey(hKeyChild) ;<br><br> // Delete this child.<br> return RegDeleteKey(hKeyParent, lpszKeyChild) ;<br>}<br><br>//<br>// Create a key and set its value.<br>//<br>BOOL SetKeyAndValue(const char<em> szKey,<br>                    const char</em> szSubkey,<br>                    const char<em> szValue)<br>{<br> HKEY hKey;<br> char szKeyBuf[1024] ;<br><br> // Copy keyname into buffer.<br> strcpy(szKeyBuf, szKey) ;<br><br> // Add subkey name to buffer.<br> if (szSubkey != NULL)<br> {<br>  strcat(szKeyBuf, &quot;\&quot;) ;<br>  strcat(szKeyBuf, szSubkey ) ;<br> }<br><br> // Create and open key and subkey.<br> long lResult = RegCreateKeyEx(HKEY_CLASSES_ROOT ,<br>                               szKeyBuf, <br>                               0, NULL, REG_OPTION_NON_VOLATILE,<br>                               KEY_ALL_ACCESS, NULL, <br>                               &amp;hKey, NULL) ;<br> if (lResult != ERROR_SUCCESS)<br> {<br>  return FALSE ;<br> }<br><br> // Set the Value.<br> if (szValue != NULL)<br> {<br>  RegSetValueEx(hKey, NULL, 0, REG_SZ, <br>                (BYTE </em>)szValue, <br>                strlen(szValue)+1) ;<br> }<br><br> RegCloseKey(hKey) ;<br> return TRUE ;<br>}<br> <br><br>Factory.cpp                                                                           #include &quot;stdafx.h&quot;<br>#include &quot;factory.h&quot;<br>#include &quot;dictcomp.h&quot;<br><br>extern ULONG    g_LockNumber;<br>extern ULONG    g_DictionaryNumber;<br><br>CDictionaryFactory::CDictionaryFactory()<br>{<br> m_Ref = 0;<br>}<br><br>CDictionaryFactory::~CDictionaryFactory()<br>{<br>}<br><br>HRESULT  CDictionaryFactory::QueryInterface(const IID&amp; iid, void </strong>ppv)<br>{<br> if ( iid == IID_IUnknown )<br> {<br>  <em>ppv = (IUnknown </em>) this ;<br>    ((IUnknown <em>)(</em>ppv))-&gt;AddRef() ;<br> } else if ( iid == IID_IClassFactory) <br> {<br>  <em>ppv = (IClassFactory </em>) this ;<br>    ((IClassFactory <em>)(</em>ppv))-&gt;AddRef() ;<br> } <br> else<br> {<br>  <em>ppv = NULL;<br>  return E_NOINTERFACE ;<br> }<br> return S_OK;<br>}<br><br>ULONG   CDictionaryFactory::AddRef()<br>{<br> m_Ref ++;<br> return  (ULONG) m_Ref;<br>}<br><br>ULONG   CDictionaryFactory::Release()<br>{<br> m_Ref –;<br> if (m_Ref == 0 ) {<br>  delete this;<br>  return 0;<br> }<br> return  (ULONG) m_Ref;<br>}<br><br>HRESULT CDictionaryFactory::CreateInstance(IUnknown </em>pUnknownOuter, <br>             const IID&amp; iid, void <strong>ppv)<br>{<br>   CDictionary <em> pObj;   <br>   HRESULT hr;<br> <br>   </em>ppv=NULL;<br>   hr=E_OUTOFMEMORY;<br>   if (NULL != pUnknownOuter)<br>    return CLASS_E_NOAGGREGATION;<br> <br>   //Create the object passing function to notify on destruction.<br>   pObj=new CDictionary();<br>   if (NULL==pObj)<br>      return hr;   <br> <br>   //Obtain the first interface pointer (which does an AddRef)<br>   hr=pObj-&gt;QueryInterface(iid, ppv);<br><br>   if (hr != S_OK) {<br>    //Kill the object if initial creation or FInit failed.<br>      g_DictionaryNumber –; // Reference count g_cDictionary be added in constructor<br>   delete pObj;<br>   }<br> <br>   return hr;   <br>}<br><br>HRESULT CDictionaryFactory::LockServer(BOOL bLock)<br>{<br>   if (bLock)<br>      g_LockNumber ++;<br>   else<br>      g_LockNumber –;<br><br>   return NOERROR;<br>}<br> <br><strong><br></strong>Factory.h                                    #ifndef <strong>DICTIONARY_FACTORY</strong><br>#define <strong>DICTIONARY_FACTORY</strong><br><br>#include &quot;Unknwn.h&quot;<br><br>class CDictionaryFactory : public IClassFactory<br>{<br>   protected:<br>      ULONG           m_Ref;<br><br>   public:<br>      CDictionaryFactory ();<br>      ~CDictionaryFactory ();<br><br>      //IUnknown members<br>      HRESULT __stdcall QueryInterface(const IID&amp; iid, void </strong>ppv);<br>      ULONG <strong>stdcall AddRef();<br>      ULONG </strong>stdcall Release();<br><br>      //IClassFactory members<br>      HRESULT <strong>stdcall CreateInstance(IUnknown <em>, const IID&amp; iid, void *</em>ppv);<br>      HRESULT </strong>stdcall LockServer(BOOL);<br>};<br><br>#endif // <strong>DICTIONARY_FACTORY</strong><br> <br><strong><br></strong><br><br><br> </p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2007/07/08/归去来辞/" rel="next" title="归去来辞">
                <i class="fa fa-chevron-left"></i> 归去来辞
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2007/07/14/客户端/" rel="prev" title="客户端">
                客户端 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/wp-content/uploads/penguin.gif"
               alt="jfo" />
          <p class="site-author-name" itemprop="name">jfo</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">596</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">36</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/jfojfo" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/jfojfo" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.pickbox.me" title="收藏夹" target="_blank">收藏夹</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://note.pickbox.me" title="网络剪贴板" target="_blank">网络剪贴板</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://iguangba.pickbox.me" title="爱逛吧" target="_blank">爱逛吧</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <p class="post-toc-empty">此文章未包含目录</p>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jfo</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  




  
  

  

  

  

</body>
</html>
