<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>jfo planet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="jfo planet">
<meta property="og:url" content="http://blog.pickbox.me/page/11/index.html">
<meta property="og:site_name" content="jfo planet">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="jfo planet">
  
    <link rel="alternative" href="/atom.xml" title="jfo planet" type="application/atom+xml">
  
  
    <link rel="icon" href="//favicon.ico">
  
  <script src="/style.js"></script>
  

</head>

<body>
  <div id="container">
    <div class="left-col">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="http://img.pickbox.me/wp-content/uploads/penguin.gif" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">jfo</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Hope is the best gift that tomorrow gives.</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a class="js-smart-menu" data-idx="0" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="1" href="javascript:void(0)">分类</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="2" href="javascript:void(0)">友链</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="3" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/jfojfo" title="github">github</a>
		        
					<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/jfojfo" title="zhihu">zhihu</a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-list"></i></div>
  		<h1 class="header-author js-mobile-header hide">jfo</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="http://img.pickbox.me/wp-content/uploads/penguin.gif" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">jfo</h1>
			</hgroup>
			
			<p class="header-subtitle">Hope is the best gift that tomorrow gives.</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/jfojfo" title="github">github</a>
			        
						<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/jfojfo" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
        
  
    <article id="post-如何使inline元素垂直居中（line-height和vertical-align）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2012/05/10/如何使inline元素垂直居中（line-height和vertical-align）/">如何使inline元素垂直居中（line-height和vertical-align）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
         <p>&nbsp;</p><p></p><p></p><p></p><p></p><p>&lt;!DOCTYPE html&gt;</p><p>&lt;html&gt;</p><p>&lt;head&gt;</p><p>&lt;meta &nbsp;charset=&quot;utf-8&quot; /&gt;</p><p>&lt;title&gt;横向对齐+垂直居中&lt;/title&gt;</p><p>&lt;style type=&quot;text/css&quot;&gt;</p><p>.box{height:100px;border:1px solid #000;}</p><p>.box input,.box span{vertical-align:middle;}</p><p>.pillar{display:inline-block;width:0px;height:100%;vertical-align:middle;} &nbsp;/<em> width:0的话，在opera下会失效。当然也有另外的方法来解决opera </em>/</p><p>&lt;/style&gt;</p><p>&lt;/head&gt;</p><p>&lt;body&gt;</p><p>&lt;div class=&quot;box&quot;&gt;</p><p>&lt;span class=&quot;pillar&quot; &gt;&lt;/span&gt;vertical-align:middle&lt;input type=&quot;text&quot; style=&quot;padding:10px;&quot; /&gt;&lt;span&gt;各元素横行对齐&lt;/span&gt;</p><p>&lt;/div&gt;</p><p>&lt;/body&gt;</p><p>&lt;/html&gt;</p><br><p></p><p></p><p>原文参考：<a href="http://www.cssass.com/blog/index.php/2010/490.html" target="_blank" rel="external">http://www.cssass.com/blog/index.php/2010/490.html</a></p><p></p><p>line-height可以应用在所有元素上。<br>但尽管line-height可以加在block元素上，实际起作用的却是内部的inline元素或textnode节点(也体现了它的继承性质)。</p><p>非可置换inline元素没有height;每一行的高度就由line-height决定。<br>而对于可置换inline元素，他本身其实是有内在高度的，将不受line-height影响（ie7是个例外）。</p><p>但这点性质，似乎正在改变。<br>css2.1也如是说：对于block,inline-block(可置换inline元素就是天生的inline-block元素), line-height是做为其minimal height的。那当高度小于line-height时，是理应起作用的。<br>我们使用html5的doctype声明:</p><p>在上面的例子里，除了ie6，这里的line-height在其他浏览器都能起作用。<br>总之，<b>单纯设置外层height=line-height使image等可置换元素垂直居中，在ie6下是行不通的</b>——如果要考虑ie6，请记住这一点。<br>那么，如何才能做到inline元素(包括可置换inline元素)的垂直居中，并且推而广之应用在block元素上呢？我们可以利用vertical-align属性。</p><p>现在先摘要说下vertical-align属性。<br>在CSS Specification中，line-height属性和vertical-align属性就是放在一起做介绍的。<br><a href="http://www.w3.org/TR/CSS2/visudet.html#line-height" target="_blank">Line height calculations: the ‘line-height’ and ‘vertical-align’ properties<br></a><br>vertical-align的默认值是baseline;<br>与line-height不同，<b>vertical-align只能用在inline元素（还有’table-cell’ 元素）上</b><br>vertical-align属性在各个浏览器下都有不少的差异。参见：<a href="http://www.mikkolee.com/13" target="_blank">http://www.mikkolee.com/13</a></p><p>不过，我们要用到的属性middle在各个浏览器解释中却没有什么差异（或只有微小的差异）。<br>让同行的inline元素按中间线对齐，我们给各个inline元素加上vertical-align:middle;</p><p>接着我们要相对外层做垂直居中。<br>假如，内部的一个inline元素（当然是可置换inline元素,或是设置了inline-block的元素——这二者其实是一样的）的高度也达到外层的高度，那么就可以保证内层所有的inline元素都垂直居中了。<br>所以我们可以设置这样一个空元素pillar。</p><p>是不是很熟悉啊，我们“未知尺寸元素的垂直居中”的一个方法就是从这里衍生而来的——那是针对block元素的居中：<a href="http://www.cssass.com/blog/index.php/2008/36.html" target="_blank">http://www.cssass.com/blog/index.php/2008/36.html</a><br>做法就是将block元素变成inline-block,或者干脆使用某一inline元素包住block元素（尽管这不符合标准），然后再使用上面的方法。</p><p></p><p></p><p>&nbsp;</p><p>&nbsp;</p><p></p><p></p> 
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2012/05/10/如何使inline元素垂直居中（line-height和vertical-align）/" class="archive-article-date">
  	<time datetime="2012-05-10T10:06:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2012-05-10</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/python-js-php-html-mysql-http/">python/js/php/html/mysql/http</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-CSS3-和-JavaScript-特效" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2012/04/30/CSS3-和-JavaScript-特效/">CSS3 和 JavaScript 特效</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
         <p>&nbsp;</p><p><a href="http://www.oschina.net/news/28001/9-applicable-and-awesome-css3-and-effects?from=20120422" target="_blank" rel="external">http://www.oschina.net/news/28001/9-applicable-and-awesome-css3-and-javascript-effects?from=20120422</a></p><p>&nbsp;</p><p><a href="https://developer.mozilla.org/en-US/demos/detail/paperfold-css/launch" target="_blank" rel="external">Paperfold</a></p><p><img src="http://img.pickbox.me/wp-content/uploads/pic/597fcc1b9d16fdfa2b29ff50b48f8c5495ee7b53.jpg" small="0"></p><p>&nbsp;</p><p>&nbsp;</p><p><a href="https://developer.mozilla.org/en-US/demos/detail/3d-flip-list-menu/launch" target="_blank" rel="external">3D Flip list menu</a></p><p><img src="http://img.pickbox.me/wp-content/uploads/pic/e748be3eb13533fafa899e8aa8d3fd1f40345be3.jpg" small="0"></p><p>&nbsp;</p><p><a href="https://developer.mozilla.org/en-US/demos/detail/animated-menu-icons/launch" target="_blank" rel="external">Animated Menu Icons</a></p><p><img src="http://img.pickbox.me/wp-content/uploads/pic/057da964034f78f027e1885679310a55b2191c39.jpg" small="0"></p><p>&nbsp;<a href="https://developer.mozilla.org/en-US/demos/detail/animated-css3-gallery/launch" target="_blank" rel="external">Animated CSS3 Gallery</a></p><p>&nbsp;<img src="http://img.pickbox.me/wp-content/uploads/pic/b152d7628535e5ddb6d5a87b76c6a7efcf1b622d.jpg" small="0"></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p></p> 
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2012/04/30/CSS3-和-JavaScript-特效/" class="archive-article-date">
  	<time datetime="2012-04-30T07:13:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2012-04-30</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/python-js-php-html-mysql-http/">python/js/php/html/mysql/http</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-如何正确使用平移动画（关于fillBefore和fillAfter的一点说明）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2012/04/20/如何正确使用平移动画（关于fillBefore和fillAfter的一点说明）/">如何正确使用平移动画（关于fillBefore和fillAfter的一点说明）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
         <p>如何实现将View向上平移自身高度一半的距离？</p><p></p><p>&nbsp;</p><p>TranslateAnimation translate = new TranslateAnimation(</p><p>Animation.RELATIVE_TO_SELF, 0, Animation.RELATIVE_TO_SELF, 0,&nbsp;</p><p>Animation.RELATIVE_TO_SELF, 0, Animation.RELATIVE_TO_SELF, 0.5f);</p><p>mView.startAnimation(translate);</p><p>问题：当动画结束后，View会跳回到原始位置。</p><p>&nbsp;</p><p>改进：</p><p>AnimationSet set = new AnimationSet(true);</p><p>TranslateAnimation translate = new TranslateAnimation(</p><p>Animation.RELATIVE_TO_SELF, 0, Animation.RELATIVE_TO_SELF, 0,&nbsp;</p><p>Animation.RELATIVE_TO_SELF, 0, Animation.RELATIVE_TO_SELF, 0.5f);</p><p>set.addAnimation(translate);</p><p>set.setFillAfter(true);</p><p>mView.startAnimation(set);</p><p>&nbsp;</p><p>setFillAfter文档说明:</p><p>If fillAfter is true, the transformation that this animation performed&nbsp;</p><p>will persist when it is finished. Defaults to false if not set.</p><p>设为true之后，界面会停留在动画播放完时的界面。</p><p>&nbsp;</p><p>问题：动画结束后界面显示正确，但是View上各控件的实际位置和看上去的位置不对应，</p><p>实际位置还在View的原始位置，因此button的点击位置会有问题，和看见的位置有偏差。</p><p>&nbsp;</p><p>正确方法：</p><p>AnimationSet set = new AnimationSet(true);</p><p>TranslateAnimation translate = new TranslateAnimation(</p><p>Animation.RELATIVE_TO_SELF, 0, Animation.RELATIVE_TO_SELF, 0,&nbsp;</p><p>Animation.RELATIVE_TO_SELF, 0.5, Animation.RELATIVE_TO_SELF, 0);</p><p>set.addAnimation(translate);</p><p>set.setFillAfter(true);</p><p>mView.offsetTopAndBottom(-mView.getHeight() / 2);</p><p>mView.startAnimation(set);</p><p>&nbsp;</p><p>先将View向上平移自身高度一半的距离，然后播放动画，从最初位置一直向上移动目标位置。</p><p>&nbsp;</p><p>setFillBefore文档说明：</p><p>If fillBefore is true, this animation will apply its transformation&nbsp;</p><p>before the start time of the animation. Defaults to true if&nbsp;</p><p>setFillEnabled(boolean) is not set to true.</p><p>&nbsp;</p><p>对TranslateAnimation，setFillBefore默认为true，也就是说在动画开始前，先将transformation&nbsp;</p><p>apply到View，这也就是为什么offsetTopAndBottom()后，View依然从原始位置开始运动。</p><p>如果setFillBefore设为false，动画播放时会有一个跳动，可以看到View从目标位置跳到原始位置。</p><p>&nbsp;</p><p>总结：</p><p>使用Animation、AnimationSet框架实现的动画效果，必须先将View放置到最终的目标位置，</p><p>然后倒过来，播放从原始位置到目标位置的动画。</p><p>&nbsp;</p><p>&nbsp;</p><p></p><p>&nbsp;</p><p></p> 
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2012/04/20/如何正确使用平移动画（关于fillBefore和fillAfter的一点说明）/" class="archive-article-date">
  	<time datetime="2012-04-20T02:48:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2012-04-20</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Android/">Android</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-standard-singleTop-singleTask-singleInstance" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2012/03/21/standard-singleTop-singleTask-singleInstance/">standard/singleTop/singleTask/singleInstance</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
         <p>&nbsp;</p><p>&nbsp;A &quot;singleInstance&quot; activity is always at the top of the stack (since it is the only activity in the task), so it is always in position to handle the intent. However, a &quot;singleTask&quot; activity may or may not have other activities above it in the stack. If it does, it is not in position to handle the intent, and the intent is dropped. (Even though the intent is dropped, its arrival would have caused the task to come to the foreground, where it would remain.)</p><p><br></p><p></p> 
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2012/03/21/standard-singleTop-singleTask-singleInstance/" class="archive-article-date">
  	<time datetime="2012-03-21T06:37:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2012-03-21</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Android/">Android</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-使用TextView-EditText应该注意的地方" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2012/03/13/使用TextView-EditText应该注意的地方/">使用TextView/EditText应该注意的地方</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
         <p>关于各种EditText、软键盘各种问题的集合：</p><p><a href="http://gundumw100.iteye.com/blog/974557" target="_blank">http://gundumw100.iteye.com/blog/974557</a></p><p>&nbsp;</p><p></p><p><a target="_blank" href="http://aichixihongshi.iteye.com/blog/1197726"></a></p><p></p> 
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2012/03/13/使用TextView-EditText应该注意的地方/" class="archive-article-date">
  	<time datetime="2012-03-13T14:02:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2012-03-13</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Android/">Android</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-CGlib——Code-Generation-Lib（代理模型的一种实现）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2012/02/28/CGlib——Code-Generation-Lib（代理模型的一种实现）/">CGlib——Code Generation Lib（代理模型的一种实现）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
         <p><a href="http://llying.iteye.com/blog/220452" target="_blank" rel="external">http://llying.iteye.com/blog/220452</a></p><p>&nbsp;</p><p>CGlib是什么？&nbsp;<br>CGlib是一个强大的,高性能,高质量的Code生成类库。它可以在运行期扩展Java类与实现Java接口。&nbsp;<br>当然这些实际的功能是asm所提供的，asm又是什么？Java字节码操控框架，具体是什么大家可以上网查一查，毕竟我们这里所要讨论的是cglib，&nbsp;<br>cglib就是封装了asm，简化了asm的操作，实现了在运行期动态生成新的class。&nbsp;<br>可能大家还感觉不到它的强大，现在就告诉你。&nbsp;<br>实际上CGlib为spring aop提供了底层的一种实现;为hibernate使用cglib动态生成VO/PO (接口层对象)。&nbsp;<br><br>下面我们将通过一个具体的事例来看一下CGlib体验一下CGlib。&nbsp;<br><em> CGlib 2.13&nbsp;<br></em> ASM 2.23&nbsp;<br>以一个实例在简单介绍下cglib的应用。&nbsp;<br>我们模拟一个虚拟的场景，模拟对表的操作。&nbsp;<br>1. 开始我们对表提供了CRUD方法。&nbsp;<br>我们现在创建一个对Table操作的DAO类。&nbsp;</p><p>Java代码</p><p></p><p></p><p></p><p><ol><li>public&nbsp;class&nbsp;TableDAO&nbsp;{&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;create(){&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(&quot;create()&nbsp;is&nbsp;running&nbsp;!&quot;);&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;query(){&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(&quot;query()&nbsp;is&nbsp;running&nbsp;!&quot;);&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;update(){&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(&quot;update()&nbsp;is&nbsp;running&nbsp;!&quot;);&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;delete(){&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(&quot;delete()&nbsp;is&nbsp;running&nbsp;!&quot;);&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</li><li>} &nbsp;</li></ol></p><p></p><p></p><p></p>OK，它就是一个javaBean，提供了CRUD方法的javaBean。&nbsp;<br>下面我们创建一个DAO工厂，用来生成DAO实例。&nbsp;<br>Java代码<p></p><p></p><ol><li>public&nbsp;class&nbsp;TableDAOFactory&nbsp;{&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;TableDAO&nbsp;tDao&nbsp;=&nbsp;new&nbsp;TableDAO();&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;TableDAO&nbsp;getInstance(){&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;tDao;&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</li><li>} &nbsp;</li></ol><p></p><p></p><p></p>接下来我们创建客户端，用来调用CRUD方法。&nbsp;<br>Java代码<p></p><p></p><p></p><ol><li>public&nbsp;class&nbsp;Client&nbsp;{&nbsp;&nbsp;</li><li>&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;void&nbsp;main(String[]&nbsp;args)&nbsp;{&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TableDAO&nbsp;tableDao&nbsp;=&nbsp;TableDAOFactory.getInstance();&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doMethod(tableDao);&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;void&nbsp;doMethod(TableDAO&nbsp;dao){&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dao.create();&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dao.query();&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dao.update();&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dao.delete();&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</li><li>} &nbsp;</li></ol><p></p><p></p>OK，完成了，CRUD方法完全被调用了。当然这里并没有CGlib的任何内容。问题不会这么简单的就结束，新的需求来临了。&nbsp;<br>2. 变化随之而来，Boss告诉我们这些方法不能开放给用户，只有“张三”才有权使用。阿~！怎么办，难道我们要在每个方法上面进行判断吗？&nbsp;<br>好像这么做也太那啥了吧，对了对了Proxy可能是最好的解决办法。jdk的代理就可以解决了。 好了我们来动手改造吧。等等jdk的代理需要实现接口，这样，&nbsp;<br>我们的dao类需要改变了。既然不想改动dao又要使用代理，我们这就请出CGlib。&nbsp;<br>我们只需新增一个权限验证的方法拦截器。&nbsp;<br>Java代码<p></p><p><ol><li>public&nbsp;class&nbsp;AuthProxy&nbsp;implements&nbsp;MethodInterceptor&nbsp;{&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;String&nbsp;name&nbsp;;&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;//传入用户名称&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;AuthProxy(String&nbsp;name){&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.name&nbsp;=&nbsp;name;&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Object&nbsp;intercept(Object&nbsp;arg0,&nbsp;Method&nbsp;arg1,&nbsp;Object[]&nbsp;arg2,&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MethodProxy&nbsp;arg3)&nbsp;throws&nbsp;Throwable&nbsp;{&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//用户进行判断&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!&quot;张三&quot;.equals(name)){&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(&quot;你没有权限！&quot;);&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;arg3.invokeSuper(arg0,&nbsp;arg2);&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</li><li>} &nbsp;</li></ol></p><p></p><p>&nbsp;当然不能忘了对我们的dao工厂进行修改，我们提供一个使用代理的实例生成方法&nbsp;</p>Java代码<p><ol><li>public&nbsp;static&nbsp;TableDAO&nbsp;getAuthInstance(AuthProxy&nbsp;authProxy){&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;Enhancer&nbsp;en&nbsp;=&nbsp;new&nbsp;Enhancer();&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;//进行代理&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;en.setSuperclass(TableDAO.class);&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;en.setCallback(authProxy);&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;//生成代理实例&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(TableDAO)en.create();&nbsp;&nbsp;</li><li>} &nbsp;</li></ol></p><p></p>我们这就可以看看客户端的实现了。添加了两个方法用来验证不同用户的权限。&nbsp;<br>Java代码<p><ol><li>public&nbsp;static&nbsp;void&nbsp;haveAuth(){&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;TableDAO&nbsp;tDao&nbsp;=&nbsp;TableDAOFactory.getAuthInstance(new&nbsp;AuthProxy(&quot;张三&quot;));&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;doMethod(tDao);&nbsp;&nbsp;</li><li>}&nbsp;&nbsp;</li><li>public&nbsp;static&nbsp;void&nbsp;haveNoAuth(){&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;TableDAO&nbsp;tDao&nbsp;=&nbsp;TableDAOFactory.getAuthInstance(new&nbsp;AuthProxy(&quot;李四&quot;));&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;doMethod(tDao);&nbsp;&nbsp;</li><li>} &nbsp;</li></ol></p><p></p>OK,&quot;张三&quot;的正常执行，&quot;李四&quot;的没有执行。&nbsp;<br>看到了吗？简单的aop就这样实现了&nbsp;<br>难道就这样结束了么？&nbsp;<br>3. Boss又来训话了，不行不行，现在除了&quot;张三&quot;其他人都用不了了，现在不可以这样。他们都来向我反映了，必须使用开放查询功能。&nbsp;<br>哈哈，现在可难不倒我们了，因为我们使用了CGlib。当然最简单的方式是去修改我们的方法拦截器，不过这样会使逻辑变得复杂，且&nbsp;<br>不利于维护。还好CGlib给我们提供了方法过滤器（CallbackFilter）,CallbackFilte可以明确表明，被代理的类中不同的方法，&nbsp;<br>被哪个拦截器所拦截。下面我们就来做个过滤器用来过滤query方法。&nbsp;<br>Java代码<p><ol><li>public&nbsp;class&nbsp;AuthProxyFilter&nbsp;implements&nbsp;CallbackFilter{&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;int&nbsp;accept(Method&nbsp;arg0)&nbsp;{&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!&quot;query&quot;.equalsIgnoreCase(arg0.getName()))&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1;&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</li><li>&nbsp;&nbsp;</li><li>} &nbsp;</li></ol></p><p></p>OK,可能大家会对return 0 or 1感到困惑，用到的时候就会讲解，当然下面就会用到了。&nbsp;<br>我们在工场中新增一个使用了过滤器的实例生成方法。&nbsp;<br>Java代码<p><ol><li>public&nbsp;static&nbsp;TableDAO&nbsp;getAuthInstanceByFilter(AuthProxy&nbsp;authProxy){&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;Enhancer&nbsp;en&nbsp;=&nbsp;new&nbsp;Enhancer();&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;en.setSuperclass(TableDAO.class);&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;en.setCallbacks(new&nbsp;Callback[]{authProxy,NoOp.INSTANCE});&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;en.setCallbackFilter(new&nbsp;AuthProxyFilter());&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(TableDAO)en.create();&nbsp;&nbsp;</li><li>} &nbsp;</li></ol></p><p></p>看到了吗setCallbacks中定义了所使用的拦截器，其中NoOp.INSTANCE是CGlib所提供的实际是一个没有任何操作的拦截器，&nbsp;<br>他们是有序的。一定要和CallbackFilter里面的顺序一致。明白了吗？上面return返回的就是返回的顺序。也就是说如果调用query方法就使用NoOp.INSTANCE进行拦截。&nbsp;<br>现在看一下客户端代码。&nbsp;<br>Java代码<p><ol><li>public&nbsp;static&nbsp;void&nbsp;haveAuthByFilter(){&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;TableDAO&nbsp;tDao&nbsp;=&nbsp;TableDAOFactory.getAuthInstanceByFilter(new&nbsp;AuthProxy(&quot;张三&quot;));&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;doMethod(tDao);&nbsp;&nbsp;</li><li>&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;tDao&nbsp;=&nbsp;TableDAOFactory.getAuthInstanceByFilter(new&nbsp;AuthProxy(&quot;李四&quot;));&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;doMethod(tDao);&nbsp;&nbsp;</li><li>} &nbsp;</li></ol></p><p></p>ok,现在&quot;李四&quot;也可以使用query方法了，其他方法仍然没有权限。&nbsp;<br>哈哈，当然这个代理的实现没有任何侵入性，无需强制让dao去实现接口。&nbsp;<br><p></p><p>&nbsp;</p><p>&nbsp;</p><p></p> 
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2012/02/28/CGlib——Code-Generation-Lib（代理模型的一种实现）/" class="archive-article-date">
  	<time datetime="2012-02-28T03:23:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2012-02-28</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Java/">Java</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Java-动态代理学习-Proxy-InvocationHandler" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2012/02/27/Java-动态代理学习-Proxy-InvocationHandler/">Java 动态代理学习(Proxy,InvocationHandler)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
         <p>&nbsp;</p><p>&nbsp;</p><p><ol><li>/<strong>&nbsp;</strong></li><li>&nbsp;<em>&nbsp;相亲接口&nbsp;</em></li><li>&nbsp;&nbsp;&nbsp;</li><li>&nbsp;<em>&nbsp;@author&nbsp;zhengt&nbsp;</em></li><li>&nbsp;&nbsp;@time&nbsp;Jun&nbsp;3,&nbsp;2095&nbsp;3:13:03&nbsp;PM&nbsp;</li><li>&nbsp;*/&nbsp;&nbsp;</li><li>public&nbsp;interface&nbsp;XiangQinInterface&nbsp;{&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>&nbsp;相亲方法&nbsp;</em></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;xiangQin();&nbsp;&nbsp;</li><li>}&nbsp;&nbsp;</li><li>/<strong>&nbsp;</strong></li><li>&nbsp;<em>&nbsp;张三相亲实现类&nbsp;</em></li><li>&nbsp;&nbsp;&nbsp;</li><li>&nbsp;<em>&nbsp;@author&nbsp;zhengt&nbsp;</em></li><li>&nbsp;&nbsp;@time&nbsp;Jun&nbsp;3,&nbsp;2095&nbsp;3:14:48&nbsp;PM&nbsp;</li><li>&nbsp;*/&nbsp;&nbsp;</li><li>public&nbsp;class&nbsp;ZhangSanXiangQinInterfaceImpl&nbsp;implements&nbsp;XiangQinInterface&nbsp;{&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;xiangQin()&nbsp;{&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(&quot;张三去相亲，娶个漂亮老婆。&quot;);&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</li><li>}&nbsp;&nbsp;</li><li>import&nbsp;java.lang.reflect.InvocationHandler;&nbsp;&nbsp;</li><li>import&nbsp;java.lang.reflect.Method;&nbsp;&nbsp;</li><li>&nbsp;&nbsp;</li><li>/&nbsp;</li><li>&nbsp;<em>&nbsp;相亲可是一辈子的大事，相亲前要准备一下，打扮得帅气些。&nbsp;</em></li><li>&nbsp;&nbsp;&nbsp;</li><li>&nbsp;<em>&nbsp;@author&nbsp;zhengt&nbsp;</em></li><li>&nbsp;&nbsp;@time&nbsp;Jun&nbsp;3,&nbsp;2095&nbsp;3:15:48&nbsp;PM&nbsp;</li><li>&nbsp;<em>/&nbsp;&nbsp;</em></li><li>public&nbsp;class&nbsp;ReadyInvocationHandler&nbsp;implements&nbsp;InvocationHandler&nbsp;{&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;//相亲接口的实现类，也就是张三相亲类&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;Object&nbsp;zhangSan&nbsp;=&nbsp;null;&nbsp;&nbsp;</li><li>&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;ReadyInvocationHandler(Object&nbsp;realSubject)&nbsp;{&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.zhangSan&nbsp;=&nbsp;realSubject;&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</li><li>&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Object&nbsp;invoke(Object&nbsp;proxy,&nbsp;Method&nbsp;m,&nbsp;Object[]&nbsp;args)&nbsp;{&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object&nbsp;result&nbsp;=&nbsp;null;&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;动态代理类$Proxy0调用xiangQin方法时会调用它自己的xiangQin方法，&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>&nbsp;而它自己的xiangQin方法里面调用的是super.h.invoke(this,&nbsp;,&nbsp;)，也就是父类Proxy的h的invoke方法，&nbsp;</em></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;也就是ReadyInvocationHandler类的invoke方法。&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>&nbsp;所以，invoke(Object&nbsp;proxy,&nbsp;Method&nbsp;m,&nbsp;Object[]&nbsp;args)种的proxy实际上就是动态代理类$Proxy0，&nbsp;</em></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果你将其强转成XiangQinInterface然后调用它的xiangQin方法，然后它就会调用super.h.invoke(this,&nbsp;,&nbsp;)，这样就会死循环。&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>/&nbsp;&nbsp;</em></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;网上关于这里最多问题就是Object&nbsp;proxy放在这里用来做什么呢？这个我也不知道，&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>&nbsp;不过至少我们知道它到底是个什么东西，具体做什么用嘛就不得而知了&nbsp;</em></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(proxy.getClass().getSimpleName());&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(&quot;张三相亲前，代理人给他打扮了打扮。&quot;);&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;m.invoke(zhangSan,&nbsp;args);&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(Exception&nbsp;ex)&nbsp;{&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.exit(1);&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result;&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</li><li>}&nbsp;&nbsp;</li><li>import&nbsp;java.lang.reflect.InvocationHandler;&nbsp;&nbsp;</li><li>import&nbsp;java.lang.reflect.Method;&nbsp;&nbsp;</li><li>import&nbsp;java.lang.reflect.Proxy;&nbsp;&nbsp;</li><li>&nbsp;&nbsp;</li><li>/<strong>&nbsp;</strong></li><li>&nbsp;<em>&nbsp;张三来到了婚介所(相亲现场)，开始相亲。&nbsp;</em></li><li>&nbsp;&nbsp;&nbsp;</li><li>&nbsp;<em>&nbsp;@author&nbsp;zhengt&nbsp;</em></li><li>&nbsp;&nbsp;@time&nbsp;Jun&nbsp;3,&nbsp;2095&nbsp;3:17:16&nbsp;PM&nbsp;</li><li>&nbsp;*/&nbsp;&nbsp;</li><li>public&nbsp;class&nbsp;HunJieSuo&nbsp;{&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;void&nbsp;main(String&nbsp;args[])&nbsp;{&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//先将张三相亲这个相亲的实现类实例化，也就是得到XiangQinInterface接口的一个实例对象&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XiangQinInterface&nbsp;zhangSan&nbsp;=&nbsp;new&nbsp;ZhangSanXiangQinInterfaceImpl();&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>&nbsp;得到ZhangSanXiangQinInterfaceImpl这个类的一个代理类，同时为代理类绑定了一个处理类ReadyInvocationHandler。&nbsp;</em></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;听着很绕口，其实就是每次调用ZhangSanXiangQinInterfaceImpl这个子类的xiangQin方法时，&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>&nbsp;不是zhangSan这个ZhangSanXiangQinInterfaceImpl类的实例去调用，&nbsp;</em></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;而是这个ZhangSanXiangQinInterfaceImpl的代理类ReadyInvocationHandler去调用它自己的invoke方法,&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>&nbsp;这个invoke方法里呢可以调用zhangSan这个实例的xiangQin方法&nbsp;</em></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/<strong>&nbsp;</strong></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>&nbsp;在java种怎样实现动态代理呢&nbsp;</em></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第一步，我们要有一个接口，还要有一个接口的实现类，而这个实现类呢就是我们要代理的对象，&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>&nbsp;所谓代理呢也就是在调用实现类的方法时，可以在方法执行前后做额外的工作，这个就是代理。&nbsp;</em></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第二步，我们要自己写一个在要代理类的方法执行时，能够做额外工作的类，而这个类必须继承InvocationHandler接口，&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>&nbsp;为什么要继承它呢？因为代理类的实例在调用实现类的方法的时候，不会调真正的实现类的这个方法，&nbsp;</em></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;而是转而调用这个类的invoke方法（继承时必须实现的方法），在这个方法中你可以调用真正的实现类的这个方法。&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>&nbsp;第三步，在要用代理类的实例去调用实现类的方法的时候，写出下面两段代码。&nbsp;</em></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XiangQinInterface&nbsp;proxy&nbsp;=&nbsp;(XiangQinInterface)&nbsp;Proxy.newProxyInstance(&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zhangSan.getClass().getClassLoader(),&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zhangSan.getClass().getInterfaces(),&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;ReadyInvocationHandler(zhangSan));&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxy.xiangQin();&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>&nbsp;这里要解释下中部那段长长的代码的意思，以及具体做了哪些工作？&nbsp;</em></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第一，根据zhangSan.getClass().getClassLoader()这个要代理类的类加载器和&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>&nbsp;zhangSan.getClass().getInterfaces()要代理类所实现的所有的接口&nbsp;</em></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;作为参数调用Proxy.getProxyClass(ClassLoader&nbsp;loader,&nbsp;Class&lt;?&gt;…&nbsp;interfaces)&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>&nbsp;的方法返回代理类的java.lang.Class对象，也就是得到了java动态生成的代理类$Proxy0的Class对象。&nbsp;</em></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;同时，java还让这个动态生成的$Proxy0类实现了要代理类的实现的所有接口，并继承了Proxy接口。&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>&nbsp;第二，实例化这个动态生成的$Proxy0类的一个实例，实例化代理类的构造函数为Proxy(InvocationHandler&nbsp;h)，&nbsp;</em></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;也就是说要实例化这个动态生成的$Proxy0类，必须给它一个InvocationHandler参数，也就是我们自己实现的用来在代理类&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>&nbsp;方法执行前后做额外工作的类ReadyInvocationHandler。&nbsp;</em></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这段代码Proxy.newProxyInstance(zhangSan.getClass().getClassLoader(),zhangSan.getClass().getInterfaces(),new&nbsp;ReadyInvocationHandler(zhangSan))&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em>&nbsp;得到的其实是一个类名叫$Proxy0&nbsp;extends&nbsp;Proxy&nbsp;implements&nbsp;XiangQinInterface的类。&nbsp;</em></li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第三，将这个$Proxy0类强制转型成XiangQinInterface类型，调用xiangQin方法。&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;&nbsp;</li><li>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</li><li>} &nbsp;</li></ol></p><p>&nbsp;</p><p>参考</p><p><a href="http://www.iteye.com/topic/683613" target="_blank" rel="external">http://www.iteye.com/topic/683613</a></p><p><a href="http://hi.baidu.com/malecu/blog/item/45d4952b31bc0e27d52af17a.html" target="_blank" rel="external">http://hi.baidu.com/malecu/blog/item/45d4952b31bc0e27d52af17a.html</a></p><p>&nbsp;</p> 
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2012/02/27/Java-动态代理学习-Proxy-InvocationHandler/" class="archive-article-date">
  	<time datetime="2012-02-27T13:25:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2012-02-27</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Java/">Java</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-android：以文件方式读取数据库blob字段（使用MemoryFile）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2012/02/21/android：以文件方式读取数据库blob字段（使用MemoryFile）/">android：以文件方式读取数据库blob字段（使用MemoryFile）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
         <p></p><p>Android的ContentResolver中有一个接口叫openAssetFileDescriptor，在doc中的解释如下：</p><p></p>public final&nbsp;&nbsp;openAssetFileDescriptor&nbsp;(&nbsp;uri,&nbsp;&nbsp;mode)Since:&nbsp;API Level 3<p>Open a raw file descriptor to access data under a URI. This interacts with the underlying&nbsp;&nbsp;method of the provider associated with the given URI, to retrieve any file stored there.</p>Accepts the following URI schemes:<ul><li>content (SCHEME_CONTENT)</li><li>android.resource (SCHEME_ANDROID_RESOURCE)</li><li>file (SCHEME_FILE)</li></ul>The android.resource (SCHEME_ANDROID_RESOURCE) Scheme<p>A Uri object can be used to reference a resource in an APK file. The Uri should be one of the following formats:</p><ul><li>android.resource://package_name/id_number<br>package_name&nbsp;is your package name as listed in your AndroidManifest.xml. For examplecom.example.myapp<br>id_number&nbsp;is the int form of the ID.<br>The easiest way to construct this form isUri uri =Uri.parse(&quot;android.resource://com.example.myapp/&quot;+ R.raw.my_resource&quot;);</li><li>android.resource://package_name/type/name<br>package_name&nbsp;is your package name as listed in your AndroidManifest.xml. For examplecom.example.myapp<br>type&nbsp;is the string form of the resource type. For example,&nbsp;raw&nbsp;or&nbsp;drawable.&nbsp;name&nbsp;is the string form of the resource name. That is, whatever the file name was in your res directory, without the type extension. The easiest way to construct this form isUri uri =Uri.parse(&quot;android.resource://com.example.myapp/raw/my_resource&quot;);</li></ul><p></p><p></p><p>&nbsp;</p><p>该接口返回AssetFileDescriptor，可以像读文件一样操作读取该uri的内容。</p><p>对应的ContentProvider必须实现openAssetFile接口，可以参考Android联系人中ContactsProvider2.java的实现：</p><p></p><p>ContactsProvider中将数据库中查询到的Photo blob数据，封装成一个MemoryFile，然后将该MemoryFile封装为</p><p>AssetFileDescriptor返回。</p><p>&nbsp;</p><p></p><p></p><p>&nbsp; &nbsp; @Override</p><p>&nbsp; &nbsp; public AssetFileDescriptor openAssetFile(Uri uri, String mode) throws FileNotFoundException {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; int match = sUriMatcher.match(uri);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; switch (match) {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case CONTACTS_PHOTO: {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return openPhotoAssetFile(uri, mode,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Data._ID + &quot;=&quot; + Contacts.PHOTO_ID + &quot; AND &quot; + RawContacts.CONTACT_ID + &quot;=?&quot;</p><p>,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new String[]{uri.getPathSegments().get(1)});</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p><p>……</p><p></p><p></p><p>&nbsp; &nbsp; private AssetFileDescriptor openPhotoAssetFile(Uri uri, String mode, String selection,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; String[] selectionArgs)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; throws FileNotFoundException {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; if (!&quot;r&quot;.equals(mode)) {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; throw new FileNotFoundException(mDbHelper.exceptionMessage(&quot;Mode &quot; + mode</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + &quot; not supported.&quot;, uri));</p><p>&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; String sql =</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;SELECT &quot; + Photo.PHOTO + &quot; FROM &quot; + mDbHelper.getDataView() +</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot; WHERE &quot; + selection;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; SQLiteDatabase db = mDbHelper.getReadableDatabase();</p><p>&nbsp; &nbsp; &nbsp; &nbsp; return SQLiteContentHelper.getBlobColumnAsAssetFile(db, sql,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; selectionArgs);</p><p>&nbsp; &nbsp; }</p><p></p><p>&nbsp;</p><p></p><p>&nbsp; &nbsp; public static AssetFileDescriptor getBlobColumnAsAssetFile(SQLiteDatabase db, String sql,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; String[] selectionArgs) throws FileNotFoundException {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; try {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MemoryFile file = simpleQueryForBlobMemoryFile(db, sql, selectionArgs);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (file == null) {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; throw new FileNotFoundException(&quot;No results.&quot;);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return AssetFileDescriptor.fromMemoryFile(file);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; } catch (IOException ex) {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; throw new FileNotFoundException(ex.toString());</p><p>&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp; &nbsp; }</p><br><p>&nbsp; &nbsp; private static MemoryFile simpleQueryForBlobMemoryFile(SQLiteDatabase db, String sql,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; String[] selectionArgs) throws IOException {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; Cursor cursor = db.rawQuery(sql, selectionArgs);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; if (cursor == null) {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return null;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp; &nbsp; &nbsp; &nbsp; try {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!cursor.moveToFirst()) {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return null;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; byte[] bytes = cursor.getBlob(0);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (bytes == null) {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return null;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MemoryFile file = new MemoryFile(null, bytes.length);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file.writeBytes(bytes, 0, 0, bytes.length);</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file.deactivate();</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return file;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; } finally {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cursor.close();</p><p>&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp; &nbsp; }</p><br><p></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p></p> 
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2012/02/21/android：以文件方式读取数据库blob字段（使用MemoryFile）/" class="archive-article-date">
  	<time datetime="2012-02-21T03:18:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2012-02-21</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Android/">Android</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Android-KeyEvent-的-生命周期" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2012/02/17/Android-KeyEvent-的-生命周期/">Android KeyEvent 的 生命周期</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p> <strong>1、生成<br><br></strong>&nbsp; &nbsp;&nbsp; &nbsp; 存在这样一个线程，它不断地从driver读取Event，并把它放到RawEvent队列中。这个队列中的RawEvent既有按键，也有触摸、轨迹球等事件。<br><br>&nbsp; &nbsp;&nbsp; &nbsp; RawEvent队列中的每个RawEvent最后都会通过一系列转化，最终变为KeyEvent被发送给另外一个线程，即输入线程，也就是一个Activity的主线程。<br><br><strong>2、传递<br><br></strong>&nbsp; &nbsp;&nbsp; &nbsp; KeyEvent传递过程主要可以划分为三步：过滤器、View树、Activity<br><br>&nbsp; &nbsp;&nbsp; &nbsp; 过滤器部分主要对应着PhoneWindowManager.java中的interceptKeyTq和interceptKeyTi这两个方法。它们的代码可以在frameworks/base/policy/base/phone/com/android/internal/policy /impl/PhoneWindowManager.java中看到。<br><br>&nbsp; &nbsp;&nbsp; &nbsp; 这两个过滤器最大的不同就是interceptKeyTq用于RawEvent，而interceptKeyTi用于KeyEvent。<br><br>&nbsp; &nbsp;&nbsp; &nbsp; 在一个没有实体键盘的机器上，Power键会被interceptKeyTq这个过滤器吃掉用来调用关机对话框或者使机器休眠。而Home键会被 interceptKeyTi这个过滤器吃掉，用来把当前Activity切换到后台并把桌面程序切换到前台。所以，应用程序在View和 Activity的onKeyDown/Up中是监听不到这两个按键的。除了这两个键以外的按键，都有机会继续前进。接下来，KeyEvent会先经过 interceptKeyTi过滤器，如果这个过滤器不吃掉的话，就会继续前进，进入View树，如果没有被哪个View吃掉的话，最后进入到 Activity的onKeyDown/Up方法中。<br><br></p><p>&nbsp; &nbsp;&nbsp; &nbsp; 当一个KeyEvent经过上面的过程还没有被吃掉的话，系统就会利用它做一些定制的功能。比如音量键被系统用来调整声音，多媒体按键用来控制媒体播放，搜索键用来快速打开搜索功能，返回键用来退出当前Activity等。</p><p><br></p><p><br></p><p>参考：</p><p><a href="http://www.eoeandroid.com/thread-101185-1-1.html" target="_blank" rel="external">http://www.eoeandroid.com/thread-101185-1-1.html</a></p><p><a href="http://blog.csdn.net/Zengyangtech/article/details/5800853" target="_blank" rel="external">http://blog.csdn.net/Zengyangtech/article/details/5800853</a></p><p>&nbsp;</p><p></p> <p></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2012/02/17/Android-KeyEvent-的-生命周期/" class="archive-article-date">
  	<time datetime="2012-02-17T04:30:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2012-02-17</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Android/">Android</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Writing-an-Android-Sync-Provider-Part-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2012/01/10/Writing-an-Android-Sync-Provider-Part-2/">Writing an Android Sync Provider: Part 2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p> Writing an Android Sync Provider: Part 2January 23rd, 2010&nbsp;<a rel="external" title="Posts by Sam Steele" href="http://www.c99.org/author/admin/" target="_blank">Sam Steele</a>&nbsp;</p><p>One of the great new user-facing features of Android 2.0 is the is the new Facebook app, which brings your Facebook contacts and statuses into your Android contacts database:<br><a rel="external" href="http://www.c99.org/wp-content/uploads/2010/01/sms.png" target="_blank"><img height="229" width="300" src="http://img.pickbox.me/wp-content/uploads/pic/4ec1fa198618367a1ecd00922e738bd4b21ce54e.jpg"></a><br>So, how exactly does my Nexus One know that Chris is excited about the upcoming launch of his new mobile apps? The answer is a Contacts sync provider in the Facebook app. Read on to learn how to create your own!</p>Sync Providers<p>Sync providers are services that allow an Account to synchronize data on the device on a regular basis. Not quite sure how to create an Account? Read&nbsp;<a href="http://www.c99.org/2010/01/23/writing-an-android-sync-provider-part-1/" target="_blank" rel="external">part one</a>&nbsp;first! To implement a Contacts sync provider, we’ll need a service, some xml files, and the following permissions added to the AndroidManifest.xml:</p>AndroidManifest.xml snippet<ol><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.INTERNET&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.ACCESS_NETWORK_STATE&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.READ_CONTACTS&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.WRITE_CONTACTS&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.GET_ACCOUNTS&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.MANAGE_ACCOUNTS&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.AUTHENTICATE_ACCOUNTS&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.READ_SYNC_SETTINGS&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.WRITE_SYNC_SETTINGS&quot;&nbsp;/&gt;</li></ol>The Service<p>Similar to our Account Authenticator service, our Contacts Sync Provider service will return a subclass of<a href="http://developer.android.com/reference/android/content/AbstractThreadedSyncAdapter.html" target="_blank" rel="external">AbstractThreadedSyncAdapter</a>&nbsp;from the onBind method.</p>ContactsSyncAdapterService.java<ol><li>public&nbsp;class&nbsp;ContactsSyncAdapterService&nbsp;extends&nbsp;Service&nbsp;{</li><li>&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;TAG =&nbsp;&quot;ContactsSyncAdapterService&quot;;</li><li>&nbsp;private&nbsp;static&nbsp;SyncAdapterImpl sSyncAdapter =&nbsp;null;</li><li>&nbsp;private&nbsp;static&nbsp;ContentResolver mContentResolver =&nbsp;null;</li><li>&nbsp;</li><li>&nbsp;public&nbsp;ContactsSyncAdapterService()&nbsp;{</li><li>&nbsp;&nbsp;super();</li><li>&nbsp;}</li><li>&nbsp;</li><li>&nbsp;private&nbsp;static&nbsp;class&nbsp;SyncAdapterImpl&nbsp;extends&nbsp;AbstractThreadedSyncAdapter&nbsp;{</li><li>&nbsp;&nbsp;private&nbsp;Context&nbsp;mContext;</li><li>&nbsp;</li><li>&nbsp;&nbsp;public&nbsp;SyncAdapterImpl(Context&nbsp;context)&nbsp;{</li><li>&nbsp; &nbsp;super(context,&nbsp;true);</li><li>&nbsp; &nbsp;mContext = context;</li><li>&nbsp;&nbsp;}</li><li>&nbsp;</li><li>&nbsp; @Override</li><li>&nbsp;&nbsp;public&nbsp;void&nbsp;onPerformSync(Account account, Bundle extras,&nbsp;String&nbsp;authority, ContentProviderClient provider, SyncResult syncResult)&nbsp;{</li><li>&nbsp; &nbsp;try&nbsp;{</li><li>&nbsp; &nbsp; ContactsSyncAdapterService.performSync(mContext, account, extras, authority, provider, syncResult);</li><li>&nbsp; &nbsp;}&nbsp;catch&nbsp;(OperationCanceledException e)&nbsp;{</li><li>&nbsp; &nbsp;}</li><li>&nbsp;&nbsp;}</li><li>&nbsp;}</li><li>&nbsp;</li><li>&nbsp;@Override</li><li>&nbsp;public&nbsp;IBinder onBind(Intent intent)&nbsp;{</li><li>&nbsp; IBinder ret =&nbsp;null;</li><li>&nbsp; ret = getSyncAdapter().getSyncAdapterBinder();</li><li>&nbsp;&nbsp;return&nbsp;ret;</li><li>&nbsp;}</li><li>&nbsp;</li><li>&nbsp;private&nbsp;SyncAdapterImpl getSyncAdapter()&nbsp;{</li><li>&nbsp;&nbsp;if&nbsp;(sSyncAdapter ==&nbsp;null)</li><li>&nbsp; &nbsp;sSyncAdapter =&nbsp;new&nbsp;SyncAdapterImpl(this);</li><li>&nbsp;&nbsp;return&nbsp;sSyncAdapter;</li><li>&nbsp;}</li><li>&nbsp;</li><li>&nbsp;private&nbsp;static&nbsp;void&nbsp;performSync(Context&nbsp;context, Account account, Bundle extras,&nbsp;String&nbsp;authority, ContentProviderClient provider, SyncResult syncResult)</li><li>&nbsp; &nbsp;throws&nbsp;OperationCanceledException&nbsp;{</li><li>&nbsp; mContentResolver = context.getContentResolver();</li><li>&nbsp; Log.i(TAG,&nbsp;&quot;performSync: &quot;&nbsp;+ account.toString());</li><li>&nbsp;&nbsp;//This is where the magic will happen!</li><li>&nbsp;}</li><li>}</li></ol><p>The service is defined in AndroidManifest.xml like so:</p>AndroidManifest.xml snippet<ol><li>&lt;service&nbsp;android:name=&quot;.sync.ContactsSyncAdapterService&quot;</li><li>&nbsp;android:exported=&quot;true&quot;&nbsp;android:process=&quot;:contacts&quot;&gt;</li><li>&nbsp;&lt;intent-filter&gt;</li><li>&nbsp;&nbsp;&lt;action&nbsp;android:name=&quot;android.content.SyncAdapter&quot;&nbsp;/&gt;</li><li>&nbsp;&lt;/intent-filter&gt;</li><li>&nbsp;&lt;meta-data&nbsp;android:name=&quot;android.content.SyncAdapter&quot;</li><li>&nbsp;&nbsp;android:resource=&quot;@xml/sync_contacts&quot;&nbsp;/&gt;</li><li>&lt;/service&gt;</li></ol><p>Finally, we need an xml file to let Android know that our sync provider handles Contacts for the Account type we defined in part 1.</p>sync_contacts.xml<ol><li>&lt;sync-adapter&nbsp;xmlns:android=&quot;<a href="http://schemas.android.com/apk/res/android&amp;quot" target="_blank" rel="external">http://schemas.android.com/apk/res/android&amp;quot</a>;</li><li>&nbsp; &nbsp;&nbsp;android:contentAuthority=&quot;com.android.contacts&quot;</li><li>&nbsp; &nbsp;&nbsp;android:accountType=&quot;fm.last.android.account&quot;/&gt;</li></ol><p>At this point we have a sync provider that doesn’t do anything, but also shouldn’t crash the Android system. Just in case, lets test it in Dev Tools first. Start the Android emulator and launch the “Dev Tools” app, then scroll down to “Sync Tester”.<br><a rel="external" href="http://www.c99.org/wp-content/uploads/2010/01/synctester.png" target="_blank"><img height="241" width="300" src="http://img.pickbox.me/wp-content/uploads/pic/85199c510fb30f24103d4f4cc895d143ac4b036e.jpg"></a><br>The drop-down should confirm that com.android.contacts can be synced with the account type you’ve created. Select the entry for your account type and press the “Bind” button to connect to your sync service. If all goes well, Sync Tester will say it’s connected to your service. Now click “Start Sync” and select your account from the popup. Sync Tester will let you know that the sync succeeded (even though we didn’t actually do anything). At this point it should be safe to enable contact syncing from the Accounts &amp; Sync settings screen without Android crashing and rebooting.<br><a rel="external" href="http://www.c99.org/wp-content/uploads/2010/01/contactsync.png" target="_blank"><img height="225" width="300" src="http://img.pickbox.me/wp-content/uploads/pic/06898418367adab48f94640c8bd4b31c8601e44e.jpg"></a></p>Contacts<p>Lets take a moment to discuss how Contacts on Android work. Each sync account, such as Google or Facebook, creates its own set of RawContacts which the Android system then aggregates into the single list of contacts you see in the Dialer. The RawContacts table contains several fields that Sync Providers can use for whatever they like, and in this implementation we will use the SYNC1 field to store the RawContact’s Last.fm username.</p>Contact Data<p>Data, such as name, phone number, email address, etc. is stored in a table that references a RawContact ID. The Data table can contain anything you like, and there are several&nbsp;<a href="http://developer.android.com/reference/android/provider/ContactsContract.CommonDataKinds.html" target="_blank" rel="external">predefined MIME-types available</a>&nbsp;for phone numbers, email addresses, names, etc. Android will automatically try to combine RawContacts that contain the same name, email address, etc. into a single Contact, and the user can also combine and split Contacts manually from the contact edit screen.<br><a rel="external" href="http://www.c99.org/wp-content/uploads/2010/01/aggregate.png" target="_blank"><img height="300" width="180" src="http://img.pickbox.me/wp-content/uploads/pic/f1230d2442a7d9339c0f473cad4bd11372f0016e.jpg"></a></p>Custom Data Types<p>A sync provider can store additional data about a RawContact in the Data table, and provide an xml file to tell the Contacts app how to format this row. To create a custom MIME type, we need to add an additional meta-data tag to our service entry in AndroidManifest.xml to reference a new ContactsSource XML file:</p>AndroidManifest.xml snippet<ol><li>&lt;meta-data&nbsp;android:name=&quot;android.provider.CONTACTS_STRUCTURE&quot;</li><li>&nbsp;android:resource=&quot;@xml/contacts&quot;&nbsp;/&gt;</li></ol><p>This ContactsSource xml file will tell the Contacts app how to format our custom MIME-types. In the example below, we specify an icon, and tell the Contacts app to use the DATA2 and DATA3 columns to render the fields. Note that this file’s format doesn’t appear to be documented outside of the&nbsp;<a href="http://www.google.com/codesearch/p?hl=en#oOy_5JrVRNM/trunk/packages/apps/Contacts/src/com/android/contacts/model/ExternalSource.java&amp;q=ContactsDataKind&amp;sa=N&amp;cd=1&amp;ct=rc" target="_blank" rel="external">source code for the Contacts app</a>.</p>contacts.xml<ol><li>&lt;ContactsSource&nbsp;xmlns:android=&quot;<a href="http://schemas.android.com/apk/res/android&quot;&amp;gt" target="_blank" rel="external">http://schemas.android.com/apk/res/android&quot;&amp;gt</a>;</li><li>&nbsp;&lt;ContactsDataKind</li><li>&nbsp;&nbsp;android:icon=&quot;@drawable/icon&quot;</li><li>&nbsp;&nbsp;android:mimeType=&quot;vnd.android.cursor.item/vnd.fm.last.android.profile&quot;</li><li>&nbsp;&nbsp;android:summaryColumn=&quot;data2&quot;</li><li>&nbsp;&nbsp;android:detailColumn=&quot;data3&quot;</li><li>&nbsp;&nbsp;android:detailSocialSummary=&quot;true&quot;&nbsp;/&gt;</li><li>&lt;/ContactsSource&gt;</li></ol><p>Here’s how Facebook’s custom “Facebook Profile” field looks when rendered by the Contacts app:<br><a rel="external" href="http://www.c99.org/wp-content/uploads/2010/01/facebookprofile.png" target="_blank"><img height="185" width="300" src="http://img.pickbox.me/wp-content/uploads/pic/7888347adab44aede80ac1abb31c8701a08bfb4e.jpg"></a></p>Creating a RawContact<p>Now lets put all the above information together to create a RawContact for a Last.fm user. Our contacts will display only a name and a custom field that links to the user’s Last.fm profile. We store the user’s username in the RawContact’s SYNC1 field so we can easily look it up later. We will batch together the creation of the RawContact and the insertion of the Data, as Android will run an aggregation pass after each batch completes.</p>addContact method<ol><li>private&nbsp;static&nbsp;void&nbsp;addContact(Account account,&nbsp;String&nbsp;name,&nbsp;String&nbsp;username)&nbsp;{</li><li>&nbsp;Log.i(TAG,&nbsp;&quot;Adding contact: &quot;&nbsp;+ name);</li><li>&nbsp;ArrayList&lt;ContentProviderOperation&gt;&nbsp;operationList =&nbsp;new&nbsp;ArrayList&lt;ContentProviderOperation&gt;();</li><li>&nbsp;</li><li>&nbsp;//Create our RawContact</li><li>&nbsp;ContentProviderOperation.Builder&nbsp;builder = ContentProviderOperation.newInsert(RawContacts.CONTENT_URI);</li><li>&nbsp;builder.withValue(RawContacts.ACCOUNT_NAME, account.name);</li><li>&nbsp;builder.withValue(RawContacts.ACCOUNT_TYPE, account.type);</li><li>&nbsp;builder.withValue(RawContacts.SYNC1, username);</li><li>&nbsp;operationList.add(builder.build());</li><li>&nbsp;</li><li>&nbsp;//Create a Data record of common type ‘StructuredName’ for our RawContact</li><li>&nbsp;builder = ContentProviderOperation.newInsert(ContactsContract.Data.CONTENT_URI);</li><li>&nbsp;builder.withValueBackReference(ContactsContract.CommonDataKinds.StructuredName.RAW_CONTACT_ID,&nbsp;0);</li><li>&nbsp;builder.withValue(ContactsContract.Data.MIMETYPE, ContactsContract.CommonDataKinds.StructuredName.CONTENT_ITEM_TYPE);</li><li>&nbsp;builder.withValue(ContactsContract.CommonDataKinds.StructuredName.DISPLAY_NAME, name);</li><li>&nbsp;operationList.add(builder.build());</li><li>&nbsp;</li><li>&nbsp;//Create a Data record of custom type &quot;vnd.android.cursor.item/vnd.fm.last.android.profile&quot; to display a link to the Last.fm profile</li><li>&nbsp;builder = ContentProviderOperation.newInsert(ContactsContract.Data.CONTENT_URI);</li><li>&nbsp;builder.withValueBackReference(ContactsContract.Data.RAW_CONTACT_ID,&nbsp;0);</li><li>&nbsp;builder.withValue(ContactsContract.Data.MIMETYPE,&nbsp;&quot;vnd.android.cursor.item/vnd.fm.last.android.profile&quot;);</li><li>&nbsp;builder.withValue(ContactsContract.Data.DATA1, username);</li><li>&nbsp;builder.withValue(ContactsContract.Data.DATA2,&nbsp;&quot;Last.fm Profile&quot;);</li><li>&nbsp;builder.withValue(ContactsContract.Data.DATA3,&nbsp;&quot;View profile&quot;);</li><li>&nbsp;operationList.add(builder.build());</li><li>&nbsp;</li><li>&nbsp;try&nbsp;{</li><li>&nbsp; mContentResolver.applyBatch(ContactsContract.AUTHORITY, operationList);</li><li>&nbsp;}&nbsp;catch&nbsp;(Exception&nbsp;e)&nbsp;{</li><li>&nbsp; Log.e(TAG,&nbsp;&quot;Something went wrong during creation! &quot;&nbsp;+ e);</li><li>&nbsp; e.printStackTrace();</li><li>&nbsp;}</li><li>}</li></ol>Social status updates<p>Android keeps another table for social networking status updates. Inserting a record into this table will replace any previous status if the timestamp of the insert is newer than the previous timestamp, otherwise the previous record will remain and the new insert will be discarded. A status update record is associated with a Data record, in our implementation we will associate it with our Last.fm profile record. Status records contain the status text, a package name where resources are located, an icon resource, and a label resource. Below is a function that will insert a status update, as well as updating our Last.fm Profile Data record to display the last track the user listened to. Note that for efficiency purposes, we will send all the updates in a single batch, so Android will only run a single aggregation pass at the end.</p>updateContactStatus method<ol><li>private&nbsp;static&nbsp;void&nbsp;updateContactStatus(ArrayList&lt;ContentProviderOperation&gt;&nbsp;operationList,&nbsp;longrawContactId,&nbsp;Track&nbsp;track)&nbsp;{</li><li>&nbsp;Uri rawContactUri = ContentUris.withAppendedId(RawContacts.CONTENT_URI, rawContactId);</li><li>&nbsp;Uri entityUri = Uri.withAppendedPath(rawContactUri,&nbsp;Entity.CONTENT_DIRECTORY);</li><li>&nbsp;Cursor&nbsp;c = mContentResolver.query(entityUri,&nbsp;new&nbsp;String[]&nbsp;{&nbsp;RawContacts.SOURCE_ID,&nbsp;Entity.DATA_ID,Entity.MIMETYPE,&nbsp;Entity.DATA1&nbsp;},&nbsp;null,&nbsp;null,&nbsp;null);</li><li>&nbsp;try&nbsp;{</li><li>&nbsp;&nbsp;while&nbsp;(c.moveToNext())&nbsp;{</li><li>&nbsp; &nbsp;if&nbsp;(!c.isNull(1))&nbsp;{</li><li>&nbsp; &nbsp;&nbsp;String&nbsp;mimeType = c.getString(2);</li><li>&nbsp; &nbsp;&nbsp;String&nbsp;status =&nbsp;&quot;&quot;;</li><li>&nbsp; &nbsp;&nbsp;if&nbsp;(track.getNowPlaying()&nbsp;!=&nbsp;null&nbsp;&amp;&amp;&nbsp;track.getNowPlaying().equals(&quot;true&quot;))</li><li>&nbsp; &nbsp; &nbsp;status =&nbsp;&quot;Listening to &quot;&nbsp;+ track.getName()&nbsp;+&nbsp;&quot; by &quot;&nbsp;+ track.getArtist();</li><li>&nbsp; &nbsp;&nbsp;else</li><li>&nbsp; &nbsp; &nbsp;status =&nbsp;&quot;Listened to &quot;&nbsp;+ track.getName()&nbsp;+&nbsp;&quot; by &quot;&nbsp;+ track.getArtist();</li><li>&nbsp;</li><li>&nbsp; &nbsp;&nbsp;if&nbsp;(mimeType.equals(&quot;vnd.android.cursor.item/vnd.fm.last.android.profile&quot;))&nbsp;{</li><li>&nbsp; &nbsp; &nbsp;ContentProviderOperation.Builder&nbsp;builder = ContentProviderOperation.newInsert(ContactsContract.StatusUpdates.CONTENT_URI);</li><li>&nbsp; &nbsp; &nbsp;builder.withValue(ContactsContract.StatusUpdates.DATA_ID, c.getLong(1));</li><li>&nbsp; &nbsp; &nbsp;builder.withValue(ContactsContract.StatusUpdates.STATUS, status);</li><li>&nbsp; &nbsp; &nbsp;builder.withValue(ContactsContract.StatusUpdates.STATUS_RES_PACKAGE,&nbsp;&quot;fm.last.android&quot;);</li><li>&nbsp; &nbsp; &nbsp;builder.withValue(ContactsContract.StatusUpdates.STATUS_LABEL, R.string.app_name);</li><li>&nbsp; &nbsp; &nbsp;builder.withValue(ContactsContract.StatusUpdates.STATUS_ICON, R.drawable.icon);</li><li>&nbsp; &nbsp; &nbsp;if&nbsp;(track.getDate()&nbsp;!=&nbsp;null)&nbsp;{</li><li>&nbsp; &nbsp; &nbsp;&nbsp;long&nbsp;date =&nbsp;Long.parseLong(track.getDate())&nbsp;*&nbsp;1000;</li><li>&nbsp; &nbsp; &nbsp; builder.withValue(ContactsContract.StatusUpdates.STATUS_TIMESTAMP, date);</li><li>&nbsp; &nbsp; &nbsp;}</li><li>&nbsp; &nbsp; &nbsp;operationList.add(builder.build());</li><li>&nbsp;</li><li>&nbsp; &nbsp; &nbsp;builder = ContentProviderOperation.newUpdate(ContactsContract.Data.CONTENT_URI);</li><li>&nbsp; &nbsp; &nbsp;builder.withSelection(BaseColumns._ID +&nbsp;&quot; = ‘&quot;&nbsp;+ c.getLong(1)&nbsp;+&nbsp;&quot;’&quot;,&nbsp;null);</li><li>&nbsp; &nbsp; &nbsp;builder.withValue(ContactsContract.Data.DATA3, status);</li><li>&nbsp; &nbsp; &nbsp;operationList.add(builder.build());</li><li>&nbsp; &nbsp;&nbsp;}</li><li>&nbsp; &nbsp;}</li><li>&nbsp;&nbsp;}</li><li>&nbsp;}&nbsp;finally&nbsp;{</li><li>&nbsp; c.close();</li><li>&nbsp;}</li><li>}</li></ol><p>Here’s how the contact record looks after we’ve inserted a status update record and updated our data record:<br><a rel="external" href="http://www.c99.org/wp-content/uploads/2010/01/lastfmstatus.png" target="_blank"><img height="257" width="300" src="http://img.pickbox.me/wp-content/uploads/pic/f1b440a7d933c89584d93b34d11373f08302006e.jpg"></a></p>Putting It All Together<p>Now that we have our utility functions written, we can fill in the body of our performSync method. We’re going to take a very simple approach to syncing: we’ll grab the list of RawContact IDs currently associated with Last.fm usernames, and we’ll create a RawContact for any Last.fm friend that doesn’t currently have one. If a RawContact already exists, we’ll fetch their most recent track and post a status update. Note that this is a one-way sync, we’re not dealing with local deletions or changes.</p>performSync method<ol><li>private&nbsp;static&nbsp;void&nbsp;performSync(Context&nbsp;context, Account account, Bundle extras,&nbsp;String&nbsp;authority, ContentProviderClient provider, SyncResult syncResult)</li><li>&nbsp;&nbsp;throws&nbsp;OperationCanceledException&nbsp;{</li><li>&nbsp;HashMap&lt;String, Long&gt;&nbsp;localContacts =&nbsp;new&nbsp;HashMap&lt;String, Long&gt;();</li><li>&nbsp;mContentResolver = context.getContentResolver();</li><li>&nbsp;Log.i(TAG,&nbsp;&quot;performSync: &quot;&nbsp;+ account.toString());</li><li>&nbsp;</li><li>&nbsp;// Load the local Last.fm contacts</li><li>&nbsp;Uri rawContactUri = RawContacts.CONTENT_URI.buildUpon().appendQueryParameter(RawContacts.ACCOUNT_NAME, account.name).appendQueryParameter(</li><li>&nbsp; &nbsp;RawContacts.ACCOUNT_TYPE, account.type).build();</li><li>&nbsp;Cursor&nbsp;c1 = mContentResolver.query(rawContactUri,&nbsp;new&nbsp;String[]&nbsp;{&nbsp;BaseColumns._ID, RawContacts.SYNC1&nbsp;},null,&nbsp;null,&nbsp;null);</li><li>&nbsp;while&nbsp;(c1.moveToNext())&nbsp;{</li><li>&nbsp; localContacts.put(c1.getString(1), c1.getLong(0));</li><li>&nbsp;}</li><li>&nbsp;</li><li>&nbsp;ArrayList&lt;ContentProviderOperation&gt;&nbsp;operationList =&nbsp;new&nbsp;ArrayList&lt;ContentProviderOperation&gt;();</li><li>&nbsp;LastFmServer server = AndroidLastFmServerFactory.getServer();</li><li>&nbsp;try&nbsp;{</li><li>&nbsp; Friends friends = server.getFriends(account.name,&nbsp;&quot;&quot;,&nbsp;&quot;50&quot;);</li><li>&nbsp;&nbsp;for&nbsp;(User user : friends.getFriends())&nbsp;{</li><li>&nbsp; &nbsp;if&nbsp;(!localContacts.containsKey(user.getName()))&nbsp;{</li><li>&nbsp; &nbsp;&nbsp;if&nbsp;(user.getRealName().length()&nbsp;&gt;&nbsp;0)</li><li>&nbsp; &nbsp; &nbsp;addContact(account, user.getRealName(), user.getName());</li><li>&nbsp; &nbsp;&nbsp;else</li><li>&nbsp; &nbsp; &nbsp;addContact(account, user.getName(), user.getName());</li><li>&nbsp; &nbsp;}&nbsp;else&nbsp;{</li><li>&nbsp; &nbsp;&nbsp;Track[]&nbsp;tracks = server.getUserRecentTracks(user.getName(),&nbsp;&quot;true&quot;,&nbsp;1);</li><li>&nbsp; &nbsp;&nbsp;if&nbsp;(tracks.length&nbsp;&gt;&nbsp;0)&nbsp;{</li><li>&nbsp; &nbsp; &nbsp;updateContactStatus(operationList, localContacts.get(user.getName()), tracks[0]);</li><li>&nbsp; &nbsp;&nbsp;}</li><li>&nbsp; &nbsp;}</li><li>&nbsp;&nbsp;}</li><li>&nbsp;&nbsp;if(operationList.size()&nbsp;&gt;&nbsp;0)</li><li>&nbsp; &nbsp;mContentResolver.applyBatch(ContactsContract.AUTHORITY, operationList);</li><li>&nbsp;}&nbsp;catch&nbsp;(Exception&nbsp;e1)&nbsp;{</li><li>&nbsp;&nbsp;// TODO Auto-generated catch block</li><li>&nbsp; e1.printStackTrace();</li><li>&nbsp;}</li><li>}</li></ol>Contact visibility<p>By default, new contacts that you create from your sync provider are not shown by the Contacts app. Instead, it will show only contacts it has aggregated with other visible sources. To enable the display of contacts that only exist in your provider, press the Menu button and select “Display options”, then expand the entry for your account and tap the checkbox next to “All Contacts”. This is a good default, as I don’t really want my address book to be littered with hundreds of twitter contacts!</p>Final Thoughts<p>The Android platform is awesome. The lack of documentation, however, is quite disappointing. While it’s great that I can dig through the system source code while troubleshooting and figuring things out, I shouldn’t have to!</p><p>Sync providers require Android 2.0, which is currently only available on 2 devices. The Account modifications I made to our login activity will need to be reimplemented using class introspection in order to keep compatibility with Android 1.5.</p><p>This sync provider is far from complete — I still need to figure out how to control the sync interval, set my sync provider as read-only since local changes are ignored, I might grab the user’s avatar if they don’t currently have an icon, and add a fancy “Do you want to sync your contacts?” popup to the login process similar to Facebook’s.</p><p>Hopefully this will help other developers out there struggling with the lack of documentation, as I’m looking forward to seeing twitter status updates in the contacts app in the future!</p><p>The source code for the implementation referenced here is available in my&nbsp;<a href="http://github.com/c99koder/lastfm-android/" target="_blank" rel="external">Last.fm github project</a>&nbsp;under the terms of the GNU General Public License. A standalone sample project is also available&nbsp;<a href="http://github.com/c99koder/AndroidSyncProviderDemo" target="_blank" rel="external">here</a>&nbsp;under the terms of the Apache License 2.0. Google has also released their own sample sync provider on the&nbsp;<a href="http://developer.android.com/resources/samples/SampleSyncAdapter/index.html" target="_blank" rel="external">Android developer portal</a>that’s a bit more complete than mine.</p>Categories:&nbsp;<a rel="external" title="View all posts in Android" href="http://www.c99.org/category/android/" target="_blank">Android</a><p></p> <p></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2012/01/10/Writing-an-Android-Sync-Provider-Part-2/" class="archive-article-date">
  	<time datetime="2012-01-10T05:23:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2012-01-10</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Android/">Android</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/10/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><a class="page-number" href="/page/13/">13</a><span class="space">&hellip;</span><a class="page-number" href="/page/60/">60</a><a class="extend next" rel="next" href="/page/12/">Next &raquo;</a>
    </nav>
  


      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 jfo
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true
	}
</script>

<script src="/./main.js"></script>


    
<div class="tools-col">
  <ul class="btn-wrap">
    
      <li class="chose" data-hook="tools-section-all"><span class="text">全部</span><i class="icon-book"></i></li>
    
    
      <li data-hook="tools-section-tag"><span class="text">标签</span><i class="icon-price-tags"></i></li>
    
    
      <li data-hook="tools-section-friends"><span class="text">友链</span><i class="icon-link"></i></li>
    
    
      <li data-hook="tools-section-me"><span class="text">我</span><i class="icon-smile"></i></li>
    
  </ul>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all chose">
    	</section>
    

    
    	<section class="tools-section tools-section-tag">
    			<div class="widget tagcloud" id="js-tagcloud">
    				<ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">87</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Arduino-OpenWrt/">Arduino/OpenWrt</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/DefaultCategory/">DefaultCategory</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Distributed-Computing/">Distributed Computing</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/English/">English</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Google/">Google</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">25</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Life/">Life</a><span class="category-list-count">67</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">52</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux-App/">Linux App</a><span class="category-list-count">61</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux-Debug/">Linux Debug</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux-Virtualization/">Linux Virtualization</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mac-OS-X/">Mac OS X</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mobile/">Mobile</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Network/">Network</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Saying/">Saying</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/WebDev/">WebDev</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Windows/">Windows</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/c-c-template-gp-boost/">c++/c++ template/gp/boost</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/c-c-algorithm/">c/c++/algorithm</a><span class="category-list-count">36</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/cocos2d-x-模拟器/">cocos2d-x/模拟器</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/com组件/">com组件</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/framework/">framework</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/gcc-binutils-make-共享库/">gcc/binutils/make/共享库</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/js-html-python/">js/html/python</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/l4ka-pistachio-iguana/">l4ka::pistachio/iguana</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux-图形/">linux 图形</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python-js-php-html-mysql-http/">python/js/php/html/mysql/http</a><span class="category-list-count">46</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/reading/">reading</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/self-collect/">self_collect</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/unifiedkernel-wine-reactos/">unifiedkernel/wine/reactos</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/wordpress/">wordpress</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/产品/">产品</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/教育/">教育</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数学-物理/">数学/物理</a><span class="category-list-count">3</span></li></ul>
    			</div>
    	</section>
    

    
    	<section class="tools-section tools-section-friends">
  		
  			<div class="friends-wrap" id="js-friends">
  			
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://iguangba.pickbox.me/">爱逛吧</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.pickbox.me/">收藏夹</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://note.pickbox.me/">网络剪贴板</a>
  	        
  	        </div>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">jfojfo#gmail.com</div>
  	  	
    	</section>
    
  </div>
  
</div>

    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>