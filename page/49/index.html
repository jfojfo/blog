<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>jfo planet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="jfo planet">
<meta property="og:url" content="http://blog.pickbox.me/page/49/index.html">
<meta property="og:site_name" content="jfo planet">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="jfo planet">
  
    <link rel="alternative" href="/atom.xml" title="jfo planet" type="application/atom+xml">
  
  
    <link rel="icon" href="//favicon.ico">
  
  <script src="/style.js"></script>
  

</head>

<body>
  <div id="container">
    <div class="left-col">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="http://img.pickbox.me/wp-content/uploads/penguin.gif" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">jfo</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Hope is the best gift that tomorrow gives.</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a class="js-smart-menu" data-idx="0" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="1" href="javascript:void(0)">分类</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="2" href="javascript:void(0)">友链</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="3" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/jfojfo" title="github">github</a>
		        
					<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/jfojfo" title="zhihu">zhihu</a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-list"></i></div>
  		<h1 class="header-author js-mobile-header hide">jfo</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="http://img.pickbox.me/wp-content/uploads/penguin.gif" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">jfo</h1>
			</hgroup>
			
			<p class="header-subtitle">Hope is the best gift that tomorrow gives.</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/jfojfo" title="github">github</a>
			        
						<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/jfojfo" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
        
  
    <article id="post-PE文件格式示意图" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2007/07/21/PE文件格式示意图/">PE文件格式示意图</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p> <img class="blogimg" small="0" src="http://img.pickbox.me/wp-content/uploads/pic/198192efe2f0a6e7ce1b3eab.jpg"> </p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2007/07/21/PE文件格式示意图/" class="archive-article-date">
  	<time datetime="2007-07-21T02:58:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2007-07-21</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Windows/">Windows</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-pragma-comment-lib-Version-lib" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2007/07/21/pragma-comment-lib-Version-lib/">#pragma comment(lib,Version.lib);</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p> [zz]From MSDN<br><br>#pragma code_seg(&quot;.orpc&quot;)<br><br>#pragma comment( &quot;comment-type&quot; [, commentstring] )<br>Places a comment record into an object file or executable file. The comment-type is one of five predefined identifiers, described below, that specifies the type of comment record. The optional commentstring is a string literal that provides additional information for some comment types. Because commentstring is a string literal, it obeys all the rules for string literals with respect to escape characters, embedded quotation marks (&quot;), and concatenation. <br><strong>compiler </strong><br>Places the name and version number of the compiler in the object file. This comment record is ignored by the linker. If you supply a commentstring parameter for this record type, the compiler generates a warning. <br><strong>exestr </strong><br>Places commentstring in the object file. At link time this string is placed in the executable file. The string is not loaded into memory when the executable file is loaded; however, it can be found with a program that finds printable strings in files. One use for this comment-record type is to embed a version number or similar information in an executable file. <br><strong>lib </strong><br>Places a library-search record in the object file. This comment type must be accompanied by a commentstring parameter containing the name (and possibly the path) of the library that you want the linker to search. The library name follows the default library-search records in the object file; the linker searches for this library just as if you had named it on the command line provided that the library is not specified with /nodefaultlib. You can place multiple library-search records in the same source file; each record appears in the object file in the same order in which it is encountered in the source file. <br>If the order of the default library and an added library is important, compiling with the /Zl switch will prevent the default library name from being placed in the object module. A second comment pragma then can be used to insert the name of the default library after the added library. The libraries listed with these pragmas will appear in the object module in the same order they are found in the source code. <br><strong>linker </strong><br>Places a linker option in the object file. You can use this comment-type to specify a linker option instead of passing it to the command line or specifying it in the development environment. For example, you can specify the /include option to force the inclusion of a symbol: <br>#pragma comment(linker, &quot;/include:<strong>mySymbol&quot;)<br>Only the following linker options are available to be passed to the linker identifier: <br>/DEFAULTLIB <br>/EXPORT <br>/INCLUDE <br>/MERGE <br>/SECTION <br><strong>user </strong><br>Places a general comment in the object file. The commentstring parameter contains the text of the comment. This comment record is ignored by the linker. <br>The following pragma causes the linker to search for the EMAPI.LIB library while linking. The linker searches first in the current working directory and then in the path specified in the LIB environment variable.<br>#pragma comment( lib, &quot;emapi&quot; )<br>The following pragma causes the compiler to place the name and version number of the compiler in the object file:<br>#pragma comment( compiler )<br>Note&nbsp;&nbsp;     For comments that take a commentstring parameter, you can use a macro in any place where you would use a string literal, provided that the macro expands to a string literal. You can also concatenate any combination of string literals and macros that expand to string literals. For example, the following statement is acceptable:<br>#pragma comment( user, &quot;Compiled on &quot; </strong>DATE<strong> &quot; at &quot; </strong>TIME__ )<br><br><br>#pragma data_seg (&quot;.shared&quot;)<br>HWND&nbsp;&nbsp;&nbsp;   g_hPwdEdit = 0;<br>char&nbsp;&nbsp;&nbsp;   g_szPassword [128] = { ‘ ’ };<br>#pragma data_seg ()<br>#pragma comment(linker,&quot;/SECTION:.shared,RWS&quot;) <br><br>#pragma comment(linker, &quot;/export:Func=ForwarderDll.RealFunc&quot;)<br><br>#pragma comment(lib, &quot;E:\work\output\Test\MainExe_ForwarderDll\Debug\SelfDll.lib&quot;)<br><br><br>#pragma comment(linker, &quot;/ignore:4199&quot;)    // no imports found<br>#pragma message(&quot;automatic link to delayimp.lib&quot;)<br>#pragma comment(lib, &quot;delayimp.lib&quot;)<br>#pragma message(&quot;DLL3.dll will be delay loaded&quot;)<br>#pragma comment(linker, &quot;/delayload:DLL3.dll&quot;)<br> <br><br><br><br><br> </p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2007/07/21/pragma-comment-lib-Version-lib/" class="archive-article-date">
  	<time datetime="2007-07-21T02:30:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2007-07-21</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Windows/">Windows</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-zz-mingw中的dlltool工具的使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2007/07/19/zz-mingw中的dlltool工具的使用/">[zz]mingw中的dlltool工具的使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
         <p>/<em> This program allows you to build the files necessary to create<br>&nbsp;&nbsp;    DLLs to run on a system which understands PE format image files.<br>&nbsp;&nbsp;    (eg, Windows NT)</em></p><p>&nbsp;&nbsp;    See &quot;Peering Inside the PE: A Tour of the Win32 Portable Executable<br>&nbsp;&nbsp;    File Format&quot;, MSJ 1994, Volume 9 for more information.<br>&nbsp;&nbsp;    Also see &quot;Microsoft Portable Executable and Common Object File Format,<br>&nbsp;&nbsp;    Specification 4.1&quot; for more information.</p><p>&nbsp;&nbsp;    A DLL contains an export table which contains the information<br>&nbsp;&nbsp;    which the runtime loader needs to tie up references from a<br>&nbsp;&nbsp;    referencing program.</p><p>&nbsp;&nbsp;    The export table is generated by this program by reading<br>&nbsp;&nbsp;    in a .DEF file or scanning the .a and .o files which will be in the<br>&nbsp;&nbsp;    DLL.  A .o file can contain information in special  &quot;.drectve&quot; sections<br>&nbsp;&nbsp;    with export information.</p><p>&nbsp;&nbsp;    A DEF file contains any number of the following commands:</p><p><br>&nbsp;&nbsp;    NAME &lt;name&gt; [ , &lt;base&gt; ]<br>&nbsp;&nbsp;    The result is going to be &lt;name&gt;.EXE</p><p>&nbsp;&nbsp;    LIBRARY &lt;name&gt; [ , &lt;base&gt; ]<br>&nbsp;&nbsp;    The result is going to be &lt;name&gt;.DLL</p><p>&nbsp;&nbsp;    EXPORTS  ( (  ( &lt;name1&gt; [ = &lt;name2&gt; ] )<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    | ( &lt;name1&gt; = &lt;module-name&gt; . &lt;external-name&gt;))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    [ @ &lt;integer&gt; ] [ NONAME ] [CONSTANT] [DATA] [PRIVATE] ) <br>&nbsp;&nbsp;    Declares name1 as an exported symbol from the<br>&nbsp;&nbsp;    DLL, with optional ordinal number &lt;integer&gt;.<br>&nbsp;&nbsp;    Or declares name1 as an alias (forward) of the function &lt;external-name&gt;<br>&nbsp;&nbsp;    in the DLL &lt;module-name&gt;.</p><p>&nbsp;&nbsp;    IMPORTS  (  (&nbsp;&nbsp;    &lt;internal-name&gt; =&nbsp;&nbsp;    &lt;module-name&gt; . &lt;integer&gt; )<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    | ( [ &lt;internal-name&gt; = ] &lt;module-name&gt; . &lt;external-name&gt; )) <em><br>&nbsp;&nbsp;    Declares that &lt;external-name&gt; or the exported function whoes ordinal number<br>&nbsp;&nbsp;    is &lt;integer&gt; is to be imported from the file &lt;module-name&gt;.  If<br>&nbsp;&nbsp;    &lt;internal-name&gt; is specified then this is the name that the imported<br>&nbsp;&nbsp;    function will be refereed to in the body of the DLL.</em></p><p>&nbsp;&nbsp;    DESCRIPTION &lt;string&gt;<br>&nbsp;&nbsp;    Puts &lt;string&gt; into output .exp file in the .rdata section</p><p>&nbsp;&nbsp;    [STACKSIZE|HEAPSIZE] &lt;number-reserve&gt; [ , &lt;number-commit&gt; ]<br>&nbsp;&nbsp;    Generates –stack|–heap &lt;number-reserve&gt;,&lt;number-commit&gt;<br>&nbsp;&nbsp;    in the output .drectve section.  The linker will<br>&nbsp;&nbsp;    see this and act upon it.</p><p>&nbsp;&nbsp;    [CODE|DATA] &lt;attr&gt;+<br>&nbsp;&nbsp;    SECTIONS ( &lt;sectionname&gt; &lt;attr&gt;+ )<br>&nbsp;&nbsp;    &lt;attr&gt; = READ | WRITE | EXECUTE | SHARED<br>&nbsp;&nbsp;    Generates –attr &lt;sectionname&gt; &lt;attr&gt; in the output<br>&nbsp;&nbsp;    .drectve section.  The linker will see this and act<br>&nbsp;&nbsp;    upon it.</p><p><br>&nbsp;&nbsp;    A -export:&lt;name&gt; in a .drectve section in an input .o or .a<br>&nbsp;&nbsp;    file to this program is equivalent to a EXPORTS &lt;name&gt;<br>&nbsp;&nbsp;    in a .DEF file.</p><p> </p><p>&nbsp;&nbsp;    The program generates output files with the prefix supplied<br>&nbsp;&nbsp;    on the command line, or in the def file, or taken from the first<br>&nbsp;&nbsp;    supplied argument.</p><p>&nbsp;&nbsp;    The .exp.s file contains the information necessary to export<br>&nbsp;&nbsp;    the routines in the DLL.  The .lib.s file contains the information<br>&nbsp;&nbsp;    necessary to use the DLL’s routines from a referencing program.</p><p> </p><p>&nbsp;&nbsp;    Example:</p><p> file1.c:<br>&nbsp;&nbsp;    asm (&quot;.section .drectve&quot;);<br>&nbsp;&nbsp;    asm (&quot;.ascii &quot;-export:adef&quot;&quot;);</p><p>&nbsp;&nbsp;    void adef (char <em> s)<br>&nbsp;&nbsp;    {<br>&nbsp;&nbsp;&nbsp;&nbsp;    printf (&quot;hello from the dll %sn&quot;, s);<br>&nbsp;&nbsp;    }</em></p><p>&nbsp;&nbsp;    void bdef (char  s)<br>&nbsp;&nbsp;    {<br>&nbsp;&nbsp;&nbsp;&nbsp;    printf (&quot;hello from the dll and the other entry point %sn&quot;, s);<br>&nbsp;&nbsp;    }</p><p> file2.c:<br>&nbsp;&nbsp;    asm (&quot;.section .drectve&quot;);<br>&nbsp;&nbsp;    asm (&quot;.ascii &quot;-export:cdef&quot;&quot;);<br>&nbsp;&nbsp;    asm (&quot;.ascii &quot;-export:ddef&quot;&quot;);</p><p>&nbsp;&nbsp;    void cdef (char <em> s)<br>&nbsp;&nbsp;    {<br>&nbsp;&nbsp;&nbsp;&nbsp;    printf (&quot;hello from the dll %sn&quot;, s);<br>&nbsp;&nbsp;    }</em></p><p>&nbsp;&nbsp;    void ddef (char  s)<br>&nbsp;&nbsp;    {<br>&nbsp;&nbsp;&nbsp;&nbsp;    printf (&quot;hello from the dll and the other entry point %sn&quot;, s);<br>&nbsp;&nbsp;    }</p><p>&nbsp;&nbsp;    int printf (void)<br>&nbsp;&nbsp;    {<br>&nbsp;&nbsp;&nbsp;&nbsp;    return 9;<br>&nbsp;&nbsp;    }</p><p> themain.c:<br>&nbsp;&nbsp;    int main (void)<br>&nbsp;&nbsp;    {<br>&nbsp;&nbsp;&nbsp;&nbsp;    cdef ();<br>&nbsp;&nbsp;&nbsp;&nbsp;    return 0;<br>&nbsp;&nbsp;    }</p><p> thedll.def</p><p>&nbsp;&nbsp;    LIBRARY thedll<br>&nbsp;&nbsp;    HEAPSIZE 0x40000, 0x2000<br>&nbsp;&nbsp;    EXPORTS bdef @ 20<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    cdef @ 30 NONAME</p><p>&nbsp;&nbsp;    SECTIONS donkey READ WRITE<br>&nbsp;&nbsp;    aardvark EXECUTE</p><p> # Compile up the parts of the dll and the program</p><p>&nbsp;&nbsp;    gcc -c file1.c file2.c themain.c</p><p> # Optional: put the dll objects into a library<br># (you don’t have to, you could name all the object<br># files on the dlltool line)</p><p>&nbsp;&nbsp;    ar  qcv thedll.in file1.o file2.o<br>&nbsp;&nbsp;    ranlib thedll.in</p><p> # Run this tool over the DLL’s .def file and generate an exports<br># file (thedll.o) and an imports file (thedll.a).<br># (You may have to use -S to tell dlltool where to find the assembler).</p><p>&nbsp;&nbsp;    dlltool –def thedll.def –output-exp thedll.exp –output-lib thedll.lib</p><p> # Build the dll with the library and the export table</p><p>&nbsp;&nbsp;    ld -o thedll.dll thedll.exp thedll.in</p><p> # Link the executable with the import library</p><p>&nbsp;&nbsp;    gcc -o themain.exe themain.o thedll.lib</p><p> This example can be extended if relocations are needed in the DLL:</p><p> # Compile up the parts of the dll and the program</p><p>&nbsp;&nbsp;    gcc -c file1.c file2.c themain.c</p><p> # Run this tool over the DLL’s .def file and generate an imports file.</p><p>&nbsp;&nbsp;    dlltool –def thedll.def –output-lib thedll.lib</p><p> # Link the executable with the import library and generate a base file<br># at the same time</p><p>&nbsp;&nbsp;    gcc -o themain.exe themain.o thedll.lib -Wl,–base-file -Wl,themain.base</p><p> # Run this tool over the DLL’s .def file and generate an exports file<br># which includes the relocations from the base file.</p><p>&nbsp;&nbsp;    dlltool –def thedll.def –base-file themain.base –output-exp thedll.exp</p><p> # Build the dll with file1.o, file2.o and the export table</p><p>&nbsp;&nbsp;    ld -o thedll.dll thedll.exp file1.o file2.o  <em>/</em></p><p>/ .idata section description</p><p>&nbsp;&nbsp;    The .idata section is the import table.  It is a collection of several<br>&nbsp;&nbsp;    subsections used to keep the pieces for each dll together: .idata$[234567].<br>&nbsp;&nbsp;    IE: Each dll’s .idata$2’s are catenated together, each .idata$3’s, etc.</p><p>&nbsp;&nbsp;    .idata$2 = Import Directory Table<br>&nbsp;&nbsp;    = array of IMAGE_IMPORT_DESCRIPTOR’s.</p><p> DWORD&nbsp;&nbsp;    Import Lookup Table;  - pointer to .idata$4<br>DWORD&nbsp;&nbsp;    TimeDateStamp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    - currently always 0<br>DWORD&nbsp;&nbsp;    ForwarderChain;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    - currently always 0<br>DWORD&nbsp;&nbsp;    Name;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    - pointer to dll’s name<br>PIMAGE_THUNK_DATA FirstThunk; - pointer to .idata$5</p><p>&nbsp;&nbsp;    .idata$3 = null terminating entry for .idata$2.</p><p>&nbsp;&nbsp;    .idata$4 = Import Lookup Table<br>&nbsp;&nbsp;    = array of array of pointers to hint name table.<br>&nbsp;&nbsp;    There is one for each dll being imported from, and each dll’s set is<br>&nbsp;&nbsp;    terminated by a trailing NULL.</p><p>&nbsp;&nbsp;    .idata$5 = Import Address Table<br>&nbsp;&nbsp;    = array of array of pointers to hint name table.<br>&nbsp;&nbsp;    There is one for each dll being imported from, and each dll’s set is<br>&nbsp;&nbsp;    terminated by a trailing NULL.<br>&nbsp;&nbsp;    Initially, this table is identical to the Import Lookup Table.  However,<br>&nbsp;&nbsp;    at load time, the loader overwrites the entries with the address of the<br>&nbsp;&nbsp;    function.</p><p>&nbsp;&nbsp;    .idata$6 = Hint Name Table<br>&nbsp;&nbsp;    = Array of { short, asciz } entries, one for each imported function.<br>&nbsp;&nbsp;    The `short’ is the function’s ordinal number.</p><p>&nbsp;&nbsp;    .idata$7 = dll name (eg: &quot;kernel32.dll&quot;). (.idata$6 for ppc).  */</p> 
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2007/07/19/zz-mingw中的dlltool工具的使用/" class="archive-article-date">
  	<time datetime="2007-07-19T14:26:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2007-07-19</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/gcc-binutils-make-共享库/">gcc/binutils/make/共享库</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-ATL-style-virtual-function-implementation" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2007/07/18/ATL-style-virtual-function-implementation/">ATL-style virtual function implementation</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p> <a href="http://www.codeproject.com/wtl/wtl4mfc1.asp#readme" target="_blank">WTL for MFC Programmers, Part I - ATL GUI Classes</a><br>ATL-style templates</p><p>Even if you can read C++ templates without getting a headache, there are two things ATL does that might trip you up at first. Take this class for example:</p>class CMyWnd : public CWindowImpl&lt;CMyWnd&gt;<br>{<br>…<br>};<p>That actually is legal, because the C++ spec says that immediately after the <code>class CMyWnd</code> part, the name <code>CMyWnd</code> is defined and can be used in the inheritance list. The reason for having the class name as a template parameter is so ATL can do the second tricky thing, compile-time virtual function calls.</p><p>To see this in action, look at this set of classes:</p><img width="9" height="9" src="http://img.pickbox.me/wp-content/uploads/pic/other_site/www_codeproject_minus.gif"> Collapsetemplate &lt;class T&gt;<br>class B1<br>{<br>public: <br>    void SayHi() <br>    {<br> <strong>T<em> pT = static_cast&lt;T</em>&gt;(this);</strong>   // HUH?? I’ll explain this below<br> <br>        pT-&gt;PrintClassName();<br>    }<br> <br>    void PrintClassName() { cout &lt;&lt; &quot;This is B1&quot;; }<br>};<br> <br>class D1 : public B1&lt;D1&gt;<br>{<br>    // No overridden functions at all<br>};<br> <br>class D2 : public B1&lt;D2&gt;<br>{<br>    void PrintClassName() { cout &lt;&lt; &quot;This is D2&quot;; }<br>};<br> <br>int main()<br>{<br>D1 d1;<br>D2 d2;<br> <br>    d1.SayHi();    // prints &quot;This is B1&quot;<br>    d2.SayHi();    // prints &quot;This is D2&quot;<br> <br>    return 0;<br>}<p>The <code>static_cast&lt;T<em>&gt;(this)</em></code> is the trick here. It casts <code>this</code>, which is of type <code>B1</code>, to either <code>D1<em></em></code> or <code>D2</code> depending on which specialization is being invoked. Because template code is generated at compile-time, this cast is guaranteed to be safe, as long as the inheritance list is written correctly. (If you wrote <code>class D3 : public B1&lt;D2&gt;</code> you’d be in trouble.) It’s safe because the <code>this</code> object can <em>only</em> be of type <code>D1<em></em></code> or <code>D2</code> (as appropriate), and nothing else. Notice that this is almost exactly like normal C++ polymorphism, except that the <code>SayHi()</code> method isn’t virtual.</p><p>To explain how this works, let’s look at each call to <code>SayHi()</code>. In the first call, the specialization <code>B1&lt;D1&gt;</code> is being used, so the <code>SayHi()</code> code expands to:</p>void B1&lt;D1&gt;::SayHi()<br>{<br>D1<em> pT = static_cast&lt;D1</em>&gt;(this);<br> <br>    pT-&gt;PrintClassName();<br>}<p>Since <code>D1</code> does not override <code>PrintClassName()</code>, <code>D1</code>‘s base classes are searched. <code>B1</code> has a <code>PrintClassName()</code> method, so that is the one called.</p><p>Now, take the second call to <code>SayHi()</code>. This time, it’s using the specialization <code>B1&lt;D2&gt;</code>, and <code>SayHi()</code> expands to:</p>void B1&lt;D2&gt;::SayHi()<br>{<br>D2<em> pT = static_cast&lt;D2</em>&gt;(this);<br> <br>    pT-&gt;PrintClassName();<br>}<p>This time, <code>D2</code> <em>does</em> contain a <code>PrintClassName()</code> method, so that is the one that gets called.</p><p>The benefits of this technique are:</p><ul> <li>It doesn’t require using pointers to objects.  </li> <li>It saves memory because there is no need for vtbls.  </li> <li>It’s impossible to call a virtual function through a null pointer at runtime because of an uninitialized vtbl.  </li> <li>All function calls are resolved at compile time, so they can be optimized. </li></ul> <p></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2007/07/18/ATL-style-virtual-function-implementation/" class="archive-article-date">
  	<time datetime="2007-07-18T11:30:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2007-07-18</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/com组件/">com组件</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-com-proxy-stub" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2007/07/17/com-proxy-stub/">com proxy &amp; stub</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p> <img src="http://img.pickbox.me/wp-content/uploads/pic/3410673894f74a2497ddd8dd.jpg" small="0" class="blogimg"> </p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2007/07/17/com-proxy-stub/" class="archive-article-date">
  	<time datetime="2007-07-17T15:13:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2007-07-17</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/com组件/">com组件</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-今天是被小鸟叫醒的" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2007/07/17/今天是被小鸟叫醒的/">今天是被小鸟叫醒的</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p> 一大早，被一只小鸟的叫声叫醒了，清澈响亮，睁开模糊的眼睛，找了半天，终于在阳台上找到了它。不多久又来了一只，于是成了一对，一起叫着。<br>我都不好意思不起床了。<br><br>这几天一直在研究技术，在公司就拼命干活，貌似小boss发威了，时不时的就凑过小脑袋来问&ldquo;怎么样？&rdquo;，我都快产生恐惧心理了，还好我觉悟比较高，多少总得认真一回，给项目组做些东西，留下点东西，顺便也可以多学一点wine下.dll和.so的知识，于是中午不睡觉也这样过着。回到实验室就研究一下COM组件相关的东东。于是就这样技术下去，都快麻木不仁了，其实一直都在麻木着，也许这样才比较容易度过这个暑假。一直都没有运动，严重虚弱，一定要锻炼，就是太懒。。。<img width="26" height="25" src="http://img.pickbox.me/wp-content/uploads/pic/other_site/img_baidu_i_f09.gif">总找借口把它一不小心给忘掉。。。<br><br>晚上去楼顶透透气，不知道grape以前在机房的时候是不是也会出来溜溜呢<img src="http://img.pickbox.me/wp-content/uploads/pic/other_site/img_baidu_i_f01.gif">，发现山那边总有几束光，突然发现那应该就是音乐喷泉的灯了！原来它在那边，9:30左右有开放一次，灯光时强时弱，虽然此时只见其光不闻其声，但仍很壮观。决定了，这个暑假什么时候再去看一次。<br><br>保安大哥快要来了，就到这里了，闪人了。。。<br><br><br><br><br> </p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2007/07/17/今天是被小鸟叫醒的/" class="archive-article-date">
  	<time datetime="2007-07-17T14:13:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2007-07-17</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Life/">Life</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-link" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2007/07/15/link/">link</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p> <strong>COM/ATL</strong><br><a target="_blank" href="http://www.codeproject.com/wtl/wtl4mfc1.asp#readme">WTL for MFC Programmers, Part I - ATL GUI Classes</a><br><a href="http://www.codeproject.com/atl/com_atl.asp" target="_blank" rel="external">Beginner’s Tutorial: COM/ATL Simple Project</a><br><a href="http://www.codeproject.com/atl/udtdemo.asp" target="_blank" rel="external">Using User Defined Types in COM &amp; ATL</a><br><a href="http://www.codeproject.com/atl/atl_underthehood_.asp" target="_blank" rel="external">ATL Under the Hood - Part 1</a><br><a href="http://www.codeproject.com/atl/atl7attributes.asp" target="_blank" rel="external">ATL7 and Attributes</a><br><a href="http://www.codeproject.com/atl/migratingatlservices.asp" target="_blank" rel="external">Migrating ATL service applications to Visual C++.NET</a><br><a href="http://www.codeproject.com/com/CCOMThread.asp" target="_blank">Understanding The COM Single-Threaded Apartment Part 1</a><br><a href="http://www.codeproject.com/com/xyevent.asp" target="_blank" rel="external">http://www.codeproject.com/com/xyevent.asp</a><br><br><br><strong>XPCOM</strong><br><a target="_blank" href="http://www.xulplanet.com/references/xpcomref/">http://www.xulplanet.com/references/xpcomref/</a><br><a target="_blank" href="http://www.xulplanet.com/references/xpcomref/">http://www.xulplanet.com/references/xpcomref/</a><br><a href="http://developer.mozilla.org/en/docs/Creating_XPCOM_Components:Creating_the_Component_Code" target="_blank">http://developer.mozilla.org/en/docs/Creating_XPCOM_Components:Creating_the_Component_Code</a><br><a href="http://www.mozilla.org/projects/xpcom/" target="_blank">http://www.mozilla.org/projects/xpcom/</a><br><a href="http://www.mozilla.org/projects/xpcom/xpcom-standalone.html" target="_blank">http://www.mozilla.org/projects/xpcom/xpcom-standalone.html</a><br><a href="http://www.ibm.com/developerworks/webservices/library/co-xpcom5.html" target="_blank">http://www.ibm.com/developerworks/webservices/library/co-xpcom5.html</a><br><a target="_blank" href="http://developer.mozilla.org/en/docs/Download_Mozilla_Source_Code">http://developer.mozilla.org/en/docs/Download_Mozilla_Source_Code</a><br><a href="http://lxr.mozilla.org/seamonkey/source/xpcom/components/nsIModule.idl" target="_blank">http://lxr.mozilla.org/seamonkey/source/xpcom/components/nsIModule.idl</a><br><br><br><a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=323853"> https://bugzilla.mozilla.org/show_bug.cgi?id=323853</a><br><a target="_blank" href="http://www.mozilla.org/projects/xpcom/book/cxc/html/quicktour2.html"> http://www.mozilla.org/projects/xpcom/book/cxc/html/quicktour2.html</a><br><br><strong><br><br><br></strong><a href="http://www.codeproject.com/atl/atl_underthehood_.asp" target="_blank" rel="external"></a> </p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2007/07/15/link/" class="archive-article-date">
  	<time datetime="2007-07-15T15:02:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2007-07-15</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/com组件/">com组件</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-XPCOM-Part-2-XPCOM-component-basics-Back-to-top" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2007/07/15/XPCOM-Part-2-XPCOM-component-basics-Back-to-top/">XPCOM Part 2: XPCOM component basics Back to top</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p> <a href="http://www.ibm.com/developerworks/webservices/library/co-xpcom2.html" target="_blank">http://www.ibm.com/developerworks/webservices/library/co-xpcom2.html</a><br><br><br><br></p><p>The idea behind XPCOM as a technology is to provide a modular framework that is platform- and language-neutral. There is very little that a component written in C++ can do that can’t be done in JavaScript or some other scripting language. The mechanism used in XPCOM to accomplish this feat is a type library.</p><p><a name="h0">Type library</a></p><p>   A type library provides a common data format or interchange mechanism for describing the methods, attributes, parameters, and interfaces of a component. By establishing a common format, the same interfaces can be described across multiple platforms and multiple programming languages. This is useful for supporting a generic marshalling or proxy mechanism. Using the type info, a program can determine every parameter of any given method or attribute on some interface. With this knowledge, it can move data back and forth between the interface and some other environment. That other environment can be a scripting engine or a proxy mechanism for crossing thread, process, or network boundaries. In the case of a scripting engine, this is how a component gets defined in the scripting environment so that scripted code can invoke methods on a component’s interface. </p><p>XPConnect is an additional layer built on top of XPCOM that can marshal an XPCOM interface into the JavaScript engine by reading an XPCOM type library file. XPConnect also allows XPCOM components to be written entirely in JavaScript so you can have C++ code call a JS component, or use JS to load and manipulate a compiled C++ component. In addition to JavaScript, the Python language has been added as another scripting alternative using a mechanism similar to XPConnect.</p><br> <img width="100%" height="1" src="http://img.pickbox.me/wp-content/uploads/pic/other_site/www_ibm_blue_rule.gif"> <img width="16" height="16" src="http://img.pickbox.me/wp-content/uploads/pic/other_site/www_ibm_u_bold.gif"><br> <a href="http://www.ibm.com/developerworks/webservices/library/co-xpcom2.html#main" target="_blank" rel="external"><strong>Back to top</strong></a> <br><br><p><a name="h5">Macros and smart pointers</a></p><p>  To combat this type of error, XPCOM includes some C++ templates that allow you to declare a smart interface pointer. The templates give you a &quot;set and forget&quot; pointer. Set the pointer to an interface and it will remember to release the interface for you. Set the pointer to another interface and it will release the previous one. Sounds simple enough. You declare your smart pointer within the scope needed and assign it to an interface. You use the smart pointer as you would a plain vanilla interface pointer. When the smart pointer loses scope, its built-in destructor will call the <code>Release</code> method for you. </p><p>Taking a look at just about any Mozilla code that uses <code>nsCOMPtr</code> or <code>nsIPtr</code> you will see something like the code in Listing 5.</p><strong>Listing 5. Mozilla code using nsCOMPtr or nslPtr</strong>                                    nsresult nsExample::DoSomething(void)<br>{<br>  nsresult rv;<br>  nsCOMPtr&lt;nsIManager&gt; pManager;<br>  <em>aResult = nsnull;<br>  pManager = do_GetService(&quot;Some contract ID goes here&quot;);<br>  if (pManager == nsnull)<br>    return NS_ERROR_NOT_AVAILABLE;<br>  rv = pManager-&gt;ManageSomething(); // do some more work here …<br>  return rv;<br>}<br><br> <br><p>In Listing 5, a smart pointer to the fictional <code>nsIManager</code> interface is declared with the name <code>pManager</code> (see the line that starts with &quot;<code>nsCOMPtr ..</code>&quot;). The smart pointer is assigned to some service. After testing that a valid pointer was indeed returned, the code above dereferences the pointer to call the <code>ManageSomething()</code> method.  When the above function returns, the <code>pManager</code> smart pointer will be destroyed –  but not before calling <code>Release</code> on the interface pointer held inside.</p><p>XPCOM expedites a lot of the declaratory grunt work demanded by C++ through the use of a family of C macros. Most interfaces return a <code>nsresult</code>. In most cases, the magic value to check for in an <code>nsresult</code> is <code>NS_OK</code>. (For an exhaustive list of <code>nsresult</code> values take a look at <code>nsError.h</code>.)</p><p>The XPCOM include files <code>nsCom.h, nsDebug.h, nsError.h, nsIServiceManager.h</code> and <code>nsISupportsUtils.h</code> provide some additional macros for testing, debugging and implementation.</p><p>When you browse the header files of various C++ XPCOM components you’ll see <code>NS_DECL_ISUPPORTS</code> as part of the class definition. This macro provides the definitions for the <code>nsISupports</code> interface.</p><strong>Listing 6. Definitions for nsISupports</strong>                                    public:<br>    NS_IMETHOD QueryInterface(REFNSIID aIID void** aInstancePtr);<br>    NS<em>IMETHOD</em>(nsrefcnt) AddRef(void);<br>    NS<em>IMETHOD</em>(nsrefcnt) Release(void);<br>    nsrefcnt mRefCnt;<br><br> <br><p>When you browse a component’s corresponding implementation file, you’ll see another mysterious one-line macro named <code>NS_IMPL_ISUPPORTS1</code> (or similar). This macro provides the actual implementation of the <code>nsISupports</code> interface. The digit &quot;1&quot; at the end of the macro denotes the number of interfaces (besides <code>nsISupports</code>) that the component implements.  If a class implemented two interfaces it could use <code>NS_IMPL_ISUPPORTS2</code>.</p><p>Remember the <code>mRefCnt</code> data member above –  we’ll be making reference to it again shortly.</p><p>Here’s how the <code>NS_IMPL_ISUPPORTS1</code> macro is defined in <code>nsISupportsUtils.h</code>:</p><strong>Listing 7. NS_IMPL_ISUPPORTS1</strong>                                    #define NS_IMPL_ISUPPORTS1(_class, _interface) <br>  NS_IMPL_ADDREF(_class)                       <br>  NS_IMPL_RELEASE(_class)                      <br>  NS_IMPL_QUERY_INTERFACE1(_class, _interface)<br> <br><p>As you can see, it’s just defined in terms of three other macros. Digging further, we start with the definition for <code>NS_IMPL_ADDREF</code>:</p><strong>Listing 8. NS_IMPL_ADDREF</strong>                                    #define NS_IMPL_ADDREF(_class)                               <br>NS<em>IMETHODIMP</em>(nsrefcnt) _class::AddRef(void)                <br>{                                                            <br>  NS_PRECONDITION(PRInt32(mRefCnt) &gt;= 0, &quot;illegal refcnt&quot;);  <br>  NS_ASSERT_OWNINGTHREAD(_class);                            <br>  ++mRefCnt;                                                 <br>  NS_LOG_ADDREF(this, mRefCnt, #_class, sizeof(</em>this));      <br>  return mRefCnt;                                            <br>}<br> <br><p>Finally some real code to look at! Out of five lines of code, three of them are debugging macros that we can safely ignore. The last line of code is a return statement. Any code calling <code>AddRef</code> is supposed to discard the value returned, so we can ignore the return statement.  </p><p> The one line of code of interest to us is the <code>++mRefCnt</code> statement. All it does is increment a counter so every time we call <code>AddRef</code> on some interface, all we are doing (in all likelihood) is causing that component to increment some internal counter. Next, let’s peek at the <code>NS_IMPL_RELEASE</code> macro:</p><strong>Listing 9. NS_IMPL_RELEASE macro</strong>                                    #define NS_IMPL_RELEASE(_class)                              <br>NS<em>IMETHODIMP</em>(nsrefcnt) _class::Release(void)               <br>{                                                            <br>  NS_PRECONDITION(0 != mRefCnt, &quot;dup release&quot;);              <br>  NS_ASSERT_OWNINGTHREAD(_class);                            <br>  –mRefCnt;                                                 <br>  NS_LOG_RELEASE(this, mRefCnt, #_class);                    <br>  if (mRefCnt == 0) {                                        <br>    mRefCnt = 1; /<em> stabilize </em>/                             <br>    NS_DELETEXPCOM(this);                                    <br>    return 0;                                                <br>  }                                                          <br>  return mRefCnt;                                            <br>}<br> <br><p>Again, we’ve got three statements involving debugging macros that we can safely ignore, along with two return statements that we can ignore for reasons explained above.</p><p>The two statements we care about are <code>–mRefCnt</code>, which decrements the object’s counter and <code>if (mRefCnt == 0)</code>, which tests to see if the counter has reached a value of zero. The next couple of lines tell us that the object will delete itself when this internal counter reaches zero.</p><p>In summary, <code>AddRef</code> increments the counter, <code>Release</code> decrements the counter – and when the number of calls to <code>AddRef</code> equal the number of calls to <code>Release</code>, the net reference count becomes zero and the component destroys itself. This whole reference-counting idea is starting to look fairly straightforward.  Next we’ve got <code>NS_IMPL_QUERY_INTERFACE1</code> defined in Listing 10.</p><strong>Listing 10. NS_IMPL_QUERY_INTERFACE1</strong>                                    #define NS_IMPL_QUERY_INTERFACE1(_class, _i1)            <br>  NS_INTERFACE_MAP_BEGIN(_class)                         <br>    NS_INTERFACE_MAP_ENTRY(_i1)                          <br>    NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, _i1)   <br>  NS_INTERFACE_MAP_END<br> <br><p>Drat! More macros to look up. By now, all of the MFC coders are chuckling because they’ve seen this kind of macro indirection nonsense before. These macros are building an interface map for the component so their order and position is important to creating a <code>QueryInterface</code> implementation.  Undaunted by this indirection, we plow ahead and look at <code>NS_INTERFACE_MAP_BEGIN</code>.  It turns out that it’s just an alias for <code>NS_IMPL_QUERY_HEAD</code> which expands into the code in Listing 11.</p><strong>Listing 11. NS_INTERFACE_MAP_BEGIN</strong>                                    #define NS_IMPL_QUERY_HEAD(_class)                                       <br>NS_IMETHODIMP _class::QueryInterface(REFNSIID aIID, void<em>* aInstancePtr) <br>{                                                                        <br>  NS_ASSERTION(aInstancePtr, &quot;QueryInterface requires a non-NULL destination!&quot;); <br>  if ( !aInstancePtr )                                                   <br>    return NS_ERROR_NULL_POINTER;                                        <br>  nsISupports</em> foundInterface;<br> <br><p>The code in this macro doesn’t really do any work. It just provides the function’s declaratory preamble and some lightweight error checking in the form of a test for a null return pointer. There isn’t even a closing curly brace to complete the function so it’s logical to suspect this macro is intended to be followed by other macros that fill in rest of the code. This next macro does some of that work. <code>NS_INTERFACE_MAP_ENTRY</code> is just an alias for <code>NS_IMPL_QUERY_BODY</code>.</p><strong>Listing 12. NS_IMPL_QUERY_BODY</strong>                                    #define NS_IMPL_QUERY_BODY(_interface)                  <br>  if ( aIID.Equals(NS_GET_IID(_interface)) )            <br>    foundInterface = NS_STATIC_CAST(_interface<em>, this); <br>  else<br><br> <br><p>This is the critical snippet of code that does the matching for our interface map. Because of the way the if/else statements are structured, we can stack multiple <code>NS_IMPL_QUERY_BODY</code> macros in succession to build an interface map that will answer to any number of interface IDs. The next macro, <code>NS_INTERFACE_MAP_ENTRY_AMBIGUOUS</code>, is just an alias for <code>NS_IMPL_QUERY_BODY_AMBIGUOUS</code>.</p><strong>Listing 13. NS_IMPL_QUERY_BODY_AMBIGUOUS</strong>                                    #define NS_IMPL_QUERY_BODY_AMBIGUOUS(_interface, _implClass)             <br>  if ( aIID.Equals(NS_GET_IID(_interface)) )                             <br>    foundInterface = NS_STATIC_CAST(_interface</em>, NS_STATIC_CAST(_implClass<em>, this)); <br>  else<br><br> <br><p> <code>NS_IMPL_QUERY_BODY_AMBIGUOUS</code> looks like it is doing the same work as <code>NS_IMPL_QUERY_BODY</code> – which it is. The only extra work being done here is avoiding a compiler error when trying to return an interface pointer for <code>nsISupports</code> when there are two or more supported interfaces that derive from <code>nsISupports</code>. Any one of them is also a valid <code>nsISupports</code> interface pointer – so the dilemma for the C++ compiler is to choose which one. One requirement placed on an XPCOM interface-dispensing mechanism is that it always return the same pointer for the same interface ID – so this macro also helps to comply with this rule by specifying which <code>nsISupports</code>-derived interface pointer gets to be used as  the  <code>nsISupports</code> interface pointer. As Listing 14 illustrates, <code>NS_INTERFACE_MAP_END</code> is just an alias for <code>NS_IMPL_QUERY_TAIL_GUTS</code>.</p><strong>Listing 14. NS_IMPL_QUERY_TAIL_GUTS</strong>                                    #define NS_IMPL_QUERY_TAIL_GUTS    <br>    foundInterface = 0;            <br>  nsresult status;                 <br>  if ( !foundInterface )           <br>    status = NS_NOINTERFACE;       <br>  else                             <br>    {                              <br>      NS_ADDREF(foundInterface);   <br>      status = NS_OK;              <br>    }                              <br>  </em>aInstancePtr = foundInterface;  <br>  return status;                   <br>}<br> <br><p>At long last, we get to the end of the implementation of <code>QueryInterface</code>. This last snippet of code returns an error code of <code>NS_NOINTERFACE</code> if the caller’s interface ID does not match any of the IDs in its map.  If the caller’s interface ID matches one of the object’s supported interfaces, the code calls the object’s <code>AddRef</code> method and returns a pointer to the interface along with a result code of <code>NS_OK</code>.</p><p>The code we’ve just gone through is a stock implementation of <code>nsISupports</code> for a component with a single interface.  The stock implementations for supporting multiple interfaces are similar. Actual components may be written using one of the stock implementations or they may provide their own. In most cases, they will use the macros found in <code>nsISupportsUtils.h</code>. By now you should see why it is so important to be able to dissect C style macros – particularly those with nested definitions – if you want to be able to read and understand the mozilla/XPCOM code base.</p> <p></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2007/07/15/XPCOM-Part-2-XPCOM-component-basics-Back-to-top/" class="archive-article-date">
  	<time datetime="2007-07-15T13:46:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2007-07-15</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/com组件/">com组件</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-XPCOM-Part-3-Setting-up-XPCOM" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2007/07/15/XPCOM-Part-3-Setting-up-XPCOM/">XPCOM Part 3: Setting up XPCOM</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p> <a href="http://www.ibm.com/developerworks/webservices/library/co-xpcom3.html" target="_blank">http://www.ibm.com/developerworks/webservices/library/co-xpcom3.html</a><br><br>。。。<br><br></p><p><a name="h11">Enabling XPCOM in an application</a></p><p>   Before an application can actually begin using XPCOM components, there are a set of libraries that must be loaded and initialized for the XPCOM framework to operate. Here’s a sample app to do that: </p><strong>Listing 1. Sample app to load and initialize necessary libraries</strong>                                    #include &lt;stdio.h&gt;<br>#include &lt;nsIServiceManager.h&gt;<br>#include &lt;nsISomething.h&gt;<br><br>int main()<br>{<br>   static const char szContractId[] =<br>      &quot;Your component’s contract ID goes here&quot;;<br>   nsresult rv;<br><br>   // Initialize XPCOM and check for failure …<br>   rv = NS_InitXPCOM(nsnull, nsnull);<br>   if ( NS_FAILED(rv) )<br>   {<br>      printf(&quot;Calling NS_InitXPCOM returns [%x].n&quot;, rv);<br>      return -1;<br>   }<br><br>   // optional autoregistration - forces component manager to check for new components.<br>   (void)nsComponentManager::AutoRegister(nsIComponentManager::NS_Startup, nsnull);<br><br>   // Create an instance of our component<br>   nsCOMPtr<br> mysample = do_CreateInstance(szContractId, &amp;rv);<br>   if ( NS_FAILED(rv) )<br>   {<br>      printf(&quot;Creating component instance of %s fails.n&quot;, szContractId);<br>      return -2;<br>   }<br><br>   // Do something useful with your component …<br><br>   // (main body of code goes here)<br><br>   // Released any interfaces.<br><br>   // Shutdown XPCOM<br>   NS_ShutdownXPCOM(nsnull);<br>   return 0;<br>}<br> <br><p>The two crucial calls are <code>NS_InitXPCOM</code> and <code>NS_ShutdownXPCOM</code>. The XPCOM core libraries are normally located in the same directory as the application, and an additional subdirectory named &quot;components&quot; is required.  Once XPCOM has been initialized, the two big XPCOM components of immediate interest for doing something productive are the Component Manager and the Service Manager. The call to AutoRegister is actually optional, and is really only needed when a new component is installed.</p><p>The above example assumes a stand-alone application that does not need browser support. <code>nsISomething</code> is a placebo for some actual interface. Real-world application code that makes use of the interface would be placed where the &quot;main body of code goes here&quot; comment appears above.</p><br> <img width="100%" height="1" src="http://img.pickbox.me/wp-content/uploads/pic/other_site/www_ibm_blue_rule.gif"> <img width="16" height="16" src="http://img.pickbox.me/wp-content/uploads/pic/other_site/www_ibm_u_bold.gif"><br> <a href="http://www.ibm.com/developerworks/webservices/library/co-xpcom3.html#main" target="_blank" rel="external"><strong>Back to top</strong></a> <br><br><p><a name="h12">Component manager</a></p><p>   The component manager does just what its name implies. It keeps track of what components are currently installed and what DLL or shared library must be loaded to create a specific component. The components subdirectory mentioned above is where the component manager expects to find any components. It scans this directory in the AutoRegister step above looking for components not already registered and adds a descriptive entry into a private map file. Subsequent requests for components happen much quicker because it already knows from the map which DLL or shared library to load. Components are identified in one of two ways: a 128-bit UUID known as a class ID or CID or a short text name known as a Contract ID.  </p><p> <em>Note to MSCOM programmers: a contract ID is functionally equivalent to an MSCOM Program ID or ProgID.</em> </p><p>Here are some core methods offered by the component manager in IDL. The first one looks up the class ID for a given contract ID. If you plan to create a lot of components of the same class and you only know the component’s contract ID, you can improve performance by calling this method first and using the shorter, faster class ID for subsequent calls to <code>createInstance</code>.</p>                                    void contractIDToClassID(in string aContractID, out nsCID aClass);<br> <br><p>This next method just does the inverse of the above:</p>                                    string CLSIDToContractID(in nsCIDRef aClass, out string aClassName);<br> <br><p>The following method verifies that some component has been registered and is therefore available for use:</p>                                    boolean isRegistered(in nsCIDRef aClass);<br> <br><p>The next two methods do all the grunt work for loading an arbitrary XPCOM component. You get your choice of identifying a component in the first parameter by class ID with <code>createInstance</code> or <code>contractID</code> in <code>createInstanceByContractID</code>. The second parameter <code>aDelegate</code> is only needed when you are doing what is called aggregation and is usually set to nsnull. The third parameter is the interface IID.</p>                                    voidPtr createInstance(in nsCIDRef aClass, in nsISupports aDelegate, in nsIIDRef aIID);<br>voidPtr createInstanceByContractID(in string aContractID, in nsISupports aDelegate, in nsIIDRef IID);<br> <br><p>The IDL source for all of the component manager methods can be found in <code>nsIComponentManager.idl</code>.</p><br> <img width="100%" height="1" src="http://img.pickbox.me/wp-content/uploads/pic/other_site/www_ibm_blue_rule.gif"> <img width="16" height="16" src="http://img.pickbox.me/wp-content/uploads/pic/other_site/www_ibm_u_bold.gif"><br> <a href="http://www.ibm.com/developerworks/webservices/library/co-xpcom3.html#main" target="_blank" rel="external"><strong>Back to top</strong></a> <br><br><p><a name="h13">Service manager</a></p><p>   XPCOM services are referred to in some books as singleton objects. No matter how many times you request a service you will always receive an interface to the same component. You’ve already seen the biggest service of them all  –  the component manager. How’s this for indirection: the service manager is itself a service. In a nutshell, the service manager takes care of loading and unloading services. When a request is made for a service that is already loaded, the service manager is smart enough to return another pointer to the existing service instead of trying to construct another object. Note how this behavior differs from the component manager which gives you a fresh new component on each request. Services are usually requested using the NS_WITH_SERVICE macro as illustrated in Listing 2. </p><strong>Listing 2. Service request</strong>                                    {  // enter scope of service smart pointer …<br>   NS_WITH_SERVICE(nsIMyService, service, kMyServiceCID, &amp;rv);<br>   if (NS_FAILED(rv)) return rv;<br>   service-&gt;DoSomething(…);    // use my service<br>} // leaving scope of service smart pointer …<br> <br><p>Note that the NS_WITH_SERVICE macro uses <code>nsCOMPtr</code> to create a smart pointer. Some examples of services are listed in Table 2.</p><strong>Table 2. Examples of services</strong> <ul> <li> LDAP</li> <li> WebShell</li> <li> JSRuntime</li> <li> Editor</li> </ul> <ul> <li> EventQueue</li> <li> RDF</li> <li> SMTP</li> </ul> <ul> <li> IMAP</li> <li> POP3</li> <li> NNTP</li> </ul> <ul> <li> DNS</li> <li> Error</li> <li> Logging</li> </ul> <br><br> <img width="100%" height="1" src="http://img.pickbox.me/wp-content/uploads/pic/other_site/www_ibm_blue_rule.gif"> <img width="16" height="16" src="http://img.pickbox.me/wp-content/uploads/pic/other_site/www_ibm_u_bold.gif"><br> <a href="http://www.ibm.com/developerworks/webservices/library/co-xpcom3.html#main" target="_blank" rel="external"><strong>Back to top</strong></a> <br><br><p><a name="h14">Category manager</a></p><p>  The component manager and service manager will fetch a component given its contract or class ID. How would you go about finding components without either of these? The answer to this question is the category manager. The category manager provides a directory of class IDs grouped into categories. When I say &quot;directory&quot; here, think phone book (as in the Yellow Pages) and not disk drive. Using the phone book analogy, if we wanted to find all of the hotels in the area, we could look up &quot;hotels&quot; in the phone book.</p><p>Suppose you’ve written a neat editor with lots of word processing features that supports multiple document types through a generic set of interfaces. The document types you chose to support are text, HTML, RTF and PDF  –  but you’ve also registered your document handlers under the &quot;document handler&quot; category and written your program to always check the document handler category to determine what document types are available.</p><p>Your friend decides your program desperately needs to support WordPerfect files so she creates a new document handler component that implements the same set of interfaces, and she registers it under the document handler category. Any user of your program can now download, install and begin using your friend’s new document handler without any extra work on your part.</p><p>Components grouped under a category usually have something in common, like a predefined set of interfaces. The category becomes an implied contract for any component registering itself under that category. Categories are a very powerful means of achieving object independence since the code that makes use of a category only cares about the interfaces and can divorce itself from any specific implementation. Despite this power, categories are one of the most under-used features of XPCOM.</p> <p></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2007/07/15/XPCOM-Part-3-Setting-up-XPCOM/" class="archive-article-date">
  	<time datetime="2007-07-15T13:39:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2007-07-15</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/com组件/">com组件</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-客户端" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2007/07/14/客户端/">客户端</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p> DictCtrl.cpp                                                                           //<br>// DictCtrl.cpp : Defines the entry point for the console application.<br>//<br><br>#include &quot;stdafx.h&quot;<br>#include &quot;windows.h&quot;<br>#include &lt;stdio.h&gt;<br>#include &lt;comutil.h&gt;<br><br>#include &quot;IDictionary.h&quot;<br>#include &quot;ISpellCheck.h&quot;<br><br>// {54BF6567-1007-11D1-B0AA-444553540000}<br>extern &quot;C&quot; const GUID CLSID_Dictionary = <br>  { 0x54bf6567, 0x1007, 0x11d1,<br>  { 0xb0, 0xaa, 0x44, 0x45, 0x53, 0x54, 0x00, 0x00} } ;<br><br>extern &quot;C&quot; const GUID IID_Dictionary = <br>  { 0x54bf6568, 0x1007, 0x11d1,<br>  { 0xb0, 0xaa, 0x44, 0x45, 0x53, 0x54, 0x00, 0x00} } ;<br><br>extern &quot;C&quot; const GUID IID_SpellCheck = <br>  { 0x54bf6569, 0x1007, 0x11d1,<br>  { 0xb0, 0xaa, 0x44, 0x45, 0x53, 0x54, 0x00, 0x00} } ;<br><br><br>int main(int argc, char<em> argv[])<br>{<br> IUnknown </em>pUnknown;<br> IDictionary <em>pDictionary;<br> ISpellCheck </em>pSpellCheck;<br> String stringResult;<br> BOOL bResult;<br> HRESULT hResult;<br><br> if (CoInitialize(NULL) != S_OK) {<br>  printf(&quot;Initialize COM library failed!n&quot;);<br>  return -1;<br> }<br><br> GUID dictionaryCLSID;<br> hResult = ::CLSIDFromProgID(L&quot;Dictionary.Object&quot;, &amp;dictionaryCLSID);<br> if (hResult != S_OK) <br> {<br>  printf(&quot;Can’t find the dictionary CLSID!n&quot;);<br>  return -2;<br> }<br> <br> hResult = CoCreateInstance(dictionaryCLSID, NULL, <br>  CLSCTX_INPROC_SERVER, IID_IUnknown, (void <strong>)&amp;pUnknown);<br> if (hResult != S_OK) <br> {<br>  printf(&quot;Create object failed!n&quot;);<br>  return -2;<br> }<br><br> hResult = pUnknown-&gt;QueryInterface(IID_Dictionary, (void </strong>)&amp;pDictionary);<br> if (hResult != S_OK) {<br>  pUnknown-&gt;Release();<br>  printf(&quot;QueryInterface IDictionary failed!n&quot;);<br>  return -3;<br> }<br> bResult = pDictionary-&gt;LoadLibrary(L&quot;animal.dict&quot;);<br> if (bResult) {<br>  String stringResult;<br>  bResult = pDictionary-&gt;LookupWord(L&quot;tiger&quot;, &amp;stringResult);<br> <br>  if (bResult) {<br>   char <em>pTiger = _com_util::ConvertBSTRToString(stringResult);<br>   printf(&quot;find the word &quot;tiger&quot; – %sn&quot;, pTiger);<br>   delete pTiger;<br>  }<br><br>  pDictionary-&gt;InsertWord(L&quot;elephant&quot;, L&quot;象&quot;);<br>  bResult = pDictionary-&gt;LookupWord(L&quot;elephant&quot;, &amp;stringResult);<br>  if (bResult) {<br><br>   pDictionary-&gt;RestoreLibrary(L&quot;animal1.dict&quot;);<br>  }<br> } else {<br>  printf(&quot;Load Library &quot;animal.dict&quot;n&quot;);<br> }<br> <br> hResult = pDictionary-&gt;QueryInterface(IID_SpellCheck, (void **)&amp;pSpellCheck);<br> pDictionary-&gt;Release();<br> if (hResult != S_OK) {<br>  pUnknown-&gt;Release();<br>  printf(&quot;QueryInterface IDictionary failed!n&quot;);<br>  return -4;<br> }<br><br> bResult = pSpellCheck-&gt;CheckWord(L&quot;lion&quot;, &amp;stringResult);<br> if (bResult) {<br>  printf(&quot;Word &quot;lion&quot; spelling right.n&quot;);<br> } else {<br>  char </em>pLion = _com_util::ConvertBSTRToString(stringResult);<br>  printf(&quot;Word &quot;lion&quot; spelling is wrong. Maybe it is %s.n&quot;, pLion);<br>  delete pLion;<br> }<br> bResult = pSpellCheck-&gt;CheckWord(L&quot;dot&quot;, &amp;stringResult);<br> if (bResult) {<br>  printf(&quot;Word &quot;dot&quot; spelling right.n&quot;);<br> } else {<br>  char *pDot = _com_util::ConvertBSTRToString(stringResult);<br>  printf(&quot;Word &quot;dot&quot; spelling is wrong. Maybe it is %s.n&quot;, pDot);<br>  delete pDot;<br> }<br><br> pSpellCheck-&gt;Release();<br> if (pUnknown-&gt;Release()== 0) <br>  printf(&quot;The reference count of dictionary object is zero.&quot;);<br><br> CoUninitialize();<br> return 0;<br>}<br><br> </p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2007/07/14/客户端/" class="archive-article-date">
  	<time datetime="2007-07-14T14:03:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2007-07-14</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/com组件/">com组件</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/48/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/47/">47</a><a class="page-number" href="/page/48/">48</a><span class="page-number current">49</span><a class="page-number" href="/page/50/">50</a><a class="page-number" href="/page/51/">51</a><span class="space">&hellip;</span><a class="page-number" href="/page/60/">60</a><a class="extend next" rel="next" href="/page/50/">Next &raquo;</a>
    </nav>
  


      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 jfo
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true
	}
</script>

<script src="/./main.js"></script>


    
<div class="tools-col">
  <ul class="btn-wrap">
    
      <li class="chose" data-hook="tools-section-all"><span class="text">全部</span><i class="icon-book"></i></li>
    
    
      <li data-hook="tools-section-tag"><span class="text">标签</span><i class="icon-price-tags"></i></li>
    
    
      <li data-hook="tools-section-friends"><span class="text">友链</span><i class="icon-link"></i></li>
    
    
      <li data-hook="tools-section-me"><span class="text">我</span><i class="icon-smile"></i></li>
    
  </ul>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all chose">
    	</section>
    

    
    	<section class="tools-section tools-section-tag">
    			<div class="widget tagcloud" id="js-tagcloud">
    				<ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">87</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Arduino-OpenWrt/">Arduino/OpenWrt</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/DefaultCategory/">DefaultCategory</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Distributed-Computing/">Distributed Computing</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/English/">English</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Google/">Google</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">25</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Life/">Life</a><span class="category-list-count">67</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">52</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux-App/">Linux App</a><span class="category-list-count">61</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux-Debug/">Linux Debug</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux-Virtualization/">Linux Virtualization</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mac-OS-X/">Mac OS X</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mobile/">Mobile</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Network/">Network</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Saying/">Saying</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/WebDev/">WebDev</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Windows/">Windows</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/c-c-template-gp-boost/">c++/c++ template/gp/boost</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/c-c-algorithm/">c/c++/algorithm</a><span class="category-list-count">36</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/cocos2d-x-模拟器/">cocos2d-x/模拟器</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/com组件/">com组件</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/framework/">framework</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/gcc-binutils-make-共享库/">gcc/binutils/make/共享库</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/js-html-python/">js/html/python</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/l4ka-pistachio-iguana/">l4ka::pistachio/iguana</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux-图形/">linux 图形</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python-js-php-html-mysql-http/">python/js/php/html/mysql/http</a><span class="category-list-count">46</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/reading/">reading</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/self-collect/">self_collect</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/unifiedkernel-wine-reactos/">unifiedkernel/wine/reactos</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/wordpress/">wordpress</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/产品/">产品</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/教育/">教育</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数学-物理/">数学/物理</a><span class="category-list-count">3</span></li></ul>
    			</div>
    	</section>
    

    
    	<section class="tools-section tools-section-friends">
  		
  			<div class="friends-wrap" id="js-friends">
  			
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://iguangba.pickbox.me/">爱逛吧</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.pickbox.me/">收藏夹</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://note.pickbox.me/">网络剪贴板</a>
  	        
  	        </div>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">jfojfo#gmail.com</div>
  	  	
    	</section>
    
  </div>
  
</div>

    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>