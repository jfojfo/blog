<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>jfo planet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="jfo planet">
<meta property="og:url" content="http://blog.pickbox.me/page/15/index.html">
<meta property="og:site_name" content="jfo planet">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="jfo planet">
  
    <link rel="alternative" href="/atom.xml" title="jfo planet" type="application/atom+xml">
  
  
    <link rel="icon" href="//favicon.ico">
  
  <script src="/style.js"></script>
  

</head>

<body>
  <div id="container">
    <div class="left-col">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="http://img.pickbox.me/wp-content/uploads/penguin.gif" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">jfo</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Hope is the best gift that tomorrow gives.</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a class="js-smart-menu" data-idx="0" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="1" href="javascript:void(0)">分类</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="2" href="javascript:void(0)">友链</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="3" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/jfojfo" title="github">github</a>
		        
					<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/jfojfo" title="zhihu">zhihu</a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-list"></i></div>
  		<h1 class="header-author js-mobile-header hide">jfo</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="http://img.pickbox.me/wp-content/uploads/penguin.gif" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">jfo</h1>
			</hgroup>
			
			<p class="header-subtitle">Hope is the best gift that tomorrow gives.</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/jfojfo" title="github">github</a>
			        
						<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/jfojfo" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
        
  
    <article id="post-The-11-JavaScript-Mistakes-you’re-Making" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2011/06/13/The-11-JavaScript-Mistakes-you’re-Making/">The 11 JavaScript Mistakes you’re Making</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
         <p><a href="http://net.tutsplus.com/tutorials/javascript-ajax/the-10-javascript-mistakes-youre-making/" target="_blank" rel="external">http://net.tutsplus.com/tutorials/javascript-ajax/the-10-javascript-mistakes-youre-making/</a></p><p>节选了一部分</p><p>&nbsp;</p><p>Mistake 2 -&nbsp;You’re Not Using Semicolons</p><p></p><p>For example, look at this simple function:</p><a href="http://net.tutsplus.com/tutorials/ -ajax/the-10- -mistakes-youre-making/#" target="_blank" rel="external"></a><p></p><p>function returnPerson (name) { &nbsp;</p><p>&nbsp; &nbsp; return &nbsp;</p><p>&nbsp; &nbsp; { &nbsp;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; name : name &nbsp;</p><p>&nbsp; &nbsp; }; &nbsp;</p><p>} &nbsp;</p><p></p><p>This looks like it should return a cute little object … but in reality, the JavaScript compiler assumes you meant to put a semicolon after&nbsp;return, and will therefore return nothing; that object will get ignored. Your solution would be to do this:</p><a href="http://net.tutsplus.com/tutorials/ -ajax/the-10- -mistakes-youre-making/#" target="_blank" rel="external"></a><p></p><p>return { &nbsp;</p><p>&nbsp; &nbsp; name : name &nbsp;</p><p>};</p><p>&nbsp;</p><p></p><p></p><p>Mistake 5 - You’re not Property-Checking when Using For-In</p><p>&nbsp;</p><p>We’re all familiar with iterating over arrays; however, you’ll probably find yourself wanting to iterate over the properties of an object. (Digression: the items in an array are actually just numbered properties in an object.) If you’ve done this before, you’ve used a for-in loop:</p><p>view plaincopy to clipboardprint?</p><p>&nbsp;</p><p>&nbsp; &nbsp;1. var prop, obj = { name: &quot;Joe&quot;, job: &quot;Coder&quot;, age: 25 }; &nbsp;</p><p>&nbsp; &nbsp;2. &nbsp;&nbsp;</p><p>&nbsp; &nbsp;3. for (var prop in obj) { &nbsp;</p><p>&nbsp; &nbsp;4. &nbsp; console.log(prop + &quot;: &quot; + obj[prop]); &nbsp;</p><p>&nbsp; &nbsp;5. } &nbsp;</p><p>&nbsp;</p><p>var prop, obj = { name: &quot;Joe&quot;, job: &quot;Coder&quot;, age: 25 };</p><p>&nbsp;</p><p>for (var prop in obj) {</p><p>&nbsp; console.log(prop + &quot;: &quot; + obj[prop]);</p><p>}</p><p>&nbsp;</p><p>If you run the above code, you should see this output:</p><p>&nbsp;</p><p>&nbsp; &nbsp;1. name: Joe &nbsp;</p><p>&nbsp; &nbsp;2. job: Coder &nbsp;</p><p>&nbsp; &nbsp;3. age: 25 &nbsp;</p><p>&nbsp;</p><p>name: Joe</p><p>job: Coder</p><p>age: 25</p><p>&nbsp;</p><p>However, browsers will include properties and methods from further up the prototype chain. Most of the time you won’t want to see these when enumerating properties. You should be using the hasOwnProperties to filter out properties that aren’t actually on the object:</p><p>view plaincopy to clipboardprint?</p><p>&nbsp;</p><p>&nbsp; &nbsp;1. Function Dog (name) { &nbsp;</p><p>&nbsp; &nbsp;2. &nbsp; &nbsp; this.name = name; &nbsp;</p><p>&nbsp; &nbsp;3. } &nbsp;</p><p>&nbsp; &nbsp;4. Dog.prototype.legs = 4; &nbsp;</p><p>&nbsp; &nbsp;5. Dog.prototype.speak = function () { &nbsp;</p><p>&nbsp; &nbsp;6. &nbsp; &nbsp; return &quot;woof!&quot;; &nbsp;</p><p>&nbsp; &nbsp;7. }; &nbsp;</p><p>&nbsp; &nbsp;8. &nbsp;&nbsp;</p><p>&nbsp; &nbsp;9. var d = new Dog(&quot;Bowser&quot;); &nbsp;</p><p>&nbsp; 10. &nbsp;&nbsp;</p><p>&nbsp; 11. for (var prop in d) { &nbsp;</p><p>&nbsp; 12. &nbsp; &nbsp; console.log( prop + &quot;: &quot; + d[prop] ); &nbsp;</p><p>&nbsp; 13. } &nbsp;</p><p>&nbsp; 14. &nbsp;&nbsp;</p><p>&nbsp; 15. console.log(&quot;=====&quot;); &nbsp;</p><p>&nbsp; 16. &nbsp;&nbsp;</p><p>&nbsp; 17. for (var prop in d) { &nbsp;</p><p>&nbsp; 18. &nbsp; if (d.hasOwnProperty(prop)) { &nbsp;</p><p>&nbsp; 19. &nbsp; &nbsp; console.log( prop + &quot;: &quot; + d[prop] ); &nbsp;</p><p>&nbsp; 20. &nbsp; } &nbsp;</p><p>&nbsp; 21. } &nbsp;</p><p>&nbsp; 22. &nbsp;&nbsp;</p><p>&nbsp; 23. // Output &nbsp;</p><p>&nbsp; 24. &nbsp;&nbsp;</p><p>&nbsp; 25. // name: Bowser &nbsp;</p><p>&nbsp; 26. // legs: 4 &nbsp;</p><p>&nbsp; 27. // speak: function () { &nbsp;</p><p>&nbsp; 28. &nbsp; &nbsp; &nbsp; &nbsp; return &quot;woof!&quot;; &nbsp;</p><p>&nbsp; 29. // } &nbsp;</p><p>&nbsp; 30. // ===== &nbsp;</p><p>&nbsp; 31. // name: Bowser &nbsp;</p><p>&nbsp;</p><p>Function Dog (name) {</p><p>&nbsp; &nbsp; this.name = name;</p><p>}</p><p>Dog.prototype.legs = 4;</p><p>Dog.prototype.speak = function () {</p><p>&nbsp; &nbsp; return &quot;woof!&quot;;</p><p>};</p><p>&nbsp;</p><p>var d = new Dog(&quot;Bowser&quot;);</p><p>&nbsp;</p><p>for (var prop in d) {</p><p>&nbsp; &nbsp; console.log( prop + &quot;: &quot; + d[prop] );</p><p>}</p><p>&nbsp;</p><p>console.log(&quot;=====&quot;);</p><p>&nbsp;</p><p>for (var prop in d) {</p><p>&nbsp; if (d.hasOwnProperty(prop)) {</p><p>&nbsp; &nbsp; console.log( prop + &quot;: &quot; + d[prop] );</p><p>&nbsp; }</p><p>}</p><p>&nbsp;</p><p>// Output</p><p>&nbsp;</p><p>// name: Bowser</p><p>// legs: 4</p><p>// speak: function () {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; return &quot;woof!&quot;;</p><p>// }</p><p>// =====</p><p>// name: Bowser</p><p>&nbsp;</p><p></p><p>&nbsp;</p><p></p><p>Mistake 9 - You’re Adding Elements to the DOM Individually</p><p>&nbsp;</p><p>All right, all right: this isn’t really JavaScript itself. But, in 99 of 100 cases, JavaScript means using the DOM. While there’s a lot of mistakes you can make when working with the DOM, this is a big one.</p><p>&nbsp;</p><p>I fondly remember the day when I inserted my first DOM element via JavaScript. It’s fun to do, and oh-so-useful, but it unfortunately is a strain on the page: inserting a DOM element forces the browser to completely repaint the page, so if you have a whole bunch of elements to add, adding them one by one is a bad idea:</p><p>view plaincopy to clipboardprint?</p><p>&nbsp;</p><p>&nbsp; &nbsp;1. var list = document.getElementById(&quot;list&quot;), &nbsp;</p><p>&nbsp; &nbsp;2. &nbsp; &nbsp; items = [&quot;one&quot;, &quot;two&quot;, &quot;three&quot;, &quot;four&quot;], &nbsp;</p><p>&nbsp; &nbsp;3. &nbsp; &nbsp; el; &nbsp;</p><p>&nbsp; &nbsp;4. &nbsp;&nbsp;</p><p>&nbsp; &nbsp;5. for (var i = 0; items[i]; i++) { &nbsp;</p><p>&nbsp; &nbsp;6. &nbsp; el = document.createElement(&quot;li&quot;); &nbsp;</p><p>&nbsp; &nbsp;7. &nbsp; el.appendChild( document.createTextNode(items[i]) ); &nbsp;</p><p>&nbsp; &nbsp;8. &nbsp; list.appendChild(el); // slow, bad idea &nbsp;</p><p>&nbsp; &nbsp;9. } &nbsp;</p><p>&nbsp;</p><p>var list = document.getElementById(&quot;list&quot;),</p><p>&nbsp; &nbsp; items = [&quot;one&quot;, &quot;two&quot;, &quot;three&quot;, &quot;four&quot;],</p><p>&nbsp; &nbsp; el;</p><p>&nbsp;</p><p>for (var i = 0; items[i]; i++) {</p><p>&nbsp; el = document.createElement(&quot;li&quot;);</p><p>&nbsp; el.appendChild( document.createTextNode(items[i]) );</p><p>&nbsp; list.appendChild(el); // slow, bad idea</p><p>}</p><p>&nbsp;</p><p>Here’s what you should do instead: use document fragments. Document fragments are a container to hold DOM elements; then instead of inserting each element individually, you can insert them all at once. The document fragment isn’t a node in itself and there will be nothing to show for it in the DOM: it’s just an invisible net for holding DOM elements before you put them into the DOM. So, here’s how you do it:</p><p>view plaincopy to clipboardprint?</p><p>&nbsp;</p><p>&nbsp; &nbsp;1. var list = document.getElementById(&quot;list&quot;), &nbsp;</p><p>&nbsp; &nbsp;2. &nbsp; &nbsp; frag = document.createDocumentFragment(), &nbsp;</p><p>&nbsp; &nbsp;3. &nbsp; &nbsp; items = [&quot;one&quot;, &quot;two&quot;, &quot;three&quot;, &quot;four&quot;], &nbsp;</p><p>&nbsp; &nbsp;4. &nbsp; &nbsp; el; &nbsp;</p><p>&nbsp; &nbsp;5. &nbsp;&nbsp;</p><p>&nbsp; &nbsp;6. for (var i = 0; items[i]; i++) { &nbsp;</p><p>&nbsp; &nbsp;7. &nbsp; el = document.createElement(&quot;li&quot;); &nbsp;</p><p>&nbsp; &nbsp;8. &nbsp; el.appendChild( document.createTextNode(items[i]) ); &nbsp;</p><p>&nbsp; &nbsp;9. &nbsp; frag.appendChild(el); // better! &nbsp;</p><p>&nbsp; 10. } &nbsp;</p><p>&nbsp; 11. &nbsp;&nbsp;</p><p>&nbsp; 12. list.appendChild(frag); &nbsp;</p><p>&nbsp;</p><p>var list = document.getElementById(&quot;list&quot;),</p><p>&nbsp; &nbsp; frag = document.createDocumentFragment(),</p><p>&nbsp; &nbsp; items = [&quot;one&quot;, &quot;two&quot;, &quot;three&quot;, &quot;four&quot;],</p><p>&nbsp; &nbsp; el;</p><p>&nbsp;</p><p>for (var i = 0; items[i]; i++) {</p><p>&nbsp; el = document.createElement(&quot;li&quot;);</p><p>&nbsp; el.appendChild( document.createTextNode(items[i]) );</p><p>&nbsp; frag.appendChild(el); // better!</p><p>}</p><p>&nbsp;</p><p>list.appendChild(frag);</p><p>&nbsp;</p><p>Faster, quicker, cleaner—what’s not to love?</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p></p><p></p> 
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2011/06/13/The-11-JavaScript-Mistakes-you’re-Making/" class="archive-article-date">
  	<time datetime="2011-06-13T03:41:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2011-06-13</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/python-js-php-html-mysql-http/">python/js/php/html/mysql/http</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-HTML5-in-5-minutes" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2011/06/13/HTML5-in-5-minutes/">HTML5 in 5 minutes</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
         <p>HTML5 in 5 minutes:</p><p><a href="http://v.youku.com/v_show/id_XMjc1NjAwMDI0.html" target="_blank">http://v.youku.com/v_show/id_XMjc1NjAwMDI0.html</a></p><p></p> 
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2011/06/13/HTML5-in-5-minutes/" class="archive-article-date">
  	<time datetime="2011-06-13T03:20:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2011-06-13</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/python-js-php-html-mysql-http/">python/js/php/html/mysql/http</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-New-Tricks-in-XMLHttpRequest2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2011/06/11/New-Tricks-in-XMLHttpRequest2/">New Tricks in XMLHttpRequest2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
         <p>&nbsp;</p><p><a target="_blank" href="http://www.html5rocks.com/en/tutorials/file/xhr2/">http://www.html5rocks.com/en/tutorials/file/xhr2/</a></p><p>&nbsp;</p><p>Introduction</p><p>One of the unsung heros in the HTML5 universe is XMLHttpRequest.  Strictly speaking XHR2 isn’t HTML5. However, it’s part of the incremental improvements  browser vendors are making to the core platform. I’m including XHR2 in our new bag of  goodies because it plays such an integral part in today’s complex web apps.</p><p>Turns out our old friend got a huge makeover but many folks  are unaware of its new features. <a href="http://dev.w3.org/2006/webapi/%20-2/" target="_blank" rel="external">XMLHttpRequest Level 2</a>  introduces a slew of new capabilities which put an end to crazy hacks in our web apps;  things like cross-origin requests, uploading progress events,  and support for uploading/downloading binary data. These allow AJAX  to work in concert with many of the bleeding edge HTML5 APIs such as <a href="http://www.html5rocks.com/tutorials/file/filesystem/" target="_blank" rel="external">File System API</a>,  <a href="http://chromium.googlecode.com/svn/trunk/samples/audio/specification/specification.html" target="_blank" rel="external">Web Audio API</a>,  and WebGL.</p><p>This tutorial highlights some of the new features in XMLHttpRequest,  especially those that can be used for <a href="http://www.html5rocks.com/tutorials/file/dndfiles/" target="_blank" rel="external">working with files</a>.</p>Fetching data<p>Fetching a file as a binary blob has been painful with XHR. Technically,  it wasn’t even possible. One trick that has been well documented involves  overriding the mime type with a user-defined charset as seen below.</p><p>The old way to fetch an image:</p>var xhr =newXMLHttpRequest();<br>xhr.open(‘GET’,’/path/to/image.png’,true);<br><br>// Hack to pass bytes through unprocessed.<br><b>xhr.overrideMimeType(‘text/plain; charset=x-user-defined’);</b><br><br>xhr.onreadystatechange =function(e){<br>&nbsp; if(this.readyState ==4&amp;&amp;this.status ==200){<br>&nbsp; &nbsp; var binStr =this.responseText;<br>&nbsp; &nbsp; for(var i =0, len = binStr.length; i &lt; len;++i){<br>&nbsp; &nbsp; &nbsp; <b>var c = binStr.charCodeAt(i);</b><br>&nbsp; &nbsp; &nbsp; <b>//String.fromCharCode(c &amp; 0xff);</b><br>&nbsp; &nbsp; &nbsp; <b>varbyte= c &amp;0xff; &nbsp;// byte at offset i</b><br>&nbsp; &nbsp; }<br>&nbsp; }<br>};<br><br>xhr.send();<p>While this works, what you actually get back in the responseText  is not a binary blob. It is a binary string representing the image file.  We’re tricking the server into passing the data back, unprocessed.  Even though this little gem works, I’m going to call it black magic and advise  against it. Anytime you resort to character code hacks and string manipulation  for coercing data into a desirable format, that’s a problem.</p>Specifying a response format<p>In the previous example, we downloaded the image as a binary &quot;file&quot;  by overriding the server’s mime type and processing the response text as a binary string.  Instead, let’s leverage XMLHttpRequest’s new  responseType and response properties to inform  the browser what format we want the data returned as.</p>xhr.<strong>responseType</strong><br>Before sending a request, set the xhr.responseType    to &quot;text&quot;, &quot;arraybuffer&quot;, &quot;blob&quot;, or &quot;document&quot;, depending on your data needs.    Note, setting xhr.responseType = ‘’ (or omitting) will default    the response to &quot;text&quot;.xhr.<strong>response</strong>After a successful request, the xhr’s response property will    contain the requested data as a DOMString, ArrayBuffer,    Blob, or Document (depending on what was set for    responseType.)<p>With this new awesomeness, we can rework the previous example, but this time,  fetch the image as an ArrayBuffer instead of a string. Handing the  buffer over to the BlobBuilder API creates a Blob:</p>BlobBuilder= window.MozBlobBuilder|| window.WebKitBlobBuilder|| window.BlobBuilder;<br><br>var xhr =newXMLHttpRequest();<br>xhr.open(‘GET’,’/path/to/image.png’,true);<br><b>xhr.responseType =’arraybuffer’;</b><br><br><b>xhr.onload</b>=function(e){<br>&nbsp; if(this.status ==200){<br>&nbsp; &nbsp; var bb =newBlobBuilder();<br>&nbsp; &nbsp; bb.append(<b>this.response</b>);// Note: not xhr.responseText<br><br>&nbsp; &nbsp; var blob = bb.getBlob(‘image/png’);<br>&nbsp; &nbsp; …<br>&nbsp; }<br>};<br><br>xhr.send();<p>Much nicer!</p>ArrayBuffer responses<p>An <a href="https://developer.mozilla.org/en/%20_typed_arrays/ArrayBuffer" target="_blank" rel="external">ArrayBuffer</a>    is a generic fixed-length container for binary data. They are super handy if you    need a generalized buffer of raw data, but the real power behind these guys is that    you can create &quot;views&quot; of the underlying data using <a href="https://developer.mozilla.org/en/%20_typed_arrays" target="_blank" rel="external">JavaScript typed arrays</a>.    In fact, multiple views can be created from a single ArrayBuffer source.    For example, you could create an 8-bit integer array that shares the same ArrayBuffer    as an existing 32-bit integer array from the same data. The underlying data    remains the same, we just create different representations of it.</p><p>As an example, the following fetches our same image as an ArrayBuffer,    but this time, creates an unsigned 8-bit integer array from that data buffer:</p>var xhr =newXMLHttpRequest();<br>xhr.open(‘GET’,’/path/to/image.png’,true);<br><b>xhr.responseType =’arraybuffer’;</b><br><br><b>xhr.onload</b>=function(e){<br>&nbsp; var uInt8Array =new<b>Uint8Array</b>(<b>this.response</b>);// this.response == uInt8Array.buffer<br>&nbsp; // var byte3 = uInt8Array[4]; // byte at offset 4<br>&nbsp; …<br>};<br><br>xhr.send();Blob responses<p>If you want to work directly with a <a href="https://developer.mozilla.org/en/DOM/Blob" target="_blank" rel="external">Blob</a> and/or  don’t need to manipulate any of the file’s bytes, use xhr.responseType=’blob’  (currently unimplemented in Chrome (<a href="http://crbug.com/52486" target="_blank" rel="external">crbug.com/52486</a>):</p>window.URL = window.URL || window.webkitURL; &nbsp;// Take care of vendor prefixes.<br><br>var xhr =newXMLHttpRequest();<br>xhr.open(‘GET’,’/path/to/image.png’,true);<br><b>xhr.responseType =’blob’;</b><br><br><b>xhr.onload</b>=function(e){<br>&nbsp; if(this.status ==200){<br>&nbsp; &nbsp; var blob =<b>this.response</b>;<br><br>&nbsp; &nbsp; var img = document.createElement(‘img’);<br>&nbsp; &nbsp; img.onload =function(e){<br>&nbsp; &nbsp; &nbsp; <b>window.URL.revokeObjectURL(img.src);</b>// Clean up after yourself.<br>&nbsp; &nbsp; };<br>&nbsp; &nbsp; img.src =<b>window.URL.createObjectURL(blob);</b><br>&nbsp; &nbsp; document.body.appendChild(img);<br>&nbsp; &nbsp; …<br>&nbsp; }<br>};<br><br>xhr.send();<p>A Blob can be used in a number of places, including savingit to <a href="http://www.html5rocks.com/tutorials/indexeddb/todo/" target="_blank" rel="external">indexedDB</a>, writing it to the HTML5 <a href="http://www.html5rocks.com/tutorials/file/filesystem/" target="_blank" rel="external">File System</a>,or <a href="http://www.html5rocks.com/tutorials/workers/basics/#toc-inlineworkers-bloburis" target="_blank" rel="external">creating an Blob URL</a>, as seenin this example.</p>Sending data<p>Being able to <a href="http://www.html5rocks.com/en/tutorials/file/xhr2/#toc-response" target="_blank" rel="external">download data in different formats</a> is great, but it doesn’t  get us anywhere if we can’t send these rich formats back to home base (the server).  XMLHttpRequest has limited us to sending DOMString  or Document (XML) data for some time. Not anymore. A revamped send()  method has been overridden to accept any of the following types:  DOMString, Document, FormData, Blob,  File, ArrayBuffer. The examples in the rest of this  section demonstrate sending data using each type.</p>Sending string data: xhr.send(DOMString)function sendText(txt){<br>&nbsp; var xhr =newXMLHttpRequest();<br>&nbsp; xhr.open(‘POST’,’/server’,true);<br>&nbsp; xhr.onload =function(e){<br>&nbsp; &nbsp; if(this.status ==200){<br>&nbsp; &nbsp; &nbsp; console.log(<b>this.responseText</b>);<br>&nbsp; &nbsp; }<br>&nbsp; };<br><br>&nbsp; xhr.send(txt);<br>}<br><br>sendText(<b>‘test string’</b>);function sendTextNew(txt){<br>&nbsp; var xhr =newXMLHttpRequest();<br>&nbsp; xhr.open(‘POST’,’/server’,true);<br>&nbsp; <b>xhr.responseType =’text’;</b><br>&nbsp; xhr.onload =function(e){<br>&nbsp; &nbsp; if(this.status ==200){<br>&nbsp; &nbsp; &nbsp; console.log(<b>this.response</b>);<br>&nbsp; &nbsp; }<br>&nbsp; };<br>&nbsp; xhr.send(txt);<br>}<br><br>sendText2(<b>‘test string’</b>);<p>There’s nothing new here, though the right snippet is slightly different.  It sets responseType=’text’ for comparison. Again, omitting that line  yields the same results.</p>Submitting forms: xhr.send(FormData)<p>Many people are probably accustomed to using <a href="http://jquery.malsup.com/form/" target="_blank" rel="external">jQuery plugins</a>  or other libraries to handle AJAX form submissions. Instead, we can use <a href="https://developer.mozilla.org/en/%20/FormData" target="_blank" rel="external">FormData</a>,  another new data type conceived for XHR2. FormData  is convenient for creating an HTML &lt;form&gt; on-the-fly, in JavaScript.  That form can then be submitted using AJAX:</p>function sendForm(){<br>&nbsp; var formData =new<b>FormData</b>();<br>&nbsp; <b>formData.append</b>(‘username’,’johndoe’);<br>&nbsp; <b>formData.append</b>(‘id’,123456);<br><br>&nbsp; var xhr =newXMLHttpRequest();<br>&nbsp; xhr.open(‘POST’,’/server’,true);<br>&nbsp; xhr.onload =function(e){…};<br><br>&nbsp; xhr.send(<b>formData</b>);<br>}<p>Essentially, we’re just dynamically creating a &lt;form&gt; and tacking on  &lt;input&gt; values to it by calling the append method.</p><p>Of course, you don’t need to create a &lt;form&gt; from scratch.  FormData objects can be initialized from and existing HTMLFormElement  on the page. For example:</p>&lt;formid=&quot;myform&quot;name=&quot;myform&quot;action=&quot;/server&quot;&gt;<br>&nbsp; &lt;inputtype=&quot;text&quot;name=&quot;username&quot;value=&quot;johndoe&quot;&gt;<br>&nbsp; &lt;inputtype=&quot;number&quot;name=&quot;id&quot;value=&quot;123456&quot;&gt;<br>&nbsp; &lt;inputtype=&quot;submit&quot;onclick=&quot;<b>return sendForm(this.form);</b>&quot;&gt;<br>&lt;/form&gt;function sendForm(form){<br>&nbsp; var formData =new<b>FormData</b>(form);<br><br>&nbsp; <b>formData.append</b>(‘secret_token’,’1234567890’);// Append extra data before send.<br><br>&nbsp; var xhr =newXMLHttpRequest();<br>&nbsp; xhr.open(‘POST’, form.action,true);<br>&nbsp; xhr.onload =function(e){…};<br><br>&nbsp; xhr.send(<b>formData</b>);<br><br>&nbsp; returnfalse;// Prevent page from submitting.<br>}<p>An HTML form can include file uploads (e.g. &lt;input type=&quot;file&quot;&gt;)  and  FormData can handle that too. Simply append the file(s) and the browser will  construct a multipart/form-data request when send() is called:</p>function uploadFiles(url, files){<br>&nbsp; var formData =new<b>FormData</b>();<br><br>&nbsp; for(var i =0, file; file = files[i];++i){<br>&nbsp; &nbsp; <b>formData.append(file.name, file);</b><br>&nbsp; }<br><br>&nbsp; var xhr =newXMLHttpRequest();<br>&nbsp; xhr.open(‘POST’, url,true);<br>&nbsp; xhr.onload =function(e){…};<br><br>&nbsp; xhr.send(<b>formData</b>); &nbsp;// multipart/form-data<br>}<br><br>document.querySelector(‘input[type=&quot;file&quot;]’).addEventListener(‘change’,function(e){<br>&nbsp; uploadFiles(‘/server’,this.files);<br>},false);Uploading a file or blob: xhr.send(Blob)<p>We can also send File or Blob data using XHR.  Keep in mind all Files are Blobs, so either works here.</p><p>This example creates a new text file from scratch using the BlobBuilder API  and uploads that Blob to the server. The code also sets up a handler  to inform the user of the upload’s progress:</p>&lt;progressmin=&quot;0&quot;max=&quot;100&quot;value=&quot;0&quot;&gt;0% complete&lt;/progress&gt;function upload(blobOrFile){<br>&nbsp; var xhr =newXMLHttpRequest();<br>&nbsp; xhr.open(‘POST’,’/server’,true);<br>&nbsp; xhr.onload =function(e){…};<br><br>&nbsp; // Listen to the upload progress.<br>&nbsp; var progressBar = document.querySelector(‘progress’);<br>&nbsp; <b>xhr.upload.onprogress</b>=function(e){<br>&nbsp; &nbsp; if(e.lengthComputable){<br>&nbsp; &nbsp; &nbsp; progressBar.value =(e.loaded / e.total)<em>100;<br>&nbsp; &nbsp; &nbsp; progressBar.textContent = progressBar.value;// Fallback for unsupported browsers.<br>&nbsp; &nbsp; }<br>&nbsp; };<br><br>&nbsp; xhr.send(<b>blobOrFile</b>);<br>}<br><br>// Take care of vendor prefixes.<br>BlobBuilder= window.MozBlobBuilder|| window.WebKitBlobBuilder|| window.BlobBuilder;<br><br>var bb =new<b>BlobBuilder</b>();<br><b>bb.append</b>(‘hello world’);<br><br>upload(<b>bb.getBlob(‘text/plain’)</b>);Uploading a chunk of bytes: xhr.send(ArrayBuffer)<p>Last but not least, we can send ArrayBuffers as the XHR’s payload.</p>function sendArrayBuffer(){<br>&nbsp; var xhr =newXMLHttpRequest();<br>&nbsp; xhr.open(‘POST’,’/server’,true);<br>&nbsp; xhr.onload =function(e){…};<br><br>&nbsp; <b>var uInt8Array =new</b><b>Uint8Array</b>([1,2,3]);<br><br>&nbsp; xhr.send(<b>uInt8Array.buffer</b>);<br><p>}</p><p></p><p>&nbsp;</p><p>&nbsp;</p><p>Practical examples</p><p><strong>Download + save files to the HTML5 file system</strong></p><p>Let’s say you have an image gallery and want to fetch a bunch  of images then save them locally using the <a href="http://www.html5rocks.com/tutorials/file/filesystem/" target="_blank" rel="external">HTML5 File System</a>.  One way to accomplish this would be to request images as ArrayBuffers,  build a Blob from the data, and write the blob using FileWriter:</p>window.requestFileSystem &nbsp;= window.requestFileSystem || window.webkiRequestFileSystem;<br><br>function onError(e){<br>&nbsp; console.log(‘Error’, e);<br>}<br><br>var xhr =newXMLHttpRequest();<br>xhr.open(‘GET’,’/path/to/image.png’,true);<br><b>xhr.responseType =’arraybuffer’;</b><br><br><b>xhr.onload</b>=function(e){<br><br>&nbsp; <b>window.requestFileSystem</b>(TEMPORARY,1024</em>1024,function(fs){<br>&nbsp; &nbsp; fs.root.getFile(‘image.png’,{create:true},function(fileEntry){<br>&nbsp; &nbsp; &nbsp; fileEntry.createWriter(function(writer){<br><br>&nbsp; &nbsp; &nbsp; &nbsp; writer.onwrite =function(e){…};<br>&nbsp; &nbsp; &nbsp; &nbsp; writer.onerror =function(e){…};<br><br>&nbsp; &nbsp; &nbsp; &nbsp; <b>var bb =newBlobBuilder();</b><br>&nbsp; &nbsp; &nbsp; &nbsp; <b>bb.append</b>(<b>this.response</b>);<br><br>&nbsp; &nbsp; &nbsp; &nbsp; <b>writer.write</b>(bb.getBlob(‘image/png’));<br><br>&nbsp; &nbsp; &nbsp; }, onError);<br>&nbsp; &nbsp; }, onError);<br>&nbsp; }, onError);<br>};<br><br>xhr.send();<p><strong>Note:</strong> to use this code, see <a href="http://www.html5rocks.com/tutorials/file/filesystem/#toc-support" target="_blank" rel="external">browser support &amp; storage limitations</a>  in the &quot;<a href="http://www.html5rocks.com/tutorials/file/filesystem/" target="_blank" rel="external">Exploring the FileSystem APIs</a>&quot; tutorial.</p><strong>Slicing a file and uploading each portion</strong><p>Using the <a href="http://www.html5rocks.com/tutorials/file/dndfiles/" target="_blank" rel="external">File APIs</a>, we can minimize  the work to upload a large file. The technique is to slice the upload into multiple chunks,  spawn an XHR for each portion, and put the file together on the server. This is  similar to how GMail uploads large attachments so quickly. Such a technique could also be  used to get around Google App Engine’s 32MB http request limit.</p>window.BlobBuilder= window.MozBlobBuilder|| window.WebKitBlobBuilder||<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;window.BlobBuilder;<br><br>function upload(blobOrFile){<br>&nbsp; var xhr =newXMLHttpRequest();<br>&nbsp; xhr.open(‘POST’,’/server’,true);<br>&nbsp; xhr.onload =function(e){…};<br>&nbsp; xhr.send(blobOrFile);<br>}<br><br>document.querySelector(‘input[type=&quot;file&quot;]’).addEventListener(‘change’,function(e){<br>&nbsp; var blob =this.files[0];<br><br>&nbsp; const BYTES_PER_CHUNK =1024*1024;// 1MB chunk sizes.<br>&nbsp; const SIZE = blob.size;<br><br>&nbsp; var start =0;<br>&nbsp; varend= BYTES_PER_CHUNK;<br><br>&nbsp; while(start &lt; SIZE){<br><br>&nbsp; &nbsp; // Note: blob.slice has changed semantics and been prefixed. See <a href="http://goo.gl/U9mE5" target="_blank" rel="external">http://goo.gl/U9mE5</a>.<br>&nbsp; &nbsp; if(‘mozSlice’in blob){<br>&nbsp; &nbsp; &nbsp; var chunk = blob.mozSlice(start,end);<br>&nbsp; &nbsp; }else{<br>&nbsp; &nbsp; &nbsp; var chunk = blob.webkitSlice(start,end);<br>&nbsp; &nbsp; }<br><br>&nbsp; &nbsp; upload(chunk);<br><br>&nbsp; &nbsp; start =end;<br>&nbsp; &nbsp; end= start + BYTES_PER_CHUNK;<br>&nbsp; }<br>},false);<br><br>})();<p>What is not shown here is the code to reconstruct the file on the server.</p><p><strong>Try it!</strong></p> 
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2011/06/11/New-Tricks-in-XMLHttpRequest2/" class="archive-article-date">
  	<time datetime="2011-06-11T04:01:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2011-06-11</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/python-js-php-html-mysql-http/">python/js/php/html/mysql/http</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-JavaScript-Equality-and-Identity" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2011/06/11/JavaScript-Equality-and-Identity/">JavaScript Equality (==) and Identity (===)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
         <p>The following rules are used to determine whether two values are identical according to the ===operator: </p><p>If the two values have different types, they are not identical. </p><p>If both values are numbers and have the same value, they are identical, unless either or both values are NaN, in which case they are not identical. The NaN value is never identical to any other value, including itself! To check whether a value is NaN, use the global isNaN( )function. </p><p>If both values are strings and contain exactly the same characters in the same positions, they are identical. If the strings differ in length or content, they are not identical. Note that in some cases, the Unicode standard allows more than one way to encode the same string. For efficiency, however, JavaScript string comparison compares strictly on a character-by-character basis, and it assumes that all strings have been converted to a &quot;normalized form&quot; before they are compared. See the &quot;String.localeCompare( )&quot; reference page in the core reference section of this book for another way to compare strings. </p><p>If both values are the boolean value true or both are the boolean value false, they are identical. </p><p>If both values refer to the same object, array, or function, they are identical. If they refer to different objects (or arrays or functions) they are not identical, even if both objects have identical properties or both arrays have identical elements. </p><p>If both values are nullor both values are undefined, they are identical. </p><p>&nbsp;</p><p>The following rules are used to determine whether two values are equal according to the ==operator: </p><p>If the two values have the same type, test them for identity. If the values are identical, they are equal; if they are not identical, they are not equal. </p><p>If the two values do not have the same type, they may still be equal. Use the following rules and type conversions to check for equality: </p><p>If one value is null and the other is undefined, they are equal. </p><p>If one value is a number and the other is a string, convert the string to a number and try the comparison again, using the converted value. </p><p>If either value is true, convert it to 1 and try the comparison again. If either value is false, convert it to 0 and try the comparison again. </p><p>If one value is an object and the other is a number or string, convert the object to a primitive and try the comparison again. An object is converted to a primitive value by either its toString( ) method or its valueOf( ) method. The built-in classes of core JavaScript attempt valueOf( ) conversion before toString( ) conversion, except for the Date class, which performs toString( ) conversion. Objects that are not part of core JavaScript may convert themselves to primitive values in an implementation-defined way. </p><p>Any other combinations of values are not equal. </p> 
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2011/06/11/JavaScript-Equality-and-Identity/" class="archive-article-date">
  	<time datetime="2011-06-11T03:19:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2011-06-11</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/python-js-php-html-mysql-http/">python/js/php/html/mysql/http</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-websocket与node-js的完美结合" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2011/06/10/websocket与node-js的完美结合/">websocket与node.js的完美结合</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
         <p>原文：<a target="_blank" href="http://cnodejs.org/blog/?p=273">http://cnodejs.org/blog/?p=273</a></p><p>之所以写下此文，是我觉得越是简单的技术往往能发挥越重要的作用，随着各种新的技术的诞生，实时web技术已经走进我们。websocket和node.js使开发实时应用非常简单，同时性能也非常高。</p><p><strong>关于websocket</strong></p><p>websocket是html5的重要feature，它直接在浏览器上对与socket的支持，这给了web开发无限的想象，虽然以前也有flashsocket+js的实现，不过毕竟不稳定，而且兼容性有很多问题，当然websocket的普及也依赖于支持html5标准的浏览器的更新，目前只有chrome、safari、firefox4.0等少数浏览器可以支持，不过大势所驱，加上智能移动设备的普及，websocket可以有更大的作为。</p><p>他解决了web实时化的问题，相比传统http有如下好处：</p>一个WEB客户端只建立一个TCP连接 Websocket服务端可以推送(push)数据到web客户端.有更加轻量级的头，减少数据传送量<p>本文来重点来分析下。</p>websocket的原理和应用<p>在继续本文之前，让我们了解下websocket的原理：</p><p>websocket通信协议实现的是基于浏览器的原生socket，这样原先只有在c/s模式下的大量开发模式都可以搬到web上来了，基本就是通过浏览器的支持在web上实现了与服务器端的socket通信。</p><p>WebSocket没有试图在HTTP之上模拟server推送，而是直接在TCP之上定义了帧协议，因此WebSocket能够支持双向的通信。</p><p>首先来介绍下websocket客户端与服务端建立连接的过程：</p><p>先用js创建一个WebSocket实例，使用ws协议建立服务器连接，ws://www.cnodejs.org:8088</p><p>ws开头是普通的websocket连接，wss是安全的websocket连接，类似于https。</p><p>客户端与服务端建立握手，发送如下信息：<br>GET /echo HTTP/1.1<br>Upgrade: WebSocket<br>Connection: Upgrade<br>Host: <a href="http://www.cnodejs.org:8088/" target="_blank" rel="external">http://www.cnodejs.org:8088</a><br>Origin: <a href="http://www.cnodejs.com/" target="_blank" rel="external">http://www.cnodejs.com</a><br>服务端会发回如下：<br>HTTP/1.1 101 Web Socket Protocol Handshake<br>Upgrade: WebSocket<br>Connection: Upgrade<br>WebSocket-Origin: <a href="http://www.cnodejs.org/" target="_blank" rel="external">http://www.cnodejs.org</a><br>WebSocket-Location: ws://www.cnodejs.org:8088/echo</p><p>具体的ws协议，可以参考： <a href="http://tools.ietf.org/html/draft-hixie-thewebsocketprotocol-76" target="_blank" rel="external">http://tools.ietf.org/html/draft-hixie-thewebsocketprotocol-76</a></p><p>我们在开发过程中不需要考虑协议的细节，因为websocket API已经帮我们封装好了。</p><p>需要注意的是所有的通信数据都是以”x00″开头以”xFF”结尾的，并且都是UTF-8编码的。</p><p>这个过程类似于http的建立连接过程，不同的是，建立连接之后，接下来客户端和服务端的任何交互都需要再有这个动作。客户端通过websocket API提供的如下4个事件进行编程：</p>onopen 建立连接后触发onmessage 收到消息后触发onerror 发生错误时触发onclose 关闭连接时触发<p>让我们全面了解一下websocket API，他其实非常简单，下面是所有的API：</p>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>[Constructor(in DOMString url,in optional DOMString protocols)]<br>[Constructor(in DOMString url,in optional DOMString[] protocols)]<br>interface WebSocket {<br>  readonly attribute DOMString url;<br>&nbsp;<br>// ready state<br>const unsigned short CONNECTING =0;<br>const unsigned short OPEN=1;<br>const unsigned short CLOSING =2;<br>const unsigned short CLOSED =3;<br>  readonly attribute unsigned short readyState;<br>  readonly attribute unsigned long bufferedAmount;<br>&nbsp;<br>// networking<br>           attribute Function onopen;<br>           attribute Function onmessage;<br>           attribute Functiononerror;<br>           attribute Function onclose;<br>  readonly attribute DOMString protocol;<br>void send(in DOMString data);<br>voidclose();<br>};<br>WebSocket implements EventTarget;<p>详细的websocket API，可以参考此文： <a href="http://dev.w3.org/html5/websockets/" target="_blank" rel="external">http://dev.w3.org/html5/websockets/</a></p>node.js与websocket的结合<p>终于讲到了正题了，node.js如何与websocket结合，websocket API是基于事件的，他是对于客户端而言，而对于服务端来说，如何来处理呢？其实可以简单的理解为实现websocket协议的socket server开发。</p><p>node.js天生就是一个高效的服务端语言，可以直接使用javascript直接来处理来自客户端的请求，这样如果服务端这边需要大量的业务逻辑开发，则可以直接使用node开发。通过node和websocket的结合可以开发出很多实时性要求很高的web应用，如游戏、直播、股票、监控、IM等等。</p><p>而node.js如何实现websocket的支持，已经有一个比较成熟的开源系统node-websocket-server： </p><p><a href="https://github.com/miksago/node-websocket-server" target="_blank" rel="external">https://github.com/miksago/node-websocket-server</a>&nbsp; ，让我们来探究一二：</p><p>其实原理也是很简单就是用node实现了websocket draft-76的协议，同时他对外提供了api，可以方便其他应用程序简化编程。</p><p>它继承了node的http.Server的事件和方法，这样它简化了服务端的编程，同时可以处理http的请求。</p><p>为了实现连接之间的通信和消息的广播，它实现了一个manager类，给每一个连接创建一个id，然后在内存中维护一个连接链表，并提供了上线和下线的自动管理。</p><p>它还提供对以下几个事件的接口：</p>listening 当服务器准备好接受客户端请求时request 当一个http 请求发生时触发streamcloseclientErrorerror<p>让我们看看一个node-websocket-server提供的一个server的例子：</p>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>var sys = require(&quot;sys&quot;)<br>, ws = require(‘../lib/ws/server’);<br>&nbsp;<br>var server = ws.createServer({debug:true});<br>&nbsp;<br>// Handle WebSocket Requests<br>server.addListener(&quot;connection&quot;,function(conn){<br>  conn.send(&quot;Connection: &quot;+conn.id);<br>&nbsp;<br>  conn.addListener(&quot;message&quot;,function(message){<br>    conn.broadcast(&quot;&lt;&quot;+conn.id+&quot;&gt; &quot;+message);<br>&nbsp;<br>if(message ==&quot;error&quot;){<br>      conn.emit(&quot;error&quot;,&quot;test&quot;);<br>}<br>});<br>});<br>&nbsp;<br>server.addListener(&quot;error&quot;,function(){<br>  console.log(Array.prototype.join.call(arguments,&quot;, &quot;));<br>});<br>&nbsp;<br>server.addListener(&quot;disconnected&quot;,function(conn){<br>  server.broadcast(&quot;&lt;&quot;+conn.id+&quot;&gt; disconnected&quot;);<br>});<br>&nbsp;<br>server.listen(8000);这个例子非常的简单，可以看到对于websocket的server端开发，我们已经不需要考虑websocket协议的实现，他几乎有着和客户端浏览器上websocketAPI一样的事件，只有对连接、断开连接、消息、错误等事件进行处理，这样应用的开发就非常的灵活了。实例：用websocket和node.js搭建实时监控系统<p>通过websocket打通了浏览器和服务端之后，我们就可以尝试搭建一个实际的应用，这里以实时监控系统为例。</p><p><a href="http://cnodejs.org/blog/wp-content/uploads/2011/02/mon_nodejs1.png" target="_blank" rel="external"><img class="alignnone size-full wp-image-299" src="http://img.pickbox.me/wp-content/uploads/pic/f9982a38e24ace7ab9998f0e.jpg" height="246" width="498"></a></p><p>直接与linux自身监控工具的结合，将监控结果通过websocket直接更到网页上，由于建立了socket长连接，绑定iostat的标准输出的事件，做到了真正的实时。同时可以支持对监控结果的讨论，增加了一个简单的chat，基于事件的通讯中，chat和监控同时发送完全不受影响，所以还可以把更多的事件加入进来。</p><p>让我们来看看这个过程：</p><p>首先是用node.js捕获iostat的输出：</p>1<br>2<br>3<br>4<br>5<br>6<br>var sys = require(&quot;sys&quot;)<br>, ws = require(‘../lib/ws/server’);<br>&nbsp;<br>var sys = require(‘sys’);<br>var spawn = require(‘child_process’).spawn;<br>var mon = spawn(&quot;iostat&quot;,[&quot;-I&quot;,&quot;5&quot;]);<p>spawn可以根据参数启动一个进程，同时可以对stdout, stderr, exit code进行捕获，当这些事件触发时，可以绑定我们的函数，同时捕获其输出。<br>这里是iostat的标准输出：<br><br>disk0       cpu     load average<br>KB/t tps  MB/s  us sy id   1m   5m   15m<br>14.64   4  0.06   7  5 88  0.76 0.95 0.90<br><br>我们捕获他的输出，将其发送到客户端去：</p>1<br>2<br>3<br>4<br>5<br>  mon.stdout.on(‘data’,function(data){<br>    data = format<em>string(data);<br>    sys.puts(data);<br>    conn.send(&quot;#mon:&quot;+data+&quot;&quot;);<br>});<p>客户端也就是浏览器，在收到消息后，对其进行简单的字符串处理，然后就可以直接在网页中输出了。</p>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>w.onmessage=function(e){<br>var msg = e.data;<br>if(msg.match(/#mon:/)){<br>var monarr = msg.split(&quot;:&quot;)[1].split(&quot; &quot;);<br>var body =&quot;&quot;;<br>for(varitemin monarr){<br>            body +=&quot;&lt;td id=’io</em>&quot;+item+&quot;’&gt;&quot;+monarr[item]+&quot;&lt;/td&gt;&quot;<br>}<br>        $(&quot;#iobody&quot;).html(body);<br>//log(monarr[0]);<br>&nbsp;<br>}<br>else<br>        log(e.data);<br>}<p>这里自定义了一个#mon的简单协议，这样可以对更多类型的输出分开处理。</p><p>服务端和客户端总共100多行的代码，就已经实现了一个实时服务器性能监控系统。<br>全部代码下载地址： <a href="http://cnodejs.googlecode.com/svn/trunk/monsocket/examples/" target="_blank" rel="external">http://cnodejs.googlecode.com/svn/trunk/monsocket/examples/</a><br>（注：本程序仅在mac osx下测试通过）</p><p>如果加上RGraph(基于html5)，则可以打造更加精美的实时展现: &nbsp;<a href="http://www.rgraph.net/docs/dynamic.html" target="_blank" rel="external">http://www.rgraph.net/docs/dynamic.html</a></p>总结<p>这篇文章适合node.js的初学者或者对于websocket不够了解的人，总结起来，就是以下几个点：</p>使用websocket API可以开发<strong>实时</strong>web应用websocket api和 node.js可以很完美的配合node-websocket-server 封装了websocket协议，使服务端进行websocket的开发，非常的简单node的易用性，使其在服务端略加编程，即可以打造一个完美的后台服务node的事件驱动的机制保证了系统的高效，可以使用EventEmitter定义自己的事件触发对于命令行输出可以使用spawn来捕获，通过在web应用中充分利用linux的各种系统工具<p><strong>参考资料</strong></p><p><a href="http://nodejs.org/" target="_blank" rel="external">http://nodejs.org/</a></p><p><a href="http://dev.w3.org/html5/websockets/" target="_blank" rel="external">http://dev.w3.org/html5/websockets/</a></p><p><a href="http://tools.ietf.org/html/draft-hixie-thewebsocketprotocol-76" target="_blank" rel="external">http://tools.ietf.org/html/draft-hixie-thewebsocketprotocol-76</a></p><p><a href="https://github.com/miksago/node-websocket-server" target="_blank" rel="external">https://github.com/miksago/node-websocket-server</a></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p><a href="https://github.com/miksago/node-websocket-server" target="_blank" rel="external"><br></a></p><p></p> 
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2011/06/10/websocket与node-js的完美结合/" class="archive-article-date">
  	<time datetime="2011-06-10T09:57:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2011-06-10</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/python-js-php-html-mysql-http/">python/js/php/html/mysql/http</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-关于JavaScript的单线程模型" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2011/06/10/关于JavaScript的单线程模型/">关于JavaScript的单线程模型</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
         <p>JS的执行原理：js引擎执行js代码的时候是单线程的，即同一时刻只会有一个进程执行JS代码，回调函数也是一个一个执行的（按照事件发生的顺序，而不是代码的顺序）。JS中的异步通信和定时是由另外的线程实现的，脱离js线程上下文。以JS定时操作举例，当JS引擎执行setTimeout(callbackFunction,100)操作时，它会通知定时线程我需要100毫秒的定时，之后JS引擎进入事件循环。100毫秒之后，定时引擎向事件队列中加入一个时间已到的事件。JS引擎从队列中读取时间已到的事件，执行callbackFunction。如果同一时间有多个事件加入事件队列，JS引擎也只会一个一个的执行callback。对于异步也是同样，JS代码发起通信请求，通信线程执行通信操作，并在操作完成后将完成事件加入事件队列。JS引擎从队列中取出事件并调用回调处理通信结果。JS引擎在执行回调函数的时候，不能同时响应其他事件。</p><p>&nbsp;</p><p>下面两幅图能很直观的说明问题：</p><p><img class="blogimg" small="0" src="http://img.pickbox.me/wp-content/uploads/pic/0c8fbc094252d17a6a60fb44.jpg"><br></p><p>&nbsp;</p><p><img class="blogimg" small="0" src="http://img.pickbox.me/wp-content/uploads/pic/cf3dc9ef213c6c68adafd540.jpg"><br></p><p>&nbsp;</p><p>参考：<br> </p><p><a target="_blank" href="http://www.phpv.net/html/1700.html">http://www.phpv.net/html/1700.html</a></p><p><a target="_blank" href="http://www.grati.org/?p=284">http://www.grati.org/?p=284</a></p> 
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2011/06/10/关于JavaScript的单线程模型/" class="archive-article-date">
  	<time datetime="2011-06-10T09:48:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2011-06-10</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/python-js-php-html-mysql-http/">python/js/php/html/mysql/http</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-JS实现-File-Download" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2011/06/03/JS实现-File-Download/">JS实现 File Download</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
         <p>problem:</p><p>Ajax is inable&nbsp;to receive a response in any form but text. Since it is now common for web applications to offer options for exporting your data in desktop app formats — such as .doc or .xls</p><p>&nbsp;</p><p>方法一：</p><p><a href="http://www.filamentgroup.com/lab/jquery_plugin_for_requesting_ajax_like_file_downloads/" target="_blank">&nbsp;http://www.filamentgroup.com/lab/jquery_plugin_for_requesting_ajax_like_file_downloads/</a></p><p></p><p>jQuery.download = function(url, data, method){</p><p>//url and data options required</p><p>if( url &amp;&amp; data ){&nbsp;</p><p>//data can be string of parameters or array/object</p><p>data = typeof data == ‘string’ ? data : jQuery.param(data);</p><p>//split params into form inputs</p><p>var inputs = ‘’;</p><p>jQuery.each(data.split(‘&amp;’), function(){&nbsp;</p><p>var pair = this.split(‘=’);</p><p>inputs+=’&lt;input type=&quot;hidden&quot; name=&quot;’+ pair[0] +’&quot; value=&quot;’+ pair[1] +’&quot; /&gt;’;&nbsp;</p><p>});</p><p>//send request</p><p>jQuery(‘&lt;form action=&quot;’+ url +’&quot; method=&quot;’+ (method||’post’) +’&quot;&gt;’+inputs+’&lt;/form&gt;’)</p><p>.appendTo(‘body’).submit().remove();</p><p>};</p><p>};</p><p>&nbsp;</p><p></p><p>$.download(‘/export.php’,’filename=mySpreadsheet&amp;format=xls&amp;content=’ + spreadsheetData );</p><br><p></p><p>&nbsp;</p><p>方法二：</p><p></p><p>Ajax的处理都是异步的，所以想实现文件下载这种同步的操作，就比较捉襟见肘。</p><p></p><p>不过google了一下，找到了一个方法，当然不是完美</p><p>主旨就是提交一个request，在server端将文件生成好，然后返回文件名，</p><p>client端则在js中隐藏一个frame，将frame的src指向生成的文件（根据返回的文件名）</p><p>&nbsp;</p><p>client:</p><p>Ext.Ajax.request({</p><p>url: ‘/csvoutput/‘,</p><p>success: function(r, o) {</p><p>obj = Ext.util.JSON.decode(r.responseText);</p><p>try {</p><p>Ext.destroy(Ext.get(‘downloadIframe’));</p><p>}</p><p>catch(e) {}</p><p>Ext.DomHelper.append(document.body, {</p><p>tag: ‘iframe’,</p><p>id:’downloadIframe’,</p><p>frameBorder: 0,</p><p>width: 0,</p><p>height: 0,</p><p>css: ‘display:none;visibility:hidden;height:0px;’,</p><p>src: obj.filename</p><p>});</p><p>},</p><p>failure: function(r, o){</p><p>},</p><p>headers: {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;’my-header’: ‘csvoutput’</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;},</p><p>params: { }</p><p>});</p><p>&nbsp;</p><p>server:(django)</p><p>result = {}</p><p>result[‘filename’] = filename</p><p>result[‘success’] = True</p><p>return HttpResponse(simplejson.dumps(result), mimetype=’text/javascript’)</p><br><p></p><p></p> 
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2011/06/03/JS实现-File-Download/" class="archive-article-date">
  	<time datetime="2011-06-03T06:47:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2011-06-03</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/python-js-php-html-mysql-http/">python/js/php/html/mysql/http</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-Android换肤" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2011/05/14/Android换肤/">Android换肤</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
         <p><a target="_blank" href="http://www.eoeandroid.com/forum-viewthread-tid-73500-extra-page%3D1%26orderby%3Ddateline.html">&nbsp;http://www.eoeandroid.com/forum-viewthread-tid-73500-extra-page%3D1%26orderby%3Ddateline.html</a></p><p>一个apk应用访问另一个apk包中的资源，可以实现换肤。</p><p>ps: 在AndroidManifest.xml中设置<strong>sharedUserId <br></strong></p><p><br></p><p>@Override<br>public void onCreate(Bundle savedInstanceState) {<br>&nbsp;&nbsp; &nbsp;super.onCreate(savedInstanceState);<br>&nbsp;&nbsp; &nbsp;setContentView(R.layout.main);<br>&nbsp;&nbsp; &nbsp;Context friendContext = null;<br>&nbsp;&nbsp; &nbsp;try {<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;friendContext = this.createPackageContext(<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&quot;com.test.android.skin.myskin&quot;, Context.CONTEXT_IGNORE_SECURITY);<br>&nbsp;&nbsp; &nbsp;} catch (NameNotFoundException e) {<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;e.printStackTrace();<br>&nbsp;&nbsp; &nbsp;}<br>&nbsp;&nbsp; &nbsp;Button btn = (Button) findViewById(R.id.btn);<br>&nbsp;&nbsp; &nbsp;btn.setBackgroundDrawable(friendContext.getResources().getDrawable(<br>&nbsp;&nbsp; &nbsp;R.drawable.btn_background));<br>}</p> 
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2011/05/14/Android换肤/" class="archive-article-date">
  	<time datetime="2011-05-14T12:47:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2011-05-14</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Android/">Android</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-动态编译Java源文件（介绍）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2011/05/13/动态编译Java源文件（介绍）/">动态编译Java源文件（介绍）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
         <p><a target="_blank" href="http://www.iteye.com/topic/608485">http://www.iteye.com/topic/608485</a></p><p>&nbsp;</p><p>通过JavaCompiler进行编译都是在当前目录下生成.class文件，而使用编译选项可以改变这个默认目录。编译选项是一个元素为String类型的Iterable集合。如我们可以使用如下代码在D盘根目录下生成.class文件。</p><p>&nbsp;Iterable options = Arrays.asList(&quot;-d&quot;, &quot;d:\&quot;);</p><p>JavaCompiler.CompilationTask task = compiler.getTask(null, fileManager,</p><p>diagnostics, options, null, compilationUnits);</p><p>&nbsp;</p><p>&nbsp;</p><p>006 年底，Sun 公司发布了 Java StandardEdition 6（Java SE 6）的最终正式版，代号 Mustang（野马）。跟 Tiger（Java SE 5）相比，Mustang在性能方面有了不错的提升。与 Tiger 在 API 库方面的大幅度加强相比，虽然 Mustang 在 API库方面的新特性显得不太多，但是也提供了许多实用和方便的功能：在脚本，WebService，XML，编译器 API，数据库，JMX，网络和Instrumentation 方面都有不错的新特性和功能加强。 本系列 文章主要介绍 Java SE 6 在 API库方面的部分新特性，通过一些例子和讲解，帮助开发者在编程实践当中更好的运用 Java SE 6，提高开发效率。</p><p>本文是其中的第四篇，介绍了 JDK 6中为在运行时操纵编译器所增加的编译器 API（JSR 199）。您将了解到，利用此 API 开发人员可以在运行时调用 Java编译器，还可以编译非文本形式的 Java 源代码，最后还能够采集编译器的诊断信息。本文将展开描述这些功能，并使用这些功能构造一个简单的应用—— 在内存中，直接为一个类生成测试用例。</p><p>新 API 功能简介</p><p>JDK 6 提供了在运行时调用编译器的 API，后面我们将假设把此 API 应用在 JSP 技术中。在传统的 JSP 技术中，服务器处理 JSP 通常需要进行下面 6 个步骤：</p><p>分析 JSP 代码；&nbsp;<br>生成 Java 代码；&nbsp;<br>将 Java 代码写入存储器；&nbsp;<br>启动另外一个进程并运行编译器编译 Java 代码；&nbsp;<br>将类文件写入存储器；&nbsp;<br>服务器读入类文件并运行；&nbsp;<br>但如果采用运行时编译，可以同时简化步骤 4 和 5，节约新进程的开销和写入存储器的输出开销，提高系统效率。实际上，在 JDK 5 中，Sun也提供了调用编译器的编程接口。然而不同的是，老版本的编程接口并不是标准 API 的一部分，而是作为 Sun的专有实现提供的，而新版则带来了标准化的优点。</p><p>新 API 的第二个新特性是可以编译抽象文件，理论上是任何形式的对象 —— 只要该对象实现了特定的接口。有了这个特性，上述例子中的步骤 3 也可以省略。整个 JSP 的编译运行在一个进程中完成，同时消除额外的输入输出操作。</p><p>第三个新特性是可以收集编译时的诊断信息。作为对前两个新特性的补充，它可以使开发人员轻松的输出必要的编译错误或者是警告信息，从而省去了很多重定向的麻烦。</p><p>运行时编译 Java 文件</p><p>在 JDK 6 中，类库通过 javax.tools包提供了程序运行时调用编译器的 API。从这个包的名字 tools 可以看出，这个开发包提供的功能并不仅仅限于编译器。工具还包括javah、jar、pack200 等，它们都是 JDK 提供的命令行工具。这个开发包希望通过实现一个统一的接口，可以在运行时调用这些工具。在JDK 6 中，编译器被给予了特别的重视。针对编译器，JDK 设计了两个接口，分别是 JavaCompiler和JavaCompiler.CompilationTask。</p><p>下面给出一个例子，展示如何在运行时调用编译器。</p><p>指定编译文件名称（该文件必须在 CLASSPATH 中可以找到）：String fullQuanlifiedFileName = &quot;compile&quot; + java.io.File.separator +&quot;Target.java&quot;;&nbsp;<br>获得编译器对象： JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();&nbsp;<br>通过调用 ToolProvider 的 getSystemJavaCompiler 方法，JDK提供了将当前平台的编译器映射到内存中的一个对象。这样使用者可以在运行时操纵编译器。JavaCompiler是一个接口，它继承了javax.tools.Tool 接口。因此，第三方实现的编译器，只要符合规范就能通过统一的接口调用。同时，tools开发包希望对所有的工具提供统一的运行时调用接口。相信将来，ToolProvider 类将会为更多地工具提供 getSystemXXXTool方法。tools 开发包实际为多种不同工具、不同实现的共存提供了框架。</p><p>编译文件：int result = compiler.run(null, null, null, fileToCompile);&nbsp;<br>获得编译器对象之后，可以调用 Tool.run 方法对源文件进行编译。Run 方法的前三个参数，分别可以用来重定向标准输入、标准输出和标准错误输出，null 值表示使用默认值。清单 1 给出了一个完整的例子：</p><p>清单 1. 程序运行时编译文件<br>01 package compile;<br>02 import java.util.Date;<br>03 public class Target {<br>04&nbsp;&nbsp; public void doSomething(){<br>05&nbsp;&nbsp;&nbsp;&nbsp; Date date = new Date(10, 3, 3);&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 这个构造函数被标记为deprecated, 编译时会<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 向错误输出输出信息。<br>06&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(&quot;Doing…&quot;);<br>07&nbsp;&nbsp; }<br>08 }</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>09 package compile;<br>10 import javax.tools.<em>;<br>11 import java.io.FileOutputStream;<br>12 public class Compiler {<br>13&nbsp;&nbsp; public static void main(String[] args) throws Exception{<br>14&nbsp;&nbsp;&nbsp;&nbsp; String fullQuanlifiedFileName = &quot;compile&quot; + java.io.File.separator +<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Target.java&quot;;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>15&nbsp;&nbsp;&nbsp;&nbsp; JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();</em></p><p>16&nbsp;&nbsp;&nbsp;&nbsp; FileOutputStream err = new FileOutputStream(&quot;err.txt&quot;);</p><p>17&nbsp;&nbsp;&nbsp;&nbsp; int compilationResult = compiler.run(null, null, err, fullQuanlifiedFileName);</p><p>18&nbsp;&nbsp;&nbsp;&nbsp; if(compilationResult == 0){<br>19&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(&quot;Done&quot;);<br>20&nbsp;&nbsp;&nbsp;&nbsp; } else {<br>21&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(&quot;Fail&quot;);<br>22&nbsp;&nbsp;&nbsp;&nbsp; }<br>23&nbsp;&nbsp; }<br>24 }<br>&nbsp;&nbsp;&nbsp;<br>首先运行 &lt;JDK60_INSTALLATION_DIR&gt;binjavac Compiler.java，然后运行&lt;JDK60_INSTALLATION_DIR&gt;jdk1.6.0binjavacompile.Compiler。屏幕上将输出 Done ，并会在当前目录生成一个 err.txt 文件，文件内容如下：</p><p>Note: compile/Target.java uses or overrides a deprecated API.<br>Note: Recompile with -Xlint:deprecation for details.<br>&nbsp;仔细观察 run 方法，可以发现最后一个参数是 String…arguments，是一个变长的字符串数组。它的实际作用是接受传递给javac 的参数。假设要编译 Target.java 文件，并显示编译过程中的详细信息。命令行为：javac Target.java-verbose。相应的可以将 17 句改为：</p><p>int compilationResult = compiler.run(null, null, err, “-verbose”，fullQuanlifiedFileName);<br>编译非文本形式的文件</p><p>JDK 6 的编译器 API的另外一个强大之处在于，它可以编译的源文件的形式并不局限于文本文件。JavaCompiler类依靠文件管理服务可以编译多种形式的源文件。比如直接由内存中的字符串构造的文件，或者是从数据库中取出的文件。这种服务是由JavaFileManager 类提供的。通常的编译过程分为以下几个步骤：</p><p>解析 javac 的参数；&nbsp;<br>在 source path 和/或 CLASSPATH 中查找源文件或者 jar 包；&nbsp;<br>处理输入，输出文件；&nbsp;<br>在这个过程中，JavaFileManager类可以起到创建输出文件，读入并缓存输出文件的作用。由于它可以读入并缓存输入文件，这就使得读入各种形式的输入文件成为可能。JDK提供的命令行工具，处理机制也大致相似，在未来的版本中，其它的工具处理各种形式的源文件也成为可能。为此，新的 JDK 定义了javax.tools.FileObject 和 javax.tools.JavaFileObject接口。任何类，只要实现了这个接口，就可以被 JavaFileManager 识别。</p><p>如果要使用 JavaFileManager，就必须构造 CompilationTask。JDK 6 提供了 JavaCompiler.CompilationTask 类来封装一个编译操作。这个类可以通过：</p><p>JavaCompiler.getTask (<br>&nbsp;&nbsp;&nbsp; Writer out,&nbsp;<br>&nbsp;&nbsp;&nbsp; JavaFileManager fileManager,<br>&nbsp;&nbsp;&nbsp; DiagnosticListener&lt;? super JavaFileObject&gt; diagnosticListener,<br>&nbsp;&nbsp;&nbsp; Iterable&lt;String&gt; options,<br>&nbsp;&nbsp;&nbsp; Iterable&lt;String&gt; classes,<br>&nbsp;&nbsp;&nbsp; Iterable&lt;? extends JavaFileObject&gt; compilationUnits<br>)<br>&nbsp;方法得到。关于每个参数的含义，请参见 JDK 文档。传递不同的参数，会得到不同的CompilationTask。通过构造这个类，一个编译过程可以被分成多步。进一步，CompilationTask提供了setProcessors(Iterable&lt;? extends Processor&gt;processors)方法，用户可以制定处理 annotation 的处理器。图 1 展示了通过 CompilationTask 进行编译的过程：</p><p>图 1. 使用 CompilationTask 进行编译<br><img src="http://img.pickbox.me/wp-content/uploads/pic/other_site/www_netbei_20091229083405929.png"><br>&nbsp;下面的例子通过构造 CompilationTask 分多步编译一组 Java 源文件。</p><p>清单 2. 构造 CompilationTask 进行编译<br>01 package math;</p><p>02 public class Calculator {<br>03&nbsp;&nbsp;&nbsp;&nbsp; public int multiply(int multiplicand, int multiplier) {<br>04&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return multiplicand  multiplier;<br>05&nbsp;&nbsp;&nbsp;&nbsp; }<br>06 }</p><p>07 package compile;<br>08 import javax.tools.<em>;<br>09 import java.io.FileOutputStream;<br>10 import java.util.Arrays;<br>11 public class Compiler {<br>12&nbsp;&nbsp; public static void main(String[] args) throws Exception{<br>13&nbsp;&nbsp;&nbsp;&nbsp; String fullQuanlifiedFileName = &quot;math&quot; + java.io.File.separator +&quot;Calculator.java&quot;;<br>14&nbsp;&nbsp;&nbsp;&nbsp; JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();<br>15&nbsp;&nbsp;&nbsp;&nbsp; StandardJavaFileManager fileManager&nbsp; =<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; compiler.getStandardFileManager(null, null, null);</em></p><p>16&nbsp;&nbsp;&nbsp;&nbsp; Iterable&lt;? extends JavaFileObject&gt; files =<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fileManager.getJavaFileObjectsFromStrings(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Arrays.asList(fullQuanlifiedFileName));<br>17&nbsp;&nbsp;&nbsp;&nbsp; JavaCompiler.CompilationTask task = compiler.getTask(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; null, fileManager, null, null, null, files);</p><p>18&nbsp;&nbsp;&nbsp;&nbsp; Boolean result = task.call();<br>19&nbsp;&nbsp;&nbsp;&nbsp; if( result == true ) {<br>20&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(&quot;Succeeded&quot;);<br>21&nbsp;&nbsp;&nbsp;&nbsp; }<br>22&nbsp;&nbsp; }<br>23 }<br>&nbsp;&nbsp;&nbsp;<br>以上是第一步，通过构造一个 CompilationTask 编译了一个 Java 文件。14-17 行实现了主要逻辑。第 14行，首先取得一个编译器对象。由于仅仅需要编译普通文件，因此第 15 行中通过编译器对象取得了一个标准文件管理器。16行，将需要编译的文件构造成了一个 Iterable 对象。最后将文件管理器和 Iterable 对象传递给 JavaCompiler 的getTask 方法，取得了 JavaCompiler.CompilationTask 对象。</p><p>接下来第二步，开发者希望生成 Calculator 的一个测试类，而不是手工编写。使用 compiler API，可以将内存中的一段字符串，编译成一个 CLASS 文件。</p><p>清单 3. 定制 JavaFileObject 对象<br>01 package math;<br>02 import java.net.URI;<br>03 public class StringObject extends SimpleJavaFileObject{<br>04&nbsp;&nbsp;&nbsp;&nbsp; private String contents = null;<br>05&nbsp;&nbsp;&nbsp;&nbsp; public StringObject(String className, String contents) throws Exception{<br>06&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; super(new URI(className), Kind.SOURCE);<br>07&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.contents = contents;<br>08&nbsp;&nbsp;&nbsp;&nbsp; }</p><p>09&nbsp;&nbsp;&nbsp;&nbsp; public CharSequence getCharContent(boolean ignoreEncodingErrors)&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throws IOException {<br>10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return contents;<br>11&nbsp;&nbsp;&nbsp;&nbsp; }<br>12 }<br>&nbsp;</p><p>SimpleJavaFileObject 是JavaFileObject 的子类，它提供了默认的实现。继承 SimpleJavaObject 之后，只需要实现getCharContent 方法。如 清单 3 中的 9-11 行所示。接下来，在内存中构造Calculator 的测试类CalculatorTest，并将代表该类的字符串放置到 StringObject 中，传递给 JavaCompiler 的 getTask方法。清单 4 展现了这些步骤。</p><p>清单 4. 编译非文本形式的源文件<br>01 package math;<br>02 import javax.tools.;<br>03 import java.io.FileOutputStream;<br>04 import java.util.Arrays;<br>05 public class AdvancedCompiler {<br>06&nbsp;&nbsp; public static void main(String[] args) throws Exception{</p><p>07&nbsp;&nbsp;&nbsp;&nbsp; // Steps used to compile Calculator<br>08&nbsp;&nbsp;&nbsp;&nbsp; // Steps used to compile StringObject</p><p>09&nbsp;&nbsp;&nbsp;&nbsp; // construct CalculatorTest in memory<br>10&nbsp;&nbsp;&nbsp;&nbsp; JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();<br>11&nbsp;&nbsp;&nbsp;&nbsp; StandardJavaFileManager fileManager&nbsp; =<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; compiler.getStandardFileManager(null, null, null);<br>12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; JavaFileObject file = constructTestor();<br>13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Iterable&lt;? extends JavaFileObject&gt; files = Arrays.asList(file);<br>14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; JavaCompiler.CompilationTask task = compiler.getTask (<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; null, fileManager, null, null, null, files);</p><p>15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Boolean result = task.call();<br>16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if( result == true ) {<br>17&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(&quot;Succeeded&quot;);<br>18&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>19&nbsp;&nbsp; }</p><p>20&nbsp;&nbsp; private static SimpleJavaFileObject constructTestor() {<br>21&nbsp;&nbsp;&nbsp;&nbsp; StringBuilder contents = new StringBuilder(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;package math;&quot; +<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;class CalculatorTest { &quot; +<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &quot;&nbsp; public void testMultiply() { &quot; +<br>&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp; Calculator c = new Calculator(); &quot; +<br>&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp; System.out.println(c.multiply(2, 4)); &quot; +<br>&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp; } &quot; +<br>&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp; public static void main(String[] args) { &quot; +<br>&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp; CalculatorTest ct = new CalculatorTest(); &quot; +<br>&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp;&nbsp;&nbsp; ct.testMultiply(); &quot; +<br>&nbsp;&nbsp;&nbsp;&nbsp; &quot;&nbsp; } &quot; +<br>&nbsp;&nbsp;&nbsp;&nbsp; &quot;} &quot;);<br>22&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; StringObject so = null;<br>23&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try {<br>24&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; so = new StringObject(&quot;math.CalculatorTest&quot;, contents.toString());<br>25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } catch(Exception exception) {<br>26&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exception.printStackTrace();<br>27&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>28&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return so;<br>29&nbsp;&nbsp;&nbsp; }<br>30 }<br>&nbsp;实现逻辑和 清单 2 相似。不同的是在 20-30 行，程序在内存中构造了 CalculatorTest 类，并且通过 StringObject 的构造函数，将内存中的字符串，转换成了 JavaFileObject 对象。</p><p>采集编译器的诊断信息</p><p>第三个新增加的功能，是收集编译过程中的诊断信息。诊断信息，通常指错误、警告或是编译过程中的详尽输出。JDK 6 通过 Listener 机制，获取这些信息。如果要注册一个DiagnosticListener，必须使用 CompilationTask 来进行编译，因为 Tool 的 run 方法没有办法注册Listener。步骤很简单，先构造一个 Listener，然后传递给 JavaFileManager 的构造函数。清单 5 对 清单 2进行了改动，展示了如何注册一个 DiagnosticListener。</p><p>清单 5. 注册一个 DiagnosticListener 收集编译信息<br>01 package math;</p><p>02 public class Calculator {<br>03&nbsp;&nbsp; public int multiply(int multiplicand, int multiplier) {<br>04&nbsp;&nbsp;&nbsp;&nbsp; return multiplicand <em> multiplier&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // deliberately omit semicolon, ADiagnosticListener&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // will take effect<br>05&nbsp;&nbsp; }<br>06 }</em></p><p>07 package compile;<br>08 import javax.tools.;<br>09 import java.io.FileOutputStream;<br>10 import java.util.Arrays;<br>11 public class CompilerWithListener {<br>12&nbsp;&nbsp; public static void main(String[] args) throws Exception{<br>13&nbsp;&nbsp;&nbsp;&nbsp; String fullQuanlifiedFileName = &quot;math&quot; +&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; java.io.File.separator +&quot;Calculator.java&quot;;<br>14&nbsp;&nbsp;&nbsp;&nbsp; JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();<br>15&nbsp;&nbsp;&nbsp;&nbsp; StandardJavaFileManager fileManager&nbsp; =<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; compiler.getStandardFileManager(null, null, null);</p><p>16&nbsp;&nbsp;&nbsp;&nbsp; Iterable&lt;? extends JavaFileObject&gt; files =<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fileManager.getJavaFileObjectsFromStrings(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Arrays.asList(fullQuanlifiedFileName));<br>17&nbsp;&nbsp;&nbsp; DiagnosticCollector&lt;JavaFileObject&gt; collector =<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new DiagnosticCollector&lt;JavaFileObject&gt;();&nbsp;<br>18&nbsp;&nbsp;&nbsp; JavaCompiler.CompilationTask task =&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; compiler.getTask(null, fileManager, collector, null, null, files);</p><p>19&nbsp;&nbsp;&nbsp;&nbsp; Boolean result = task.call();<br>20&nbsp;&nbsp;&nbsp;&nbsp; List&lt;Diagnostic&lt;? extends JavaFileObject&gt;&gt; diagnostics =&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; collector.getDiagnostics();<br>21&nbsp;&nbsp;&nbsp;&nbsp; for(Diagnostic&lt;? extends JavaFileObject&gt; d : diagnostics){<br>22&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(&quot;Line Number-&gt;&quot; + d.getLineNumber());<br>23&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(&quot;Message-&gt;&quot;+&nbsp;<br>&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; d.getMessage(Locale.ENGLISH));<br>24&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(&quot;Source&quot; + d.getCode());<br>25&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(&quot; &quot;);<br>26&nbsp;&nbsp;&nbsp;&nbsp; }</p><p>27&nbsp;&nbsp;&nbsp;&nbsp; if( result == true ) {<br>28&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(&quot;Succeeded&quot;);<br>29&nbsp;&nbsp;&nbsp;&nbsp; }<br>30&nbsp;&nbsp; }<br>31 }<br>&nbsp;在17 行，构造了一个 DiagnosticCollector 对象，这个对象由 JDK 提供，它实现了 DiagnosticListener接口。18 行将它注册到 CompilationTask 中去。一个编译过程可能有多个诊断信息。每一个诊断信息，被抽象为一个Diagnostic。20-26 行，将所有的诊断信息逐个输出。编译并运行 Compiler，得到以下输出：</p><p>清单 6. DiagnosticCollector 收集的编译信息<br>Line Number-&gt;5<br>Message-&gt;math/Calculator.java:5: ‘;’ expected<br>Source-&gt;compiler.err.expected<br>&nbsp;<br>实际上，也可以由用户自己定制。清单 7 给出了一个定制的 Listener。</p><p>清单 7. 自定义的 DiagnosticListener<br>01 class ADiagnosticListener implements DiagnosticListener&lt;JavaFileObject&gt;{<br>02 &nbsp; public void report(Diagnostic&lt;? extends JavaFileObject&gt; diagnostic) {<br>03&nbsp;&nbsp;&nbsp; System.out.println(&quot;Line Number-&gt;&quot; + diagnostic.getLineNumber());<br>04&nbsp;&nbsp;&nbsp; System.out.println(&quot;Message-&gt;&quot;+ diagnostic.getMessage(Locale.ENGLISH));<br>05&nbsp;&nbsp;&nbsp; System.out.println(&quot;Source&quot; + diagnostic.getCode());<br>06&nbsp;&nbsp;&nbsp; System.out.println(&quot; &quot;);<br>07&nbsp; }<br>08 }<br>&nbsp;总结</p><p>JDK 6的编译器新特性，使得开发者可以更自如的控制编译的过程，这给了工具开发者更加灵活的自由度。通过 API的调用完成编译操作的特性，使得开发者可以更方便、高效地将编译变为软件系统运行时的服务。而编译更广泛形式的源代码，则为整合更多的数据源及功能提供了强大的支持。相信随着 JDK 的不断完善，更多的工具将具有 API 支持，我们拭目以待。</p><p>&nbsp;</p> 
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2011/05/13/动态编译Java源文件（介绍）/" class="archive-article-date">
  	<time datetime="2011-05-13T15:08:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2011-05-13</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Java/">Java</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-动态编译Java源文件（code）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2011/05/13/动态编译Java源文件（code）/">动态编译Java源文件（code）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
         <p><a target="_blank" href="http://www.infoq.com/cn/articles/cf-java-byte-code">http://www.infoq.com/cn/articles/cf-java-byte-code</a></p><p><a target="_blank" href="http://www.infoq.com/cn/articles/cf-java-byte-code"><br></a></p><p>import java.io.IOException;<br>import java.lang.reflect.InvocationTargetException;<br>import java.lang.reflect.Method;<br>import java.net.URI;<br>import java.net.URISyntaxException;<br>import java.util.Arrays;<br><br>import javax.tools.DiagnosticCollector;<br>import javax.tools.JavaCompiler;<br>import javax.tools.JavaFileObject;<br>import javax.tools.SimpleJavaFileObject;<br>import javax.tools.StandardJavaFileManager;<br>import javax.tools.ToolProvider;<br>import javax.tools.JavaCompiler.CompilationTask;<br><br><br>public class Main {<br><br>&nbsp;&nbsp;&nbsp; public static void main(String[] args) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; String className = &quot;Test&quot;;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; String methodName = &quot;test&quot;;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; String source = &quot;public class &quot; + className +<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot; { public static void &quot; + methodName +<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot; () {System.out.println(&quot;Hello World!&quot;);} }&quot;;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DiagnosticCollector&lt;JavaFileObject&gt; diagnostics =<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new DiagnosticCollector&lt;JavaFileObject&gt;();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; StandardJavaFileManager fileManager =<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; compiler.getStandardFileManager(null, null, null);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; StringSourceJavaObject sourceObject = null;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sourceObject = new StringSourceJavaObject(className, source);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } catch (URISyntaxException e) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e.printStackTrace();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Iterable&lt;? extends JavaFileObject&gt; fileObjects = Arrays.asList(sourceObject);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; String path = System.getProperty(&quot;user.dir&quot;) + File.separator + &quot;bin&quot;;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 编译选项，将编译产生的类文件放在bin/目录下, see &quot;javac -help&quot;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Iterable&lt;String&gt; options = Arrays.asList(&quot;-d&quot;, path, &quot;-cp&quot;, path);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CompilationTask task = compiler.getTask(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; null, fileManager, diagnostics, options, null, fileObjects);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; boolean result = task.call();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!result) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(&quot;编译失败&quot;);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ClassLoader loader = Main.class.getClassLoader();<br>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ClassLoader loader = fileManager.getClassLoader(null);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Class&lt;?&gt; c = loader.loadClass(className);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Method m = c.getMethod(methodName, new Class[]{});<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m.invoke(c, null);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } catch (ClassNotFoundException e) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e.printStackTrace();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } catch (SecurityException e) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e.printStackTrace();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } catch (NoSuchMethodException e) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e.printStackTrace();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } catch (IllegalArgumentException e) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e.printStackTrace();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } catch (IllegalAccessException e) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e.printStackTrace();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } catch (InvocationTargetException e) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e.printStackTrace();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp; static class StringSourceJavaObject extends SimpleJavaFileObject {<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private String content = null;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public StringSourceJavaObject(String name, String content) throws URISyntaxException {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; super(URI.create(&quot;string:///&quot; + name.replace(‘.’,’/‘) + Kind.SOURCE.extension), Kind.SOURCE);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.content = content;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public CharSequence getCharContent(boolean ignoreEncodingErrors) throws IOException {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return content;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>}</p> 
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2011/05/13/动态编译Java源文件（code）/" class="archive-article-date">
  	<time datetime="2011-05-13T14:54:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2011-05-13</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Java/">Java</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/14/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="page-number" href="/page/14/">14</a><span class="page-number current">15</span><a class="page-number" href="/page/16/">16</a><a class="page-number" href="/page/17/">17</a><span class="space">&hellip;</span><a class="page-number" href="/page/60/">60</a><a class="extend next" rel="next" href="/page/16/">Next &raquo;</a>
    </nav>
  


      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 jfo
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true
	}
</script>

<script src="/./main.js"></script>


    
<div class="tools-col">
  <ul class="btn-wrap">
    
      <li class="chose" data-hook="tools-section-all"><span class="text">全部</span><i class="icon-book"></i></li>
    
    
      <li data-hook="tools-section-tag"><span class="text">标签</span><i class="icon-price-tags"></i></li>
    
    
      <li data-hook="tools-section-friends"><span class="text">友链</span><i class="icon-link"></i></li>
    
    
      <li data-hook="tools-section-me"><span class="text">我</span><i class="icon-smile"></i></li>
    
  </ul>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all chose">
    	</section>
    

    
    	<section class="tools-section tools-section-tag">
    			<div class="widget tagcloud" id="js-tagcloud">
    				<ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">87</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Arduino-OpenWrt/">Arduino/OpenWrt</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/DefaultCategory/">DefaultCategory</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Distributed-Computing/">Distributed Computing</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/English/">English</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Google/">Google</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">25</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Life/">Life</a><span class="category-list-count">67</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">52</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux-App/">Linux App</a><span class="category-list-count">61</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux-Debug/">Linux Debug</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux-Virtualization/">Linux Virtualization</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mac-OS-X/">Mac OS X</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mobile/">Mobile</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Network/">Network</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Saying/">Saying</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/WebDev/">WebDev</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Windows/">Windows</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/c-c-template-gp-boost/">c++/c++ template/gp/boost</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/c-c-algorithm/">c/c++/algorithm</a><span class="category-list-count">36</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/cocos2d-x-模拟器/">cocos2d-x/模拟器</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/com组件/">com组件</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/framework/">framework</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/gcc-binutils-make-共享库/">gcc/binutils/make/共享库</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/js-html-python/">js/html/python</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/l4ka-pistachio-iguana/">l4ka::pistachio/iguana</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux-图形/">linux 图形</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python-js-php-html-mysql-http/">python/js/php/html/mysql/http</a><span class="category-list-count">46</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/reading/">reading</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/self-collect/">self_collect</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/unifiedkernel-wine-reactos/">unifiedkernel/wine/reactos</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/wordpress/">wordpress</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/产品/">产品</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/教育/">教育</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数学-物理/">数学/物理</a><span class="category-list-count">3</span></li></ul>
    			</div>
    	</section>
    

    
    	<section class="tools-section tools-section-friends">
  		
  			<div class="friends-wrap" id="js-friends">
  			
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://iguangba.pickbox.me/">爱逛吧</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.pickbox.me/">收藏夹</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://note.pickbox.me/">网络剪贴板</a>
  	        
  	        </div>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">jfojfo#gmail.com</div>
  	  	
    	</section>
    
  </div>
  
</div>

    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>