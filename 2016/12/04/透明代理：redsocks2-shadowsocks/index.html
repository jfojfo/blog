<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="jfo, blog" />





  <link rel="alternate" href="/atom.xml" title="jfo planet" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="redsocks2 + shadowsocks几点说明
socket四要素：srcIP + srcPort + destIP + destPort唯一确定一个socket连接。server端accept监听到连接请求后，通常会另起一个子进程处理，但accept返回的新socket，与accept监听的端口还是一样的，都是server_port，而不是新开一个port(no new port is">
<meta property="og:type" content="article">
<meta property="og:title" content="透明代理：redsocks2_shadowsocks">
<meta property="og:url" content="http://blog.pickbox.me/2016/12/04/透明代理：redsocks2-shadowsocks/index.html">
<meta property="og:site_name" content="jfo planet">
<meta property="og:description" content="redsocks2 + shadowsocks几点说明
socket四要素：srcIP + srcPort + destIP + destPort唯一确定一个socket连接。server端accept监听到连接请求后，通常会另起一个子进程处理，但accept返回的新socket，与accept监听的端口还是一样的，都是server_port，而不是新开一个port(no new port is">
<meta property="og:updated_time" content="2016-12-04T07:22:17.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="透明代理：redsocks2_shadowsocks">
<meta name="twitter:description" content="redsocks2 + shadowsocks几点说明
socket四要素：srcIP + srcPort + destIP + destPort唯一确定一个socket连接。server端accept监听到连接请求后，通常会另起一个子进程处理，但accept返回的新socket，与accept监听的端口还是一样的，都是server_port，而不是新开一个port(no new port is">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://blog.pickbox.me/2016/12/04/透明代理：redsocks2-shadowsocks/"/>


  <title> 透明代理：redsocks2_shadowsocks | jfo planet </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">jfo planet</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Hope is the best gift that tomorrow gives.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                透明代理：redsocks2_shadowsocks
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-04T15:11:37+08:00" content="2016-12-04">
              2016-12-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Network/" itemprop="url" rel="index">
                    <span itemprop="name">Network</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="redsocks2-shadowsocks"><a href="#redsocks2-shadowsocks" class="headerlink" title="redsocks2 + shadowsocks"></a>redsocks2 + shadowsocks</h2><h3 id="几点说明"><a href="#几点说明" class="headerlink" title="几点说明"></a>几点说明</h3><ul>
<li><p>socket四要素：srcIP + srcPort + destIP + destPort唯一确定一个socket连接。server端<code>accept</code>监听到连接请求后，通常会另起一个子进程处理，但accept返回的新socket，与accept监听的端口还是一样的，都是server_port，而不是新开一个port(no new port is opened)，参考<a href="http://stackoverflow.com/questions/489036/how-does-the-socket-api-accept-function-work" target="_blank" rel="external">How does the socket API accept() function work?</a></p>
</li>
<li><p>iptables SNAT/DNAT：<code>--to</code>更改TCP/IP包中的IP和Port，通过第三层TCP/IP协议将数据包送达目标机器</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t nat -A POSTROUTING -s 172.16.36.0/24 -j SNAT --to $PROXY_IP:$PROXY_PORT</div></pre></td></tr></table></figure>
<ul>
<li><p>默认网关：通过链路层MAC地址将数据包送达目标机器。TCP/IP协议中没有关于默认网关IP的字段，通过ARP协议获取到默认网关IP对应的MAC地址，数据包发送出去时，在第二层链路层添加MAC地址，这样数据包就会被默认网关接收到</p>
</li>
<li><p>iptables redirect：会把原来的目标地址和端口改掉。REDIRECT使用了ip_conntrack模块，可以通过函数接口获取原来目的地址<br><br>if you redirect TCP traffic, the ip_conntrack provides a getsockopt() to get the original destination address.<br><br>REDIRECT实际上也是一种特殊的NAT</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">This target is only valid in the nat table, in the PREROUTING and OUTPUT </div><div class="line">       chains, and user-defined chains which are only  called  from  those</div><div class="line">       chains.   It redirects the packet to the machine itself by changing the</div><div class="line">       destination IP  to  the  primary  address  of  the  incoming  interface</div><div class="line">       (locally-generated  packets  are  mapped to the 127.0.0.1 address).  It</div><div class="line">       takes one option</div><div class="line"></div><div class="line">       --to-ports port[-port]</div><div class="line">              This specifies a destination port or  range  of  ports  to  use:</div><div class="line">              without  this,  the  destination port is never altered.  This is</div><div class="line">              only valid if the rule also specifies -p tcp or -p udp.</div></pre></td></tr></table></figure>
<h3 id="redsocks2"><a href="#redsocks2" class="headerlink" title="redsocks2"></a>redsocks2</h3><p>TCP/IP中的目标地址一旦修改，就无法将数据包发送给真正的目标对象，而所有的socket监听，只有目标地址是自己才能接收，上层应用想代理流量，必须处理这一对矛盾，而iptables的redirect刚好派上用场</p>
<p>redsocks通过修改iptables，将流量redirect到自己监听的端口号，然后遵循代理协议格式将流量转发给代理</p>
<p>redsocks2在redsocks基础上进行增强，支持智能代理：只有直接连接失败的才通过代理访问</p>
<p>目前来看，只有使用redsocks真正实现透明代理</p>
<p>项目下载：</p>
<ul>
<li><a href="https://github.com/darkk/redsocks" target="_blank" rel="external">redsocks</a></li>
<li><a href="https://github.com/semigodking/redsocks" target="_blank" rel="external">redsocks2</a></li>
</ul>
<h3 id="方案细节"><a href="#方案细节" class="headerlink" title="方案细节"></a>方案细节</h3><p>能刷openwrt固件的路由都容易集成redsocks和shadowsocks，不过路由一般容量受限，例如4M内存+16M Flash，影响发挥</p>
<p>刚好有一块cubieboard2板，装Ubuntu12.04，可以用来布置整套透明代理：redsocks2 + shadowsocks</p>
<p>再从路由器的DHCP配置中将gateway地址修改为cubieboard的IP地址即可，这样局域网所有机器都通过cubieboard代理上网</p>
<h2 id="其他方案"><a href="#其他方案" class="headerlink" title="其他方案"></a>其他方案</h2><p>下面列出几种尝试过的方案</p>
<h3 id="pcap-dnsproxy-nginx"><a href="#pcap-dnsproxy-nginx" class="headerlink" title="pcap_dnsproxy + nginx"></a>pcap_dnsproxy + nginx</h3><ul>
<li><p>基本思路：通过pcap_dnsproxy将需要代理的url IP地址解析为自己的代理服务器地址，流量通过代理服务器nginx反向代理进行访问</p>
</li>
<li><p>问题：浏览器https访问时，会提示网站证书问题，因为我们的nginx透明代理扮演中间人的角色，不被客户端信任。<br>wget 可以用–no-check-certificate忽略证书，casperjs用–ignore-ssl-errors=yes忽略</p>
</li>
<li><p>dnsproxy Host.ini配置：</p>
</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[Hosts]</div><div class="line">52.197.180.130 .*\.google.com.*</div><div class="line">52.197.180.130 .*\.gstatic.com</div><div class="line">52.197.180.130 .*\.googleusercontent.com</div><div class="line">52.197.180.130 .*\.googleadservices.com</div><div class="line">52.197.180.130 .*\.doubleclick.com</div></pre></td></tr></table></figure>
<p>语法类似/etc/hosts文件，但可以使用正则匹配，方便很多</p>
<ul>
<li>nginx 443端口配置：</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="section">server</span> &#123;</div><div class="line">    <span class="attribute">resolver</span> <span class="number">8.8.8.8</span>;</div><div class="line">    <span class="attribute">listen</span>       <span class="number">443</span> ssl;</div><div class="line">    <span class="comment">#server_name  ssl.pickbox.me;</span></div><div class="line"></div><div class="line">    <span class="attribute">ssl_certificate</span>      /opt/nginx/ssl/example_com.crt;</div><div class="line">    <span class="attribute">ssl_certificate_key</span>  /opt/nginx/ssl/example_com.key;</div><div class="line">    <span class="attribute">ssl_verify_client</span>    <span class="literal">off</span>;</div><div class="line"></div><div class="line">    <span class="attribute">ssl_session_timeout</span>  <span class="number">5m</span>;</div><div class="line"></div><div class="line">    <span class="attribute">location</span> / &#123;</div><div class="line">        <span class="attribute">proxy_pass</span> <span class="variable">$scheme</span>://<span class="variable">$host</span><span class="variable">$request_uri</span>;</div><div class="line">        <span class="attribute">proxy_redirect</span>     <span class="literal">off</span>;</div><div class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</div><div class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</div><div class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="attribute">access_log</span>  logs/access.p.log;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>需要生成cert文件，用gencert.sh脚本生成</p>
<p>80端口配置类似</p>
<h3 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h3><p><a href="http://www.cnblogs.com/lexus/archive/2012/02/14/2351939.html" target="_blank" rel="external">http://www.cnblogs.com/lexus/archive/2012/02/14/2351939.html</a></p>
<p><a href="http://img.pickbox.me/wp-content/uploads/iptables - Transparent web proxy.pdf" target="_blank" rel="external">下载</a></p>
<p>该方法同样有https证书问题，看看加深对socket四要素理解吧</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line">PROXY_IP=192.168.1.10</div><div class="line">PROXY_PORT=3128</div><div class="line">LAN_IP=`nvram get lan_ipaddr`</div><div class="line">LAN_NET=<span class="variable">$LAN_IP</span>/`nvram get lan_netmask`</div><div class="line"></div><div class="line">iptables -t nat -A PREROUTING -i br0 <span class="_">-s</span> <span class="variable">$LAN_NET</span> <span class="_">-d</span> <span class="variable">$LAN_NET</span> -p tcp --dport 80 -j ACCEPT</div><div class="line">iptables -t nat -A PREROUTING -i br0 <span class="_">-s</span> ! <span class="variable">$PROXY_IP</span> -p tcp --dport 80 -j DNAT --to <span class="variable">$PROXY_IP</span>:<span class="variable">$PROXY_PORT</span></div><div class="line">iptables -t nat -I POSTROUTING -o br0 <span class="_">-s</span> <span class="variable">$LAN_NET</span> <span class="_">-d</span> <span class="variable">$PROXY_IP</span> -p tcp -j SNAT --to <span class="variable">$LAN_IP</span></div><div class="line">iptables -I FORWARD -i br0 -o br0 <span class="_">-s</span> <span class="variable">$LAN_NET</span> <span class="_">-d</span> <span class="variable">$PROXY_IP</span> -p tcp --dport <span class="variable">$PROXY_PORT</span> -j ACCEPT</div></pre></td></tr></table></figure>
<p>This solution described in the previous section redirects packets to the proxy server using Network Address Translation to modify the actual packets. The result is that packets arriving at the proxy have a source IP address of the router rather than the original client. As a result, it’s not possible to see the IP address of the originating client in the proxy logs, nor is it possible to apply access rules in the proxy based on the originating client IP address.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line">PROXY_IP=192.168.1.10</div><div class="line"></div><div class="line">iptables -t mangle -A PREROUTING -j ACCEPT -p tcp --dport 80 <span class="_">-s</span> <span class="variable">$PROXY_IP</span></div><div class="line">iptables -t mangle -A PREROUTING -j MARK --set-mark 3 -p tcp --dport 80 </div><div class="line">ip rule add fwmark 3 table 2 </div><div class="line">ip route add default via <span class="variable">$PROXY_IP</span> dev br0 table 2</div></pre></td></tr></table></figure>
<p>还需要改一下port，否则数据包还是转发到proxy机器的80端口上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -A PREROUTING -t nat -i eth0 -p tcp --dport 80 -j REDIRECT --to-port [PROXY_PORT]</div></pre></td></tr></table></figure>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/11/17/nginx负载均衡/" rel="next" title="nginx负载均衡">
                <i class="fa fa-chevron-left"></i> nginx负载均衡
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/wp-content/uploads/penguin.gif"
               alt="jfo" />
          <p class="site-author-name" itemprop="name">jfo</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">597</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">36</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/jfojfo" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/jfojfo" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.pickbox.me" title="收藏夹" target="_blank">收藏夹</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://note.pickbox.me" title="网络剪贴板" target="_blank">网络剪贴板</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://iguangba.pickbox.me" title="爱逛吧" target="_blank">爱逛吧</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#redsocks2-shadowsocks"><span class="nav-number">1.</span> <span class="nav-text">redsocks2 + shadowsocks</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#几点说明"><span class="nav-number">1.1.</span> <span class="nav-text">几点说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#redsocks2"><span class="nav-number">1.2.</span> <span class="nav-text">redsocks2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方案细节"><span class="nav-number">1.3.</span> <span class="nav-text">方案细节</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他方案"><span class="nav-number">2.</span> <span class="nav-text">其他方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#pcap-dnsproxy-nginx"><span class="nav-number">2.1.</span> <span class="nav-text">pcap_dnsproxy + nginx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#iptables"><span class="nav-number">2.2.</span> <span class="nav-text">iptables</span></a></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2007 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jfo</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = false;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = decodeURIComponent(data.url);
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title >= 0 || index_content >= 0 ){
                                isMatch = true;
								if (i == 0) {
                                    first_occur = index_content;
                                }
                            } 
							
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

  

  
<script type="text/javascript" src="http://p.pickbox.me/js/pv.js"></script>



</body>
</html>
