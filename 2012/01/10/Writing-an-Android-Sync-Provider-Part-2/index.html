<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="jfo, blog" />





  <link rel="alternate" href="/atom.xml" title="jfo planet" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="Writing an Android Sync Provider: Part 2January 23rd, 2010&amp;nbsp;Sam Steele&amp;nbsp;One of the great new user-facing features of Android 2.0 is the is the new Facebook app, which brings your Facebook con">
<meta property="og:type" content="article">
<meta property="og:title" content="Writing an Android Sync Provider: Part 2">
<meta property="og:url" content="http://blog.pickbox.me/2012/01/10/Writing-an-Android-Sync-Provider-Part-2/index.html">
<meta property="og:site_name" content="jfo planet">
<meta property="og:description" content="Writing an Android Sync Provider: Part 2January 23rd, 2010&amp;nbsp;Sam Steele&amp;nbsp;One of the great new user-facing features of Android 2.0 is the is the new Facebook app, which brings your Facebook con">
<meta property="og:image" content="http://img.pickbox.me/wp-content/uploads/pic/4ec1fa198618367a1ecd00922e738bd4b21ce54e.jpg">
<meta property="og:image" content="http://img.pickbox.me/wp-content/uploads/pic/85199c510fb30f24103d4f4cc895d143ac4b036e.jpg">
<meta property="og:image" content="http://img.pickbox.me/wp-content/uploads/pic/06898418367adab48f94640c8bd4b31c8601e44e.jpg">
<meta property="og:image" content="http://img.pickbox.me/wp-content/uploads/pic/f1230d2442a7d9339c0f473cad4bd11372f0016e.jpg">
<meta property="og:image" content="http://img.pickbox.me/wp-content/uploads/pic/7888347adab44aede80ac1abb31c8701a08bfb4e.jpg">
<meta property="og:image" content="http://img.pickbox.me/wp-content/uploads/pic/f1b440a7d933c89584d93b34d11373f08302006e.jpg">
<meta property="og:updated_time" content="2016-10-15T05:24:27.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Writing an Android Sync Provider: Part 2">
<meta name="twitter:description" content="Writing an Android Sync Provider: Part 2January 23rd, 2010&amp;nbsp;Sam Steele&amp;nbsp;One of the great new user-facing features of Android 2.0 is the is the new Facebook app, which brings your Facebook con">
<meta name="twitter:image" content="http://img.pickbox.me/wp-content/uploads/pic/4ec1fa198618367a1ecd00922e738bd4b21ce54e.jpg">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://blog.pickbox.me/2012/01/10/Writing-an-Android-Sync-Provider-Part-2/"/>


  <title> Writing an Android Sync Provider: Part 2 | jfo planet </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">jfo planet</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Hope is the best gift that tomorrow gives.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Writing an Android Sync Provider: Part 2
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2012-01-10T13:23:00+08:00" content="2012-01-10">
              2012-01-10
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p> Writing an Android Sync Provider: Part 2January 23rd, 2010&nbsp;<a rel="external" title="Posts by Sam Steele" href="http://www.c99.org/author/admin/" target="_blank">Sam Steele</a>&nbsp;</p><p>One of the great new user-facing features of Android 2.0 is the is the new Facebook app, which brings your Facebook contacts and statuses into your Android contacts database:<br><a rel="external" href="http://www.c99.org/wp-content/uploads/2010/01/sms.png" target="_blank"><img height="229" width="300" src="http://img.pickbox.me/wp-content/uploads/pic/4ec1fa198618367a1ecd00922e738bd4b21ce54e.jpg"></a><br>So, how exactly does my Nexus One know that Chris is excited about the upcoming launch of his new mobile apps? The answer is a Contacts sync provider in the Facebook app. Read on to learn how to create your own!</p>Sync Providers<p>Sync providers are services that allow an Account to synchronize data on the device on a regular basis. Not quite sure how to create an Account? Read&nbsp;<a href="http://www.c99.org/2010/01/23/writing-an-android-sync-provider-part-1/" target="_blank" rel="external">part one</a>&nbsp;first! To implement a Contacts sync provider, we’ll need a service, some xml files, and the following permissions added to the AndroidManifest.xml:</p>AndroidManifest.xml snippet<ol><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.INTERNET&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.ACCESS_NETWORK_STATE&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.READ_CONTACTS&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.WRITE_CONTACTS&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.GET_ACCOUNTS&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.MANAGE_ACCOUNTS&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.AUTHENTICATE_ACCOUNTS&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.READ_SYNC_SETTINGS&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.WRITE_SYNC_SETTINGS&quot;&nbsp;/&gt;</li></ol>The Service<p>Similar to our Account Authenticator service, our Contacts Sync Provider service will return a subclass of<a href="http://developer.android.com/reference/android/content/AbstractThreadedSyncAdapter.html" target="_blank" rel="external">AbstractThreadedSyncAdapter</a>&nbsp;from the onBind method.</p>ContactsSyncAdapterService.java<ol><li>public&nbsp;class&nbsp;ContactsSyncAdapterService&nbsp;extends&nbsp;Service&nbsp;{</li><li>&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;TAG =&nbsp;&quot;ContactsSyncAdapterService&quot;;</li><li>&nbsp;private&nbsp;static&nbsp;SyncAdapterImpl sSyncAdapter =&nbsp;null;</li><li>&nbsp;private&nbsp;static&nbsp;ContentResolver mContentResolver =&nbsp;null;</li><li>&nbsp;</li><li>&nbsp;public&nbsp;ContactsSyncAdapterService()&nbsp;{</li><li>&nbsp;&nbsp;super();</li><li>&nbsp;}</li><li>&nbsp;</li><li>&nbsp;private&nbsp;static&nbsp;class&nbsp;SyncAdapterImpl&nbsp;extends&nbsp;AbstractThreadedSyncAdapter&nbsp;{</li><li>&nbsp;&nbsp;private&nbsp;Context&nbsp;mContext;</li><li>&nbsp;</li><li>&nbsp;&nbsp;public&nbsp;SyncAdapterImpl(Context&nbsp;context)&nbsp;{</li><li>&nbsp; &nbsp;super(context,&nbsp;true);</li><li>&nbsp; &nbsp;mContext = context;</li><li>&nbsp;&nbsp;}</li><li>&nbsp;</li><li>&nbsp; @Override</li><li>&nbsp;&nbsp;public&nbsp;void&nbsp;onPerformSync(Account account, Bundle extras,&nbsp;String&nbsp;authority, ContentProviderClient provider, SyncResult syncResult)&nbsp;{</li><li>&nbsp; &nbsp;try&nbsp;{</li><li>&nbsp; &nbsp; ContactsSyncAdapterService.performSync(mContext, account, extras, authority, provider, syncResult);</li><li>&nbsp; &nbsp;}&nbsp;catch&nbsp;(OperationCanceledException e)&nbsp;{</li><li>&nbsp; &nbsp;}</li><li>&nbsp;&nbsp;}</li><li>&nbsp;}</li><li>&nbsp;</li><li>&nbsp;@Override</li><li>&nbsp;public&nbsp;IBinder onBind(Intent intent)&nbsp;{</li><li>&nbsp; IBinder ret =&nbsp;null;</li><li>&nbsp; ret = getSyncAdapter().getSyncAdapterBinder();</li><li>&nbsp;&nbsp;return&nbsp;ret;</li><li>&nbsp;}</li><li>&nbsp;</li><li>&nbsp;private&nbsp;SyncAdapterImpl getSyncAdapter()&nbsp;{</li><li>&nbsp;&nbsp;if&nbsp;(sSyncAdapter ==&nbsp;null)</li><li>&nbsp; &nbsp;sSyncAdapter =&nbsp;new&nbsp;SyncAdapterImpl(this);</li><li>&nbsp;&nbsp;return&nbsp;sSyncAdapter;</li><li>&nbsp;}</li><li>&nbsp;</li><li>&nbsp;private&nbsp;static&nbsp;void&nbsp;performSync(Context&nbsp;context, Account account, Bundle extras,&nbsp;String&nbsp;authority, ContentProviderClient provider, SyncResult syncResult)</li><li>&nbsp; &nbsp;throws&nbsp;OperationCanceledException&nbsp;{</li><li>&nbsp; mContentResolver = context.getContentResolver();</li><li>&nbsp; Log.i(TAG,&nbsp;&quot;performSync: &quot;&nbsp;+ account.toString());</li><li>&nbsp;&nbsp;//This is where the magic will happen!</li><li>&nbsp;}</li><li>}</li></ol><p>The service is defined in AndroidManifest.xml like so:</p>AndroidManifest.xml snippet<ol><li>&lt;service&nbsp;android:name=&quot;.sync.ContactsSyncAdapterService&quot;</li><li>&nbsp;android:exported=&quot;true&quot;&nbsp;android:process=&quot;:contacts&quot;&gt;</li><li>&nbsp;&lt;intent-filter&gt;</li><li>&nbsp;&nbsp;&lt;action&nbsp;android:name=&quot;android.content.SyncAdapter&quot;&nbsp;/&gt;</li><li>&nbsp;&lt;/intent-filter&gt;</li><li>&nbsp;&lt;meta-data&nbsp;android:name=&quot;android.content.SyncAdapter&quot;</li><li>&nbsp;&nbsp;android:resource=&quot;@xml/sync_contacts&quot;&nbsp;/&gt;</li><li>&lt;/service&gt;</li></ol><p>Finally, we need an xml file to let Android know that our sync provider handles Contacts for the Account type we defined in part 1.</p>sync_contacts.xml<ol><li>&lt;sync-adapter&nbsp;xmlns:android=&quot;<a href="http://schemas.android.com/apk/res/android&amp;quot" target="_blank" rel="external">http://schemas.android.com/apk/res/android&amp;quot</a>;</li><li>&nbsp; &nbsp;&nbsp;android:contentAuthority=&quot;com.android.contacts&quot;</li><li>&nbsp; &nbsp;&nbsp;android:accountType=&quot;fm.last.android.account&quot;/&gt;</li></ol><p>At this point we have a sync provider that doesn’t do anything, but also shouldn’t crash the Android system. Just in case, lets test it in Dev Tools first. Start the Android emulator and launch the “Dev Tools” app, then scroll down to “Sync Tester”.<br><a rel="external" href="http://www.c99.org/wp-content/uploads/2010/01/synctester.png" target="_blank"><img height="241" width="300" src="http://img.pickbox.me/wp-content/uploads/pic/85199c510fb30f24103d4f4cc895d143ac4b036e.jpg"></a><br>The drop-down should confirm that com.android.contacts can be synced with the account type you’ve created. Select the entry for your account type and press the “Bind” button to connect to your sync service. If all goes well, Sync Tester will say it’s connected to your service. Now click “Start Sync” and select your account from the popup. Sync Tester will let you know that the sync succeeded (even though we didn’t actually do anything). At this point it should be safe to enable contact syncing from the Accounts &amp; Sync settings screen without Android crashing and rebooting.<br><a rel="external" href="http://www.c99.org/wp-content/uploads/2010/01/contactsync.png" target="_blank"><img height="225" width="300" src="http://img.pickbox.me/wp-content/uploads/pic/06898418367adab48f94640c8bd4b31c8601e44e.jpg"></a></p>Contacts<p>Lets take a moment to discuss how Contacts on Android work. Each sync account, such as Google or Facebook, creates its own set of RawContacts which the Android system then aggregates into the single list of contacts you see in the Dialer. The RawContacts table contains several fields that Sync Providers can use for whatever they like, and in this implementation we will use the SYNC1 field to store the RawContact’s Last.fm username.</p>Contact Data<p>Data, such as name, phone number, email address, etc. is stored in a table that references a RawContact ID. The Data table can contain anything you like, and there are several&nbsp;<a href="http://developer.android.com/reference/android/provider/ContactsContract.CommonDataKinds.html" target="_blank" rel="external">predefined MIME-types available</a>&nbsp;for phone numbers, email addresses, names, etc. Android will automatically try to combine RawContacts that contain the same name, email address, etc. into a single Contact, and the user can also combine and split Contacts manually from the contact edit screen.<br><a rel="external" href="http://www.c99.org/wp-content/uploads/2010/01/aggregate.png" target="_blank"><img height="300" width="180" src="http://img.pickbox.me/wp-content/uploads/pic/f1230d2442a7d9339c0f473cad4bd11372f0016e.jpg"></a></p>Custom Data Types<p>A sync provider can store additional data about a RawContact in the Data table, and provide an xml file to tell the Contacts app how to format this row. To create a custom MIME type, we need to add an additional meta-data tag to our service entry in AndroidManifest.xml to reference a new ContactsSource XML file:</p>AndroidManifest.xml snippet<ol><li>&lt;meta-data&nbsp;android:name=&quot;android.provider.CONTACTS_STRUCTURE&quot;</li><li>&nbsp;android:resource=&quot;@xml/contacts&quot;&nbsp;/&gt;</li></ol><p>This ContactsSource xml file will tell the Contacts app how to format our custom MIME-types. In the example below, we specify an icon, and tell the Contacts app to use the DATA2 and DATA3 columns to render the fields. Note that this file’s format doesn’t appear to be documented outside of the&nbsp;<a href="http://www.google.com/codesearch/p?hl=en#oOy_5JrVRNM/trunk/packages/apps/Contacts/src/com/android/contacts/model/ExternalSource.java&amp;q=ContactsDataKind&amp;sa=N&amp;cd=1&amp;ct=rc" target="_blank" rel="external">source code for the Contacts app</a>.</p>contacts.xml<ol><li>&lt;ContactsSource&nbsp;xmlns:android=&quot;<a href="http://schemas.android.com/apk/res/android&quot;&amp;gt" target="_blank" rel="external">http://schemas.android.com/apk/res/android&quot;&amp;gt</a>;</li><li>&nbsp;&lt;ContactsDataKind</li><li>&nbsp;&nbsp;android:icon=&quot;@drawable/icon&quot;</li><li>&nbsp;&nbsp;android:mimeType=&quot;vnd.android.cursor.item/vnd.fm.last.android.profile&quot;</li><li>&nbsp;&nbsp;android:summaryColumn=&quot;data2&quot;</li><li>&nbsp;&nbsp;android:detailColumn=&quot;data3&quot;</li><li>&nbsp;&nbsp;android:detailSocialSummary=&quot;true&quot;&nbsp;/&gt;</li><li>&lt;/ContactsSource&gt;</li></ol><p>Here’s how Facebook’s custom “Facebook Profile” field looks when rendered by the Contacts app:<br><a rel="external" href="http://www.c99.org/wp-content/uploads/2010/01/facebookprofile.png" target="_blank"><img height="185" width="300" src="http://img.pickbox.me/wp-content/uploads/pic/7888347adab44aede80ac1abb31c8701a08bfb4e.jpg"></a></p>Creating a RawContact<p>Now lets put all the above information together to create a RawContact for a Last.fm user. Our contacts will display only a name and a custom field that links to the user’s Last.fm profile. We store the user’s username in the RawContact’s SYNC1 field so we can easily look it up later. We will batch together the creation of the RawContact and the insertion of the Data, as Android will run an aggregation pass after each batch completes.</p>addContact method<ol><li>private&nbsp;static&nbsp;void&nbsp;addContact(Account account,&nbsp;String&nbsp;name,&nbsp;String&nbsp;username)&nbsp;{</li><li>&nbsp;Log.i(TAG,&nbsp;&quot;Adding contact: &quot;&nbsp;+ name);</li><li>&nbsp;ArrayList&lt;ContentProviderOperation&gt;&nbsp;operationList =&nbsp;new&nbsp;ArrayList&lt;ContentProviderOperation&gt;();</li><li>&nbsp;</li><li>&nbsp;//Create our RawContact</li><li>&nbsp;ContentProviderOperation.Builder&nbsp;builder = ContentProviderOperation.newInsert(RawContacts.CONTENT_URI);</li><li>&nbsp;builder.withValue(RawContacts.ACCOUNT_NAME, account.name);</li><li>&nbsp;builder.withValue(RawContacts.ACCOUNT_TYPE, account.type);</li><li>&nbsp;builder.withValue(RawContacts.SYNC1, username);</li><li>&nbsp;operationList.add(builder.build());</li><li>&nbsp;</li><li>&nbsp;//Create a Data record of common type ‘StructuredName’ for our RawContact</li><li>&nbsp;builder = ContentProviderOperation.newInsert(ContactsContract.Data.CONTENT_URI);</li><li>&nbsp;builder.withValueBackReference(ContactsContract.CommonDataKinds.StructuredName.RAW_CONTACT_ID,&nbsp;0);</li><li>&nbsp;builder.withValue(ContactsContract.Data.MIMETYPE, ContactsContract.CommonDataKinds.StructuredName.CONTENT_ITEM_TYPE);</li><li>&nbsp;builder.withValue(ContactsContract.CommonDataKinds.StructuredName.DISPLAY_NAME, name);</li><li>&nbsp;operationList.add(builder.build());</li><li>&nbsp;</li><li>&nbsp;//Create a Data record of custom type &quot;vnd.android.cursor.item/vnd.fm.last.android.profile&quot; to display a link to the Last.fm profile</li><li>&nbsp;builder = ContentProviderOperation.newInsert(ContactsContract.Data.CONTENT_URI);</li><li>&nbsp;builder.withValueBackReference(ContactsContract.Data.RAW_CONTACT_ID,&nbsp;0);</li><li>&nbsp;builder.withValue(ContactsContract.Data.MIMETYPE,&nbsp;&quot;vnd.android.cursor.item/vnd.fm.last.android.profile&quot;);</li><li>&nbsp;builder.withValue(ContactsContract.Data.DATA1, username);</li><li>&nbsp;builder.withValue(ContactsContract.Data.DATA2,&nbsp;&quot;Last.fm Profile&quot;);</li><li>&nbsp;builder.withValue(ContactsContract.Data.DATA3,&nbsp;&quot;View profile&quot;);</li><li>&nbsp;operationList.add(builder.build());</li><li>&nbsp;</li><li>&nbsp;try&nbsp;{</li><li>&nbsp; mContentResolver.applyBatch(ContactsContract.AUTHORITY, operationList);</li><li>&nbsp;}&nbsp;catch&nbsp;(Exception&nbsp;e)&nbsp;{</li><li>&nbsp; Log.e(TAG,&nbsp;&quot;Something went wrong during creation! &quot;&nbsp;+ e);</li><li>&nbsp; e.printStackTrace();</li><li>&nbsp;}</li><li>}</li></ol>Social status updates<p>Android keeps another table for social networking status updates. Inserting a record into this table will replace any previous status if the timestamp of the insert is newer than the previous timestamp, otherwise the previous record will remain and the new insert will be discarded. A status update record is associated with a Data record, in our implementation we will associate it with our Last.fm profile record. Status records contain the status text, a package name where resources are located, an icon resource, and a label resource. Below is a function that will insert a status update, as well as updating our Last.fm Profile Data record to display the last track the user listened to. Note that for efficiency purposes, we will send all the updates in a single batch, so Android will only run a single aggregation pass at the end.</p>updateContactStatus method<ol><li>private&nbsp;static&nbsp;void&nbsp;updateContactStatus(ArrayList&lt;ContentProviderOperation&gt;&nbsp;operationList,&nbsp;longrawContactId,&nbsp;Track&nbsp;track)&nbsp;{</li><li>&nbsp;Uri rawContactUri = ContentUris.withAppendedId(RawContacts.CONTENT_URI, rawContactId);</li><li>&nbsp;Uri entityUri = Uri.withAppendedPath(rawContactUri,&nbsp;Entity.CONTENT_DIRECTORY);</li><li>&nbsp;Cursor&nbsp;c = mContentResolver.query(entityUri,&nbsp;new&nbsp;String[]&nbsp;{&nbsp;RawContacts.SOURCE_ID,&nbsp;Entity.DATA_ID,Entity.MIMETYPE,&nbsp;Entity.DATA1&nbsp;},&nbsp;null,&nbsp;null,&nbsp;null);</li><li>&nbsp;try&nbsp;{</li><li>&nbsp;&nbsp;while&nbsp;(c.moveToNext())&nbsp;{</li><li>&nbsp; &nbsp;if&nbsp;(!c.isNull(1))&nbsp;{</li><li>&nbsp; &nbsp;&nbsp;String&nbsp;mimeType = c.getString(2);</li><li>&nbsp; &nbsp;&nbsp;String&nbsp;status =&nbsp;&quot;&quot;;</li><li>&nbsp; &nbsp;&nbsp;if&nbsp;(track.getNowPlaying()&nbsp;!=&nbsp;null&nbsp;&amp;&amp;&nbsp;track.getNowPlaying().equals(&quot;true&quot;))</li><li>&nbsp; &nbsp; &nbsp;status =&nbsp;&quot;Listening to &quot;&nbsp;+ track.getName()&nbsp;+&nbsp;&quot; by &quot;&nbsp;+ track.getArtist();</li><li>&nbsp; &nbsp;&nbsp;else</li><li>&nbsp; &nbsp; &nbsp;status =&nbsp;&quot;Listened to &quot;&nbsp;+ track.getName()&nbsp;+&nbsp;&quot; by &quot;&nbsp;+ track.getArtist();</li><li>&nbsp;</li><li>&nbsp; &nbsp;&nbsp;if&nbsp;(mimeType.equals(&quot;vnd.android.cursor.item/vnd.fm.last.android.profile&quot;))&nbsp;{</li><li>&nbsp; &nbsp; &nbsp;ContentProviderOperation.Builder&nbsp;builder = ContentProviderOperation.newInsert(ContactsContract.StatusUpdates.CONTENT_URI);</li><li>&nbsp; &nbsp; &nbsp;builder.withValue(ContactsContract.StatusUpdates.DATA_ID, c.getLong(1));</li><li>&nbsp; &nbsp; &nbsp;builder.withValue(ContactsContract.StatusUpdates.STATUS, status);</li><li>&nbsp; &nbsp; &nbsp;builder.withValue(ContactsContract.StatusUpdates.STATUS_RES_PACKAGE,&nbsp;&quot;fm.last.android&quot;);</li><li>&nbsp; &nbsp; &nbsp;builder.withValue(ContactsContract.StatusUpdates.STATUS_LABEL, R.string.app_name);</li><li>&nbsp; &nbsp; &nbsp;builder.withValue(ContactsContract.StatusUpdates.STATUS_ICON, R.drawable.icon);</li><li>&nbsp; &nbsp; &nbsp;if&nbsp;(track.getDate()&nbsp;!=&nbsp;null)&nbsp;{</li><li>&nbsp; &nbsp; &nbsp;&nbsp;long&nbsp;date =&nbsp;Long.parseLong(track.getDate())&nbsp;*&nbsp;1000;</li><li>&nbsp; &nbsp; &nbsp; builder.withValue(ContactsContract.StatusUpdates.STATUS_TIMESTAMP, date);</li><li>&nbsp; &nbsp; &nbsp;}</li><li>&nbsp; &nbsp; &nbsp;operationList.add(builder.build());</li><li>&nbsp;</li><li>&nbsp; &nbsp; &nbsp;builder = ContentProviderOperation.newUpdate(ContactsContract.Data.CONTENT_URI);</li><li>&nbsp; &nbsp; &nbsp;builder.withSelection(BaseColumns._ID +&nbsp;&quot; = ‘&quot;&nbsp;+ c.getLong(1)&nbsp;+&nbsp;&quot;’&quot;,&nbsp;null);</li><li>&nbsp; &nbsp; &nbsp;builder.withValue(ContactsContract.Data.DATA3, status);</li><li>&nbsp; &nbsp; &nbsp;operationList.add(builder.build());</li><li>&nbsp; &nbsp;&nbsp;}</li><li>&nbsp; &nbsp;}</li><li>&nbsp;&nbsp;}</li><li>&nbsp;}&nbsp;finally&nbsp;{</li><li>&nbsp; c.close();</li><li>&nbsp;}</li><li>}</li></ol><p>Here’s how the contact record looks after we’ve inserted a status update record and updated our data record:<br><a rel="external" href="http://www.c99.org/wp-content/uploads/2010/01/lastfmstatus.png" target="_blank"><img height="257" width="300" src="http://img.pickbox.me/wp-content/uploads/pic/f1b440a7d933c89584d93b34d11373f08302006e.jpg"></a></p>Putting It All Together<p>Now that we have our utility functions written, we can fill in the body of our performSync method. We’re going to take a very simple approach to syncing: we’ll grab the list of RawContact IDs currently associated with Last.fm usernames, and we’ll create a RawContact for any Last.fm friend that doesn’t currently have one. If a RawContact already exists, we’ll fetch their most recent track and post a status update. Note that this is a one-way sync, we’re not dealing with local deletions or changes.</p>performSync method<ol><li>private&nbsp;static&nbsp;void&nbsp;performSync(Context&nbsp;context, Account account, Bundle extras,&nbsp;String&nbsp;authority, ContentProviderClient provider, SyncResult syncResult)</li><li>&nbsp;&nbsp;throws&nbsp;OperationCanceledException&nbsp;{</li><li>&nbsp;HashMap&lt;String, Long&gt;&nbsp;localContacts =&nbsp;new&nbsp;HashMap&lt;String, Long&gt;();</li><li>&nbsp;mContentResolver = context.getContentResolver();</li><li>&nbsp;Log.i(TAG,&nbsp;&quot;performSync: &quot;&nbsp;+ account.toString());</li><li>&nbsp;</li><li>&nbsp;// Load the local Last.fm contacts</li><li>&nbsp;Uri rawContactUri = RawContacts.CONTENT_URI.buildUpon().appendQueryParameter(RawContacts.ACCOUNT_NAME, account.name).appendQueryParameter(</li><li>&nbsp; &nbsp;RawContacts.ACCOUNT_TYPE, account.type).build();</li><li>&nbsp;Cursor&nbsp;c1 = mContentResolver.query(rawContactUri,&nbsp;new&nbsp;String[]&nbsp;{&nbsp;BaseColumns._ID, RawContacts.SYNC1&nbsp;},null,&nbsp;null,&nbsp;null);</li><li>&nbsp;while&nbsp;(c1.moveToNext())&nbsp;{</li><li>&nbsp; localContacts.put(c1.getString(1), c1.getLong(0));</li><li>&nbsp;}</li><li>&nbsp;</li><li>&nbsp;ArrayList&lt;ContentProviderOperation&gt;&nbsp;operationList =&nbsp;new&nbsp;ArrayList&lt;ContentProviderOperation&gt;();</li><li>&nbsp;LastFmServer server = AndroidLastFmServerFactory.getServer();</li><li>&nbsp;try&nbsp;{</li><li>&nbsp; Friends friends = server.getFriends(account.name,&nbsp;&quot;&quot;,&nbsp;&quot;50&quot;);</li><li>&nbsp;&nbsp;for&nbsp;(User user : friends.getFriends())&nbsp;{</li><li>&nbsp; &nbsp;if&nbsp;(!localContacts.containsKey(user.getName()))&nbsp;{</li><li>&nbsp; &nbsp;&nbsp;if&nbsp;(user.getRealName().length()&nbsp;&gt;&nbsp;0)</li><li>&nbsp; &nbsp; &nbsp;addContact(account, user.getRealName(), user.getName());</li><li>&nbsp; &nbsp;&nbsp;else</li><li>&nbsp; &nbsp; &nbsp;addContact(account, user.getName(), user.getName());</li><li>&nbsp; &nbsp;}&nbsp;else&nbsp;{</li><li>&nbsp; &nbsp;&nbsp;Track[]&nbsp;tracks = server.getUserRecentTracks(user.getName(),&nbsp;&quot;true&quot;,&nbsp;1);</li><li>&nbsp; &nbsp;&nbsp;if&nbsp;(tracks.length&nbsp;&gt;&nbsp;0)&nbsp;{</li><li>&nbsp; &nbsp; &nbsp;updateContactStatus(operationList, localContacts.get(user.getName()), tracks[0]);</li><li>&nbsp; &nbsp;&nbsp;}</li><li>&nbsp; &nbsp;}</li><li>&nbsp;&nbsp;}</li><li>&nbsp;&nbsp;if(operationList.size()&nbsp;&gt;&nbsp;0)</li><li>&nbsp; &nbsp;mContentResolver.applyBatch(ContactsContract.AUTHORITY, operationList);</li><li>&nbsp;}&nbsp;catch&nbsp;(Exception&nbsp;e1)&nbsp;{</li><li>&nbsp;&nbsp;// TODO Auto-generated catch block</li><li>&nbsp; e1.printStackTrace();</li><li>&nbsp;}</li><li>}</li></ol>Contact visibility<p>By default, new contacts that you create from your sync provider are not shown by the Contacts app. Instead, it will show only contacts it has aggregated with other visible sources. To enable the display of contacts that only exist in your provider, press the Menu button and select “Display options”, then expand the entry for your account and tap the checkbox next to “All Contacts”. This is a good default, as I don’t really want my address book to be littered with hundreds of twitter contacts!</p>Final Thoughts<p>The Android platform is awesome. The lack of documentation, however, is quite disappointing. While it’s great that I can dig through the system source code while troubleshooting and figuring things out, I shouldn’t have to!</p><p>Sync providers require Android 2.0, which is currently only available on 2 devices. The Account modifications I made to our login activity will need to be reimplemented using class introspection in order to keep compatibility with Android 1.5.</p><p>This sync provider is far from complete — I still need to figure out how to control the sync interval, set my sync provider as read-only since local changes are ignored, I might grab the user’s avatar if they don’t currently have an icon, and add a fancy “Do you want to sync your contacts?” popup to the login process similar to Facebook’s.</p><p>Hopefully this will help other developers out there struggling with the lack of documentation, as I’m looking forward to seeing twitter status updates in the contacts app in the future!</p><p>The source code for the implementation referenced here is available in my&nbsp;<a href="http://github.com/c99koder/lastfm-android/" target="_blank" rel="external">Last.fm github project</a>&nbsp;under the terms of the GNU General Public License. A standalone sample project is also available&nbsp;<a href="http://github.com/c99koder/AndroidSyncProviderDemo" target="_blank" rel="external">here</a>&nbsp;under the terms of the Apache License 2.0. Google has also released their own sample sync provider on the&nbsp;<a href="http://developer.android.com/resources/samples/SampleSyncAdapter/index.html" target="_blank" rel="external">Android developer portal</a>that’s a bit more complete than mine.</p>Categories:&nbsp;<a rel="external" title="View all posts in Android" href="http://www.c99.org/category/android/" target="_blank">Android</a><p></p> <p></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2011/11/25/JQuery参考/" rel="next" title="JQuery参考">
                <i class="fa fa-chevron-left"></i> JQuery参考
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2012/02/17/Android-KeyEvent-的-生命周期/" rel="prev" title="Android KeyEvent 的 生命周期">
                Android KeyEvent 的 生命周期 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/wp-content/uploads/penguin.gif"
               alt="jfo" />
          <p class="site-author-name" itemprop="name">jfo</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">595</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">36</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/jfojfo" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/jfojfo" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.pickbox.me" title="收藏夹" target="_blank">收藏夹</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://note.pickbox.me" title="网络剪贴板" target="_blank">网络剪贴板</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://iguangba.pickbox.me" title="爱逛吧" target="_blank">爱逛吧</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <p class="post-toc-empty">此文章未包含目录</p>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2007 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jfo</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = false;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = decodeURIComponent(data.url);
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title >= 0 || index_content >= 0 ){
                                isMatch = true;
								if (i == 0) {
                                    first_occur = index_content;
                                }
                            } 
							
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

  

  
<script type="text/javascript">
function attach () {
    $('body').append('<img src="http://p.pickbox.me/pv">');
    $(document).unbind('scroll', attach);
}
$(document).bind('scroll', attach);
</script>



</body>
</html>
