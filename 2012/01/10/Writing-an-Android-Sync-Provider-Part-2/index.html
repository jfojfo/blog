<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Writing an Android Sync Provider: Part 2 | jfo planet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Writing an Android Sync Provider: Part 2January 23rd, 2010&amp;nbsp;Sam Steele&amp;nbsp;One of the great new user-facing features of Android 2.0 is the is the new Facebook app, which brings your Facebook con">
<meta property="og:type" content="article">
<meta property="og:title" content="Writing an Android Sync Provider: Part 2">
<meta property="og:url" content="http://blog.pickbox.me/2012/01/10/Writing-an-Android-Sync-Provider-Part-2/index.html">
<meta property="og:site_name" content="jfo planet">
<meta property="og:description" content="Writing an Android Sync Provider: Part 2January 23rd, 2010&amp;nbsp;Sam Steele&amp;nbsp;One of the great new user-facing features of Android 2.0 is the is the new Facebook app, which brings your Facebook con">
<meta property="og:image" content="http://img.pickbox.me/wp-content/uploads/pic/4ec1fa198618367a1ecd00922e738bd4b21ce54e.jpg">
<meta property="og:image" content="http://img.pickbox.me/wp-content/uploads/pic/85199c510fb30f24103d4f4cc895d143ac4b036e.jpg">
<meta property="og:image" content="http://img.pickbox.me/wp-content/uploads/pic/06898418367adab48f94640c8bd4b31c8601e44e.jpg">
<meta property="og:image" content="http://img.pickbox.me/wp-content/uploads/pic/f1230d2442a7d9339c0f473cad4bd11372f0016e.jpg">
<meta property="og:image" content="http://img.pickbox.me/wp-content/uploads/pic/7888347adab44aede80ac1abb31c8701a08bfb4e.jpg">
<meta property="og:image" content="http://img.pickbox.me/wp-content/uploads/pic/f1b440a7d933c89584d93b34d11373f08302006e.jpg">
<meta property="og:updated_time" content="2016-10-15T05:24:27.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Writing an Android Sync Provider: Part 2">
<meta name="twitter:description" content="Writing an Android Sync Provider: Part 2January 23rd, 2010&amp;nbsp;Sam Steele&amp;nbsp;One of the great new user-facing features of Android 2.0 is the is the new Facebook app, which brings your Facebook con">
<meta name="twitter:image" content="http://img.pickbox.me/wp-content/uploads/pic/4ec1fa198618367a1ecd00922e738bd4b21ce54e.jpg">
  
    <link rel="alternative" href="/atom.xml" title="jfo planet" type="application/atom+xml">
  
  
    <link rel="icon" href="//favicon.ico">
  
  <script src="/style.js"></script>
  

</head>

<body>
  <div id="container">
    <div class="left-col">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="http://img.pickbox.me/wp-content/uploads/penguin.gif" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">jfo</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Hope is the best gift that tomorrow gives.</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a class="js-smart-menu" data-idx="0" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="1" href="javascript:void(0)">分类</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="2" href="javascript:void(0)">友链</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="3" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/jfojfo" title="github">github</a>
		        
					<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/jfojfo" title="zhihu">zhihu</a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-list"></i></div>
  		<h1 class="header-author js-mobile-header hide">jfo</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="http://img.pickbox.me/wp-content/uploads/penguin.gif" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">jfo</h1>
			</hgroup>
			
			<p class="header-subtitle">Hope is the best gift that tomorrow gives.</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/jfojfo" title="github">github</a>
			        
						<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/jfojfo" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
        <article id="post-Writing-an-Android-Sync-Provider-Part-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Writing an Android Sync Provider: Part 2
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p> Writing an Android Sync Provider: Part 2January 23rd, 2010&nbsp;<a rel="external" title="Posts by Sam Steele" href="http://www.c99.org/author/admin/" target="_blank">Sam Steele</a>&nbsp;</p><p>One of the great new user-facing features of Android 2.0 is the is the new Facebook app, which brings your Facebook contacts and statuses into your Android contacts database:<br><a rel="external" href="http://www.c99.org/wp-content/uploads/2010/01/sms.png" target="_blank"><img height="229" width="300" src="http://img.pickbox.me/wp-content/uploads/pic/4ec1fa198618367a1ecd00922e738bd4b21ce54e.jpg"></a><br>So, how exactly does my Nexus One know that Chris is excited about the upcoming launch of his new mobile apps? The answer is a Contacts sync provider in the Facebook app. Read on to learn how to create your own!</p>Sync Providers<p>Sync providers are services that allow an Account to synchronize data on the device on a regular basis. Not quite sure how to create an Account? Read&nbsp;<a href="http://www.c99.org/2010/01/23/writing-an-android-sync-provider-part-1/" target="_blank" rel="external">part one</a>&nbsp;first! To implement a Contacts sync provider, we’ll need a service, some xml files, and the following permissions added to the AndroidManifest.xml:</p>AndroidManifest.xml snippet<ol><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.INTERNET&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.ACCESS_NETWORK_STATE&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.READ_CONTACTS&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.WRITE_CONTACTS&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.GET_ACCOUNTS&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.MANAGE_ACCOUNTS&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.AUTHENTICATE_ACCOUNTS&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.READ_SYNC_SETTINGS&quot;&nbsp;/&gt;</li><li>&lt;uses-permission&nbsp;android:name=&quot;android.permission.WRITE_SYNC_SETTINGS&quot;&nbsp;/&gt;</li></ol>The Service<p>Similar to our Account Authenticator service, our Contacts Sync Provider service will return a subclass of<a href="http://developer.android.com/reference/android/content/AbstractThreadedSyncAdapter.html" target="_blank" rel="external">AbstractThreadedSyncAdapter</a>&nbsp;from the onBind method.</p>ContactsSyncAdapterService.java<ol><li>public&nbsp;class&nbsp;ContactsSyncAdapterService&nbsp;extends&nbsp;Service&nbsp;{</li><li>&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;TAG =&nbsp;&quot;ContactsSyncAdapterService&quot;;</li><li>&nbsp;private&nbsp;static&nbsp;SyncAdapterImpl sSyncAdapter =&nbsp;null;</li><li>&nbsp;private&nbsp;static&nbsp;ContentResolver mContentResolver =&nbsp;null;</li><li>&nbsp;</li><li>&nbsp;public&nbsp;ContactsSyncAdapterService()&nbsp;{</li><li>&nbsp;&nbsp;super();</li><li>&nbsp;}</li><li>&nbsp;</li><li>&nbsp;private&nbsp;static&nbsp;class&nbsp;SyncAdapterImpl&nbsp;extends&nbsp;AbstractThreadedSyncAdapter&nbsp;{</li><li>&nbsp;&nbsp;private&nbsp;Context&nbsp;mContext;</li><li>&nbsp;</li><li>&nbsp;&nbsp;public&nbsp;SyncAdapterImpl(Context&nbsp;context)&nbsp;{</li><li>&nbsp; &nbsp;super(context,&nbsp;true);</li><li>&nbsp; &nbsp;mContext = context;</li><li>&nbsp;&nbsp;}</li><li>&nbsp;</li><li>&nbsp; @Override</li><li>&nbsp;&nbsp;public&nbsp;void&nbsp;onPerformSync(Account account, Bundle extras,&nbsp;String&nbsp;authority, ContentProviderClient provider, SyncResult syncResult)&nbsp;{</li><li>&nbsp; &nbsp;try&nbsp;{</li><li>&nbsp; &nbsp; ContactsSyncAdapterService.performSync(mContext, account, extras, authority, provider, syncResult);</li><li>&nbsp; &nbsp;}&nbsp;catch&nbsp;(OperationCanceledException e)&nbsp;{</li><li>&nbsp; &nbsp;}</li><li>&nbsp;&nbsp;}</li><li>&nbsp;}</li><li>&nbsp;</li><li>&nbsp;@Override</li><li>&nbsp;public&nbsp;IBinder onBind(Intent intent)&nbsp;{</li><li>&nbsp; IBinder ret =&nbsp;null;</li><li>&nbsp; ret = getSyncAdapter().getSyncAdapterBinder();</li><li>&nbsp;&nbsp;return&nbsp;ret;</li><li>&nbsp;}</li><li>&nbsp;</li><li>&nbsp;private&nbsp;SyncAdapterImpl getSyncAdapter()&nbsp;{</li><li>&nbsp;&nbsp;if&nbsp;(sSyncAdapter ==&nbsp;null)</li><li>&nbsp; &nbsp;sSyncAdapter =&nbsp;new&nbsp;SyncAdapterImpl(this);</li><li>&nbsp;&nbsp;return&nbsp;sSyncAdapter;</li><li>&nbsp;}</li><li>&nbsp;</li><li>&nbsp;private&nbsp;static&nbsp;void&nbsp;performSync(Context&nbsp;context, Account account, Bundle extras,&nbsp;String&nbsp;authority, ContentProviderClient provider, SyncResult syncResult)</li><li>&nbsp; &nbsp;throws&nbsp;OperationCanceledException&nbsp;{</li><li>&nbsp; mContentResolver = context.getContentResolver();</li><li>&nbsp; Log.i(TAG,&nbsp;&quot;performSync: &quot;&nbsp;+ account.toString());</li><li>&nbsp;&nbsp;//This is where the magic will happen!</li><li>&nbsp;}</li><li>}</li></ol><p>The service is defined in AndroidManifest.xml like so:</p>AndroidManifest.xml snippet<ol><li>&lt;service&nbsp;android:name=&quot;.sync.ContactsSyncAdapterService&quot;</li><li>&nbsp;android:exported=&quot;true&quot;&nbsp;android:process=&quot;:contacts&quot;&gt;</li><li>&nbsp;&lt;intent-filter&gt;</li><li>&nbsp;&nbsp;&lt;action&nbsp;android:name=&quot;android.content.SyncAdapter&quot;&nbsp;/&gt;</li><li>&nbsp;&lt;/intent-filter&gt;</li><li>&nbsp;&lt;meta-data&nbsp;android:name=&quot;android.content.SyncAdapter&quot;</li><li>&nbsp;&nbsp;android:resource=&quot;@xml/sync_contacts&quot;&nbsp;/&gt;</li><li>&lt;/service&gt;</li></ol><p>Finally, we need an xml file to let Android know that our sync provider handles Contacts for the Account type we defined in part 1.</p>sync_contacts.xml<ol><li>&lt;sync-adapter&nbsp;xmlns:android=&quot;<a href="http://schemas.android.com/apk/res/android&amp;quot" target="_blank" rel="external">http://schemas.android.com/apk/res/android&amp;quot</a>;</li><li>&nbsp; &nbsp;&nbsp;android:contentAuthority=&quot;com.android.contacts&quot;</li><li>&nbsp; &nbsp;&nbsp;android:accountType=&quot;fm.last.android.account&quot;/&gt;</li></ol><p>At this point we have a sync provider that doesn’t do anything, but also shouldn’t crash the Android system. Just in case, lets test it in Dev Tools first. Start the Android emulator and launch the “Dev Tools” app, then scroll down to “Sync Tester”.<br><a rel="external" href="http://www.c99.org/wp-content/uploads/2010/01/synctester.png" target="_blank"><img height="241" width="300" src="http://img.pickbox.me/wp-content/uploads/pic/85199c510fb30f24103d4f4cc895d143ac4b036e.jpg"></a><br>The drop-down should confirm that com.android.contacts can be synced with the account type you’ve created. Select the entry for your account type and press the “Bind” button to connect to your sync service. If all goes well, Sync Tester will say it’s connected to your service. Now click “Start Sync” and select your account from the popup. Sync Tester will let you know that the sync succeeded (even though we didn’t actually do anything). At this point it should be safe to enable contact syncing from the Accounts &amp; Sync settings screen without Android crashing and rebooting.<br><a rel="external" href="http://www.c99.org/wp-content/uploads/2010/01/contactsync.png" target="_blank"><img height="225" width="300" src="http://img.pickbox.me/wp-content/uploads/pic/06898418367adab48f94640c8bd4b31c8601e44e.jpg"></a></p>Contacts<p>Lets take a moment to discuss how Contacts on Android work. Each sync account, such as Google or Facebook, creates its own set of RawContacts which the Android system then aggregates into the single list of contacts you see in the Dialer. The RawContacts table contains several fields that Sync Providers can use for whatever they like, and in this implementation we will use the SYNC1 field to store the RawContact’s Last.fm username.</p>Contact Data<p>Data, such as name, phone number, email address, etc. is stored in a table that references a RawContact ID. The Data table can contain anything you like, and there are several&nbsp;<a href="http://developer.android.com/reference/android/provider/ContactsContract.CommonDataKinds.html" target="_blank" rel="external">predefined MIME-types available</a>&nbsp;for phone numbers, email addresses, names, etc. Android will automatically try to combine RawContacts that contain the same name, email address, etc. into a single Contact, and the user can also combine and split Contacts manually from the contact edit screen.<br><a rel="external" href="http://www.c99.org/wp-content/uploads/2010/01/aggregate.png" target="_blank"><img height="300" width="180" src="http://img.pickbox.me/wp-content/uploads/pic/f1230d2442a7d9339c0f473cad4bd11372f0016e.jpg"></a></p>Custom Data Types<p>A sync provider can store additional data about a RawContact in the Data table, and provide an xml file to tell the Contacts app how to format this row. To create a custom MIME type, we need to add an additional meta-data tag to our service entry in AndroidManifest.xml to reference a new ContactsSource XML file:</p>AndroidManifest.xml snippet<ol><li>&lt;meta-data&nbsp;android:name=&quot;android.provider.CONTACTS_STRUCTURE&quot;</li><li>&nbsp;android:resource=&quot;@xml/contacts&quot;&nbsp;/&gt;</li></ol><p>This ContactsSource xml file will tell the Contacts app how to format our custom MIME-types. In the example below, we specify an icon, and tell the Contacts app to use the DATA2 and DATA3 columns to render the fields. Note that this file’s format doesn’t appear to be documented outside of the&nbsp;<a href="http://www.google.com/codesearch/p?hl=en#oOy_5JrVRNM/trunk/packages/apps/Contacts/src/com/android/contacts/model/ExternalSource.java&amp;q=ContactsDataKind&amp;sa=N&amp;cd=1&amp;ct=rc" target="_blank" rel="external">source code for the Contacts app</a>.</p>contacts.xml<ol><li>&lt;ContactsSource&nbsp;xmlns:android=&quot;<a href="http://schemas.android.com/apk/res/android&quot;&amp;gt" target="_blank" rel="external">http://schemas.android.com/apk/res/android&quot;&amp;gt</a>;</li><li>&nbsp;&lt;ContactsDataKind</li><li>&nbsp;&nbsp;android:icon=&quot;@drawable/icon&quot;</li><li>&nbsp;&nbsp;android:mimeType=&quot;vnd.android.cursor.item/vnd.fm.last.android.profile&quot;</li><li>&nbsp;&nbsp;android:summaryColumn=&quot;data2&quot;</li><li>&nbsp;&nbsp;android:detailColumn=&quot;data3&quot;</li><li>&nbsp;&nbsp;android:detailSocialSummary=&quot;true&quot;&nbsp;/&gt;</li><li>&lt;/ContactsSource&gt;</li></ol><p>Here’s how Facebook’s custom “Facebook Profile” field looks when rendered by the Contacts app:<br><a rel="external" href="http://www.c99.org/wp-content/uploads/2010/01/facebookprofile.png" target="_blank"><img height="185" width="300" src="http://img.pickbox.me/wp-content/uploads/pic/7888347adab44aede80ac1abb31c8701a08bfb4e.jpg"></a></p>Creating a RawContact<p>Now lets put all the above information together to create a RawContact for a Last.fm user. Our contacts will display only a name and a custom field that links to the user’s Last.fm profile. We store the user’s username in the RawContact’s SYNC1 field so we can easily look it up later. We will batch together the creation of the RawContact and the insertion of the Data, as Android will run an aggregation pass after each batch completes.</p>addContact method<ol><li>private&nbsp;static&nbsp;void&nbsp;addContact(Account account,&nbsp;String&nbsp;name,&nbsp;String&nbsp;username)&nbsp;{</li><li>&nbsp;Log.i(TAG,&nbsp;&quot;Adding contact: &quot;&nbsp;+ name);</li><li>&nbsp;ArrayList&lt;ContentProviderOperation&gt;&nbsp;operationList =&nbsp;new&nbsp;ArrayList&lt;ContentProviderOperation&gt;();</li><li>&nbsp;</li><li>&nbsp;//Create our RawContact</li><li>&nbsp;ContentProviderOperation.Builder&nbsp;builder = ContentProviderOperation.newInsert(RawContacts.CONTENT_URI);</li><li>&nbsp;builder.withValue(RawContacts.ACCOUNT_NAME, account.name);</li><li>&nbsp;builder.withValue(RawContacts.ACCOUNT_TYPE, account.type);</li><li>&nbsp;builder.withValue(RawContacts.SYNC1, username);</li><li>&nbsp;operationList.add(builder.build());</li><li>&nbsp;</li><li>&nbsp;//Create a Data record of common type ‘StructuredName’ for our RawContact</li><li>&nbsp;builder = ContentProviderOperation.newInsert(ContactsContract.Data.CONTENT_URI);</li><li>&nbsp;builder.withValueBackReference(ContactsContract.CommonDataKinds.StructuredName.RAW_CONTACT_ID,&nbsp;0);</li><li>&nbsp;builder.withValue(ContactsContract.Data.MIMETYPE, ContactsContract.CommonDataKinds.StructuredName.CONTENT_ITEM_TYPE);</li><li>&nbsp;builder.withValue(ContactsContract.CommonDataKinds.StructuredName.DISPLAY_NAME, name);</li><li>&nbsp;operationList.add(builder.build());</li><li>&nbsp;</li><li>&nbsp;//Create a Data record of custom type &quot;vnd.android.cursor.item/vnd.fm.last.android.profile&quot; to display a link to the Last.fm profile</li><li>&nbsp;builder = ContentProviderOperation.newInsert(ContactsContract.Data.CONTENT_URI);</li><li>&nbsp;builder.withValueBackReference(ContactsContract.Data.RAW_CONTACT_ID,&nbsp;0);</li><li>&nbsp;builder.withValue(ContactsContract.Data.MIMETYPE,&nbsp;&quot;vnd.android.cursor.item/vnd.fm.last.android.profile&quot;);</li><li>&nbsp;builder.withValue(ContactsContract.Data.DATA1, username);</li><li>&nbsp;builder.withValue(ContactsContract.Data.DATA2,&nbsp;&quot;Last.fm Profile&quot;);</li><li>&nbsp;builder.withValue(ContactsContract.Data.DATA3,&nbsp;&quot;View profile&quot;);</li><li>&nbsp;operationList.add(builder.build());</li><li>&nbsp;</li><li>&nbsp;try&nbsp;{</li><li>&nbsp; mContentResolver.applyBatch(ContactsContract.AUTHORITY, operationList);</li><li>&nbsp;}&nbsp;catch&nbsp;(Exception&nbsp;e)&nbsp;{</li><li>&nbsp; Log.e(TAG,&nbsp;&quot;Something went wrong during creation! &quot;&nbsp;+ e);</li><li>&nbsp; e.printStackTrace();</li><li>&nbsp;}</li><li>}</li></ol>Social status updates<p>Android keeps another table for social networking status updates. Inserting a record into this table will replace any previous status if the timestamp of the insert is newer than the previous timestamp, otherwise the previous record will remain and the new insert will be discarded. A status update record is associated with a Data record, in our implementation we will associate it with our Last.fm profile record. Status records contain the status text, a package name where resources are located, an icon resource, and a label resource. Below is a function that will insert a status update, as well as updating our Last.fm Profile Data record to display the last track the user listened to. Note that for efficiency purposes, we will send all the updates in a single batch, so Android will only run a single aggregation pass at the end.</p>updateContactStatus method<ol><li>private&nbsp;static&nbsp;void&nbsp;updateContactStatus(ArrayList&lt;ContentProviderOperation&gt;&nbsp;operationList,&nbsp;longrawContactId,&nbsp;Track&nbsp;track)&nbsp;{</li><li>&nbsp;Uri rawContactUri = ContentUris.withAppendedId(RawContacts.CONTENT_URI, rawContactId);</li><li>&nbsp;Uri entityUri = Uri.withAppendedPath(rawContactUri,&nbsp;Entity.CONTENT_DIRECTORY);</li><li>&nbsp;Cursor&nbsp;c = mContentResolver.query(entityUri,&nbsp;new&nbsp;String[]&nbsp;{&nbsp;RawContacts.SOURCE_ID,&nbsp;Entity.DATA_ID,Entity.MIMETYPE,&nbsp;Entity.DATA1&nbsp;},&nbsp;null,&nbsp;null,&nbsp;null);</li><li>&nbsp;try&nbsp;{</li><li>&nbsp;&nbsp;while&nbsp;(c.moveToNext())&nbsp;{</li><li>&nbsp; &nbsp;if&nbsp;(!c.isNull(1))&nbsp;{</li><li>&nbsp; &nbsp;&nbsp;String&nbsp;mimeType = c.getString(2);</li><li>&nbsp; &nbsp;&nbsp;String&nbsp;status =&nbsp;&quot;&quot;;</li><li>&nbsp; &nbsp;&nbsp;if&nbsp;(track.getNowPlaying()&nbsp;!=&nbsp;null&nbsp;&amp;&amp;&nbsp;track.getNowPlaying().equals(&quot;true&quot;))</li><li>&nbsp; &nbsp; &nbsp;status =&nbsp;&quot;Listening to &quot;&nbsp;+ track.getName()&nbsp;+&nbsp;&quot; by &quot;&nbsp;+ track.getArtist();</li><li>&nbsp; &nbsp;&nbsp;else</li><li>&nbsp; &nbsp; &nbsp;status =&nbsp;&quot;Listened to &quot;&nbsp;+ track.getName()&nbsp;+&nbsp;&quot; by &quot;&nbsp;+ track.getArtist();</li><li>&nbsp;</li><li>&nbsp; &nbsp;&nbsp;if&nbsp;(mimeType.equals(&quot;vnd.android.cursor.item/vnd.fm.last.android.profile&quot;))&nbsp;{</li><li>&nbsp; &nbsp; &nbsp;ContentProviderOperation.Builder&nbsp;builder = ContentProviderOperation.newInsert(ContactsContract.StatusUpdates.CONTENT_URI);</li><li>&nbsp; &nbsp; &nbsp;builder.withValue(ContactsContract.StatusUpdates.DATA_ID, c.getLong(1));</li><li>&nbsp; &nbsp; &nbsp;builder.withValue(ContactsContract.StatusUpdates.STATUS, status);</li><li>&nbsp; &nbsp; &nbsp;builder.withValue(ContactsContract.StatusUpdates.STATUS_RES_PACKAGE,&nbsp;&quot;fm.last.android&quot;);</li><li>&nbsp; &nbsp; &nbsp;builder.withValue(ContactsContract.StatusUpdates.STATUS_LABEL, R.string.app_name);</li><li>&nbsp; &nbsp; &nbsp;builder.withValue(ContactsContract.StatusUpdates.STATUS_ICON, R.drawable.icon);</li><li>&nbsp; &nbsp; &nbsp;if&nbsp;(track.getDate()&nbsp;!=&nbsp;null)&nbsp;{</li><li>&nbsp; &nbsp; &nbsp;&nbsp;long&nbsp;date =&nbsp;Long.parseLong(track.getDate())&nbsp;*&nbsp;1000;</li><li>&nbsp; &nbsp; &nbsp; builder.withValue(ContactsContract.StatusUpdates.STATUS_TIMESTAMP, date);</li><li>&nbsp; &nbsp; &nbsp;}</li><li>&nbsp; &nbsp; &nbsp;operationList.add(builder.build());</li><li>&nbsp;</li><li>&nbsp; &nbsp; &nbsp;builder = ContentProviderOperation.newUpdate(ContactsContract.Data.CONTENT_URI);</li><li>&nbsp; &nbsp; &nbsp;builder.withSelection(BaseColumns._ID +&nbsp;&quot; = ‘&quot;&nbsp;+ c.getLong(1)&nbsp;+&nbsp;&quot;’&quot;,&nbsp;null);</li><li>&nbsp; &nbsp; &nbsp;builder.withValue(ContactsContract.Data.DATA3, status);</li><li>&nbsp; &nbsp; &nbsp;operationList.add(builder.build());</li><li>&nbsp; &nbsp;&nbsp;}</li><li>&nbsp; &nbsp;}</li><li>&nbsp;&nbsp;}</li><li>&nbsp;}&nbsp;finally&nbsp;{</li><li>&nbsp; c.close();</li><li>&nbsp;}</li><li>}</li></ol><p>Here’s how the contact record looks after we’ve inserted a status update record and updated our data record:<br><a rel="external" href="http://www.c99.org/wp-content/uploads/2010/01/lastfmstatus.png" target="_blank"><img height="257" width="300" src="http://img.pickbox.me/wp-content/uploads/pic/f1b440a7d933c89584d93b34d11373f08302006e.jpg"></a></p>Putting It All Together<p>Now that we have our utility functions written, we can fill in the body of our performSync method. We’re going to take a very simple approach to syncing: we’ll grab the list of RawContact IDs currently associated with Last.fm usernames, and we’ll create a RawContact for any Last.fm friend that doesn’t currently have one. If a RawContact already exists, we’ll fetch their most recent track and post a status update. Note that this is a one-way sync, we’re not dealing with local deletions or changes.</p>performSync method<ol><li>private&nbsp;static&nbsp;void&nbsp;performSync(Context&nbsp;context, Account account, Bundle extras,&nbsp;String&nbsp;authority, ContentProviderClient provider, SyncResult syncResult)</li><li>&nbsp;&nbsp;throws&nbsp;OperationCanceledException&nbsp;{</li><li>&nbsp;HashMap&lt;String, Long&gt;&nbsp;localContacts =&nbsp;new&nbsp;HashMap&lt;String, Long&gt;();</li><li>&nbsp;mContentResolver = context.getContentResolver();</li><li>&nbsp;Log.i(TAG,&nbsp;&quot;performSync: &quot;&nbsp;+ account.toString());</li><li>&nbsp;</li><li>&nbsp;// Load the local Last.fm contacts</li><li>&nbsp;Uri rawContactUri = RawContacts.CONTENT_URI.buildUpon().appendQueryParameter(RawContacts.ACCOUNT_NAME, account.name).appendQueryParameter(</li><li>&nbsp; &nbsp;RawContacts.ACCOUNT_TYPE, account.type).build();</li><li>&nbsp;Cursor&nbsp;c1 = mContentResolver.query(rawContactUri,&nbsp;new&nbsp;String[]&nbsp;{&nbsp;BaseColumns._ID, RawContacts.SYNC1&nbsp;},null,&nbsp;null,&nbsp;null);</li><li>&nbsp;while&nbsp;(c1.moveToNext())&nbsp;{</li><li>&nbsp; localContacts.put(c1.getString(1), c1.getLong(0));</li><li>&nbsp;}</li><li>&nbsp;</li><li>&nbsp;ArrayList&lt;ContentProviderOperation&gt;&nbsp;operationList =&nbsp;new&nbsp;ArrayList&lt;ContentProviderOperation&gt;();</li><li>&nbsp;LastFmServer server = AndroidLastFmServerFactory.getServer();</li><li>&nbsp;try&nbsp;{</li><li>&nbsp; Friends friends = server.getFriends(account.name,&nbsp;&quot;&quot;,&nbsp;&quot;50&quot;);</li><li>&nbsp;&nbsp;for&nbsp;(User user : friends.getFriends())&nbsp;{</li><li>&nbsp; &nbsp;if&nbsp;(!localContacts.containsKey(user.getName()))&nbsp;{</li><li>&nbsp; &nbsp;&nbsp;if&nbsp;(user.getRealName().length()&nbsp;&gt;&nbsp;0)</li><li>&nbsp; &nbsp; &nbsp;addContact(account, user.getRealName(), user.getName());</li><li>&nbsp; &nbsp;&nbsp;else</li><li>&nbsp; &nbsp; &nbsp;addContact(account, user.getName(), user.getName());</li><li>&nbsp; &nbsp;}&nbsp;else&nbsp;{</li><li>&nbsp; &nbsp;&nbsp;Track[]&nbsp;tracks = server.getUserRecentTracks(user.getName(),&nbsp;&quot;true&quot;,&nbsp;1);</li><li>&nbsp; &nbsp;&nbsp;if&nbsp;(tracks.length&nbsp;&gt;&nbsp;0)&nbsp;{</li><li>&nbsp; &nbsp; &nbsp;updateContactStatus(operationList, localContacts.get(user.getName()), tracks[0]);</li><li>&nbsp; &nbsp;&nbsp;}</li><li>&nbsp; &nbsp;}</li><li>&nbsp;&nbsp;}</li><li>&nbsp;&nbsp;if(operationList.size()&nbsp;&gt;&nbsp;0)</li><li>&nbsp; &nbsp;mContentResolver.applyBatch(ContactsContract.AUTHORITY, operationList);</li><li>&nbsp;}&nbsp;catch&nbsp;(Exception&nbsp;e1)&nbsp;{</li><li>&nbsp;&nbsp;// TODO Auto-generated catch block</li><li>&nbsp; e1.printStackTrace();</li><li>&nbsp;}</li><li>}</li></ol>Contact visibility<p>By default, new contacts that you create from your sync provider are not shown by the Contacts app. Instead, it will show only contacts it has aggregated with other visible sources. To enable the display of contacts that only exist in your provider, press the Menu button and select “Display options”, then expand the entry for your account and tap the checkbox next to “All Contacts”. This is a good default, as I don’t really want my address book to be littered with hundreds of twitter contacts!</p>Final Thoughts<p>The Android platform is awesome. The lack of documentation, however, is quite disappointing. While it’s great that I can dig through the system source code while troubleshooting and figuring things out, I shouldn’t have to!</p><p>Sync providers require Android 2.0, which is currently only available on 2 devices. The Account modifications I made to our login activity will need to be reimplemented using class introspection in order to keep compatibility with Android 1.5.</p><p>This sync provider is far from complete — I still need to figure out how to control the sync interval, set my sync provider as read-only since local changes are ignored, I might grab the user’s avatar if they don’t currently have an icon, and add a fancy “Do you want to sync your contacts?” popup to the login process similar to Facebook’s.</p><p>Hopefully this will help other developers out there struggling with the lack of documentation, as I’m looking forward to seeing twitter status updates in the contacts app in the future!</p><p>The source code for the implementation referenced here is available in my&nbsp;<a href="http://github.com/c99koder/lastfm-android/" target="_blank" rel="external">Last.fm github project</a>&nbsp;under the terms of the GNU General Public License. A standalone sample project is also available&nbsp;<a href="http://github.com/c99koder/AndroidSyncProviderDemo" target="_blank" rel="external">here</a>&nbsp;under the terms of the Apache License 2.0. Google has also released their own sample sync provider on the&nbsp;<a href="http://developer.android.com/resources/samples/SampleSyncAdapter/index.html" target="_blank" rel="external">Android developer portal</a>that’s a bit more complete than mine.</p>Categories:&nbsp;<a rel="external" title="View all posts in Android" href="http://www.c99.org/category/android/" target="_blank">Android</a><p></p> <p></p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2012/01/10/Writing-an-Android-Sync-Provider-Part-2/" class="archive-article-date">
  	<time datetime="2012-01-10T05:23:00.000Z" itemprop="datePublished"><i class="icon-clock"></i>2012-01-10</time>
</a>
      
      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Android/">Android</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>

  
<nav id="article-nav">
  
    <a href="/2012/02/17/Android-KeyEvent-的-生命周期/" id="article-nav-newer" class="article-nav-link-wrap">
      <i class="icon-circle-left"></i>
      <div class="article-nav-title">
        
          Android KeyEvent 的 生命周期
        
      </div>
    </a>
  
  
    <a href="/2011/11/25/JQuery参考/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">JQuery参考</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>




<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">Share to: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
	    <a class="jiathis_button_twitter"></a>
	    <a class="jiathis_button_plus"></a> 
	    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="//v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>









      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 jfo
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true
	}
</script>

<script src="/./main.js"></script>


    
<div class="tools-col">
  <ul class="btn-wrap">
    
      <li class="chose" data-hook="tools-section-all"><span class="text">全部</span><i class="icon-book"></i></li>
    
    
      <li data-hook="tools-section-tag"><span class="text">标签</span><i class="icon-price-tags"></i></li>
    
    
      <li data-hook="tools-section-friends"><span class="text">友链</span><i class="icon-link"></i></li>
    
    
      <li data-hook="tools-section-me"><span class="text">我</span><i class="icon-smile"></i></li>
    
  </ul>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all chose">
    	</section>
    

    
    	<section class="tools-section tools-section-tag">
    			<div class="widget tagcloud" id="js-tagcloud">
    				<ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">87</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Arduino-OpenWrt/">Arduino/OpenWrt</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/DefaultCategory/">DefaultCategory</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Distributed-Computing/">Distributed Computing</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/English/">English</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Google/">Google</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">25</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Life/">Life</a><span class="category-list-count">67</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">52</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux-App/">Linux App</a><span class="category-list-count">61</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux-Debug/">Linux Debug</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux-Virtualization/">Linux Virtualization</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mac-OS-X/">Mac OS X</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mobile/">Mobile</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Network/">Network</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Saying/">Saying</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/WebDev/">WebDev</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Windows/">Windows</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/c-c-template-gp-boost/">c++/c++ template/gp/boost</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/c-c-algorithm/">c/c++/algorithm</a><span class="category-list-count">36</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/cocos2d-x-模拟器/">cocos2d-x/模拟器</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/com组件/">com组件</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/framework/">framework</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/gcc-binutils-make-共享库/">gcc/binutils/make/共享库</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/js-html-python/">js/html/python</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/l4ka-pistachio-iguana/">l4ka::pistachio/iguana</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux-图形/">linux 图形</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python-js-php-html-mysql-http/">python/js/php/html/mysql/http</a><span class="category-list-count">46</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/reading/">reading</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/self-collect/">self_collect</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/unifiedkernel-wine-reactos/">unifiedkernel/wine/reactos</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/wordpress/">wordpress</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/产品/">产品</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/教育/">教育</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数学-物理/">数学/物理</a><span class="category-list-count">3</span></li></ul>
    			</div>
    	</section>
    

    
    	<section class="tools-section tools-section-friends">
  		
  			<div class="friends-wrap" id="js-friends">
  			
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://iguangba.pickbox.me/">爱逛吧</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.pickbox.me/">收藏夹</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://note.pickbox.me/">网络剪贴板</a>
  	        
  	        </div>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">jfojfo#gmail.com</div>
  	  	
    	</section>
    
  </div>
  
</div>

    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>