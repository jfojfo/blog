<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="jfo, blog" />





  <link rel="alternate" href="/atom.xml" title="jfo planet" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="Instrumentation.callActivityOnCreate(Activity, Bundle) line: 1047&amp;#160;&amp;#160;&amp;#160; ActivityThread.performLaunchActivity(ActivityThread$ActivityRecord, Intent) line: 2459&amp;#160;&amp;#160;&amp;#160; ActivityTh">
<meta property="og:type" content="article">
<meta property="og:title" content="Activity启动流程(1)">
<meta property="og:url" content="http://blog.pickbox.me/2010/08/21/Activity启动流程-1/index.html">
<meta property="og:site_name" content="jfo planet">
<meta property="og:description" content="Instrumentation.callActivityOnCreate(Activity, Bundle) line: 1047&amp;#160;&amp;#160;&amp;#160; ActivityThread.performLaunchActivity(ActivityThread$ActivityRecord, Intent) line: 2459&amp;#160;&amp;#160;&amp;#160; ActivityTh">
<meta property="og:image" content="http://img.pickbox.me/wp-content/uploads/pic/486d5066de7fd060aa184c5a.jpg">
<meta property="og:image" content="http://img.pickbox.me/wp-content/uploads/pic/2f90b8a13b7cabcf46106427.jpg">
<meta property="og:image" content="http://img.pickbox.me/wp-content/uploads/pic/2ba9b400b79ce3c3e850cd21.jpg">
<meta property="og:image" content="http://img.pickbox.me/wp-content/uploads/pic/61adfadc257063e5cc116622.jpg">
<meta property="og:image" content="http://img.pickbox.me/wp-content/uploads/pic/69bbd60726893f897a89472c.jpg">
<meta property="og:image" content="http://img.pickbox.me/wp-content/uploads/pic/47a89950f9b70c268435242f.jpg">
<meta property="og:updated_time" content="2016-10-15T05:24:27.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Activity启动流程(1)">
<meta name="twitter:description" content="Instrumentation.callActivityOnCreate(Activity, Bundle) line: 1047&amp;#160;&amp;#160;&amp;#160; ActivityThread.performLaunchActivity(ActivityThread$ActivityRecord, Intent) line: 2459&amp;#160;&amp;#160;&amp;#160; ActivityTh">
<meta name="twitter:image" content="http://img.pickbox.me/wp-content/uploads/pic/486d5066de7fd060aa184c5a.jpg">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://blog.pickbox.me/2010/08/21/Activity启动流程-1/"/>


  <title> Activity启动流程(1) | jfo planet </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">jfo planet</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Hope is the best gift that tomorrow gives.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Activity启动流程(1)
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2010-08-21T22:08:00+08:00" content="2010-08-21">
              2010-08-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p> <br>Instrumentation.callActivityOnCreate(Activity, Bundle) line: 1047&#160;&#160;&#160; <br>ActivityThread.performLaunchActivity(ActivityThread$ActivityRecord, Intent) line: 2459&#160;&#160;&#160; <br>ActivityThread.handleLaunchActivity(ActivityThread$ActivityRecord, Intent) line: 2512&#160;&#160;&#160; <br>ActivityThread.access$2200(ActivityThread, ActivityThread$ActivityRecord, Intent) line: 119&#160;&#160;&#160; <br>ActivityThread$H.handleMessage(Message) line: 1863&#160;&#160;&#160; <br>ActivityThread$H(Handler).dispatchMessage(Message) line: 99&#160;&#160;&#160; <br>Looper.loop() line: 123&#160;&#160;&#160; <br>ActivityThread.main(String[]) line: 4363&#160;&#160;&#160; <br>Method.invokeNative(Object, Object[], Class, Class[], Class, int, boolean) line: not available [native method]&#160;&#160;&#160; <br>Method.invoke(Object, Object…) line: 521&#160;&#160;&#160; <br>ZygoteInit$MethodAndArgsCaller.run() line: 860&#160;&#160;&#160; <br>ZygoteInit.main(String[]) line: 618&#160;&#160;&#160; <br>NativeStart.main(String[]) line: not available [native method]&#160;&#160;&#160; <br><br><br>Dalvik_dalvik_system_Zygote_fork()@dalvik/vm/native/dalvik_system_Zygote.c<br>Dalvik_dalvik_system_Zygote_forkAndSpecialize()@dalvik/vm/native/dalvik_system_Zygote.c<br>Dalvik_dalvik_system_Zygote_forkSystemServer()@dalvik/vm/native/dalvik_system_Zygote.c<br>const DalvikNativeMethod dvm_dalvik_system_Zygote[] = {<br>{ &quot;fork&quot;,&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &quot;()I&quot;,<br>Dalvik_dalvik_system_Zygote_fork },<br>{ &quot;forkAndSpecialize&quot;,&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &quot;(II[II[[I)I&quot;,<br>Dalvik_dalvik_system_Zygote_forkAndSpecialize },<br>{ &quot;forkSystemServer&quot;,&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &quot;(II[II[[I)I&quot;,<br>Dalvik_dalvik_system_Zygote_forkSystemServer },<br>{ NULL, NULL, NULL },<br>};<br><br><br><br><a href="http://blog.csdn.net/maxleng/archive/2010/05/24/5621345.aspx" target="_blank">Android Application</a></p><p>&#160;&#160;&#160; Android提供给开发程序员的概念空间中Application只是一个松散的表征概念，没有多少实质上的表征。在Android实际空间中看不到实 际意义上的应用程序的概念,即使有一个叫Application的类，这个也就是个应用程序上下文状态，是一个极度弱化的概念。Application只 是一个空间范畴的概念，Application就是Activity，Service之类的组件上下文描述。Application并不是Android 的核心概念，而Activity才是Android的核心概念。</p><p>&#160;&#160;&#160; 从Android的SDK文档中，我们知道一般情况Android应用程序是由以下四种组件构造而成的：Activity，Broadcast Intent Receiver，服务（Service），内容提供器（Content Provider）。我们可以使用下面的图来表示一下Android的概念空间。这些组件依附于应用程序中，应用程序并不会一开始就建立起来，而是在这些 组件建立起来后，需要运行时，才开始建立应用程序对象。</p><p><a href="http://hi.csdn.net/attachment/201005/24/0_1274715036pPGc.gif" target="_blank" rel="external"><img class="blogimg" small="0" src="http://img.pickbox.me/wp-content/uploads/pic/486d5066de7fd060aa184c5a.jpg"><br></a></p>2.1应用进程名称<p>&#160;&#160;&#160; 为什么要从应用进程名称开始？作为内核研究，我们还是回到问题的最本质处：不管Activity，Service等组件如何设计和运行，它要提供服务，就 必须要依附在Linux的进程上，建立消息循环，组件才能够真正的运作。Activity实例是如何Hosting在Linux进程上的？这个是我们首先 想要弄明白的。</p><p>我们在<a href="http://androidappdocs.appspot.com/guide/topics/manifest/manifest-element.html" target="_blank" rel="external"></a>的<a href="http://blog.csdn.net/maxleng/archive/2010/05/24/5621345.aspx#proc#proc" target="_blank" rel="external">process</a>=&quot;string&quot;这个定义。</p><blockquote><p><a href="http://blog.csdn.net/maxleng/archive/2010/05/24/5621345.aspx#clear#clear" target="_blank" rel="external">allowClearUserData</a>=[&quot;true&quot; | &quot;false&quot;]        <br>android:<a href="http://blog.csdn.net/maxleng/archive/2010/05/24/5621345.aspx#reparent#reparent" target="_blank" rel="external">allowTaskReparenting</a>=[&quot;true&quot; | &quot;false&quot;]        <br>android:<a href="http://blog.csdn.net/maxleng/archive/2010/05/24/5621345.aspx#agent#agent" target="_blank" rel="external">backupAgent</a>=&quot;string&quot;        <br>…</p><p>android:<a href="http://blog.csdn.net/maxleng/archive/2010/05/24/5621345.aspx#label#label" target="_blank" rel="external">label</a>=&quot;string resource&quot;        <br>android:<a href="http://blog.csdn.net/maxleng/archive/2010/05/24/5621345.aspx#space#space" target="_blank" rel="external">manageSpaceActivity</a>=&quot;string&quot;        <br>android:<a href="http://blog.csdn.net/maxleng/archive/2010/05/24/5621345.aspx#nm#nm" target="_blank" rel="external">name</a>=&quot;string&quot;        <br>android:<a href="http://blog.csdn.net/maxleng/archive/2010/05/24/5621345.aspx#prmsn#prmsn" target="_blank" rel="external">permission</a>=&quot;string&quot;        <br>android:<a href="http://blog.csdn.net/maxleng/archive/2010/05/24/5621345.aspx#persistent#persistent" target="_blank" rel="external">persistent</a>=[&quot;true&quot; | &quot;false&quot;]        <br>android:<a href="http://blog.csdn.net/maxleng/archive/2010/05/24/5621345.aspx#proc#proc" target="_blank" rel="external">process</a>=&quot;string&quot;        <br>android:<a href="http://blog.csdn.net/maxleng/archive/2010/05/24/5621345.aspx#restoreany#restoreany" target="_blank" rel="external">restoreAnyVersion</a>=[&quot;true&quot; | &quot;false&quot;]        <br>android:<a href="http://blog.csdn.net/maxleng/archive/2010/05/24/5621345.aspx#aff#aff" target="_blank" rel="external">taskAffinity</a>=&quot;string&quot;        <br>android:<a href="http://blog.csdn.net/maxleng/archive/2010/05/24/5621345.aspx#theme#theme" target="_blank" rel="external">theme</a>=&quot;resource or theme&quot; &gt;        <br>. . .         <br></p></blockquote><p>在SDK用已经描述的很清楚到了。</p><p>android:process</p><p>The name of a process where all components of the application should run. Each component can override this default by setting its own process attribute.</p><p>By default, Android creates a process for an application when the first of its components needs to run. All components then run in that process. The name of the default process matches the package name set by the <a href="http://androidappdocs.appspot.com/guide/topics/manifest/manifest-element.html" target="_blank" rel="external"></a> element.</p><p>By setting this attribute to a process name that’s shared with another application, you can arrange for components of both applications to run in the same process — but only if the two applications also share a user ID and be signed with the same certificate.</p><p>为什么要提出这么一个定义？android:process名称。</p><p>&#160;&#160;&#160; 默认状态下，Activity Manager Service在应用程序的第一个组件需要运行时将会为应用程序建立一个进程，而这个进程的名字就是android:process=”string”所 指定，缺省的是应用程序包的名字。该进程一旦建立，后面的该应用的组件都将运行在该进程中，他们绑定的根据就是这个Android：Process指定的 名称，因为在他们都在同一个应用程序包里，也就具有了同样的进程名字，于是他们都托管在了同一进程中。组件将通过ClassLoader从Package 中获取到应用程序的信息。</p><p>&#160;&#160;&#160; 在建立Actvitiy时，如果在应用进程端没有应用对象，系统在该过程中利用makeApplication建立一个Application对象，实例 化&quot;android.app.Application&quot;，建立一个应用程序上下文完成例如资源，package等信息管理。</p>2.2&#160; ActivityThread运行框架<p>&#160;&#160;&#160; 在分析中，我们可以看到真正对应应用进程的不是Application而是ActivityThread。我们从实际的应用堆栈可以看到：</p><blockquote><p>NaiveStart.main()</p></blockquote><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; ZygoteInit.main</p><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ZygoteInit$MethodAndArgsCall.run</p><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Method.Invoke</p><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; method.invokeNative</p><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ActivityThread.main()</p><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Looper.loop()</p><p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ….</p><p>&#160;&#160;&#160; 每个应用程序都以ActivityThread.main()为入口进入到消息循环处理。对于一个进程来讲，我们需要这个闭合的处理框架。</p><p><a href="http://hi.csdn.net/attachment/201005/24/0_1274715037oaa7.gif" target="_blank" rel="external"><img class="blogimg" small="0" src="http://img.pickbox.me/wp-content/uploads/pic/2f90b8a13b7cabcf46106427.jpg"><br></a></p><p>&#160;&#160;&#160; ActivitiyThread是应用程序概念空间的重要概念，他建立了应用进程运行的框架，并提供了一个IActivityThread接口作为与 Activity Manager Service的通讯接口.通过该接口AMS可以将Activity的状态变化传递到客户端的Activity对象。</p>2．3 ActivitiyThread的建立<p>为了叙述的方便我将Actvitiy Manager Service简写成AMS。</p><p>&#160;&#160;&#160; 在AMS中关于应用程序的概念是ProcessRecord，请求都是从Activity，Service…等开始的，在Activity需要Resume时，此时如果与Activity相关的应用进程没有起来，AM则启动应用进程。</p><p>AMS与应用进程的绑定分为两个部分，第一部分就是AM建立应用进程，第二部分就是应用进程Attach到AM，与AM建立通讯通道。</p><p>1）创建建立进程：startProcessLocked(processName,Appinfo.uid)。该函数在StartSecificActivityLocked等调用。</p><p>（1） 建立ProcessRecord对象app,并将该对象添加到mProcessNames中。应用对象在mProcessNames中使用应用名字和 uid来标识自己。如果在同一个Package中的Activity,如果都使用默认设置，那么这些Activity都会托管在同一个进程中，这是因为他 们在带的ApplicationInfo中的ProcessName都是一样的。</p><p><a href="http://hi.csdn.net/attachment/201005/24/0_1274715038X0aT.gif" target="_blank" rel="external"><img class="blogimg" small="0" src="http://img.pickbox.me/wp-content/uploads/pic/2ba9b400b79ce3c3e850cd21.jpg"><br></a>&#160;</p><p><a href="http://hi.csdn.net/attachment/201005/24/0_12747150398uU3.gif" target="_blank" rel="external"><img class="blogimg" small="0" src="http://img.pickbox.me/wp-content/uploads/pic/61adfadc257063e5cc116622.jpg"><br></a></p><p>mPidsSelfLocked数组记录了PID，这个将会在应用进程跑起来后，将自己Attach到AM时，根据pid找到自己的前世：ProcessRecord.</p><p>2）android.app.ActivityThread进程启动</p><p>&#160;&#160;&#160;&#160; Android.app.ActivityThread进程建立后，将跳入到ActivityThread的main函数开始运行，进入消息循环。<a href="http://hi.csdn.net/attachment/201005/24/0_1274715040RR9z.gif" target="_blank" rel="external"><img class="blogimg" small="0" src="http://img.pickbox.me/wp-content/uploads/pic/69bbd60726893f897a89472c.jpg"><br></a></p><p>&#160;&#160;&#160; 应用进程使用thread.attach()发起AMS的AttachApplicationLocked调用，并传递 ActvitiyThread对象和CallingPid。AttachApplicationLocked将根据CallingPid在 mPidsSelfLocked找到对应的ProcessRecord实例app,将ActvitiyThread放置app.thread中。这样应用 进程和AMS建立起来双向连接。AM可以使用AIDL接口，通过app.thread可以访问应用进程的对象。</p><p>&#160;&#160;&#160; 应用程序通过ActivityThread提供的框架，建立消息循环Looper和Handler。从前面的相关章节我们知道有Looper和Handler,整个系统就可以运作了。</p><p>为了更为系统的了解应用程序的建立时序及其涉及到数据操作，我给出了应用进程的建立过程示意图：</p><p>&#160;<a href="http://hi.csdn.net/attachment/201005/24/0_12747150430h53.gif" target="_blank" rel="external"><img class="blogimg" small="0" src="http://img.pickbox.me/wp-content/uploads/pic/47a89950f9b70c268435242f.jpg"><br></a></p><br><br><br><del>to be continue</del> <p></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2010/08/20/android-启动流程/" rel="next" title="android 启动流程">
                <i class="fa fa-chevron-left"></i> android 启动流程
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2010/08/23/Android-Framework-分析/" rel="prev" title="Android Framework 分析">
                Android Framework 分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/wp-content/uploads/penguin.gif"
               alt="jfo" />
          <p class="site-author-name" itemprop="name">jfo</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">595</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">36</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/jfojfo" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/jfojfo" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.pickbox.me" title="收藏夹" target="_blank">收藏夹</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://note.pickbox.me" title="网络剪贴板" target="_blank">网络剪贴板</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://iguangba.pickbox.me" title="爱逛吧" target="_blank">爱逛吧</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <p class="post-toc-empty">此文章未包含目录</p>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2007 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jfo</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = false;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = decodeURIComponent(data.url);
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title >= 0 || index_content >= 0 ){
                                isMatch = true;
								if (i == 0) {
                                    first_occur = index_content;
                                }
                            } 
							
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

  

  
<script type="text/javascript">
function attach () {
    $('body').append('<img src="http://p.pickbox.me/pv">');
    $(document).unbind('scroll', attach);
}
$(document).bind('scroll', attach);
</script>



</body>
</html>
