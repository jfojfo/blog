<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="jfo, blog" />





  <link rel="alternate" href="/atom.xml" title="jfo planet" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="http://hi.baidu.com/j%5Ffo/blog/item/95f3f424c721aa328744f9b0.html/ Message queue control operation.  /int msgctl (int msqid, int cmd, struct msqid_ds __buf);/ Get messages queue.  /int msgget (key_t">
<meta property="og:type" content="article">
<meta property="og:title" content="IPC programming ：message queues">
<meta property="og:url" content="http://blog.pickbox.me/2008/03/05/IPC-programming-：message-queues/index.html">
<meta property="og:site_name" content="jfo planet">
<meta property="og:description" content="http://hi.baidu.com/j%5Ffo/blog/item/95f3f424c721aa328744f9b0.html/ Message queue control operation.  /int msgctl (int msqid, int cmd, struct msqid_ds __buf);/ Get messages queue.  /int msgget (key_t">
<meta property="og:updated_time" content="2016-10-15T05:24:27.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="IPC programming ：message queues">
<meta name="twitter:description" content="http://hi.baidu.com/j%5Ffo/blog/item/95f3f424c721aa328744f9b0.html/ Message queue control operation.  /int msgctl (int msqid, int cmd, struct msqid_ds __buf);/ Get messages queue.  /int msgget (key_t">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://blog.pickbox.me/2008/03/05/IPC-programming-：message-queues/"/>


  <title> IPC programming ：message queues | jfo planet </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">jfo planet</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Hope is the best gift that tomorrow gives.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule" rel="section">
            
            日程
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                IPC programming ：message queues
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2008-03-05T22:41:00+08:00" content="2008-03-05">
              2008-03-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p> <a href="http://hi.baidu.com/j%5Ffo/blog/item/95f3f424c721aa328744f9b0.html" target="_blank">http://hi.baidu.com/j%5Ffo/blog/item/95f3f424c721aa328744f9b0.html</a><br><br>/<em> Message queue control operation.  </em>/<br>int msgctl (int <strong>msqid, int </strong>cmd, struct msqid_ds <em>__buf);<br><br>/</em> Get messages queue.  <em>/<br>int msgget (key_t <strong>key, int </strong>msgflg);<br><br>/</em> Receive message from message queue.  <em>/<br>int msgrcv (int __msqid, void </em><strong>msgp, size_t </strong>msgsz, long int <strong>msgtyp, int </strong>msgflg);<br><br>/<em> Send message to message queue.  </em>/<br>int msgsnd (int <strong>msqid, </strong>const void <em><strong>msgp, size_t </strong>msgsz, int __msgflg);<br><br><br>ipcs<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   -t&nbsp;&nbsp;&nbsp;&nbsp;   time<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   -p&nbsp;&nbsp;&nbsp;&nbsp;   pid<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   -c&nbsp;&nbsp;&nbsp;&nbsp;   creator<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   -l&nbsp;&nbsp;&nbsp;&nbsp;   limits<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   -u&nbsp;&nbsp;&nbsp;&nbsp;   summary<br>&nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;    -i&nbsp;&nbsp;    &nbsp;&nbsp;   id<br><br>ipcrm<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   -M shmkey<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   removes the shared memory segment created with shmkey after  the<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   last detach is performed.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   -m shmid<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   removes  the shared memory segment identified by shmid after the<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   last detach is performed.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   -Q msgkey<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   removes the message queue created with msgkey.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   -q msgid<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   removes the message queue identified by msgid.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   -S semkey<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   removes the semaphore created with semkey.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   -s semid<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   removes the semaphore identified by semid.<br><br><br> <hr><br><br>/</em><br><em> private-queue-hello-world.c - a &quot;hello world&quot; example in which a single<br></em> process creates a message queue and sends<br><em> itself a &quot;hello world&quot; message via this queue.<br></em>/<br>#include &lt;stdio.h&gt;<br>#include &lt;sys/types.h&gt;<br>#include &lt;sys/ipc.h&gt;<br>#include &lt;sys/msg.h&gt;<br>int main(int argc, char<em> argv[])<br>{<br>&nbsp;&nbsp;&nbsp;      /</em><br>&nbsp;&nbsp;&nbsp;      Creating A Message Queue - msgget()<br>&nbsp;&nbsp;&nbsp;      In order to use a message queue, it has to be created first. The msgget() system call is used to do just that. This system call accepts two parameters - a queue key, and flags. The key may be one of:<br>&nbsp;&nbsp;&nbsp;      &nbsp;&nbsp;&nbsp;      1. IPC_PRIVATE (0) - used to create a private message queue.<br>&nbsp;&nbsp;&nbsp;      &nbsp;&nbsp;&nbsp;      2. a positive integer - used to create (or access) a publicly-accessible message queue.<br>&nbsp;&nbsp;&nbsp;      The second parameter contains flags that control how the system call is to be processed. It may contain flags like IPC_CREAT or IPC_EXCL, which behave similar to O_CREAT and O_EXCL in the open() system call.<br>&nbsp;&nbsp;&nbsp;      <em>/<br>&nbsp;&nbsp;        /</em> create a private message queue, with access only to the owner. <em>/<br>&nbsp;&nbsp;        int queue_id = msgget(IPC_PRIVATE, 0600);<br><br>&nbsp;&nbsp;&nbsp;       /</em><br>&nbsp;&nbsp;&nbsp;       struct msgbuf {<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       long mtype; / <em> message type, a positive number (cannot be zero). </em> /<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       char mtext[1]; / <em> message body array. usually larger then one byte. </em> /<br>&nbsp;&nbsp;&nbsp;       };<br>&nbsp;&nbsp;&nbsp;       <em>/<br>&nbsp;&nbsp;&nbsp;       struct msgbuf</em> msg;<br>&nbsp;&nbsp;        struct msgbuf<em> recv_msg;<br>&nbsp;&nbsp;        int rc;<br>&nbsp;&nbsp;        if (queue_id == -1) {<br>&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;        perror(&quot;main: msgget&quot;);<br>&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;        exit(1);<br>&nbsp;&nbsp;        }<br>&nbsp;&nbsp;        printf(&quot;message queue created, queue id ‘%d’.n&quot;, queue_id);<br>&nbsp;&nbsp;        msg = (struct msgbuf</em>)malloc(sizeof(struct msgbuf)+strlen(&quot;hello world&quot;));<br><br>&nbsp;&nbsp;&nbsp;       /<em> set the message type. for example - set it to ‘1’. </em>/<br>&nbsp;&nbsp;        msg-&gt;mtype = 1;<br>&nbsp;&nbsp;        strcpy(msg-&gt;mtext, &quot;hello world&quot;);<br>&nbsp;&nbsp;&nbsp;       /<em><br>&nbsp;&nbsp;&nbsp;       Writing Messages Onto A Queue - msgsnd()<br>&nbsp;&nbsp;&nbsp;       Once we created the message queue, and a message structure, we can place it on the message queue, using the<br>&nbsp;&nbsp;&nbsp;       msgsnd() system call. This system call copies our message structure and places that as the last message on the queue.<br>&nbsp;&nbsp;&nbsp;       It takes the following parameters:<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       1. int msqid  - id of message queue, as returned from the msgget() call.<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       2. struct msgbuf</em> msg - a pointer to a properly initializes message structure, such as the one we prepared in<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       the previous section.<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       3. int msgsz - the size of the data part (mtext) of the message, in bytes.<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       4. int msgflg - flags specifying how to send the message. may be a logical &quot;or&quot; of the following:<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       IPC_NOWAIT - if the message cannot be sent immediately, without blocking the process, return ‘-1’, and<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       set errno to EAGAIN.<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       to set no flags, use the value ‘0’.<br>&nbsp;&nbsp;&nbsp;       <em>/<br>&nbsp;&nbsp;        rc = msgsnd(queue_id, msg, strlen(msg-&gt;mtext)+1, 0);<br>&nbsp;&nbsp;        if (rc == -1) {<br>&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;        perror(&quot;main: msgsnd&quot;);<br>&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;        exit(1);<br>&nbsp;&nbsp;        }<br>&nbsp;&nbsp;        free(msg);<br>&nbsp;&nbsp;        printf(&quot;message placed on the queue successfully.n&quot;);<br><br>&nbsp;&nbsp;&nbsp;       recv_msg = (struct msgbuf</em>)malloc(sizeof(struct msgbuf)+strlen(&quot;hello<br>&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;        world&quot;));<br><br>&nbsp;&nbsp;&nbsp;       /<em><br>&nbsp;&nbsp;&nbsp;       int msgtyp - Type of message we wish to read. may be one of:<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       1. 0 - The first message on the queue will be returned.<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       2. a positive integer - the first message on the queue whose type (mtype) equals this integer (unless a certain flag is set in msgflg, see below).<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       3. a negative integer - the first message on the queue whose type is less then or equal to the absolute value of this integer.<br>&nbsp;&nbsp;&nbsp;       </em>/<br>&nbsp;&nbsp;&nbsp;       /<em><br>&nbsp;&nbsp;&nbsp;       int msgflg - a logical ‘or’ combination of any of the following flags:<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       IPC_NOWAIT - if there is no message on the queue matching what we want to read, return ‘-1’, and set errno to ENOMSG.<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       MSG_EXCEPT - if the message type parameter is a positive integer, then return the first message whose type is NOT equal to the given integer.<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       MSG_NOERROR - If a message with a text part larger then ‘msgsz’ matches what we want to read, then truncate the text when copying the message to our msgbuf structure. If this flag is not set and the message text is too large, the system call returns ‘-1’, and errno is set to E2BIG.<br>&nbsp;&nbsp;&nbsp;       </em>/<br>&nbsp;&nbsp;&nbsp;       /<em> use ‘0’ in the message type parameter, and use no flags (0). </em>/<br>&nbsp;&nbsp;&nbsp;       rc = msgrcv(queue_id, recv_msg, strlen(&quot;hello world&quot;)+1, 0, 0);<br>&nbsp;&nbsp;        if (rc == -1) {<br>&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;        perror(&quot;main: msgrcv&quot;);<br>&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;        exit(1);<br>&nbsp;&nbsp;        }<br>&nbsp;&nbsp;        printf(&quot;msgrcv: received message: mtype ‘%d’; mtext ‘%s’n&quot;,<br>&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;        recv_msg-&gt;mtype, recv_msg-&gt;mtext);<br>&nbsp;&nbsp;        return 0;<br>}<br><br><br> <hr><br><br>/<em><br></em> queue_sender.c - a program that reads messages with one of 3 identifiers<br><em> to a message queue.<br></em>/<br>#include &lt;stdio.h&gt; /<em> standard I/O functions. </em>/<br>#include &lt;stdlib.h&gt; /<em> malloc(), free() etc. </em>/<br>#include &lt;sys/types.h&gt; /<em> various type definitions. </em>/<br>#include &lt;sys/ipc.h&gt; /<em> general SysV IPC structures </em>/<br>#include &lt;sys/msg.h&gt; /<em> message queue functions and structs. </em>/<br>#include &quot;queue_defs.h&quot; /<em> definitions shared by both programs </em>/<br>int main(int argc, char<em> argv[])<br>{<br>&nbsp;&nbsp;&nbsp;       int queue_id; /</em> ID of the created queue. <em>/<br>&nbsp;&nbsp;&nbsp;       struct msgbuf</em> msg; /<em> structure used for sent messages. </em>/<br>&nbsp;&nbsp;&nbsp;       /<em>struct msgbuf</em> recv_msg;<em>/<br>&nbsp;&nbsp;&nbsp;       int i; /</em> loop counter <em>/<br>&nbsp;&nbsp;&nbsp;       int rc; /</em> error code retuend by system calls. <em>/<br>&nbsp;&nbsp;&nbsp;       /</em> create a public message queue, with access only to the owning user. <em>/<br>&nbsp;&nbsp;&nbsp;       queue_id = msgget(QUEUE_ID, IPC_CREAT | IPC_EXCL | 0600);<br>&nbsp;&nbsp;&nbsp;       if (queue_id == -1) {<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       perror(&quot;main: msgget&quot;);<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       exit(1);<br>&nbsp;&nbsp;&nbsp;       }<br>&nbsp;&nbsp;&nbsp;       printf(&quot;message queue created, queue id ‘%d’.n&quot;, queue_id);<br>&nbsp;&nbsp;&nbsp;       msg = (struct msgbuf</em>)malloc(sizeof(struct msgbuf)+MAX_MSG_SIZE);<br>&nbsp;&nbsp;&nbsp;       /<em> form a loop of creating messages and sending them. </em>/<br>&nbsp;&nbsp;&nbsp;       for (i=1; i &lt;= NUM_MESSAGES; i++) {<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       msg-&gt;mtype = (i % 3) + 1; /<em> create message type between ‘1’ and ‘3’ </em>/<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       sprintf(msg-&gt;mtext, &quot;hello world - %d&quot;, i);<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;   rc = msgsnd(queue_id, msg, strlen(msg-&gt;mtext)+1, 0);<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       if (rc == -1) {<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       perror(&quot;main: msgsnd&quot;);<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       exit(1);<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       }<br>&nbsp;&nbsp;&nbsp;       }<br>&nbsp;&nbsp;&nbsp;       /<em> free allocated memory. </em>/<br>&nbsp;&nbsp;&nbsp;       free(msg);<br>&nbsp;&nbsp;&nbsp;       printf(&quot;generated %d messages, exiting.n&quot;, NUM<em>MESSAGES);<br>&nbsp;&nbsp;&nbsp;       return 0;<br>}<br><br><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>__</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></em><br><br>/<em><br></em> queue_reader.c - a program that reads messages with a given identifier<br><em> off of a message queue.<br></em>/<br>#include &lt;stdio.h&gt; /<em> standard I/O functions. </em>/<br>#include &lt;stdlib.h&gt; /<em> malloc(), free() etc. </em>/<br>#include &lt;unistd.h&gt; /<em> sleep(), etc. </em>/<br>#include &lt;sys/types.h&gt; /<em> various type definitions. </em>/<br>#include &lt;sys/ipc.h&gt; /<em> general SysV IPC structures </em>/<br>#include &lt;sys/msg.h&gt; /<em> message queue functions and structs. </em>/<br>#include &quot;queue_defs.h&quot; /<em> definitions shared by both programs </em>/<br>void main(int argc, char<em> argv[])<br>{<br>&nbsp;&nbsp;&nbsp;       int queue_id; /</em> ID of the created queue. <em>/<br>&nbsp;&nbsp;&nbsp;       struct msgbuf</em> msg; /<em> structure used for received messages. </em>/<br>&nbsp;&nbsp;&nbsp;       int rc; /<em> error code returned by system calls. </em>/<br>&nbsp;&nbsp;&nbsp;       int msg_type; /<em> type of messages we want to receive. </em>/<br>&nbsp;&nbsp;&nbsp;       /<em> read message type from command line </em>/<br>&nbsp;&nbsp;&nbsp;       if (argc != 2) {<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       fprintf(stderr, &quot;Usage: %s &lt;message type&gt;n&quot;, argv[0]);<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       fprintf(stderr, &quot; &lt;message type&gt; must be between 1 and 3.n&quot;);<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       exit(1);<br>&nbsp;&nbsp;&nbsp;       }<br>&nbsp;&nbsp;&nbsp;       msg_type = atoi(argv[1]);<br>&nbsp;&nbsp;&nbsp;       if (msg_type &lt; 1 || msg_type &gt; 3) {<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       fprintf(stderr, &quot;Usage: %s &lt;message type&gt;n&quot;, argv[0]);<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       fprintf(stderr, &quot; &lt;message type&gt; must be between 1 and 3.n&quot;);<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       exit(1);<br>&nbsp;&nbsp;&nbsp;       }<br>&nbsp;&nbsp;&nbsp;       /<em> access the public message queue that the sender program created. </em>/<br>&nbsp;&nbsp;&nbsp;       queue_id = msgget(QUEUE_ID, 0);<br>&nbsp;&nbsp;&nbsp;       if (queue_id == -1) {<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       perror(&quot;main: msgget&quot;);<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       exit(1);<br>&nbsp;&nbsp;&nbsp;       }<br>&nbsp;&nbsp;&nbsp;       printf(&quot;message queue opened, queue id ‘%d’.n&quot;, queue_id);<br>&nbsp;&nbsp;&nbsp;       msg = (struct msgbuf<em>)malloc(sizeof(struct msgbuf)+MAX_MSG_SIZE);<br>&nbsp;&nbsp;&nbsp;       /</em> form a loop of receiving messages and printing them out. <em>/<br>&nbsp;&nbsp;&nbsp;       while (1) {<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       rc = msgrcv(queue_id, msg, MAX_MSG_SIZE+1, msg_type, 0);<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       if (rc == -1) {<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       perror(&quot;main: msgrcv&quot;);<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       exit(1);<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       }<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       printf(&quot;Reader ‘%d’ read message: ‘%s’n&quot;, msg_type, msg-&gt;mtext);<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       /</em> slow down a little… <em>/<br>&nbsp;&nbsp;&nbsp;       &nbsp;&nbsp;&nbsp;       sleep(1);<br>&nbsp;&nbsp;&nbsp;       }<br>&nbsp;&nbsp;&nbsp;       /</em> NOT REACHED */<br>}<br> </p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2008/03/04/GDB调试/" rel="next" title="GDB调试">
                <i class="fa fa-chevron-left"></i> GDB调试
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2008/03/08/笔记片段——段治文课/" rel="prev" title="笔记片段——段治文课">
                笔记片段——段治文课 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/wp-content/uploads/penguin.gif"
               alt="jfo" />
          <p class="site-author-name" itemprop="name">jfo</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">595</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">36</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/jfojfo" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/jfojfo" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.pickbox.me" title="收藏夹" target="_blank">收藏夹</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://note.pickbox.me" title="网络剪贴板" target="_blank">网络剪贴板</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://iguangba.pickbox.me" title="爱逛吧" target="_blank">爱逛吧</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <p class="post-toc-empty">此文章未包含目录</p>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2007 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jfo</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = false;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = decodeURIComponent(data.url);
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title >= 0 || index_content >= 0 ){
                                isMatch = true;
								if (i == 0) {
                                    first_occur = index_content;
                                }
                            } 
							
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

  

  
<script type="text/javascript">
function attach () {
    $('body').append('<img src="http://p.pickbox.me/pv">');
    $(document).unbind('scroll', attach);
}
$(document).bind('scroll', attach);
</script>



</body>
</html>
