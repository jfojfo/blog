<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="jfo, blog" />





  <link rel="alternate" href="/atom.xml" title="jfo planet" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="http://blog.chinaunix.net/u/30686/showart.php Adding New SIMD Instructions to the GCC Back-end">
<meta property="og:type" content="article">
<meta property="og:title" content="【zz】Adding New SIMD Instructions to the GCC Back-end">
<meta property="og:url" content="http://blog.pickbox.cc/2008/03/12/【zz】Adding-New-SIMD-Instructions-to-the-GCC-Back-end/index.html">
<meta property="og:site_name" content="jfo planet">
<meta property="og:description" content="http://blog.chinaunix.net/u/30686/showart.php Adding New SIMD Instructions to the GCC Back-end">
<meta property="og:updated_time" content="2017-06-07T05:03:26.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="【zz】Adding New SIMD Instructions to the GCC Back-end">
<meta name="twitter:description" content="http://blog.chinaunix.net/u/30686/showart.php Adding New SIMD Instructions to the GCC Back-end">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://blog.pickbox.cc/2008/03/12/【zz】Adding-New-SIMD-Instructions-to-the-GCC-Back-end/"/>


  <title> 【zz】Adding New SIMD Instructions to the GCC Back-end | jfo planet </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">jfo planet</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Hope is the best gift that tomorrow gives.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                【zz】Adding New SIMD Instructions to the GCC Back-end
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2008-03-12T21:52:00+08:00" content="2008-03-12">
              2008-03-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/gcc-binutils-make-共享库/" itemprop="url" rel="index">
                    <span itemprop="name">gcc/binutils/make/共享库</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p> <a target="_blank" href="http://blog.chinaunix.net/u/30686/showart.php?id=489526">http://blog.chinaunix.net/u/30686/showart.php</a><br><br> <strong>Adding New SIMD Instructions to the GCC Back-end</strong>                                                                                                                                                                                                              Mauricio Alvarez: alvarez (at) ac (dot) upc (dot) edu<br>                        Created: 16/09/2005.<br>                        Modified: 13.03.2006.                        <strong>1. <a name="Introduction"></a>Introduction</strong>                        This guide shows how to include support in the gcc compiler for new instructions that are added to an existing ISA. The idea is to extend an ISA with custom instructions for domain-specific processor acceleration and to  support these instructions into the compiler using intrinsics.<br> <br>                        This work is based on the PowerPC ISA with the Altivec multimedia extension and the new instructions that are going to be added are related to the video coding/decoding domain.  GCC version 4.0 is used.<br> <br>                        In a first stage of this work new instructions are going to be supported by means of intrinsics that allow the programmer to use them directly in C or C++ programs.<br> <br> <br> <strong>2. <a name="GCC_structure_and_passes"></a>GCC structure and passes</strong>                        In order to provide support for new instructions in gcc it is necessary to support them in some of  the stages of the compiler:<br> <br> <strong>front-end: parse tree ——–&gt; middle-end: generic tree ———&gt; back-end: RTL<br> </strong> <strong><br>                        GCC passes [1]</strong><br> <ul> <li>Parsing pass: language front-end</li> <li>Gimplification pass: convert intermediate representation of a function into the GIMPLE language</li> <li>Tree SSA passes: tree optimization passes (for example autovectorization)</li> <li>RTL passes: rtl generation and optimization passes</li> </ul> <strong>Modifications in each stacge of GCC</strong><br> <strong>2.1 front-end</strong>: specification of new intrinsics added to the Altivec existing intrinsics.<br> <strong>2.2 middle-end</strong>: because the instructions are not going to be generated automatically, there is no need to modify this stage<br>                        2.3 <strong>back-end</strong>: creation of the machine description of the new instructions.<br> <strong>3. Front-end support for intrinsics in GCC</strong> <strong>3.1 <a name="What_instrinsics_are"></a>What intrinsics are?</strong><br>                        A <em>intrinsic</em> is a function known by the compiler that directly maps to a sequence of one or more assembly language instructions.<br> <br>                        Intrinsics make the use of processor specific enhancements easier because they provide a language interface (C,C++) to assembly instructions. In doing so, the compiler manages things that the user would normally have to be concerned with, such register names, register allocations and memory locations of data.<br> <br>                        GCC has intrinsics for the SIMD extensions (SSE, Altivec) that are available in most modern processors.<br> <br> <strong>3.2 <a name="Altivec_Intrinsics_in_GCC"></a>Altivec Intrinsics in GCC<br> </strong>Altivec intrinsics are an interface to the PowerPC processors to access Altivec instructions. Intrinsics specification also adds new types to the C,C++ languages for declaring packed variables as described in the Altivec Programming Interface Manual [2].<br> <br>                        The intrinsics interface is made available by adding <em>#include &lt;altivec.h&gt; </em>in the source program and by adding  the <em>-maltivec and -mabi=altivec</em> compiler flags to the compilation command. This is only applicable for the <em>fsf  official GCC. </em>Mac computers (with powerpc processors) use a special version of gcc that does not need to inlude the header <em>altivec.h </em>and requires the compiler flag <em>-faltivec</em><br> <br>                        Altivec intrinsics are declared in <em>altivec.h </em>that is available in the gcc source code in: <em>gcc/config/rs6000/altivec.h<br> </em><br>                        An example of the Altivec intrinsics is the vector average, which calculates the rounded average of two vectors.<br> <br>                        - compiler intrinsic: <em>d = vec_avg(a,b)<br>                        - </em>Assembly instructions: see next table<br> <br> <strong>d = vec_avg(a,b)</strong> <strong>d</strong> <strong>a</strong> <strong>b</strong> <strong>maps to</strong>                                                                                                    vector unsigned char                                    vector unsigned char                                    vector unsigned char                                    vavgub d,a,b                                                                                                    vector signed char                                    vector signed char                                    vector signed char                                    vavgsb d,a,b                                                                                                    vector unsigned short                                    vector unsigned short                                    vector unsigned short                                    vavguh d,a,b                                                                                                    vector signed short                                    vector signed short                                    vector signed short                                    vavgsh d,a,b                                                                                                    vector unsigned int                                    vector unsigned int                                    vector unsigned int                                    vavguw d,a,b                                                                                                    vector signed int                                    vector signed int                                    vector signed int                                    vavgsw d,a,b                                                                                                            <br> <br> <strong>3.3 <a name="Implementation_of_Altivec_intrinsics"></a>Implementation of Altivec intrinsics<br> </strong>Intrinsics are implemented as functions but the code is placed inline and they do not generate a function call. As can be seen in the example above each intrinsic can map to several assembly instructions depending on the data type of the operands. In GCC this is implemented by means of overloaded functions. In C++ they are supported directly by the language. In C they are implemented with macros.<br> <br>                        Here there is the C++ declaration of the <em>vec_avg</em> intrinsic for vector signed/unsigned char:<br> <em><br>                        inline   <strong>vector unsigned char<br>                        vec_avg (</strong>vector unsigned char a1, <strong>vector unsigned char a2)<br>                        {<br>                        return (</strong>vector unsigned char) <strong>builtin_altivec_vavgub ((</strong>vector signed char) a1, (<strong>vector signed char) a2);<br>                        }<br> <br>                        inline   </strong>vector signed char<br>                        vec_avg (<strong>vector signed char a1, </strong>vector signed char a2)<br>                        {<br>                        return (<strong>vector signed char) </strong>builtin_altivec_vavgsb ((<strong>vector signed char) a1, (</strong>vector signed char) a2);<br>                        }<br> <br> </em>In C, the same declaration is done with macros:<br> <em>#define vec_avg(a1, a2) <br>                        <strong>ch (</strong>bin_args_eq (<strong>vector unsigned char, (a1), </strong>vector unsigned char, (a2)), <br>                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   ((<strong>vector unsigned char) </strong>builtin_altivec_vavgub ((<strong>vector signed char) (a1), (</strong>vector signed char) (a2))), <br>                        <strong>ch (</strong>bin_args_eq (<strong>vector signed char, (a1), </strong>vector signed char, (a2)), <br>                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   ((<strong>vector signed char) </strong>builtin_altivec_vavgsb ((<strong>vector signed char) (a1), (</strong>vector signed char) (a2))), <br>                        <strong>ch (</strong>bin_args_eq (<strong>vector unsigned short, (a1), </strong>vector unsigned short, (a2)), <br>                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   ((<strong>vector unsigned short) </strong>builtin_altivec_vavguh ((<strong>vector signed short) (a1), (</strong>vector signed short) (a2))), <br>                        <strong>ch (</strong>bin_args_eq (<strong>vector signed short, (a1), </strong>vector signed short, (a2)), <br>                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   ((<strong>vector signed short) </strong>builtin_altivec_vavgsh ((<strong>vector signed short) (a1), (</strong>vector signed short) (a2))), <br>                        <strong>ch (</strong>bin_args_eq (<strong>vector unsigned int, (a1), </strong>vector unsigned int, (a2)), <br>                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   ((<strong>vector unsigned int) </strong>builtin_altivec_vavguw ((<strong>vector signed int) (a1), (</strong>vector signed int) (a2))), <br>                        <strong>ch (</strong>bin_args_eq (<strong>vector signed int, (a1), </strong>vector signed int, (a2)), <br>                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   ((<strong>vector signed int) </strong>builtin_altivec_vavgsw ((<strong>vector signed int) (a1), (</strong>vector signed int) (a2))), <br>                        &nbsp;&nbsp;&nbsp;   <strong>builtin_altivec_compiletime_error (&quot;vec_avg&quot;)))))))</strong></em><br> <br> <em>bin_args_eq</em> is a macro that checks the compatibility of the data type of the operands.<br> <em>_ch</em> is a macro that chooses between the builtin assembly expression or a data type error<br> <br> <strong>3.4 An example of a new Altivec intrinsics for pixel interpolation<br> </strong>We are going to include support for a new instruction devoted to the pixel interpolation, a process that is common in the video coding standards like MPEG-4 or H.264.<br> <br>                        The interface to the new instruction is <em>d = vec_inter(a,b)</em> and the assembly mapping is shown in the next table<br> <br> <br> <strong>d = vec_inter(a,b)</strong> <strong>d</strong> <strong>a</strong> <strong>b</strong> <strong>maps to</strong>                                                                                                    vector unsigned char                                    vector unsigned char                                    vector unsigned char                                    vinterub d,a,b                                                                                                    vector signed char                                    vector signed char                                    vector signed char                                    vintersb d,a,b                                                                                                    vector unsigned short                                    vector unsigned short                                    vector unsigned short                                    vinteruh d,a,b                                                                                                    vector signed short                                    vector signed short                                    vector signed short                                    vintersh d,a,b                                                                                                    vector unsigned int                                    vector unsigned int                                    vector unsigned int                                    vinteruw d,a,b                                                                                                    vector signed int                                    vector signed int                                    vector signed int                                    vintersw d,a,b                                                                                                            <br>                        The definition in C++  for the signed/unsigned char version is like that:<br> <br> <em>inline   <strong>vector unsigned char<br>                        vec_inter (</strong>vector unsigned char a1, <strong>vector unsigned char a2)<br>                        {<br>                        return (</strong>vector unsigned char) <strong>builtin_altivec_vinterub ((</strong>vector signed char) a1, (<strong>vector signed char) a2);<br>                        }<br> <br>                        inline   </strong>vector signed char<br>                        vec_inter (<strong>vector signed char a1, </strong>vector signed char a2)<br>                        {<br>                        return (<strong>vector signed char) </strong>builtin_altivec_vintersb ((<strong>vector signed char) a1, (</strong>vector signed char) a2);<br>                        }<br> </em><br> <strong>4. Back-end support for intrinsics in GCC</strong>                        Intrinsics are implemented in the machine description of the back-end of the compiler.  The back-end is implemented in several files:<br> <ul> <li>rs6000.h: C macros for machine fundamentals, compiler environment, machine description support and ABI</li> <li>rs6000.c: C functions for macro expansion and machine description support</li> <li>rs6000.md: Machine description for RS6000 (Power) instructions</li> <li>altivec.h: declaration of intrinsics functions</li> <li>altivec.md: machine description for altivec instructions</li> </ul>                        The machine descriptions are used in the matching process to transform RTL expressions into assembler instructions. An instruction description in the machine description consists of instruction template patterns for both instruction generation and instruction matching.<br> <br> <strong>4.1 Instruction patterns for altivec instructions</strong><br>                        Here is an example of an instruction pattern for the vec_avg intrinsic using unsigned char operands:<br> <br> <em>(define_insn &quot;altivec_vavgub&quot;<br>                        [(&nbsp;&nbsp;&nbsp;   set (match_operand: V16QI 0 &quot;register_operand&quot; &quot;=v&quot;)<br>                        &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   (unspec:</em><em>V16QI </em><em>[ (match_operand: </em><em>V16QI </em><em>1 &quot;register_operand&quot; &quot;v&quot;)<br>                        &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   (match_operand:</em><em>V16QI </em><em>2 &quot;register_operand&quot; &quot;v&quot;)] 44))]<br>                        &quot;TARGET_ALTIVEC&quot;<br>                        &quot;vavgub %0,%1,%2&quot;<br>                        [(set_attr &quot;type&quot; &quot;vecsimple&quot;)])<br> </em><br> <ul> <li><em>define_insn</em>: is the pattern type for both instruction generation and matching.</li> <li><em>altivec_vavgub</em>: is the pattern name.</li> <li><em>set (the operand)</em>: a composition of operations: At the leaves of the resulting operation tree, there is usually some kind of operand-matching expression. The generic form is <em>(match_operand: Mode operand-number &quot;predicate&quot; &quot;constraints&quot;)</em> <ul> <li>In<em> set (match_operand: V16QI 0 &quot;register_operand&quot; &quot;=v&quot;) </em>there is a matching for an operand of type V16QI (vector of 16 QI, QI means a byte), which is the first operand &quot;0&quot;. &quot;=v&quot; means this is the destination operand.  There is a predicate &quot;register operand&quot; than means the operand is a register and there is a constraint &quot;v&quot; that means that the register operand needs to be a vector register.</li> <li><code>(unspec [<var>operands</var> <small>…</small>] <var>index</var>)</code> Represents a machine-specific operation on <var>operands</var>. <var>index</var> selects between multiple machine-specific operations.  For standard operations the name of the operation goes instead of unspec (for example: xor: QI), but altivec instructions are not standard instructions for the compiler, so they need to be declared machine-specific instructions.</li> </ul> </li> </ul> <ul> <li><em>&quot;TARGET_ALTIVEC&quot; </em>is a pattern condition for when the pattern applies.</li> <li><em> &quot;vavgub %0,%1,%2&quot; </em>is the specification of output template for the <em>define_insn. </em>The output template for the altivec instructions is just the assembler instruction as a string.</li> <li><em> [(set_attr &quot;type&quot; &quot;vecsimple&quot;)]): </em>is the specification of an attribute for the instruction. In this case the instruction is of the type: vector simple.</li> </ul> <br> <strong>4.2 Instruction patterns for new instructions<br> </strong>Similar to the example presented above, we have defined a pattern for the vector interpolation instruction: <em>vec_avg</em><br> <br>                        -<em> veg_avg</em> for the unsigned data types:<br> <br> <em>(define_insn &quot;altivec_vinteru&lt;VI_char&gt;&quot;<br>                        [(set (match_operand:VI 0 &quot;register_operand&quot; &quot;=v&quot;)<br>                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   (unspec:VI [(match_operand:VI 1 &quot;register_operand&quot; &quot;v&quot;)<br>                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   (match_operand:VI 2 &quot;register_operand&quot; &quot;v&quot;)] 244))]<br>                        &quot;TARGET_ALTIVEC&quot;<br>                        &quot;vinteru&lt;VI_char&gt; %0,%1,%2&quot;<br>                        [(set_attr &quot;type&quot; &quot;vecsimple&quot;)])<br> <br> </em>-<em> veg_avg</em> for the signed data types:<br> <em><br>                        (define_insn &quot;altivec_vinters&lt;VI_char&gt;&quot;<br>                        [(set (match_operand:VI 0 &quot;register_operand&quot; &quot;=v&quot;)<br>                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   (unspec:VI [(match_operand:VI 1 &quot;register_operand&quot; &quot;v&quot;)<br>                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   (match_operand:VI 2 &quot;register_operand&quot; &quot;v&quot;)] 245))]<br>                        &quot;TARGET_ALTIVEC&quot;<br>                        &quot;vinters&lt;VI_char&gt; %0,%1,%2&quot;<br>                        [(set_attr &quot;type&quot; &quot;vecsimple&quot;)])<br> <br> </em><strong>4.3 Builtin description of the intrinsics<br> </strong>It is necessary to add the intrinsics in the back-end of the compiler. In our case, the intrinsics are added to the RS600 back-end which includes all the Power and PowerPC processors. The subroutines for code generation are defined in <em>gcc/gcc-4.0.0/gcc/config/rs6000/rs6000.c  </em>In this file there is a special section for the definition of builtins.<br> <br>                        For two operands instructions there is a structure like this:<br> <em><br>                        static struct builtin_description bdesc_2arg[] =<br>                        {<br>                        …<br>                        { MASK_ALTIVEC, CODE_FOR_altivec_vinterub, &quot;<strong>builtin_altivec_vinterub&quot;, ALTIVEC_BUILTIN_VINTERUB },<br>                        { MASK_ALTIVEC, CODE_FOR_altivec_vintersb, &quot;</strong>builtin_altivec_vintersb&quot;, ALTIVEC_BUILTIN_VINTERSB },<br>                        { MASK_ALTIVEC, CODE_FOR_altivec_vinteruh, &quot;<strong>builtin_altivec_vinteruh&quot;, ALTIVEC_BUILTIN_VINTERUH },<br>                        { MASK_ALTIVEC, CODE_FOR_altivec_vintersh, &quot;</strong>builtin_altivec_vintersh&quot;, ALTIVEC_BUILTIN_VINTERSH },<br>                        { MASK_ALTIVEC, CODE_FOR_altivec_vinteruw, &quot;<strong>builtin_altivec_vinteruw&quot;, ALTIVEC_BUILTIN_VINTERUW },<br>                        { MASK_ALTIVEC, CODE_FOR_altivec_vintersw, &quot;</strong>builtin_altivec_vintersw&quot;, ALTIVEC_BUILTIN_VINTERSW },<br>                        …<br>                        }<br> <br> </em>And the definition of  ALTIVEC_BUILTINs are placed in: <em>gcc/gcc-4.0.0/gcc/config/rs6000/rs6000.h<br> <br>                        enum rs6000_builtins<br>                        {<br>                        /<em> Altivec builtins.  </em>/<br>                        …<br>                        ALTIVEC_BUILTIN_VINTERUB,<br>                        ALTIVEC_BUILTIN_VINTERSB,<br>                        ALTIVEC_BUILTIN_VINTERUH,<br>                        ALTIVEC_BUILTIN_VINTERSH,<br>                        ALTIVEC_BUILTIN_VINTERUW,<br>                        ALTIVEC_BUILTIN_VINTERSW,  <br>                        …<br>                        }<br> </em><br> <strong>5.  Extending GNU Assembler<br> </strong>In order to support new instructions for a given ISA it is necessary to modify the assembler for producing the object code.  The natural election of an assembler to use in conjunction with the gcc compiler is gas, the gnu assembler which is part of the binutils collection of tools.<br> <br>                        Gas is implemented in two sections, a front-end and a back-end<br> <ul> <li><em>Gas Front-end</em>: handles the parsing of input</li> <li><em>Gas back-end:</em> does the whole machine dependant part</li> </ul> <br> <strong>5.1 Opcode List</strong><br>                        The opcode list for PowerPC instructions is defined in the PowerPC back-end: <br> <em>/binutils-2.16.1/opcodes/</em>ppc-opc.c<br> <br> <em>const struct powerpc_opcode powerpc_opcodes[] = {<br>                        …<br>                        { &quot;vinterub&quot;,VX(4, 1900), VX_MASK,&nbsp;&nbsp;&nbsp;   PPCVEC,&nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   { VD, VA, VB } },<br>                        { &quot;vinteruh&quot;,VX(4, 1901), VX_MASK,&nbsp;&nbsp;&nbsp;   PPCVEC,&nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   { VD, VA, VB } },<br>                        { &quot;vinteruw&quot;,VX(4, 1902), VX_MASK,&nbsp;&nbsp;&nbsp;   PPCVEC,&nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   { VD, VA, VB } },<br>                        { &quot;vintersb&quot;,VX(4, 1903), VX_MASK,&nbsp;&nbsp;&nbsp;   PPCVEC,&nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   { VD, VA, VB } },<br>                        { &quot;vintersh&quot;,VX(4, 1904), VX_MASK,&nbsp;&nbsp;&nbsp;   PPCVEC,&nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   { VD, VA, VB } },<br>                        { &quot;vintersw&quot;,VX(4, 1905), VX_MASK,&nbsp;&nbsp;&nbsp;   PPCVEC,&nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   { VD, VA, VB } },<br>                        …<br>                        }<br> <br> </em> <ul> <li><em>vinterXX: is the instruction name.</em></li> <li>VX(4,YY): 4 is the main opcode and YY is the secondary opcode.</li> <li>VX is a macro that creates the altivec instructions:<em> VX(op, xop) (OP (op) | (((unsigned long)(xop)) &amp; 0x7ff))</em></li> <li>VX_MASK: used by the disassembler.</li> <li>PPCVEC: used to indicate which specific processors support the instructions.</li> <li>{ VD, VA, VB }: Operands: an array of operand codes. Each code is an index into the operation table.</li> </ul> <em><br> </em><strong>5.2 Adding new opcodes to the Altivec extension<br> <br>                        PowerPC opcode format:<br> </strong> <strong>———————————————————————————-</strong><br> <strong>| Main Opcode  |&nbsp;&nbsp;   VD&nbsp;&nbsp;   |&nbsp;&nbsp;   VA&nbsp;&nbsp;   |&nbsp;&nbsp;   VB&nbsp;&nbsp;   |&nbsp;&nbsp;   &nbsp;&nbsp;   Extended opcode&nbsp;&nbsp;   |</strong><br> <strong>———————————————————————————-</strong> <br> <ul> <li>Main opcode: for altivec instructions is =0x04.</li> <li>VD, VA, VB, are the identifiers of registers: 5 bits each.</li> <li>Extended opcode: the opcode of the instruction itself.</li> </ul> <br> <strong>Free opcodes<br> </strong>Beyond the extended opcode of 1900 there are free slots for new instructions. For the interpolation instructions these are the selected opcodes:<strong><br> </strong><em>- vinterub: 1900<br>                        - vinteruh: 1901<br>                        - vinteruw: 1902<br>                        - vintersb: 1903<br>                        - vintersh: 1904<br>                        - vintersw: 1905<br> </em><br>                        Appendix 1. Notes on compilation of gcc                        Adding new instructions do not change at all the compilation process of gcc. But for our experiments we are using a Power4 machine with AIX operating system and a PowerPC+Altivec emulator and simulator. Neither the processors or the OS has support for Altivec instructions. So it is necessary to tell gcc that include the support for altivec.<br> <br> <ul> <li><strong>in <em>gcc/config/rs6000/</em></strong><strong>aix.h:</strong> it is necessary to define that the system supports ALTIVEC instructions.</li> </ul> <blockquote> <blockquote>#define TARGET_ALTIVEC 1<br>                        #define TARGET_ALTIVEC_ABI 1<br>                        #define TARGET_ALTIVEC_VRSAVE 1<br> </blockquote></blockquote> <ul> <li><strong>in gcc/config/rs6000/xcoff.h</strong> Additionally it is necessary to guarantee that the global variables are aligned to 128-bit. Thus is done by changing the emission of the assembler directive <em>csect </em>who is responsible for the aligment of sections in the generated code.</li> </ul> <br> <em>#define READ_ONLY_DATA_SECTION_FUNCTION&nbsp;&nbsp;&nbsp;   <br>                        void&nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   <br>                        read_only_data_section (void)&nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;&nbsp;   <br>                        {&nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;&nbsp;   <br>                        if (in_section != read_only_data)&nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;   <br>                        &nbsp;&nbsp;&nbsp;   {&nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;&nbsp;   <br>                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   fprintf (asm_out_file, &quot;t.csect %s[RO],4n&quot;,&nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;     &nbsp;&nbsp;   &lt;——– Alignment to 128<br>                        &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   xcoff_read_only_section_name);&nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   <br>                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   in_section = read_only_data;&nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;     <br>                        &nbsp;&nbsp;&nbsp;   }&nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;   &nbsp;&nbsp;&nbsp;     <br>                        }<br> </em><br>                        the same need to be applied for<br> <em>#define READ_ONLY_PRIVATE_DATA_SECTION_FUNCTION </em><br> <br> <ul> <li>it is better to use the bash shell in order to speed-up the compilation process UNDER AIX:</li> </ul> <blockquote><em>CONFIG_SHELL={bin_dir}/bash<br>                        export CONFIG_SHELL<br> </em></blockquote> <ul> <li><strong>Building GCC: </strong>for the configuration it is necessary to enable altivec and the desired languages for the front-end.<strong><br> </strong></li> </ul> <blockquote>$ ./configure –prefix=$BIN_DIR –enable-languages=c,c++ –enable-altivec –disable-nls –disable-multilib.  <br>                        $ gmake<br>                        $ gmake install<br> </blockquote>                        References                        [1] <a href="http://gcc.gnu.org/onlinedocs/gccint/" target="_blank" rel="external">GCC Internals</a>. GNU Compiler Collection Internals<br>                        [2] <a href="http://www.freescale.com/files/32bit/doc/ref_manual/ALTIVECPIM.pdf" target="_blank" rel="external">ALTIVECPIM</a>. AltiVec Technology Programming Interface Manual. Motorola/Freescale.<br>                        [3] <a href="http://www.gnu.org/software/binutils/" target="_blank" rel="external">BINUTILS</a>. GNU binary utils: assembler, linker, loader and other utilities for dealing with binary files generated by gcc compilers.                        <ul> <li>Motorola/Freescale. <em>Programming Environments Manual for 32-bit Implementations of the PowerPC Architecture</em>. P/N MPCFPE32B/AD .</li> <li>IBM (2000). <em>Book E: Enhanced PowerPC&#8482; Architecture</em> (3rd ed.)</li> <li>Motorola/Freescale. ALTIVECPEM. AltiVec Technology Programming Environments Manual.</li> <li>Intrinsics wikipedia. <a href="http://en.wikipedia.org/wiki/Intrinsic_function" target="_blank" rel="external">http://en.wikipedia.org/wiki/Intrinsic_function</a></li> <li>Hans-Peter Nilsson. Porting gcc for dunces. ftp://ftp.axis.se/pub/users/hp/pgccfd/</li> </ul> </p><p> </p> <strong>原文地址</strong> <a href="http://personals.ac.upc.edu/alvarez/media/gcc-isa-extensions.html" target="_blank">http://personals.ac.upc.edu/alvarez/media/gcc-isa-extensions.html</a> <p></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2008/03/11/Linux终端彩色输出/" rel="next" title="Linux终端彩色输出">
                <i class="fa fa-chevron-left"></i> Linux终端彩色输出
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2008/03/14/read-rtx-from-md-file-gencodes/" rel="prev" title="read rtx from .md file & gencodes">
                read rtx from .md file & gencodes <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/wp-content/uploads/penguin.gif"
               alt="jfo" />
          <p class="site-author-name" itemprop="name">jfo</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">604</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">38</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/jfojfo" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/jfojfo" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.pickbox.me" title="收藏夹" target="_blank">收藏夹</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://note.pickbox.me" title="网络剪贴板" target="_blank">网络剪贴板</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://iguangba.pickbox.me" title="爱逛吧" target="_blank">爱逛吧</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <p class="post-toc-empty">此文章未包含目录</p>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2007 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jfo</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = false;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = decodeURIComponent(data.url);
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title >= 0 || index_content >= 0 ){
                                isMatch = true;
								if (i == 0) {
                                    first_occur = index_content;
                                }
                            } 
							
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

  

  
<script type="text/javascript" src="http://p.pickbox.me/js/pv.js"></script>



</body>
</html>
