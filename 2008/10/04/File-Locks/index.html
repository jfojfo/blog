<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="jfo, blog" />





  <link rel="alternate" href="/atom.xml" title="jfo planet" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="http://www.gnu.org/software/libtool/manual/libc/File-Locks.htmlFile LocksThe remaining fcntl commands are used to support record locking, which permits multiple cooperating programs to prevent each o">
<meta property="og:type" content="article">
<meta property="og:title" content="File Locks">
<meta property="og:url" content="http://blog.pickbox.me/2008/10/04/File-Locks/index.html">
<meta property="og:site_name" content="jfo planet">
<meta property="og:description" content="http://www.gnu.org/software/libtool/manual/libc/File-Locks.htmlFile LocksThe remaining fcntl commands are used to support record locking, which permits multiple cooperating programs to prevent each o">
<meta property="og:updated_time" content="2016-10-15T05:24:27.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="File Locks">
<meta name="twitter:description" content="http://www.gnu.org/software/libtool/manual/libc/File-Locks.htmlFile LocksThe remaining fcntl commands are used to support record locking, which permits multiple cooperating programs to prevent each o">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://blog.pickbox.me/2008/10/04/File-Locks/"/>


  <title> File Locks | jfo planet </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">jfo planet</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Hope is the best gift that tomorrow gives.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                File Locks
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2008-10-04T01:16:00+08:00" content="2008-10-04">
              2008-10-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p> <br><a target="_blank" href="http://www.gnu.org/software/libtool/manual/libc/File-Locks.html">http://www.gnu.org/software/libtool/manual/libc/File-Locks.html</a><br>File Locks</p><p><a name="index-file-locks-1363"></a><a name="index-record-locking-1364"></a>The remaining <code>fcntl</code> commands are used to support <dfn>record locking</dfn>, which permits multiple cooperating programs to prevent each other from simultaneously accessing parts of a file in error-prone ways.</p><p><a name="index-exclusive-lock-1365"></a><a name="index-write-lock-1366"></a>An <dfn>exclusive</dfn> or <dfn>write</dfn> lock gives a process exclusive access for writing to the specified part of the file.  While a write lock is in place, no other process can lock that part of the file.</p><p><a name="index-shared-lock-1367"></a><a name="index-read-lock-1368"></a>A <dfn>shared</dfn> or <dfn>read</dfn> lock prohibits any other process from requesting a write lock on the specified part of the file.  However, other processes can request read locks.</p><p>The <code>read</code> and <code>write</code> functions do not actually check to see whether there are any locks in place.  If you want to implement a locking protocol for a file shared by multiple processes, your application must do explicit <code>fcntl</code> calls to request and clear locks at the appropriate points. (the <em>struct file</em> does not contain the <em>struct flock</em>)</p><p>Locks are associated with processes.  A process can only have one kind of lock set for each byte of a given file.  When any file descriptor for that file is closed by the process, all of the locks that process holds on that file are released, even if the locks were made using other descriptors that remain open.  Likewise, locks are released when a process exits, and are not inherited by child processes created using <code>fork</code> (see <a href="http://www.gnu.org/software/libtool/manual/libc/Creating-a-Process.html#Creating-a-Process" target="_blank" rel="external">Creating a Process</a>).</p><p> </p>（只要有一个fd close掉了，尽管还有其他引用同一个file struct的fd处于open，所有的锁全部释放！！！）<br><br>F_SETLK、F_SETLKW(wait if cannot accquired)<br>F_GETLK：<br>On input to this call, lock describes a lock we would like to place&#160; on&#160; the<br>file.&#160;&#160; If the lock could be placed, fcntl() does not actually place it, but<br>returns F_UNLCK in the l_type field of lock and leaves the other&#160; fields&#160; of<br>the&#160; structure&#160; unchanged.&#160;&#160; If one or more incompatible locks would prevent<br>this lock being placed, then fcntl() returns&#160; details&#160; about&#160; one&#160; of&#160; these<br>locks&#160; in&#160; the&#160; l_type, l_whence, l_start, and l_len fields of lock and sets<br>l_pid to be the PID of the process holding that lock.<br><br>F_UNLCK(unlock)<br><br><br>As well as being removed by an explicit F_UNLCK,&#160; record&#160; locks&#160; are&#160; automatically<br>released&#160; when the process terminates or if it closes <strong><u><em>any</em></u> </strong>file descriptor referring<br>to a file on which locks are held.&#160; This is bad: it means that a process&#160; can&#160; lose<br>the&#160; locks&#160; on&#160; a file like /etc/passwd or /etc/mtab when for some reason a library<br>function decides to open, read and close it.<br><br>Record locks are not inherited by a child created via fork(2),&#160; but&#160; are&#160; preserved<br>across an execve(2).<br><br>Because of the buffering performed by the stdio(3) library, the use of record lock‐<br>ing with routines in that package should&#160; be&#160; avoided;&#160; use&#160; read(2)&#160; and&#160; write(2)<br>instead.<br><br><br><br><p>As an example of a situation where file locking is useful, consider a program that can be run simultaneously by several different users, that logs status information to a common file.  One example of such a program might be a game that uses a file to keep track of high scores.  Another example might be a program that records usage or accounting information for billing purposes.</p><p>Having multiple copies of the program simultaneously writing to the file could cause the contents of the file to become mixed up.  But you can prevent this kind of problem by setting a write lock on the file before actually writing to the file.</p><p>If the program also needs to read the file and wants to make sure that the contents of the file are in a consistent state, then it can also use a read lock.  While the read lock is set, no other process can lock that part of the file for writing.  </p><p>Remember that file locks are only a <em>voluntary</em> protocol for controlling access to a file.  There is still potential for access to the file by programs that don’t use the lock protocol. (ie, you can still read/write anything you like from/to this file using an editor like vim, it’s up to you to control access using the flock protocol !!!)</p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><br><br>example code<br><br>// flock.c<br>// gcc -o flock flock.c<br><br>#include &lt;sys/types.h&gt;<br>#include &lt;sys/stat.h&gt;<br>#include &lt;fcntl.h&gt;<br>#include &lt;unistd.h&gt;<br>#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br><br>int main()<br>{<br>char buf[] = &quot;123456789012345678901234567890&quot;;<br>char buf2[] = &quot;abcdefghijklmnopqrstuvwxyz&quot;;<br>int fd, fd2;<br>struct flock lock;<br><br>lock.l_type = F_WRLCK;<br>lock.l_whence = SEEK_SET;<br>lock.l_start = 2;<br>lock.l_len = 8;<br><br>fd = open(&quot;/tmp/lock&quot;, O_CREAT|O_TRUNC|O_RDWR, S_IRUSR|S_IWUSR);<br>if(fd == -1)<br>&#160;&#160;&#160;  fprintf(stderr, &quot;fail to open filen&quot;);<br>if(-1 == fcntl(fd, F_SETLK, &amp;lock))<br>&#160;&#160;&#160;  fprintf(stderr, &quot;fail to fcntl filen&quot;);<br>if(-1 == write(fd, buf, sizeof(buf)-1))<br>&#160;&#160;&#160; fprintf(stderr, &quot;fail to write filen&quot;);<br><br>fd2 = dup(fd);<br> lock.l_type = F_WRLCK;<br>lock.l_whence = SEEK_SET;<br>lock.l_start = 1;<br>lock.l_len = 5;<br>if(-1 == fcntl(fd2, F_SETLK, &amp;lock))     // no error, fcntl success after dup<br>&#160;&#160;&#160;&#160;&#160;&#160;&#160;   fprintf(stderr, &quot;fail to fcntl file dupn&quot;);<br>printf(&quot;Okn&quot;);<br><br>getchar(); // now run <code>flock2&#39;&lt;br /&gt;// 标记(1)&lt;br /&gt; close(fd2); // now all locks are released !!!&amp;#160; 如果这里没有close(fd2)，后面的fcntl依然可以成功，可见file lock是针对进程互斥的&lt;br /&gt;getchar(); // now run</code>flock2’ again<br><br> fd2 = open(&quot;/tmp/lock&quot;, O_RDWR);<br>if(fd2 == -1)<br>&#160;&#160;&#160; fprintf(stderr, &quot;fail to open file 2n&quot;);<br>lock.l_type = F_WRLCK;<br>lock.l_whence = SEEK_SET;<br>lock.l_start = 4;<br>lock.l_len = 8;<br>if(-1 == fcntl(fd2, F_SETLK, &amp;lock))&#160;&#160;&#160;&#160;  // no error!!! fcntl success after open the same file the second time<br>&#160;&#160;&#160;&#160;&#160;&#160;&#160;   fprintf(stderr, &quot;fail to fcntl file 2n&quot;);<br>&#160;&#160;&#160;   if(-1 == write(fd2, buf2, sizeof(buf2)-1))<br>&#160;&#160;&#160; &#160;&#160;&#160; fprintf(stderr, &quot;fail to write file 2n&quot;);<br><br>// &#160;&#160;   sleep(1000);<br>getchar();&#160; // now run flock2 again<br>close(fd);<br>close(fd2);<br>}<br><br>// flock2.c<br>// gcc -o flock2 flock2.c<br><br>#include &lt;unistd.h&gt;<br>#include &lt;fcntl.h&gt;<br>#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;string.h&gt;<br><br>int main()<br>{<br>int fd;<br>struct flock lock;<br>memset(&amp;lock, 0, sizeof(lock));<br>lock.l_type = F_WRLCK;<br>lock.l_whence = SEEK_SET;<br>lock.l_start = 2;<br>lock.l_len = 8;<br><br>fd = open(&quot;/tmp/lock&quot;, O_RDWR);<br>if(fd == -1)<br>printf(&quot;fail to openn&quot;);<br>if(-1 == fcntl(fd, F_GETLK, &amp;lock))<br>printf(&quot;fail to fcntln&quot;);<br>printf(&quot;pid : %dn&quot;, lock.l_pid);<br>printf(&quot;l_start:%d, l_len:%dn&quot;, lock.l_start, lock.l_len);<br>}<br><br><br>Output:<br>jfo@lab:~/test$ ./flock2<br>pid : 1921<br>l_start:1, l_len:9<br><br>// now <code>flock&#39; enter&lt;br /&gt;jfo@lab:~/test$ ./flock2&lt;br /&gt;pid : 0&lt;br /&gt;l_start:2, l_len:8&lt;br /&gt;&lt;br /&gt;// now</code>flock’ enter again<br> jfo@lab:~/test$ ./flock2<br>pid : 1921<br>l_start:4, l_len:8<br><br>// now `flock’ enter again and will exit<br> jfo@lab:~/test$ ./flock2<br>pid : 0<br>l_start:2, l_len:8<br><br> <br><br>前面提到，在标记(1)处如果没有close(fd2);则最后一次enter之前的输出如下：Output:<br>jfo@lab:~/test$ ./flock2<br>pid : 16530<br>l_start:1, l_len:11<br><br> 说明lock合并了。<br><br><br><br><br><del>end</del> <p></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2008/10/03/【zz】工作量大不過勞的六個方法/" rel="next" title="【zz】工作量大不過勞的六個方法">
                <i class="fa fa-chevron-left"></i> 【zz】工作量大不過勞的六個方法
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2008/10/04/Linux-socket-programming-PF-UNIX-PF-LOCAL/" rel="prev" title="Linux socket programming - PF_UNIX/PF_LOCAL">
                Linux socket programming - PF_UNIX/PF_LOCAL <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/wp-content/uploads/penguin.gif"
               alt="jfo" />
          <p class="site-author-name" itemprop="name">jfo</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">595</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">36</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/jfojfo" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/jfojfo" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.pickbox.me" title="收藏夹" target="_blank">收藏夹</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://note.pickbox.me" title="网络剪贴板" target="_blank">网络剪贴板</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://iguangba.pickbox.me" title="爱逛吧" target="_blank">爱逛吧</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <p class="post-toc-empty">此文章未包含目录</p>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2007 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jfo</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = false;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = decodeURIComponent(data.url);
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title >= 0 || index_content >= 0 ){
                                isMatch = true;
								if (i == 0) {
                                    first_occur = index_content;
                                }
                            } 
							
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

  

  
<script type="text/javascript" src="http://p.pickbox.me/js/pv.js"></script>



</body>
</html>
